<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" type="image/x-icon" href="assets/logos/logo.jpg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Camisetazo - Tienda deportiva premium: camisetas de fútbol, NBA, NFL y más. Calidad superior, envíos rápidos y atención personalizada.">
    <meta property="og:title" content="Camisetazo - Tienda Deportiva Premium">
    <meta property="og:description" content="Explora nuestro catálogo premium: camisetas de fútbol, NBA, NFL, zapatillas y más. Envío express y pago seguro.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="assets/logos/logo.jpg">
    <title>Camisetazo - Tienda Deportiva Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">        
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="styles/modal-adjustments.css">
    <link rel="stylesheet" href="styles/mobile-improvements.css">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GS53GWE2Z0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-GS53GWE2Z0');
</script>
</head>
<body>
    <div id="formStatus"></div>
    <div class="contenedor-principal">
        <header>
    <div class="brand-header">
        <img src="assets/logos/logo.jpg" alt="Logo Camisetazo" class="logo" loading="lazy" width="120" height="120">
        <div class="brand-title">CAMISETAZO</div>
        <div class="brand-subtitle">Tienda Deportiva Premium</div>
    </div>
    <nav class="navegacion">
        <button class="boton-seccion activo" data-seccion="tienda">Catálogo</button>
        <button class="boton-seccion" data-seccion="pedidos">Tienda</button>
    <button class="boton-seccion" data-seccion="carrito">Carrito</button>
    <button class="boton-seccion" data-seccion="quienes-somos">¿Quiénes Somos?</button>
    <button class="boton-seccion" data-seccion="identificarse">Identificarse</button>
    </nav>
</header>

<!-- Sección Tienda -->
<section id="tienda" class="seccion activa">
            <div class="catalogo-header animate__animated animate__fadeInDown">
                <h2 class="catalogo-titulo">Catálogo Premium</h2>
                <p class="catalogo-descripcion">Explora nuestra selección exclusiva de productos deportivos de alta calidad. Haz clic en cada categoría para ver el catálogo completo.</p>
            </div>
            <div class="grid-catalogo">
                <!-- Tarjeta 1 -->
                <div class="catalogo-card animate__animated animate__fadeInUp catalogo-card-clickable futbol-dropdown" data-link="https://2020soccer.x.yupoo.com/albums">
                    <div class="catalogo-img-wrap">
                        <img src="assets/images/camfut.png" alt="Camisetas" class="catalogo-img" loading="lazy" width="120" height="120">
                    </div>
                    <div class="catalogo-info">
                        <h3>Camisetas Fútbol</h3>
                        <p>Las mejores camisetas de clubes y selecciones, calidad premium.</p>
                        <button class="catalogo-btn futbol-dropdown-btn" type="button">
                            Ver opciones <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="futbol-dropdown-menu">
                            <a href="https://2020soccer.x.yupoo.com/albums" target="_blank" rel="noopener noreferrer">GENERAL</a>
                            <a href="https://classic-football-fhirts052.x.yupoo.com/" target="_blank" rel="noopener noreferrer">RETRO</a>
                            <a href="https://yongfa1688.x.yupoo.com/" target="_blank" rel="noopener noreferrer">NUEVA TEMPORADA</a>
                            <a href="https://aosendi.x.yupoo.com/albums" target="_blank" rel="noopener noreferrer">CONJUNTOS</a>
                            <a href="https://dongshanstore.x.yupoo.com/" target="_blank" rel="noopener noreferrer">CONJUNTOS 2</a>
                        </div>
                    </div>
                </div>
                <!-- Tarjeta 2 -->
                <div class="catalogo-card animate__animated animate__fadeInUp catalogo-card-clickable" style="animation-delay: 0.1s;" data-link="https://eu1688.x.yupoo.com/albums">
                    <div class="catalogo-img-wrap">
                        <img src="assets/images/zap.png" alt="Zapatillas" class="catalogo-img" loading="lazy" width="120" height="120">
                    </div>
                    <div class="catalogo-info">
                        <h3>Zapatillas</h3>
                        <p>Modelos exclusivos y últimas tendencias en sneakers deportivas.</p>
                        <a href="https://eu1688.x.yupoo.com/albums" class="catalogo-btn" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">
                            Ver catálogo <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                <!-- Tarjeta 3 -->
                <div class="catalogo-card animate__animated animate__fadeInUp catalogo-card-clickable" style="animation-delay: 0.2s;" data-link="https://x.yupoo.com/photos/05941188/albums">
                    <div class="catalogo-img-wrap">
                        <img src="assets/images/nba.png" alt="NBA" class="catalogo-img nba-img" loading="lazy" width="250" height="160">
                    </div>
                    <div class="catalogo-info">
                        <h3>NBA</h3>
                        <p>Camisetas y productos oficiales de la mejor liga de baloncesto.</p>
                        <a href="https://x.yupoo.com/photos/05941188/albums" class="catalogo-btn" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">
                            Ver catálogo <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                <!-- Tarjeta 4 -->
                <div class="catalogo-card animate__animated animate__fadeInUp catalogo-card-clickable" style="animation-delay: 0.3s;" data-link="https://docs.google.com/document/d/1IXUCHDWRw8osfQltnWGwz2bUFpD_J85-0_Nnq0p55NI/edit?usp=drivesdk">
                    <div class="catalogo-img-wrap">
                        <img src="assets/images/airpods.png" alt="AirPods" class="catalogo-img" loading="lazy" width="120" height="120">
                    </div>
                    <div class="catalogo-info">
                        <h3>AirPods</h3>
                        <p>Audio inalámbrico de alta calidad, compatibles con todos tus dispositivos.</p>
                        <a href="https://docs.google.com/document/d/1IXUCHDWRw8osfQltnWGwz2bUFpD_J85-0_Nnq0p55NI/edit?usp=drivesdk" class="catalogo-btn" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">
                            Ver catálogo <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                <!-- Tarjeta 5 -->
                <div class="catalogo-card animate__animated animate__fadeInUp catalogo-card-clickable" style="animation-delay: 0.4s;" data-link="https://zuqiuliu.x.yupoo.com">
                    <div class="catalogo-img-wrap">
                        <img src="assets/images/botfut.png" alt="Botas Fútbol" class="catalogo-img" loading="lazy" width="120" height="120">
                    </div>
                    <div class="catalogo-info">
                        <h3>Botas Fútbol</h3>
                        <p>Botas de fútbol profesionales para todos los terrenos y estilos.</p>
                        <a href="https://zuqiuliu.x.yupoo.com" class="catalogo-btn" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">
                            Ver catálogo <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                <!-- Tarjeta 6 -->
                <div class="catalogo-card animate__animated animate__fadeInUp catalogo-card-clickable" style="animation-delay: 0.5s;" data-link="https://x.yupoo.com/photos/yiyisports2016/collections/3551571">
                    <div class="catalogo-img-wrap">
                        <img src="assets/images/f1.png" alt="F1" class="catalogo-img" loading="lazy" width="120" height="120">
                    </div>
                    <div class="catalogo-info">
                        <h3>F1</h3>
                        <p>Merchandising y ropa oficial de Fórmula 1 para verdaderos fans.</p>
                        <a href="https://x.yupoo.com/photos/yiyisports2016/collections/3551571" class="catalogo-btn" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">
                            Ver catálogo <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                <!-- Tarjeta 7 -->
                <div class="catalogo-card animate__animated animate__fadeInUp catalogo-card-clickable" style="animation-delay: 0.6s;" data-link="https://docs.google.com/document/d/15vg3VeVf8gs3R7r6JEaG8_mdgA05hKDKg9mMsdKFVWc/edit?usp=sharing">
                    <div class="catalogo-img-wrap">
                        <img src="assets/images/ps4.png" alt="Mandos PS4" class="catalogo-img" loading="lazy" width="120" height="120">
                    </div>
                    <div class="catalogo-info">
                        <h3>Mandos PS4</h3>
                        <p>Mandos y accesorios para PlayStation 4, máxima precisión y calidad.</p>
                        <a href="https://docs.google.com/document/d/15vg3VeVf8gs3R7r6JEaG8_mdgA05hKDKg9mMsdKFVWc/edit?usp=sharing" class="catalogo-btn" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">
                            Ver catálogo <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                <!-- Tarjeta 8 -->
                <div class="catalogo-card animate__animated animate__fadeInUp catalogo-card-clickable" style="animation-delay: 0.7s;" data-link="https://nfl-world.x.yupoo.com/">
                    <div class="catalogo-img-wrap">
                        <img src="assets/images/nfl.png" alt="NFL" class="catalogo-img" loading="lazy" width="120" height="120">
                    </div>
                    <div class="catalogo-info">
                        <h3>NFL</h3>
                        <p>Jerseys y artículos oficiales de la National Football League.</p>
                        <a href="https://nfl-world.x.yupoo.com/" class="catalogo-btn" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation();">
                            Ver catálogo <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                
            </div>
        </section>


<!-- Sección Quiénes Somos -->
        <section id="quienes-somos" class="seccion">
    <style>
    .quienes-somos-ui {
        max-width: 900px;
        margin: 0 auto 2.5rem auto;
        background: rgba(20,40,80,0.18);
        border-radius: 22px;
        box-shadow: 0 4px 32px rgba(42,91,168,0.10), 0 1.5px 8px rgba(0,0,0,0.08);
        padding: 2.5rem 2rem 2rem 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
        border: 1.5px solid rgba(42,91,168,0.13);
        animation: aparecer 0.8s;
    }
    .quienes-somos-ui h2 {
        color: var(--azul-acento);
        font-size: 2.2rem;
        font-weight: 800;
        margin-bottom: 1.2rem;
        letter-spacing: 1px;
        text-shadow: 0 2px 12px rgba(42,91,168,0.10);
    }
    .quienes-somos-ui p {
        color: #e0e0e0;
        font-size: 1.15rem;
        line-height: 1.7;
        margin-bottom: 2rem;
        opacity: 0.92;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
    }
    .quienes-somos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 2rem;
        margin-top: 2.5rem;
    }
    .quienes-somos-card {
        background: rgba(42,91,168,0.13);
        border-radius: 16px;
        padding: 2rem 1.2rem 1.5rem 1.2rem;
        box-shadow: 0 2px 12px rgba(42,91,168,0.08);
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(42,91,168,0.10);
    }
    .quienes-somos-card:hover {
        transform: translateY(-6px) scale(1.03);
        box-shadow: 0 8px 32px rgba(42,91,168,0.13);
        background: rgba(42,91,168,0.18);
    }
    .quienes-somos-card i {
        font-size: 2.7rem;
        margin-bottom: 1rem;
        color: var(--azul-acento);
        background: #fff;
        border-radius: 50%;
        padding: 0.7rem;
        box-shadow: 0 2px 8px rgba(42,91,168,0.08);
        transition: background 0.2s;
    }
    .quienes-somos-card h3 {
        font-size: 1.25rem;
        color: #fff;
        margin-bottom: 0.7rem;
        font-weight: 700;
    }
    .quienes-somos-card p {
        color: #b8c6e0;
        font-size: 1rem;
        margin-bottom: 0;
        min-height: 40px;
    }
    .quienes-somos-card .stars {
        color: #ffd700;
        margin-top: 0.5rem;
        font-size: 1.1rem;
    }
    .quienes-somos-card .stars i {
        color: #FFD700 !important;
        font-size: 1rem !important;
        background: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        box-shadow: none !important;
        margin: 0 1px;
        vertical-align: middle;
    }
    .quienes-somos-instagram {
        background: linear-gradient(90deg, #e1306c 0%, #fdc468 100%);
        color: #fff;
        border-radius: 16px;
        padding: 1.5rem 1rem 1.2rem 1rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 12px rgba(225,48,108,0.10);
        display: flex;
        flex-direction: column;
        align-items: center;
        animation: aparecer 1s;
    }
    .quienes-somos-instagram i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        color: #fff;
        background: #e1306c;
        border-radius: 50%;
        padding: 0.7rem;
        box-shadow: 0 2px 8px rgba(225,48,108,0.10);
    }
    .quienes-somos-instagram a {
        color: #fff;
        font-weight: 600;
        text-decoration: underline;
        margin: 0.5rem 0;
        font-size: 1.1rem;
    }
    .quienes-somos-instagram p {
        margin-top: 0.5rem;
        opacity: 0.95;
        font-size: 1rem;
    }
    @media (max-width: 700px) {
        .quienes-somos-ui {
            padding: 1.2rem 0.5rem;
        }
        .quienes-somos-grid {
            grid-template-columns: 1fr;
            gap: 1.2rem;
        }
    }
    .formulario-pedido {
        max-width: 900px;
        margin: 2.5rem auto;
        background: linear-gradient(135deg, rgba(10,31,61,0.92) 70%, rgba(42,91,168,0.13) 100%);
        backdrop-filter: blur(16px);
        border-radius: 28px;
        padding: 2.7rem 2.2rem 2.2rem 2.2rem;
        border: 2.5px solid var(--azul-acento);
        box-shadow: 0 8px 40px rgba(42,91,168,0.13), 0 2px 12px rgba(0,0,0,0.10);
        position: relative;
        animation: aparecer 0.7s;
    }

    .formulario-pedido h2 {
        text-align: center;
        color: var(--azul-acento);
        margin-bottom: 2.2rem;
        font-size: 2.3rem;
        font-weight: 900;
        letter-spacing: 1.5px;
        text-shadow: 0 2px 12px rgba(42,91,168,0.10);
    }

    .selector-unidades {
        display: flex;
        justify-content: center;
        gap: 1.2rem;
        margin-bottom: 2.2rem;
    }

    .boton-unidad {
        background: var(--azul-acento);
        color: #fff;
        border: 2px solid transparent;
        border-radius: 12px;
        padding: 0.9rem 2.1rem;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 2px 12px rgba(42,91,168,0.10);
        transition: background 0.2s, color 0.2s, border 0.2s, transform 0.2s, box-shadow 0.2s;
    }

    .boton-unidad.activo, .boton-unidad:focus {
        background: #163a6b;
        color: var(--azul-acento);
        border: 2.5px solid var(--azul-acento);
        outline: none;
        box-shadow: 0 6px 24px rgba(42,91,168,0.13);
        transform: translateY(-3px) scale(1.04);
    }

    .boton-unidad:not(.activo):hover {
        background: #2456a8;
        color: #fff;
        border: 2px solid #2456a8;
        transform: translateY(-1px) scale(1.02);
        box-shadow: 0 4px 16px rgba(42,91,168,0.13);
    }

    .input-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 2.2rem;
        margin: 2.2rem 0 1.5rem 0;
    }

    .input-group {
        margin-bottom: 1.2rem;
        background: rgba(255,255,255,0.04);
        border-radius: 10px;
        padding: 1.1rem 1rem 0.7rem 1rem;
        box-shadow: 0 1px 6px rgba(42,91,168,0.07);
        border: 1.5px solid rgba(42,91,168,0.10);
    }

    .input-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #e0e0e0;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .input-group input,
    .input-group textarea {
        width: 100%;
        padding: 13px;
        border: 2px solid var(--azul-acento);
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.13);
        color: white;
        font-size: 1.08rem;
        transition: all 0.3s ease;
    }

    .input-group input:focus,
    .input-group textarea:focus {
        outline: none;
        border-color: #4a90e2;
        box-shadow: 0 0 10px rgba(74, 144, 226, 0.3);
        background: rgba(255,255,255,0.18);
    }

    .calculadora-precio {
        background: rgba(255, 255, 255, 0.13);
        border-radius: 16px;
        padding: 2.2rem 1.5rem 1.5rem 1.5rem;
        margin: 2.2rem 0 1.2rem 0;
        box-shadow: 0 4px 16px rgba(42, 91, 168, 0.10);
        border: 1.5px solid var(--azul-acento);
    }

    .calculadora-precio h3 {
        color: var(--azul-acento);
        font-size: 1.4rem;
        font-weight: 800;
        margin-bottom: 1.2rem;
        letter-spacing: 1px;
    }

    .detalle-precio {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 1rem 0;
        padding: 1.1rem 1.2rem;
        background: rgba(255, 255, 255, 0.09);
        border-radius: 10px;
        font-size: 1.08rem;
        border: 1px solid rgba(42,91,168,0.10);
        box-shadow: 0 1px 4px rgba(42,91,168,0.06);
    }

    .detalle-precio span:first-child:before {
        content: '\f02b';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        color: var(--azul-acento);
        margin-right: 0.7em;
        font-size: 1.1em;
        vertical-align: middle;
    }

    .total-container {
        background: var(--azul-acento);
        padding: 1.7rem;
        border-radius: 12px;
        margin: 2.2rem 0 0.5rem 0;
        text-align: center;
        box-shadow: 0 2px 12px rgba(42,91,168,0.13);
    }

    .precio-total {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0.5rem 0;
        color: #fff;
        text-shadow: 0 2px 12px rgba(42,91,168,0.10);
    }

    .moneda {
        font-size: 1.2rem;
        vertical-align: super;
    }

    .badge-extra {
        background: #28a745;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.9rem;
        margin-left: 1rem;
    }
    .contenedor-principal {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

.brand-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(20,40,80,0.25);
    border-radius: 24px;
    box-shadow: 0 6px 32px rgba(42,91,168,0.10), 0 1.5px 8px rgba(0,0,0,0.10);
    padding: 2.5rem 1.5rem 2rem 1.5rem;
    margin-bottom: 2rem;
    position: relative;
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
}

.brand-header .logo {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 1.2rem;
    box-shadow: 0 4px 24px rgba(42,91,168,0.15);
    background: #fff;
    border: 4px solid var(--azul-acento);
    transition: transform 0.3s;
}
.brand-header .logo:hover {
    transform: scale(1.07) rotate(-2deg);
}

.brand-header .brand-title {
    font-size: 2.7em;
    font-weight: 900;
    color: var(--azul-acento);
    letter-spacing: 2px;
    text-shadow: 0 2px 12px rgba(42,91,168,0.10);
    margin-bottom: 0.2em;
    line-height: 1.1;
    background: linear-gradient(90deg, #fff 60%, var(--azul-acento) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.brand-header .brand-subtitle {
    color: #e0e0e0;
    font-size: 1.1em;
    font-weight: 400;
    opacity: 0.85;
    margin-bottom: 0;
    text-align: center;
    letter-spacing: 0.5px;
}

        header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
            padding: 20px 0;
        }

        .logo {
            width: 200px;
            filter: drop-shadow(0 0 15px rgba(42, 91, 168, 0.4));
            animation: pulse 3s 1;
            border-radius: 50%;
            margin: 20px auto;
        }

        @keyframes flotar {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        h1 {
            font-size: 2.5em;
            margin: 1rem 0 0.5rem;
            color: #e0e0e0;
            position: relative;
            display: inline-block;
            padding-bottom: 10px;
        }

        h1::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100%;
            height: 3px;
            background: var(--azul-acento);
            transform: scaleX(0);
            animation: subrayar-titulo 1.5s ease-in-out 1s forwards;
            box-shadow: 0 0 15px rgba(42, 91, 168, 0.5);
        }

        @keyframes subrayar-titulo {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }
        .selector-unidades {
            display: flex;
            justify-content: center;
            gap: 1.2rem;
            margin-bottom: 2.2rem;
        }

        .boton-unidad {
            background: var(--azul-acento);
            color: #fff;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 0.9rem 2.1rem;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(42,91,168,0.10);
            transition: background 0.2s, color 0.2s, border 0.2s, transform 0.2s, box-shadow 0.2s;
        }

        .boton-unidad.activo, .boton-unidad:focus {
            background: #163a6b;
            color: var(--azul-acento);
            border: 2.5px solid var(--azul-acento);
            outline: none;
            box-shadow: 0 6px 24px rgba(42,91,168,0.13);
            transform: translateY(-3px) scale(1.04);
        }

        .boton-unidad:not(.activo):hover {
            background: #2456a8;
            color: #fff;
            border: 2px solid #2456a8;
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 16px rgba(42,91,168,0.13);
        }

        .boton-version-especial, .boton-version-jugador, .boton-camiseta-nba {
            width: 100%;
            padding: 0.85rem 0;
            font-size: 1.08rem;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            background: linear-gradient(90deg, var(--azul-acento) 60%, #1a3b6d 100%);
            color: #fff;
            box-shadow: 0 2px 12px rgba(42,91,168,0.10);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, transform 0.18s, box-shadow 0.2s;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.7em;
            position: relative;
            outline: none;
        }
        .boton-version-especial span, .boton-version-jugador span, .boton-camiseta-nba span {
            font-size: 0.98em;
            font-weight: 600;
            margin-left: 0.5em;
            letter-spacing: 0.2px;
        }
        .boton-version-especial.activo, .boton-version-jugador.activo, .boton-camiseta-nba.activo {
            background: linear-gradient(90deg, #fff 10%, var(--azul-acento) 100%);
            color: var(--azul-acento);
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 6px 24px rgba(42,91,168,0.13);
            border: 2px solid var(--azul-acento);
        }
        .boton-version-especial:not(.activo):hover, .boton-version-jugador:not(.activo):hover, .boton-camiseta-nba:not(.activo):hover {
            background: linear-gradient(90deg, #2a5ba8 60%, #1a3b6d 100%);
            color: #fff;
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 16px rgba(42,91,168,0.13);
        }
        .boton-version-jugador::before,
    .boton-version-especial:not(.boton-version-jugador):not(.boton-camiseta-nba)::before,
    .boton-camiseta-nba::before {
        content: none !important;
        display: none !important;
    }
      /* Panel de puntos: separación de líneas */
     #profile-section #points-summary { gap: 10px; }

     /* Responsive: apilar cabecera y centrar acciones en móvil */
     @media (max-width: 520px) {
       #profile-section .ident-header { flex-direction: column; text-align: center; gap: 10px; }
       #profile-section .profile-actions { width: 100%; justify-content: center; margin-left: 0; margin-bottom: 0; }
     }
   </style>
    <div class="quienes-somos-ui animate__animated animate__fadeIn">
        <h2>Nuestra Historia</h2>
        <p>
            En Camisetazo nos apasiona conectar a los verdaderos amantes del deporte con artículos premium de las mejores marcas. Nos especializamos en ofrecer productos de alta calidad y artículos exclusivos que permiten vivir la emoción del deporte al mejor precio. Combinamos nuestro conocimiento experto con un servicio personalizado para garantizar que cada compra supere tus expectativas.
        </p>
        <div class="quienes-somos-instagram">
            <i class="fab fa-instagram"></i>
            <h3>Síguenos en Instagram</h3>
            <a href="https://www.instagram.com/camisetazo._/" target="_blank" rel="noopener noreferrer">@camisetazo._ ➔</a>
            <p>Novedades diarias | Ofertas exclusivas</p>
        </div>
        <div class="clientes-carrusel-section">
            <h3 style="color:var(--azul-acento);margin-bottom:1rem;">Clientes Satisfechos</h3>
            <div class="clientes-carrusel">
                <button class="carrusel-btn" id="carrusel-prev" aria-label="Anterior">&#8592;</button>
                <div class="carrusel-imagenes">
                    <div class="carrusel-img-bg activa" data-img="assets/clientes/cliente1.jpg" aria-label="Cliente satisfecho 1"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente2.jpg" aria-label="Cliente satisfecho 2"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente3.jpg" aria-label="Cliente satisfecho 3"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente4.jpg" aria-label="Cliente satisfecho 4"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente5.jpg" aria-label="Cliente satisfecho 5"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente6.jpg" aria-label="Cliente satisfecho 6"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente7.jpg" aria-label="Cliente satisfecho 7"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente8.jpg" aria-label="Cliente satisfecho 8"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente9.jpg" aria-label="Cliente satisfecho 9"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente10.jpg" aria-label="Cliente satisfecho 10"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente11.jpg" aria-label="Cliente satisfecho 11"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente12.jpg" aria-label="Cliente satisfecho 12"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente13.jpg" aria-label="Cliente satisfecho 13"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente14.jpg" aria-label="Cliente satisfecho 14"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente15.jpg" aria-label="Cliente satisfecho 15"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente16.jpg" aria-label="Cliente satisfecho 16"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente17.jpg" aria-label="Cliente satisfecho 17"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente18.jpg" aria-label="Cliente satisfecho 18"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente19.jpg" aria-label="Cliente satisfecho 19"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente20.jpg" aria-label="Cliente satisfecho 20"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente21.jpg" aria-label="Cliente satisfecho 21"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente22.jpg" aria-label="Cliente satisfecho 22"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente23.jpg" aria-label="Cliente satisfecho 23"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente24.jpg" aria-label="Cliente satisfecho 24"></div>
                    <div class="carrusel-img-bg" data-img="assets/clientes/cliente25.jpg" aria-label="Cliente satisfecho 25"></div>
                    
                </div>
                <button class="carrusel-btn" id="carrusel-next" aria-label="Siguiente">&#8594;</button>
            </div>
            <p style="margin-top:0.7rem;color:#b8c6e0;font-size:1rem;">Desliza para ver más capturas de clientes reales. ¡Gracias por confiar en nosotros!</p>
        </div>
        
        <div class="reseñas-clientes">
            <h3 style="color:var(--azul-acento);margin:1.5rem 0 1rem;">Opiniones sobre nuestras camisetas</h3>
            <div class="lista-reseñas">
                <div class="reseña">
                    <p>"La calidad de la tela es increíble, se nota que es premium desde el primer uso. ¡Superó mis expectativas!"</p>
                </div>
                <div class="reseña">
                    <p>"Compré la del Barça y la verdad que los detalles están perfectamente cosidos. No se deshilacha como otras."</p>
                </div>
                <div class="reseña">
                    <p>"Llevo 3 meses usando la del Madrid y sigue como nueva después de tantos lavados. Calidad-precio imbatible."</p>
                </div>
                <div class="reseña">
                    <p>"Los logos y patrocinadores están bien pegados, no se levantan como en otras tiendas. Muy recomendable."</p>
                </div>
                <div class="reseña">
                    <p>"La transpiración es excelente, jugué un partido completo y no se pegó al cuerpo. ¡De las mejores que he tenido!"</p>
                </div>
            </div>
        </div>
        <div class="quienes-somos-grid">
            <div class="quienes-somos-card">
                <i class="fas fa-shield-alt"></i>
                <h3>Garantía de Pago</h3>
                <p>Transacciones seguras con protección al comprador</p>
            </div>
            <div class="quienes-somos-card">
                <i class="fas fa-shipping-fast"></i>
                <h3>Envío Express</h3>
                <p>Entrega en 1-2 semanas con seguimiento del paquete</p>
            </div>
            <div class="quienes-somos-card">
                <i class="fas fa-users"></i>
                <h3>Comunidad</h3>
                <p>+100 clientes satisfechos</p>
                <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                </div>
            </div>
            <div class="quienes-somos-card">
                <i class="fas fa-headset"></i>
                <h3>Atención al cliente</h3>
                <p>Obtén respuestas rápidas con nuestro servicio de atención al cliente</p>
            </div>
            <div class="quienes-somos-card">
                <i class="fas fa-tshirt"></i>
                <h3>Personalización</h3>
                <p>Elige nombre, número y detalles únicos para tu camiseta</p>
            </div>
            <div class="quienes-somos-card">
                <i class="fas fa-gem"></i>
                <h3>Calidad Premium</h3>
                <p>Materiales de alta gama y acabados profesionales en cada producto</p>
            </div>
        </div>
    </div>
</section>
    <section id="carrito" class="seccion">
        <div class="cart-layout" role="group" aria-label="Carrito y recomendaciones">
            <aside id="cartPanel" class="cart-panel" aria-label="Carrito de compras">
                <div class="cart-header">
                    <h3>Tu Carrito</h3>
                    <div id="cartCount" class="cart-count" aria-hidden="true">0</div>
                </div>

                <div id="cartItems" class="cart-items">
                    <div class="cart-empty">Tu carrito está vacío<br><small>Agrega productos para empezar</small></div>
                </div>

                <div class="cart-divider" aria-hidden="true"></div>

                <div class="cart-discount-section">
                    <div class="discount-dropdown-container">
                        <button id="discountDropdownBtn" class="discount-dropdown-btn">
                            <span id="discountBtnText">Aplicar descuento</span>
                            <span class="dropdown-arrow">▼</span>
                        </button>
                        <div id="discountDropdown" class="discount-dropdown-menu hidden">
                            <div class="discount-dropdown-header">
                                <h4>Tus descuentos disponibles</h4>
                            </div>
                            <div id="discountList" class="discount-list">
                                <div class="discount-empty">No tienes descuentos disponibles</div>
                            </div>
                        </div>
                    </div>
                    <div id="appliedDiscount" class="applied-discount hidden">
                        <span id="appliedDiscountText"></span>
                        <button id="removeDiscountBtn" class="remove-discount-btn">×</button>
                    </div>
                </div>

                <div class="cart-totals">
                    <div class="tot-row"><span>Subtotal</span><span><strong id="cartSubtotal">0.00</strong></span></div>
                    <div class="tot-row"><span>Descuento</span><span id="cartDiscount">-0.00</span></div>
                    <div class="tot-row"><span>Gastos envío</span><span id="cartShipping">2.00</span></div>
                    <div class="tot-row total"><span>Total</span><span id="cartTotal">0.00</span></div>
                </div>

                <div class="cart-actions">
                    <button id="clearCartGallery" class="btn-secondary">Vaciar</button>
                    <button id="gotoCheckoutBtn" class="btn-primary">Pagar</button>
                </div>

                <p class="cart-note">Antes de pagar se solicitará correo de PayPal, usuario de Instagram y dirección de envío.</p>
            </aside>
            <aside id="cartRecoPanel" class="cart-reco-panel" aria-label="Recomendaciones para ti">
                <div class="reco-header">
                    <h3>Te podría gustar</h3>
                    <div class="reco-nav">
                        <button class="reco-arrow" id="recoPrev" aria-label="Desplazar recomendaciones a la izquierda">‹</button>
                        <button class="reco-arrow" id="recoNext" aria-label="Desplazar recomendaciones a la derecha">›</button>
                    </div>
                </div>
                <div id="recoScroller" class="reco-scroller" tabindex="0" role="region" aria-label="Lista de recomendaciones desplazable horizontalmente"></div>
                <p class="reco-hint">Añade productos al carrito para ver recomendaciones.</p>
            </aside>
        </div>
        <style>
            /* Estilos locales sólo para la sección Carrito */
            #carrito .cart-layout { display:grid; grid-template-columns: 1fr; gap:16px; align-items:start; grid-template-areas: 'cart' 'reco'; }
            #carrito #cartPanel { grid-area: cart; }
            #carrito #cartRecoPanel { grid-area: reco; }
            #carrito { scroll-margin-top: 16px; }
            @media (min-width: 992px) { #carrito .cart-layout { grid-template-columns: minmax(520px, 1fr) clamp(320px, 28vw, 460px); grid-template-areas: 'cart reco'; } }
            #carrito .cart-panel { max-width: none; max-height: none; }
            @media (min-width: 992px) { #carrito .cart-panel { position: sticky; top: 16px; } }
             @media (min-width: 992px) { #carrito #cartRecoPanel { position: sticky; top: 16px; } }
            #carrito .cart-panel { margin-top: 0 !important; }
            #carrito #cartRecoPanel { background: rgba(10,31,61,0.9); border:1px solid rgba(46,123,237,0.12); border-radius:14px; padding:12px 12px 0px; }
            @media (min-width: 992px) { #carrito #cartRecoPanel { margin-top:16px !important; } }
            #carrito .reco-header { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
            #carrito .reco-header h3 { color:#fff; font-size:1.02rem; margin:0; }
            #carrito .reco-nav { display:flex; gap:8px; }
            #carrito .reco-arrow { background: transparent; border: 1px solid rgba(255,255,255,0.12); color:#d6e9ff; border-radius:8px; padding:6px 10px; cursor:pointer; }
            #carrito .reco-arrow:hover { background: rgba(255,255,255,0.07); }
            #carrito .reco-scroller { display:grid; grid-auto-flow: column; grid-auto-columns: minmax(160px, 1fr); gap:10px; overflow-x:auto; overflow-y:hidden; scroll-snap-type:x mandatory; padding-bottom:4px; }
            #carrito .reco-scroller::-webkit-scrollbar { height:8px; }
            #carrito .reco-scroller::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius:6px; }
            #carrito .reco-card { scroll-snap-align:start; background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03)); border:1px solid rgba(255,255,255,0.08); border-radius:12px; overflow:hidden; display:flex; flex-direction:column; cursor:pointer; }
            #carrito .reco-card img { width:100%; aspect-ratio:1/1; object-fit:cover; }
            #carrito .reco-meta { padding:8px 10px; color:#d6e9ff; min-height:64px; }
            #carrito .reco-name { font-weight:700; font-size:0.95rem; line-height:1.2; margin-bottom:4px; }
            #carrito .reco-price { color:#9fe0ff; font-weight:800; }
            #carrito .reco-actions { display:flex; gap:8px; padding:8px 10px 12px; }
            #carrito .reco-actions .btn-primary { flex:1; padding:8px 10px; border-radius:10px; }
            #carrito .reco-actions .btn-secondary { padding:8px 10px; border-radius:10px; }
            #carrito .reco-hint { color:#9fbfe8; font-size:0.9rem; margin-top:4px; text-align:center; }

            /* Estilos para el desplegable de descuentos */
            .cart-discount-section {
                margin: 16px 0;
                padding: 12px;
                background: rgba(255,255,255,0.02);
                border-radius: 12px;
                border: 1px solid rgba(255,255,255,0.05);
            }

            .discount-dropdown-container {
                position: relative;
                margin-bottom: 12px;
            }

            .discount-dropdown-btn {
                width: 100%;
                padding: 12px 16px;
                background: linear-gradient(180deg, var(--azul-acento) 0%, #1a3b6d 100%);
                color: #fff;
                border: 1px solid rgba(255,255,255,0.12);
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: all 0.2s ease;
            }

            .discount-dropdown-btn:hover {
                background: linear-gradient(180deg, #2e7bed 0%, #1a3b6d 100%);
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }

            .discount-dropdown-btn.active {
                background: linear-gradient(180deg, #ff9500 0%, #cc7700 100%);
            }

            .discount-dropdown-btn.has-discounts {
                background: linear-gradient(180deg, #4299e1 0%, #3182ce 100%);
                border-color: #3182ce;
                color: #fff;
                animation: pulse-discount 2s infinite;
            }

            @keyframes pulse-discount {
                0% {
                    box-shadow: 0 0 0 0 rgba(66, 153, 225, 0.4);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(66, 153, 225, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(66, 153, 225, 0);
                }
            }

            .dropdown-arrow {
                font-size: 12px;
                transition: transform 0.2s ease;
            }

            .discount-dropdown-btn.active .dropdown-arrow {
                transform: rotate(180deg);
            }

            .discount-dropdown-menu {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(10,31,61,0.95);
                border: 1px solid rgba(46,123,237,0.2);
                border-radius: 8px;
                margin-top: 4px;
                max-height: 300px;
                overflow-y: auto;
                z-index: 1000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            }

            .discount-dropdown-header {
                padding: 12px 16px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
            }

            .discount-dropdown-header h4 {
                margin: 0;
                color: #fff;
                font-size: 0.95rem;
                font-weight: 700;
            }

            .discount-list {
                padding: 8px;
            }

            .discount-item {
                padding: 12px;
                margin: 4px 0;
                background: rgba(255,255,255,0.03);
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
                border: 1px solid rgba(255,255,255,0.05);
            }

            .discount-item:hover {
                background: rgba(255,255,255,0.06);
                border-color: rgba(46,123,237,0.3);
            }

            .discount-item-title {
                font-weight: 600;
                color: #fff;
                font-size: 0.9rem;
                margin-bottom: 4px;
            }

            .discount-item-description {
                color: #bcd9ff;
                font-size: 0.8rem;
                line-height: 1.3;
            }

            .discount-item-code {
                color: #9fe0ff;
                font-size: 0.75rem;
                margin-top: 4px;
                font-family: monospace;
            }

            .discount-empty {
                padding: 20px;
                text-align: center;
                color: #9fbfe8;
                font-size: 0.9rem;
            }

            .applied-discount {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px;
                background: linear-gradient(90deg, rgba(255,200,100,0.1), rgba(255,180,0,0.05));
                border: 1px solid rgba(255,180,0,0.3);
                border-radius: 8px;
                margin-top: 8px;
            }

            .applied-discount span {
                color: #ffd966;
                font-weight: 600;
                font-size: 0.9rem;
            }

            .remove-discount-btn {
                background: rgba(255,80,80,0.2);
                color: #ff5050;
                border: 1px solid rgba(255,80,80,0.3);
                border-radius: 4px;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                    justify-content: center;
                cursor: pointer;
                font-size: 16px;
                line-height: 1;
                transition: all 0.2s ease;
            }

            .remove-discount-btn:hover {
                background: rgba(255,80,80,0.3);
                color: #ff8080;
            }

            .hidden {
                display: none !important;
            }

            /* Optimización móvil mejorada del carrito */
            @media (max-width: 768px) {
                /* Layout responsivo sin desbordes */
                #carrito .cart-layout {
                    display: flex;
                    flex-direction: column;
                    gap: 16px;
                    padding: 0 clamp(8px, 2vw, 16px);
                    width: 100%;
                    box-sizing: border-box;
                }
                
                /* Contenedores adaptativos con proporciones mantenidas */
                #carrito .cart-panel,
                #carrito #cartRecoPanel {
                    width: 100%;
                    max-width: 100%;
                    min-width: 0;
                    margin: 0;
                    border-radius: 12px;
                    box-sizing: border-box;
                    overflow: hidden;
                }
                
                #carrito .cart-panel {
                    padding: clamp(12px, 3vw, 16px);
                    background: rgba(10,31,61,0.95);
                    border: 1px solid rgba(46,123,237,0.12);
                }
                
                /* Header optimizado para móviles */
                #carrito .cart-header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 12px;
                    padding: 8px 4px 12px;
                    margin-bottom: 8px;
                }
                
                #carrito .cart-header h3 {
                    font-size: clamp(1rem, 2.5vw, 1.15rem);
                    margin: 0;
                    white-space: nowrap;
                }
                
                /* Lista de items con altura dinámica */
                #carrito .cart-items {
                    max-height: min(50vh, 400px);
                    overflow-y: auto;
                    margin-bottom: 12px;
                    padding-right: 4px;
                }
                
                /* Items del carrito con layout flexible */
                #carrito .cart-item {
                    display: flex;
                    gap: clamp(8px, 2vw, 12px);
                    align-items: flex-start;
                    padding: clamp(8px, 2vw, 12px);
                    border-radius: 8px;
                    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
                    border: 1px solid rgba(255,255,255,0.03);
                    margin-bottom: 8px;
                    box-sizing: border-box;
                }
                
                #carrito .cart-item img {
                    width: clamp(48px, 12vw, 64px);
                    height: clamp(48px, 12vw, 64px);
                    object-fit: cover;
                    border-radius: 6px;
                    flex-shrink: 0;
                }
                
                #carrito .cart-item .meta {
                    flex: 1;
                    min-width: 0;
                    text-align: left;
                }
                
                #carrito .cart-item .meta b {
                    display: block;
                    color: #fff;
                    font-size: clamp(0.9rem, 2.2vw, 0.98rem);
                    margin-bottom: 2px;
                    line-height: 1.3;
                    word-break: break-word;
                    overflow-wrap: break-word;
                }
                
                #carrito .cart-item .meta small {
                    color: #bcd9ff;
                    font-size: clamp(0.8rem, 2vw, 0.9rem);
                    display: block;
                    line-height: 1.2;
                }
                
                #carrito .cart-item .meta .qty-row {
                    margin-top: 6px;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    flex-wrap: wrap;
                }
                
                #carrito .cart-item .meta .qty-row input {
                    width: clamp(44px, 10vw, 56px);
                    padding: 4px 6px;
                    border-radius: 6px;
                    border: 1px solid rgba(255,255,255,0.06);
                    background: transparent;
                    color: #fff;
                    text-align: center;
                    font-size: clamp(0.9rem, 2vw, 0.95rem);
                }
                
                /* Precio y controles alineados */
                #carrito .cart-item .meta + div {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-end;
                    gap: 4px;
                    min-width: 60px;
                    flex-shrink: 0;
                }
                
                #carrito .cart-item .remove {
                    background: transparent;
                    border: none;
                    color: #ff8a8a;
                    cursor: pointer;
                    font-size: 1.1rem;
                    padding: 4px;
                    align-self: flex-end;
                }
                
                /* Totales con mejor legibilidad */
                #carrito .cart-totals {
                    display: flex;
                    flex-direction: column;
                    gap: 6px;
                    padding: 8px 0;
                }
                
                #carrito .cart-totals .tot-row {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    color: #cfe8ff;
                    font-weight: 600;
                    font-size: clamp(0.9rem, 2.2vw, 1rem);
                    line-height: 1.4;
                }
                
                #carrito .cart-totals .tot-row.total {
                    font-size: clamp(1rem, 2.5vw, 1.16rem);
                    color: #fff;
                    font-weight: 800;
                    padding-top: 4px;
                    border-top: 1px solid rgba(255,255,255,0.08);
                }
                
                /* Acciones con mejor espaciado */
                #carrito .cart-actions {
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    margin-top: 12px;
                }
                
                #carrito .cart-actions .btn-primary,
                #carrito .cart-actions .btn-secondary {
                    width: 100%;
                    padding: clamp(10px, 2.5vw, 12px) clamp(12px, 3vw, 16px);
                    border-radius: 8px;
                    font-size: clamp(0.9rem, 2.2vw, 1rem);
                    min-height: 44px;
                    box-sizing: border-box;
                }
                
                /* Panel de recomendaciones optimizado */
                #carrito #cartRecoPanel {
                    padding: 12px 12px 4px;
                    background: rgba(10,31,61,0.9);
                    border: 1px solid rgba(46,123,237,0.12);
                }
                
                #carrito .reco-header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 8px;
                    margin-bottom: 8px;
                    flex-wrap: wrap;
                }
                
                #carrito .reco-header h3 {
                    font-size: clamp(0.95rem, 2.3vw, 1.02rem);
                    margin: 0;
                }
                
                #carrito .reco-scroller {
                    display: grid;
                    grid-auto-flow: column;
                    grid-auto-columns: minmax(clamp(130px, 30vw, 160px), 1fr);
                    gap: clamp(6px, 1.5vw, 10px);
                    overflow-x: auto;
                    overflow-y: hidden;
                    scroll-snap-type: x mandatory;
                    padding-bottom: 4px;
                    -webkit-overflow-scrolling: touch;
                }
                
                #carrito .reco-card {
                    scroll-snap-align: start;
                    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
                    border: 1px solid rgba(255,255,255,0.08);
                    border-radius: 8px;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                    cursor: pointer;
                    min-width: 0;
                }
                
                #carrito .reco-card img {
                    width: 100%;
                    aspect-ratio: 1/1;
                    object-fit: cover;
                    border-radius: 6px 6px 0 0;
                }
                
                #carrito .reco-meta {
                    padding: clamp(6px, 1.5vw, 8px);
                    color: #d6e9ff;
                    min-height: clamp(50px, 12vw, 64px);
                }
                
                #carrito .reco-name {
                    font-weight: 700;
                    font-size: clamp(0.85rem, 2vw, 0.95rem);
                    line-height: 1.2;
                    margin-bottom: 2px;
                }
                
                #carrito .reco-price {
                    color: #9fe0ff;
                    font-weight: 800;
                    font-size: clamp(0.85rem, 2vw, 0.9rem);
                }
                
                /* Ajustes para pantallas muy pequeñas */
                @media (max-width: 360px) {
                    #carrito .cart-layout {
                        padding: 0 6px;
                    }
                    
                    #carrito .cart-panel,
                    #carrito #cartRecoPanel {
                        border-radius: 8px;
                    }
                    
                    #carrito .cart-item {
                        padding: 6px;
                        gap: 6px;
                    }
                    
                    #carrito .cart-item img {
                        width: 42px;
                        height: 42px;
                    }
                }
            }
        </style>
        <script>
            (function(){
                const scroller = document.getElementById('recoScroller');
                const prev = document.getElementById('recoPrev');
                const next = document.getElementById('recoNext');
                if (!scroller) return;
                const scrollBy = () => Math.max(220, scroller.clientWidth * 0.8);
                prev && prev.addEventListener('click', () => scroller.scrollBy({ left: -scrollBy(), behavior: 'smooth' }));
                next && next.addEventListener('click', () => scroller.scrollBy({ left: scrollBy(), behavior: 'smooth' }));
                scroller.addEventListener('wheel', (e) => {
                    if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                        scroller.scrollLeft += e.deltaY;
                        e.preventDefault();
                    }
                }, { passive: false });
            })();
        </script>
    </section>
    <!-- Sección Pedidos: Galería de productos y carrito -->
    <section id="pedidos" class="seccion">
    <!-- Hidden order form (submitted to FormSubmit) - populated programmatically before submit -->
    <form id="pedidoForm" action="https://formsubmit.co/ac88c19c0b46633676d4b3e8db41dea8" method="POST" style="display:none;">
        <input type="hidden" name="_next" value="compraExitosa.html">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_subject" value="Nuevo pedido con pago confirmado">
        <input type="hidden" name="_language" value="es">
        <input type="hidden" name="_template" value="table">
        <input type="hidden" name="precio_total" id="precioTotal">
        <!-- Reserve common fields (will be filled from checkout modal) -->
        <input type="hidden" name="emailPaypal" id="form_emailPaypal">
        <input type="hidden" name="direccion" id="form_direccion">
        <input type="hidden" name="contactName" id="form_contactName">
        <input type="hidden" name="city" id="form_city">
        <input type="hidden" name="state" id="form_state">
        <input type="hidden" name="country" id="form_country">
        <input type="hidden" name="postal" id="form_postal">
        <input type="hidden" name="phone" id="form_phone">
        <input type="hidden" name="instagram" id="form_instagram">
        <!-- Campos recomendados para FormSubmit -->
        <input type="text" name="_honey" style="display:none">
        <input type="hidden" name="_replyto" id="form_replyto">
    <!-- removed JSON payload: keep only the human-readable summary to avoid large payloads in FormSubmit -->
    <!-- Human-readable cart summary for email clarity -->
    <input type="hidden" name="cart_items_text" id="form_cart_items_text">
    </form>
    <div class="product-gallery-ui">
    <div class="gallery-header"></div>

    <div id="productGallery" class="product-gallery" aria-live="polite"></div>

    
    </div>

    <style>
    /* Galería: estilo azul, limpio y responsivo similar a Manchester City */
    /* Ocultar la UI de la galería cuando la sección pedidos no está activa */
    #pedidos:not(.activa) .product-gallery-ui { display: none; }
    /* Grid layout with named areas so header spans both columns and the product gallery
       always occupies the left column while the cart occupies the right column. This
       prevents automatic wrapping that placed the cart below the products. */
    #pedidos.activa .product-gallery-ui {
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        grid-template-areas: "header" "gallery";
        gap: 22px;
        align-items: start;
    }
    .gallery-header { grid-area: header; }
    .product-gallery { grid-area: gallery; }
    .cart-panel { grid-area: cart; }
        .gallery-header h2 { color: var(--azul-acento); font-size: 2rem; margin: 0 0 6px; }
        .gallery-header p { color: #cfdff6; margin: 0 0 16px; }
          /* Gallery: center items inside the left column by default.
              If there is only one product, align it to the left (start) so it appears at the very left edge. */
        .product-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 18px; width: 100%; }
          .product-gallery > .product-item:only-child { justify-self: start; max-width: 800px; }
    .product-item { background: rgba(255,255,255,0.03); border: 1px solid rgba(42,91,168,0.08); padding: 10px 12px; border-radius: 12px; text-align: center; transition: transform .12s, box-shadow .12s; max-width: 360px; box-sizing: border-box; cursor: pointer; align-items: stretch; display:flex; flex-direction:column; justify-content:space-between; overflow:hidden; }
        .product-item:hover { transform: translateY(-6px); box-shadow: 0 8px 30px rgba(42,91,168,0.12); }
    .product-item img { width: 100%; height: 160px; object-fit: cover; border-radius: 8px; }
        .product-item h4 { color: #fff; margin: 8px 0 6px; font-size: 1.04rem; }
        .product-item .price { color: #9fe0ff; font-weight: 900; margin: 6px 0; font-size:1.05rem; display:inline-block; background: rgba(15,56,100,0.12); padding:6px 10px; border-radius:8px; }
        .product-item .excerpt { color: #d6e9ff; font-size: 0.95rem; min-height: 0; margin-bottom:0; }
    .product-item .actions { display:flex; gap:8px; justify-content:center; margin-top:6px; }
        .btn-primary { background: linear-gradient(90deg,var(--azul-acento) 60%, #163a6b 100%); color: #fff; border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer; }
        .btn-secondary { background: transparent; color: #d6e9ff; border: 1px solid rgba(255,255,255,0.06); padding: 8px 12px; border-radius: 10px; cursor: pointer; }

          /* Keep the cart visually on the right side of the page at all times. Make it fixed so it doesn't move
              when the gallery grows. Add max-height/overflow to remain scrollable on small viewports. */
    .cart-panel { background: rgba(10,31,61,0.95); padding: 16px; border-radius: 14px; color: #e6f3ff; border: 1px solid rgba(46,123,237,0.12); position: relative; width: 100%; max-width: 420px; box-sizing: border-box; max-height: calc(100vh - 160px); overflow: auto; }
        .cart-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
        .cart-header h3 { margin:0; color:#fff; font-size:1.15rem; letter-spacing:0.4px; }
        .cart-count { background:linear-gradient(90deg,#2e7bed,#144a85); color:#fff; padding:6px 10px; border-radius:999px; font-weight:800; font-size:0.9rem; box-shadow:0 6px 18px rgba(46,123,237,0.18); }
        .cart-items { max-height: 420px; overflow:auto; margin-bottom:12px; }
        .cart-empty { text-align:center; color:#9fbfe8; padding:24px 8px; border-radius:10px; background:rgba(255,255,255,0.02); }
        .cart-item { display:flex; gap:12px; align-items:flex-start; padding:10px; border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); margin-bottom:10px; border:1px solid rgba(255,255,255,0.03); width:100%; box-sizing:border-box; }
        .cart-item img { width:64px; height:64px; object-fit:cover; border-radius:8px; box-shadow: 0 6px 18px rgba(0,0,0,0.35); }
        .cart-item .meta { flex:1; text-align:left; min-width:0; }
        .cart-item .meta b { display:block; color:#fff; font-size:0.98rem; margin-bottom:4px; white-space:normal; overflow-wrap:anywhere; word-break:break-word; }
        .cart-item .meta small { color:#bcd9ff; display:block; font-size:0.9rem; }
        .cart-item .meta .qty-row { margin-top:6px; display:flex; align-items:center; gap:8px; }
        .cart-item .meta .qty-row input { width:56px; padding:6px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:#fff; text-align:center; }
        .cart-item .remove { background:transparent; border:none; color:#ff8a8a; cursor:pointer; font-size:1.05rem; padding:6px; }
        /* Evitar desborde: limitar columna derecha y permitir envolver controles */
        .cart-item .meta + div { flex: 0 0 auto; max-width: 52%; }
        .cart-item .meta + div > div { flex-wrap: wrap; }
        .cart-divider { height:1px; background:linear-gradient(90deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01)); margin:10px 0; border-radius:2px; }
        .cart-totals { display:flex; flex-direction:column; gap:8px; padding:6px 2px; }
        .cart-totals .tot-row { display:flex; justify-content:space-between; color:#cfe8ff; font-weight:700; }
        .cart-totals .tot-row.total { font-size:1.16rem; color:#fff; font-weight:900; }
        .cart-actions { display:flex; gap:8px; margin-top:10px; }
        .cart-actions .btn-primary { flex:1; }
        .cart-actions .btn-secondary { background:transparent; border:1px solid rgba(255,255,255,0.04); padding:10px 12px; border-radius:10px; color:#d6e9ff; }
        .cart-note { font-size:0.85rem; color:#bcd9ff; margin-top:8px; }

        /* Banner promocional desplegable debajo del carrito */
        .cart-promo-banner {
            position: fixed; /* se alinea al carrito con getBoundingClientRect */
            left: 0; top: 0; /* actualizados dinámicamente */
            width: auto; /* ajustado al ancho del carrito */
            box-sizing: border-box;
            padding: 10px 14px;
            border-radius: 12px;
            color: #fff;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25), 0 1px 0 rgba(255,255,255,0.06) inset;
            opacity: 0;
            transform: translateY(-8px); /* aparece deslizándose hacia abajo desde el borde inferior del carrito */
            pointer-events: none; /* no obstruye interacciones */
            z-index: 1195; /* por debajo de modales y del carrito fijo (1200) */
            border: 1px solid rgba(255,255,255,0.12);
        }
        /* Animaciones (300-500ms) */
        .cart-promo-banner.fast { transition: opacity 0.3s ease, transform 0.3s ease; }
        .cart-promo-banner.subtle { transition: opacity 0.45s ease, transform 0.45s ease; }
        .cart-promo-banner.visible { opacity: 1; transform: translateY(0); }
        /* Temas de color */
        .cart-promo-banner.theme-3 { background: linear-gradient(180deg, #ff9800 0%, #ff7a00 100%); }
        .cart-promo-banner.theme-5 { background: linear-gradient(180deg, #2ecc71 0%, #27ae60 100%); }
        .cart-promo-banner .promo-inner { display:flex; align-items:center; justify-content:center; gap:10px; font-size:0.95rem; line-height:1; }
    .cart-promo-banner .promo-badge { display:inline-flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.16); padding: 6px 10px; border-radius: 999px; font-weight:900; letter-spacing:1px; text-transform:uppercase; color:#fff; font-size:0.95rem; }

        /* Keep cart on the right even on narrower viewports but reduce its width and ensure the gallery
           has right padding so content doesn't sit underneath the fixed cart. */
        @media (min-width: 1201px) {
            /* Desktop: single-column gallery; cart is not reserved here so products use full width */
            #pedidos.activa .product-gallery-ui { display: grid; grid-template-columns: 1fr; grid-template-rows: auto 1fr; grid-template-areas: "header" "gallery"; gap: 22px; }
            .gallery-header { grid-area: header; }
            .product-gallery { grid-area: gallery; }
            /* Keep four product columns, now spanning the full available width */
            .product-gallery { display: grid; grid-template-columns: repeat(4, 1fr); gap: 18px; padding-right: 0; width: 100%; }
            /* Scale product cards proportionally on desktop for the wider area */
            #pedidos .product-item { max-width: none; }
            #pedidos .product-item img { height: clamp(160px, 14vw, 240px); }
            /* Each competition's products grid shows 3 products per row */
            .competition-products { grid-template-columns: repeat(3, 1fr); }
            /* Cart panel no longer participates in this grid on desktop; increase max width for better UX in its dedicated view */
            .cart-panel { position: relative; right: 0; top: 0; width: 100%; max-width: 560px; align-self: start; transform: none; margin-top: 36px; }
            /* Header/controls align to the 4th product column because they share the same grid column */
            #pedidos.activa .product-gallery { padding-right: 0; }
        }
        @media (max-width: 1200px) {
            .product-gallery-ui { padding-right: 0; }
            .cart-panel { position: relative; width: 100%; right: 0; top: 0; z-index: auto; }
        }
    /* Small helper for the checkout modal inputs */
    .checkout-input { 
        width:100%;
        padding:12px 16px;
        border-radius:10px;
        border:2px solid rgba(255,255,255,0.15);
        background:rgba(255,255,255,0.08);
        color:#fff;
        margin-bottom:12px;
        font-size:14px;
        transition:all 0.3s ease;
        backdrop-filter:blur(10px);
    }
    
    .checkout-input:focus {
        outline:none;
        border-color:rgba(99, 102, 241, 0.6);
        background:rgba(255,255,255,0.12);
        box-shadow:0 0 0 3px rgba(99, 102, 241, 0.2);
        transform:translateY(-1px);
    }
    
    .checkout-input::placeholder {
        color:rgba(255,255,255,0.6);
        font-weight:400;
    }
    
    .checkout-input:hover {
        border-color:rgba(255,255,255,0.25);
        background:rgba(255,255,255,0.1);
    }
    /* Ajustes para que la tarjeta se adapte a la imagen 800x800 */
    .product-item, .pedido-mini-card { display:flex; flex-direction:column; align-items:center; }
    .product-item > img, .pedido-mini-card img.pedido-carrusel-img { max-width:800px; width:100%; height:140px; object-fit:cover; border-radius:8px; }
    .pedido-mini-card { padding:4px; cursor: pointer; }
    .pedido-mini-card .thumb-img { display:none; }
    
    /* Estilos para las secciones de competición */
    .gallery-controls {
        margin-top: 10px;
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(5,25,55,0.6);
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        width: 100%;
        box-sizing: border-box;
    }
    
    .gallery-controls .league-filter,
    .gallery-controls .sort-order {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .gallery-controls select {
        padding: 8px 12px;
        border-radius: 6px;
        background: #071735;
        color: white;
        border: 1px solid #2e7bed;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 180px;
    }
    
    .gallery-controls select:hover {
        border-color: var(--azul-acento);
        box-shadow: 0 0 8px rgba(46,123,237,0.5);
    }
    
    .gallery-controls label {
        color: #9fe0ff;
        font-weight: 500;
        white-space: nowrap;
    }
    
    @media (max-width: 768px) {
        .gallery-controls {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .gallery-controls .league-filter,
        .gallery-controls .sort-order {
            width: 100%;
        }
        
        .gallery-controls select {
            width: 100%;
        }
    }
    </style>

    <style>
    /* MOBILE: mejoras específicas solo para la sección 'pedidos' (tienda)
       - layout de una columna para la galería
       - tarjetas más grandes y separadas para toque cómodo
       - carrito actúa como bottom-sheet colapsable para no tapar contenido
       Estos estilos solo afectan a #pedidos y no tocan otras secciones. */
    @media (max-width: 900px) {
        /* Rejilla de la UI: header + galería + carrito (pila vertical) */
        #pedidos.activa .product-gallery-ui {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr auto;
            grid-template-areas: "header" "gallery" "cart";
            gap: 14px;
            padding-right: 0;
        }

        /* Galería: 2 columnas táctiles por fila, imágenes más altas */
        #pedidos .product-gallery { grid-template-columns: repeat(2, minmax(140px, 1fr)); gap: 12px; }
        #pedidos .product-item { padding: 12px; border-radius: 12px; max-width: none; }
        #pedidos .product-item img { height: 180px; object-fit: cover; border-radius: 8px; }

        /* Espaciado en header/controles */
        #pedidos .gallery-header, #pedidos .gallery-controls { padding: 8px 6px; }

        /* Carrito: bottom sheet fijo, ancho completo con márgenes, altura limitada y scroll interno */
        #pedidos .cart-panel {
            position: fixed !important;
            left: 12px !important;
            right: 12px !important;
            bottom: 12px !important;
            top: auto !important;
            width: auto !important;
            max-width: none !important;
            max-height: 62vh !important;
            overflow: auto !important;
            border-radius: 12px !important;
            box-shadow: 0 12px 40px rgba(0,0,0,0.45) !important;
            transition: transform 0.22s ease, visibility 0.22s ease;
            z-index: 3001 !important;
            margin-top: 0 !important;
        }

        /* Estado colapsado: solo se deja visible la cabecera (aprox 64px) */
        #pedidos .cart-panel.collapsed { transform: translateY(calc(100% - 64px)); }

        /* Cabecera del carrito táctil */
        #pedidos .cart-header { cursor: pointer; padding: 12px 10px; }

        /* Botones grandes y full-width dentro del carrito */
        #pedidos .cart-actions { display:flex; gap:8px; }
        #pedidos .cart-actions .btn-primary, #pedidos .cart-actions .btn-secondary { padding: 12px; font-size: 1rem; border-radius: 10px; }

        /* Ajustes de elementos del carrito para facilitar la lectura */
        #pedidos .cart-item { padding:10px; gap:10px; }
        #pedidos .cart-item img { width:56px; height:56px; }
        #pedidos .cart-items { max-height: calc(62vh - 180px); overflow:auto; }

        /* Aumentar zona de pulsación en filtros/inputs */
        #pedidos .gallery-controls select, #pedidos .product-search-wrap input { padding: 12px 10px; font-size: 1rem; }
    }
    </style>

    <script>
        // Datos de ejemplos tomados de la carpeta assets/productos
        const PRODUCTS = [
    { id: 'barca1', name: 'Camiseta Local Barcelona 25/26', price: 19.90, img: 'assets/productos/La Liga/Barcelona2526L/1.jpg', images: [
        'assets/productos/La Liga/Barcelona2526L/1.jpg',
        'assets/productos/La Liga/Barcelona2526L/2.jpg',
        'assets/productos/La Liga/Barcelona2526L/3.jpg',
        'assets/productos/La Liga/Barcelona2526L/4.jpg',
        'assets/productos/La Liga/Barcelona2526L/5.jpg'
    ], excerpt: '', link: 'productos/barcelona2526L.html' },

    { id: 'realm1', name: 'Camiseta Local Real Madrid 25/26', price: 19.90, img: 'assets/productos/La Liga/RealMadrid2526L/1.jpg', images: [
        'assets/productos/La Liga/RealMadrid2526L/1.jpg',
        'assets/productos/La Liga/RealMadrid2526L/2.jpg',
        'assets/productos/La Liga/RealMadrid2526L/3.jpg',
        'assets/productos/La Liga/RealMadrid2526L/4.jpg'
    ], excerpt: '', link: 'productos/realmadrid2526L.html' },

    { id: 'athl1', name: 'Camiseta Local Athletic Club 25/26', price: 19.90, img: 'assets/productos/La Liga/Athletic2526L/1.jpg', images: [
        'assets/productos/La Liga/Athletic2526L/1.jpg',
        'assets/productos/La Liga/Athletic2526L/2.jpg',
        'assets/productos/La Liga/Athletic2526L/3.jpg',
        'assets/productos/La Liga/Athletic2526L/4.jpg'
    ], excerpt: '', link: 'productos/athletic2526L.html' },

    { id: 'atletico0203', name: 'Camiseta Retro Atlético 02/03', price: 24.90, img: 'assets/productos/La Liga/Atletico0203LR/1.jpg', images: [
        'assets/productos/La Liga/Atletico0203LR/1.jpg',
        'assets/productos/La Liga/Atletico0203LR/2.jpg',
        'assets/productos/La Liga/Atletico0203LR/3.jpg'
    ], excerpt: '', link: 'productos/atletico0203.html', versions: ['fan'], isRetro: true },

    { id: 'athl0103F', name: 'Camiseta Retro Athletic 01/03 Visitante', price: 24.90, img: 'assets/productos/La Liga/Athletic0103FR/1.jpg', images: [
        'assets/productos/La Liga/Athletic0103FR/1.jpg',
        'assets/productos/La Liga/Athletic0103FR/2.jpg',
        'assets/productos/La Liga/Athletic0103FR/3.jpg',
        'assets/productos/La Liga/Athletic0103FR/4.jpg'
    ], excerpt: '', link: 'productos/athletic0103FR.html', versions: ['fan'], isRetro: true },

    { id: 'atleticoL', name: 'Camiseta Local Atlético 25/26', price: 19.90, img: 'assets/productos/La Liga/Atletico2526L/1.jpg', images: [
        'assets/productos/La Liga/Atletico2526L/1.jpg',
        'assets/productos/La Liga/Atletico2526L/2.jpg',
        'assets/productos/La Liga/Atletico2526L/3.jpg',
        'assets/productos/La Liga/Atletico2526L/4.jpg'
    ], excerpt: '', link: 'productos/atletico2526L.html' },

    { id: 'atleticoF2', name: 'Camiseta Visitante Atlético 25/26', price: 19.90, img: 'assets/productos/La Liga/Atletico2526F/1.jpg', images: [
        'assets/productos/La Liga/Atletico2526F/1.jpg',
        'assets/productos/La Liga/Atletico2526F/2.jpg',
        'assets/productos/La Liga/Atletico2526F/3.jpg',
        'assets/productos/La Liga/Atletico2526F/4.jpg'
    ], excerpt: '', link: 'productos/atletico2526F.html' },

    { id: 'betisL', name: 'Camiseta Local Betis 25/26', price: 19.90, img: 'assets/productos/La Liga/Betis2526L/1.jpg', images: [
        'assets/productos/La Liga/Betis2526L/1.jpg',
        'assets/productos/La Liga/Betis2526L/2.jpg',
        'assets/productos/La Liga/Betis2526L/3.jpg',
        'assets/productos/La Liga/Betis2526L/4.jpg'
    ], excerpt: '', link: 'productos/betis2526L.html' },
    { id: 'Barcelona2526F', name: 'Camiseta Visitante Barcelona 25/26', price: 19.90, img: 'assets/productos/La Liga/Barcelona2526F/1.jpg', images: [
        'assets/productos/La Liga/Barcelona2526F/1.jpg',
        'assets/productos/La Liga/Barcelona2526F/2.jpg',
        'assets/productos/La Liga/Barcelona2526F/3.jpg',
        'assets/productos/La Liga/Barcelona2526F/4.jpg'
    ], excerpt: '', link: 'productos/Barcelona2526F.html' },

    { id: 'celtaL', name: 'Camiseta Local Celta 25/26', price: 19.90, img: 'assets/productos/La Liga/Celta2526L/1.jpg', images: [
        'assets/productos/La Liga/Celta2526L/1.jpg',
        'assets/productos/La Liga/Celta2526L/2.jpg',
        'assets/productos/La Liga/Celta2526L/3.jpg',
        'assets/productos/La Liga/Celta2526L/4.jpg'
    ], excerpt: '', link: 'productos/celta2526L.html' },

    { id: 'elcheF', name: 'Camiseta Visitante Elche 25/26', price: 19.90, img: 'assets/productos/La Liga/Elche2526F/1.jpg', images: [
        'assets/productos/La Liga/Elche2526F/1.jpg',
        'assets/productos/La Liga/Elche2526F/2.jpg',
        'assets/productos/La Liga/Elche2526F/3.jpg',
        'assets/productos/La Liga/Elche2526F/4.jpg'
    ], excerpt: '', link: 'productos/Elche2526F.html' },

    { id: 'elcheL', name: 'Camiseta Local Elche 25/26', price: 19.90, img: 'assets/productos/La Liga/Elche2526L/1.jpeg', images: [
        'assets/productos/La Liga/Elche2526L/1.jpeg',
        'assets/productos/La Liga/Elche2526L/2.jpeg',
        'assets/productos/La Liga/Elche2526L/3.jpeg'
    ], excerpt: '', link: 'productos/Elche2526L.html' },

    { id: 'espanyolLR', name: 'Camiseta Retro Espanyol 99/00 Local', price: 24.90, img: 'assets/productos/La Liga/Espanyol9920LR/1.jpg', images: [
        'assets/productos/La Liga/Espanyol9920LR/1.jpg',
        'assets/productos/La Liga/Espanyol9920LR/2.jpg',
        'assets/productos/La Liga/Espanyol9920LR/3.jpg',
        'assets/productos/La Liga/Espanyol9920LR/4.jpg'
    ], excerpt: '', link: 'productos/espanyol9920LR.html', versions: ['fan'], isRetro: true },

    { id: 'getafeL', name: 'Camiseta Local Getafe 25/26', price: 19.90, img: 'assets/productos/La Liga/Getafe2526L/1.png', images: [
        'assets/productos/La Liga/Getafe2526L/1.png',
        'assets/productos/La Liga/Getafe2526L/2.png'
    ], excerpt: '', link: 'productos/getafe2526L.html' },

    { id: 'gironaL', name: 'Camiseta Local Girona 25/26', price: 19.90, img: 'assets/productos/La Liga/Girona2526L/1.jpg', images: [
        'assets/productos/La Liga/Girona2526L/1.jpg',
        'assets/productos/La Liga/Girona2526L/2.jpg',
        'assets/productos/La Liga/Girona2526L/3.jpg',
        'assets/productos/La Liga/Girona2526L/4.jpg'
    ], excerpt: '', link: 'productos/girona2526L.html' },

    { id: 'granadaL', name: 'Camiseta Local Granada 25/26', price: 19.90, img: 'assets/productos/La Liga/Granada2526L/1.jpg', images: [
        'assets/productos/La Liga/Granada2526L/1.jpg',
        'assets/productos/La Liga/Granada2526L/2.jpg',
        'assets/productos/La Liga/Granada2526L/3.jpg',
        'assets/productos/La Liga/Granada2526L/4.jpg'
    ], excerpt: '', link: 'productos/granada2526L.html' },

    { id: 'laspalmasL', name: 'Camiseta Local Las Palmas 25/26', price: 19.90, img: 'assets/productos/La Liga/LasPalmas2526L/1.jpg', images: [
        'assets/productos/La Liga/LasPalmas2526L/1.jpg',
        'assets/productos/La Liga/LasPalmas2526L/2.jpg',
        'assets/productos/La Liga/LasPalmas2526L/3.jpg',
        'assets/productos/La Liga/LasPalmas2526L/4.jpg'
    ], excerpt: '', link: 'productos/laspalmas2526L.html' },

    { id: 'leganesL', name: 'Camiseta Local Leganés 25/26', price: 19.90, img: 'assets/productos/La Liga/Leganes2526L/1.jpg', images: [
        'assets/productos/La Liga/Leganes2526L/1.jpg',
        'assets/productos/La Liga/Leganes2526L/2.jpg',
        'assets/productos/La Liga/Leganes2526L/3.jpg',
        'assets/productos/La Liga/Leganes2526L/4.jpg'
    ], excerpt: '', link: 'productos/leganes2526L.html' },

    { id: 'levanteL', name: 'Camiseta Local Levante 25/26', price: 19.90, img: 'assets/productos/La Liga/Levante2526L/1.jpeg', images: [
        'assets/productos/La Liga/Levante2526L/1.jpeg',
        'assets/productos/La Liga/Levante2526L/2.jpeg',
        'assets/productos/La Liga/Levante2526L/3.jpeg',
        'assets/productos/La Liga/Levante2526L/4.jpeg'
    ], excerpt: '', link: 'productos/levante2526L.html' },

    { id: 'malagaL', name: 'Camiseta Local Málaga 25/26', price: 19.90, img: 'assets/productos/La Liga/Malaga2526L/1.jpg', images: [
        'assets/productos/La Liga/Malaga2526L/1.jpg',
        'assets/productos/La Liga/Malaga2526L/2.jpg',
        'assets/productos/La Liga/Malaga2526L/3.jpg',
        'assets/productos/La Liga/Malaga2526L/4.jpg'
    ], excerpt: '', link: 'productos/malaga2526L.html' },

    { id: 'mallorcaL', name: 'Camiseta Local Mallorca 25/26', price: 19.90, img: 'assets/productos/La Liga/Mallorca2526L/1.jpg', images: [
        'assets/productos/La Liga/Mallorca2526L/1.jpg',
        'assets/productos/La Liga/Mallorca2526L/2.jpg',
        'assets/productos/La Liga/Mallorca2526L/3.jpg',
        'assets/productos/La Liga/Mallorca2526L/4.jpg'
    ], excerpt: '', link: 'productos/mallorca2526L.html' },

    { id: 'osasunaL', name: 'Camiseta Local Osasuna 25/26', price: 19.90, img: 'assets/productos/La Liga/Osasuna2526L/1.png', images: [
        'assets/productos/La Liga/Osasuna2526L/1.png',
        'assets/productos/La Liga/Osasuna2526L/2.png'
    ], excerpt: '', link: 'productos/osasuna2526L.html' },

    { id: 'oviedoL', name: 'Camiseta Local Oviedo 25/26', price: 19.90, img: 'assets/productos/La Liga/Oviedo2526L/1.jpg', images: [
        'assets/productos/La Liga/Oviedo2526L/1.jpg',
        'assets/productos/La Liga/Oviedo2526L/2.jpg',
        'assets/productos/La Liga/Oviedo2526L/3.jpg',
        'assets/productos/La Liga/Oviedo2526L/4.jpg'
    ], excerpt: '', link: 'productos/oviedo2526L.html' },

    { id: 'rayoL', name: 'Camiseta Local Rayo Vallecano 25/26', price: 19.90, img: 'assets/productos/La Liga/Rayo2526L/1.jpg', images: [
        'assets/productos/La Liga/Rayo2526L/1.jpg',
        'assets/productos/La Liga/Rayo2526L/2.jpg'
    ], excerpt: '', link: 'productos/rayo2526L.html' },

    { id: 'realmF', name: 'Camiseta Visitante Real Madrid 25/26', price: 19.90, img: 'assets/productos/La Liga/RealMadrid2526F/1.jpg', images: [
        'assets/productos/La Liga/RealMadrid2526F/1.jpg',
        'assets/productos/La Liga/RealMadrid2526F/2.jpg',
        'assets/productos/La Liga/RealMadrid2526F/3.jpg',
        'assets/productos/La Liga/RealMadrid2526F/4.jpg'
    ], excerpt: '', link: 'productos/realmadrid2526F.html' },

    { id: 'realmT', name: 'Camiseta Tercera Real Madrid 25/26', price: 19.90, img: 'assets/productos/La Liga/RealMadrid2526T/1.jpg', images: [
        'assets/productos/La Liga/RealMadrid2526T/1.jpg',
        'assets/productos/La Liga/RealMadrid2526T/2.jpg',
        'assets/productos/La Liga/RealMadrid2526T/3.jpg',
        'assets/productos/La Liga/RealMadrid2526T/4.jpg'
    ], excerpt: '', link: 'productos/realmadrid2526T.html' },

    { id: 'realsociedadL', name: 'Camiseta Local Real Sociedad 25/26', price: 19.90, img: 'assets/productos/La Liga/RealSociedad2526L/1.jpg', images: [
        'assets/productos/La Liga/RealSociedad2526L/1.jpg',
        'assets/productos/La Liga/RealSociedad2526L/2.jpg',
        'assets/productos/La Liga/RealSociedad2526L/3.jpg',
        'assets/productos/La Liga/RealSociedad2526L/4.jpg'
    ], excerpt: '', link: 'productos/realsociedad2526L.html' },

    { id: 'sevillaF', name: 'Camiseta Visitante Sevilla 25/26', price: 19.90, img: 'assets/productos/La Liga/Sevilla2526F/1.jpg', images: [
        'assets/productos/La Liga/Sevilla2526F/1.jpg',
        'assets/productos/La Liga/Sevilla2526F/2.jpg',
        'assets/productos/La Liga/Sevilla2526F/3.jpg',
        'assets/productos/La Liga/Sevilla2526F/4.jpg'
    ], excerpt: '', link: 'productos/sevilla2526F.html' },

    { id: 'sevillaT', name: 'Camiseta Tercera Sevilla 25/26', price: 19.90, img: 'assets/productos/La Liga/Sevilla2526T/1.jpg', images: [
        'assets/productos/La Liga/Sevilla2526T/1.jpg',
        'assets/productos/La Liga/Sevilla2526T/2.jpg',
        'assets/productos/La Liga/Sevilla2526T/3.jpg',
        'assets/productos/La Liga/Sevilla2526T/4.jpg'
    ], excerpt: '', link: 'productos/sevilla2526T.html' },

    { id: 'valenciaL', name: 'Camiseta Local Valencia 25/26', price: 19.90, img: 'assets/productos/La Liga/Valencia2526L/1.jpg', images: [
        'assets/productos/La Liga/Valencia2526L/1.jpg',
        'assets/productos/La Liga/Valencia2526L/2.jpg',
        'assets/productos/La Liga/Valencia2526L/3.jpg',
        'assets/productos/La Liga/Valencia2526L/4.jpg'
    ], excerpt: '', link: 'productos/valencia2526L.html' },

    { id: 'valladolidL', name: 'Camiseta Local Valladolid 25/26', price: 19.90, img: 'assets/productos/La Liga/Valladolid2526L/1.jpg', images: [
        'assets/productos/La Liga/Valladolid2526L/1.jpg',
        'assets/productos/La Liga/Valladolid2526L/2.jpg',
        'assets/productos/La Liga/Valladolid2526L/3.jpg',
        'assets/productos/La Liga/Valladolid2526L/4.jpg'
    ], excerpt: '', link: 'productos/valladolid2526L.html' },
    
    { id: 'alavesL', name: 'Camiseta Local Alavés 25/26', price: 19.90, img: 'assets/productos/La Liga/Alaves2526L/1.jpg', images: [
        'assets/productos/La Liga/Alaves2526L/1.jpg',
        'assets/productos/La Liga/Alaves2526L/2.jpg',
    ], excerpt: '', link: 'productos/alaves2526L.html' },

    { id: 'villarrealL', name: 'Camiseta Local Villarreal 25/26', price: 19.90, img: 'assets/productos/La Liga/Villarreal2526L/1.jpg', images: [
        'assets/productos/La Liga/Villarreal2526L/1.jpg',
        'assets/productos/La Liga/Villarreal2526L/2.jpg',
        'assets/productos/La Liga/Villarreal2526L/3.jpg',
        'assets/productos/La Liga/Villarreal2526L/4.jpg'
    ], excerpt: '', link: 'productos/villarreal2526L.html' },
    { id: 'munich2526L', name: 'Camiseta Local Bayern Munich 25/26', price: 19.90, img: 'assets/productos/Bundesliga/Munich2526L/1.jpg', images: [
        'assets/productos/Bundesliga/Munich2526L/1.jpg',
        'assets/productos/Bundesliga/Munich2526L/2.jpg',
        'assets/productos/Bundesliga/Munich2526L/3.jpg',
        'assets/productos/Bundesliga/Munich2526L/4.jpg'
    ], excerpt: '', link: 'productos/munich2526L.html' },
    { id: 'Paris2526L', name: 'Camiseta Local PSG 25/26', price: 19.90, img: 'assets/productos/Ligue 1/PSG2526L/1.jpg', images: [
        'assets/productos/Ligue 1/PSG2526L/1.jpg',
        'assets/productos/Ligue 1/PSG2526L/2.jpg',
        'assets/productos/Ligue 1/PSG2526L/3.jpg',
        'assets/productos/Ligue 1/PSG2526L/4.jpg'
    ], excerpt: '', link: 'productos/Paris2526L.html' },
    { id: 'CrystalPalace2526L', name: 'Camiseta Local Crystal Palace 25/26', price: 19.90, img: 'assets/productos/Premier League/CrystalPalace2526L/1.jpg', images: [
        'assets/productos/Premier League/CrystalPalace2526L/1.jpg',
        'assets/productos/Premier League/CrystalPalace2526L/2.jpg',
        'assets/productos/Premier League/CrystalPalace2526L/3.jpg',
        'assets/productos/Premier League/CrystalPalace2526L/4.jpg'
    ], excerpt: '', link: 'productos/CrystalPalace2526L.html' },
    { id: 'Milan9798LR', name: 'Camiseta Retro Milan 97/98 Local', price: 24.90, img: 'assets/productos/Serie A/Milan9798LR/1.jpg', images: [
        'assets/productos/Serie A/Milan9798LR/1.jpg',
        'assets/productos/Serie A/Milan9798LR/2.jpg',
        'assets/productos/Serie A/Milan9798LR/3.jpg',
        'assets/productos/Serie A/Milan9798LR/4.jpg'
    ], excerpt: '', link: 'productos/Milan9798LR.html', versions: ['fan'], isRetro: true },

    { id: 'atleticoKids2526F', name: 'Camiseta Visitante Atlético 25/26 (niños)', price: 21.90, img: 'assets/productos/La Liga/AtleticoKids2526F/1.jpg', images: [
        'assets/productos/La Liga/AtleticoKids2526F/1.jpg',
        'assets/productos/La Liga/AtleticoKids2526F/2.jpg',
        'assets/productos/La Liga/AtleticoKids2526F/3.jpg',
        'assets/productos/La Liga/AtleticoKids2526F/4.jpg'
    ], excerpt: '', link: 'productos/AtleticoKids2526F.html' },

    { id: 'athleticKids2526T', name: 'Camiseta Tercera Athletic Club 25/26 (niños)', price: 21.90, img: 'assets/productos/La Liga/AthelticKids2526T/1.jpg', images: [
        'assets/productos/La Liga/AthelticKids2526T/1.jpg',
        'assets/productos/La Liga/AthelticKids2526T/2.jpg',
        'assets/productos/La Liga/AthelticKids2526T/3.jpg'
    ], excerpt: '', link: 'productos/AthleticKids2526T.html' },

    { id: 'marseillaKids2526F', name: 'Camiseta Visitante Marsella 25/26 (niños)', price: 21.90, img: 'assets/productos/Ligue 1/MarseillaKids2526F/1.jpg', images: [
        'assets/productos/Ligue 1/MarseillaKids2526F/1.jpg',
        'assets/productos/Ligue 1/MarseillaKids2526F/2.jpg',
        'assets/productos/Ligue 1/MarseillaKids2526F/3.jpg',
        'assets/productos/Ligue 1/MarseillaKids2526F/4.jpg'
    ], excerpt: '', link: 'productos/MarseillaKids2526F.html' },

    { id: 'unitedKids2526F', name: 'Camiseta Visitante Manchester United 25/26 (niños)', price: 21.90, img: 'assets/productos/Premier League/UnitedKids2526F/1.jpg', images: [
        'assets/productos/Premier League/UnitedKids2526F/1.jpg',
        'assets/productos/Premier League/UnitedKids2526F/2.jpg',
        'assets/productos/Premier League/UnitedKids2526F/3.jpg',
        'assets/productos/Premier League/UnitedKids2526F/4.jpg'
    ], excerpt: '', link: 'productos/UnitedKids2526F.html' },

    { id: 'nbaLakers1', name: 'Camiseta NBA Lakers (Modelo 1)', price: 24.90, img: 'assets/productos/NBA/Lakers1/1.jpeg', images: [
        'assets/productos/NBA/Lakers1/1.jpeg',
        'assets/productos/NBA/Lakers1/2.jpeg'
    ], excerpt: '', link: 'productos/Lakers1.html' },

    { id: 'nbaOklahoma1', name: 'Camiseta NBA Oklahoma (Modelo 1)', price: 24.90, img: 'assets/productos/NBA/Oklahoma/1.jpeg', images: [
        'assets/productos/NBA/Oklahoma/1.jpeg',
        'assets/productos/NBA/Oklahoma/2.jpeg'
    ], excerpt: '', link: 'productos/Oklahoma.html' },

    { id: 'nbaPhila1', name: 'Camiseta NBA Philadelphia (Modelo 1)', price: 24.90, img: 'assets/productos/NBA/Phila1/1.jpeg', images: [
        'assets/productos/NBA/Phila1/1.jpeg',
        'assets/productos/NBA/Phila1/2.jpeg',
        'assets/productos/NBA/Phila1/3.jpeg'
    ], excerpt: '', link: 'productos/Phila1.html' },

    { id: 'Barcelona2526T', name: 'Camiseta Tercera Barcelona 25/26', price: 19.90, img: 'assets/productos/La Liga/Barcelona2526T/1.jpg', images: [
        'assets/productos/La Liga/Barcelona2526T/1.jpg',
        'assets/productos/La Liga/Barcelona2526T/2.jpg',
        'assets/productos/La Liga/Barcelona2526T/3.jpg',
        'assets/productos/La Liga/Barcelona2526T/4.jpg'
    ], excerpt: '', link: 'productos/Barcelona2526T.html' },

    { id: 'LasPalmas2526F', name: 'Camiseta Visitante Las Palmas 25/26', price: 19.90, img: 'assets/productos/La Liga/LasPalmas2526F/1.jpg', images: [
        'assets/productos/La Liga/LasPalmas2526F/1.jpg',
        'assets/productos/La Liga/LasPalmas2526F/2.jpg',
        'assets/productos/La Liga/LasPalmas2526F/3.jpg',
        'assets/productos/La Liga/LasPalmas2526F/4.jpg'
    ], excerpt: '', link: 'productos/LasPalmas2526F.html' },

    { id: 'Atletico9596TR', name: 'Camiseta Retro Atlético 95/96 Tercera', price: 24.90, img: 'assets/productos/La Liga/Atletico9596TR/1.jpg', images: [
        'assets/productos/La Liga/Atletico9596TR/1.jpg',
        'assets/productos/La Liga/Atletico9596TR/2.jpg',
        'assets/productos/La Liga/Atletico9596TR/3.jpg',
        'assets/productos/La Liga/Atletico9596TR/4.jpg'
    ], excerpt: '', link: 'productos/atletico9596TR.html', versions: ['fan'], isRetro: true },

    { id: 'Barcelona9697LR', name: 'Camiseta Retro Barcelona 96/97 Local', price: 24.90, img: 'assets/productos/La Liga/Barcelona9697LR/1.jpg', images: [
        'assets/productos/La Liga/Barcelona9697LR/1.jpg',
        'assets/productos/La Liga/Barcelona9697LR/2.jpg',
        'assets/productos/La Liga/Barcelona9697LR/3.jpg',
        'assets/productos/La Liga/Barcelona9697LR/4.jpg'
    ], excerpt: '', link: 'productos/barcelona9697LR.html', versions: ['fan'], isRetro: true },

    { id: 'Sevilla2526L', name: 'Camiseta Local Sevilla 25/26', price: 19.90, img: 'assets/productos/La Liga/Sevilla2526L/1.jpg', images: [
        'assets/productos/La Liga/Sevilla2526L/1.jpg',
        'assets/productos/La Liga/Sevilla2526L/2.jpg',
        'assets/productos/La Liga/Sevilla2526L/3.jpg',
        'assets/productos/La Liga/Sevilla2526L/4.jpg'
    ], excerpt: '', link: 'productos/Sevilla2526L.html' },

    { id: 'Schalke2526L', name: 'Camiseta Local Schalke 25/26', price: 19.90, img: 'assets/productos/Bundesliga/Schalke2526L/1.jpg', images: [
        'assets/productos/Bundesliga/Schalke2526L/1.jpg',
        'assets/productos/Bundesliga/Schalke2526L/2.jpg',
        'assets/productos/Bundesliga/Schalke2526L/3.jpg',
        'assets/productos/Bundesliga/Schalke2526L/4.jpg'
    ], excerpt: '', link: 'productos/Schalke2526L.html' },

    { id: 'Flamengo2526T', name: 'Camiseta Tercera Flamengo 25/26', price: 19.90, img: 'assets/productos/Brasileirão Série A/Flamengo2526T/1.jpg', images: [
        'assets/productos/Brasileirão Série A/Flamengo2526T/1.jpg',
        'assets/productos/Brasileirão Série A/Flamengo2526T/2.jpg',
        'assets/productos/Brasileirão Série A/Flamengo2526T/3.jpg',
        'assets/productos/Brasileirão Série A/Flamengo2526T/4.jpg'
    ], excerpt: '', link: 'productos/Flamengo2526T.html' },

    { id: 'AlNassr2526L', name: 'Camiseta Local Al-Nassr 25/26', price: 19.90, img: 'assets/productos/Liga Arabe/Al-Nassr2526L/1.jpg', images: [
        'assets/productos/Liga Arabe/Al-Nassr2526L/1.jpg',
        'assets/productos/Liga Arabe/Al-Nassr2526L/2.jpg',
        'assets/productos/Liga Arabe/Al-Nassr2526L/3.jpg',
        'assets/productos/Liga Arabe/Al-Nassr2526L/4.jpg'
    ], excerpt: '', link: 'productos/AlNassr2526L.html' },

    { id: 'Boca0102LR', name: 'Camiseta Retro Boca Juniors 01/02 Local', price: 24.90, img: 'assets/productos/SAF (Argentina)/Boca0102LR/1.jpeg', images: [
        'assets/productos/SAF (Argentina)/Boca0102LR/1.jpeg',
        'assets/productos/SAF (Argentina)/Boca0102LR/2.jpeg',
        'assets/productos/SAF (Argentina)/Boca0102LR/3.jpeg'
    ], excerpt: '', link: 'productos/Boca0102LR.html', versions: ['fan'], isRetro: true },

    { id: 'Monaco2526F', name: 'Camiseta Visitante Monaco 25/26', price: 19.90, img: 'assets/productos/Ligue 1/Monaco2526F/1.jpg', images: [
        'assets/productos/Ligue 1/Monaco2526F/1.jpg',
        'assets/productos/Ligue 1/Monaco2526F/2.jpg',
        'assets/productos/Ligue 1/Monaco2526F/3.jpg',
        'assets/productos/Ligue 1/Monaco2526F/4.jpg'
    ], excerpt: '', link: 'productos/Monaco2526F.html' },

    { id: 'Lazio2526F', name: 'Camiseta Visitante Lazio 25/26', price: 19.90, img: 'assets/productos/Serie A/Lazio2526F/1.jpg', images: [
        'assets/productos/Serie A/Lazio2526F/1.jpg',
        'assets/productos/Serie A/Lazio2526F/2.jpg',
        'assets/productos/Serie A/Lazio2526F/3.jpg',
        'assets/productos/Serie A/Lazio2526F/4.jpg'
    ], excerpt: '', link: 'productos/Lazio2526F.html' },

    { id: 'RomaKids2526L', name: 'Camiseta Local Roma 25/26 (niños)', price: 21.90, img: 'assets/productos/Serie A/RomaKids2526L/1.jpg', images: [
        'assets/productos/Serie A/RomaKids2526L/1.jpg',
        'assets/productos/Serie A/RomaKids2526L/2.jpg',
        'assets/productos/Serie A/RomaKids2526L/3.jpg'
    ], excerpt: '', link: 'productos/RomaKids2526L.html' },

    { id: 'Espana0809LR', name: 'Camiseta Retro España 08/09 Local', price: 24.90, img: 'assets/productos/Internacional/España0809LR/1.jpeg', images: [
        'assets/productos/Internacional/España0809LR/1.jpeg',
        'assets/productos/Internacional/España0809LR/2.jpeg',
        'assets/productos/Internacional/España0809LR/3.jpeg',
        'assets/productos/Internacional/España0809LR/4.jpeg'
    ], excerpt: '', link: 'productos/Espana0809LR.html', versions: ['fan'], isRetro: true },

    { id: 'Espana2425L', name: 'Camiseta Local España 24/25', price: 19.90, img: 'assets/productos/Internacional/España2425L/1.jpg', images: [
        'assets/productos/Internacional/España2425L/1.jpg',
        'assets/productos/Internacional/España2425L/2.jpg',
        'assets/productos/Internacional/España2425L/3.jpg',
        'assets/productos/Internacional/España2425L/4.jpg'
    ], excerpt: '', link: 'productos/Espana2425L.html' },

    { id: 'Francia9899LR', name: 'Camiseta Retro Francia 98/99 Local', price: 24.90, img: 'assets/productos/Internacional/Francia9899LR/1.jpg', images: [
        'assets/productos/Internacional/Francia9899LR/1.jpg',
        'assets/productos/Internacional/Francia9899LR/2.jpg',
        'assets/productos/Internacional/Francia9899LR/3.jpg',
        'assets/productos/Internacional/Francia9899LR/4.jpg'
    ], excerpt: '', link: 'productos/Francia9899LR.html', versions: ['fan'], isRetro: true },

    { id: 'Holanda9899LR', name: 'Camiseta Retro Holanda 98/99 Local', price: 24.90, img: 'assets/productos/Internacional/Holanda9899LR/1.jpg', images: [
        'assets/productos/Internacional/Holanda9899LR/1.jpg',
        'assets/productos/Internacional/Holanda9899LR/2.jpg',
        'assets/productos/Internacional/Holanda9899LR/3.jpg'
    ], excerpt: '', link: 'productos/Holanda9899LR.html', versions: ['fan'], isRetro: true },

    { id: 'PSG2526T', name: 'Camiseta Tercera PSG 25/26', price: 19.90, img: 'assets/productos/Ligue 1/PSG2526T/1.jpg', images: [
        'assets/productos/Ligue 1/PSG2526T/1.jpg',
        'assets/productos/Ligue 1/PSG2526T/2.jpg',
        'assets/productos/Ligue 1/PSG2526T/3.jpg',
        'assets/productos/Ligue 1/PSG2526T/4.jpg'
    ], excerpt: '', link: 'productos/PSG2526T.html' },

    { id: 'Arsenal2525L', name: 'Camiseta Local Arsenal 25/25', price: 19.90, img: 'assets/productos/Premier League/Arsenal2525L/1.jpg', images: [
        'assets/productos/Premier League/Arsenal2525L/1.jpg',
        'assets/productos/Premier League/Arsenal2525L/2.jpg',
        'assets/productos/Premier League/Arsenal2525L/3.jpg',
        'assets/productos/Premier League/Arsenal2525L/4.jpg'
    ], excerpt: '', link: 'productos/Arsenal2525L.html' },

    { id: 'Arsenal2526F', name: 'Camiseta Visitante Arsenal 25/26', price: 19.90, img: 'assets/productos/Premier League/Arsenal2526F/1.jpg', images: [
        'assets/productos/Premier League/Arsenal2526F/1.jpg',
        'assets/productos/Premier League/Arsenal2526F/2.jpg',
        'assets/productos/Premier League/Arsenal2526F/3.jpg',
        'assets/productos/Premier League/Arsenal2526F/4.jpg'
    ], excerpt: '', link: 'productos/Arsenal2526F.html' },

    { id: 'AstonVilla2526L', name: 'Camiseta Local Aston Villa 25/26', price: 19.90, img: 'assets/productos/Premier League/AstonVilla2526L/1.jpg', images: [
        'assets/productos/Premier League/AstonVilla2526L/1.jpg',
        'assets/productos/Premier League/AstonVilla2526L/2.jpg',
        'assets/productos/Premier League/AstonVilla2526L/3.jpg',
        'assets/productos/Premier League/AstonVilla2526L/4.jpg'
    ], excerpt: '', link: 'productos/AstonVilla2526L.html' },

    { id: 'Chealsea2526L', name: 'Camiseta Local Chelsea 25/26', price: 19.90, img: 'assets/productos/Premier League/Chealsea2526L/1.jpg', images: [
        'assets/productos/Premier League/Chealsea2526L/1.jpg',
        'assets/productos/Premier League/Chealsea2526L/2.jpg',
        'assets/productos/Premier League/Chealsea2526L/3.jpg',
        'assets/productos/Premier League/Chealsea2526L/4.jpg'
    ], excerpt: '', link: 'productos/Chealsea2526L.html' },

    { id: 'ManCity2526F', name: 'Camiseta Visitante Manchester City 25/26', price: 19.90, img: 'assets/productos/Premier League/ManCity2526F/1.jpg', images: [
        'assets/productos/Premier League/ManCity2526F/1.jpg',
        'assets/productos/Premier League/ManCity2526F/2.jpg',
        'assets/productos/Premier League/ManCity2526F/3.jpg',
        'assets/productos/Premier League/ManCity2526F/4.jpg'
    ], excerpt: '', link: 'productos/ManCity2526F.html' },

    { id: 'ManUnited2526L', name: 'Camiseta Local Manchester United 25/26', price: 19.90, img: 'assets/productos/Premier League/ManUnited2526L/1.jpg', images: [
        'assets/productos/Premier League/ManUnited2526L/1.jpg',
        'assets/productos/Premier League/ManUnited2526L/2.jpg'
    ], excerpt: '', link: 'productos/ManUnited2526L.html' },

    { id: 'Newcastle2526L', name: 'Camiseta Local Newcastle 25/26', price: 19.90, img: 'assets/productos/Premier League/Newcastle2526L/1.jpg', images: [
        'assets/productos/Premier League/Newcastle2526L/1.jpg',
        'assets/productos/Premier League/Newcastle2526L/2.jpg',
        'assets/productos/Premier League/Newcastle2526L/3.jpg',
        'assets/productos/Premier League/Newcastle2526L/4.jpg'
    ], excerpt: '', link: 'productos/Newcastle2526L.html' },

    { id: 'Napoli2526L', name: 'Camiseta Local Napoli 25/26', price: 19.90, img: 'assets/productos/Serie A/Napoli2526L/1.jpg', images: [
        'assets/productos/Serie A/Napoli2526L/1.jpg',
        'assets/productos/Serie A/Napoli2526L/2.jpg',
        'assets/productos/Serie A/Napoli2526L/3.jpg',
        'assets/productos/Serie A/Napoli2526L/4.jpg'
    ], excerpt: '', link: 'productos/Napoli2526L.html' },

    { id: 'Albacete2526L', name: 'Camiseta Local Albacete 25/26', price: 19.90, img: 'assets/productos/La Liga/Albacete2526L/1.jpg', images: [
        'assets/productos/La Liga/Albacete2526L/1.jpg',
        'assets/productos/La Liga/Albacete2526L/2.jpg',
        'assets/productos/La Liga/Albacete2526L/3.jpg',
        'assets/productos/La Liga/Albacete2526L/4.jpg'
    ], excerpt: '', link: 'productos/Albacete2526L.html' },

    { id: 'MalagaKids2526L', name: 'Camiseta Local Málaga 25/26 (niños)', price: 21.90, img: 'assets/productos/La Liga/MalagaKids2526L/1.jpg', images: [
        'assets/productos/La Liga/MalagaKids2526L/1.jpg',
        'assets/productos/La Liga/MalagaKids2526L/2.jpg',
        'assets/productos/La Liga/MalagaKids2526L/3.jpg'
    ], excerpt: '', link: 'productos/MalagaKids2526L.html' },

    { id: 'River2526L', name: 'Camiseta Local River Plate 25/26', price: 19.90, img: 'assets/productos/SAF (Argentina)/River2526L/1.jpg', images: [
        'assets/productos/SAF (Argentina)/River2526L/1.jpg',
        'assets/productos/SAF (Argentina)/River2526L/2.jpg',
        'assets/productos/SAF (Argentina)/River2526L/3.jpg',
        'assets/productos/SAF (Argentina)/River2526L/4.jpg'
    ], excerpt: '', link: 'productos/River2526L.html' },

    { id: 'RiverKids2526L', name: 'Camiseta Local River Plate 25/26 (niños)', price: 21.90, img: 'assets/productos/SAF (Argentina)/RiverKids2526L/1.jpeg', images: [
        'assets/productos/SAF (Argentina)/RiverKids2526L/1.jpeg',
        'assets/productos/SAF (Argentina)/RiverKids2526L/2.jpg',
        'assets/productos/SAF (Argentina)/RiverKids2526L/3.jpg',
        'assets/productos/SAF (Argentina)/RiverKids2526L/4.jpg'
    ], excerpt: '', link: 'productos/RiverKids2526L.html' }
];

        const EXTRAS = { parche: 1, dorsal: 2, versionJugador: 5, version: 5 };
        const SHIPPING = 2.00;
        // Ofertas por cantidad (no se crean productos nuevos; se aplican automáticamente según cantidad de camisetas)
        // Nota: asumimos que las camisetas son el producto con id 'barca1' o cuyo nombre contiene 'Camiseta'
        const OFFERS = [
            { size: 5, price: 85.90, shipping: 0, label: 'MEGAPACK 5' },
            { size: 4, price: 72.90, shipping: 0, label: 'Pack 4' },
            { size: 3, price: 56.90, shipping: 0, label: 'Pack 3' },
            { size: 2, price: 39.80, shipping: 0, label: 'Pack 2' },
            // oferta para 1 unidad promocional (si la tienda tiene 1x en oferta)
            { size: 1, price: 19.90, shipping: 1.90, label: 'Pack 1 (Promo)' }
        ];
        let CART = [];

        // Helpers globales para detección de camisetas y cálculo de mejor combinación de packs
        function isShirtItem(ci){
            if (!ci || !ci.name) return false;
            const name = (ci.name || '').toLowerCase();
            return (ci.productId === 'barca1') || name.includes('camiseta') || name.includes('camisetas');
        }

        function computeBestOfferForCount(count){
            if (count <= 0) return { total:0, shipping:0, combo: {} };
            const dp = Array(count+1).fill(null);
            dp[0] = { total:0, shipping:0, combo: {} };
            for (let i=1;i<=count;i++){
                let best = null;
                for (const offer of OFFERS){
                    if (i - offer.size < 0) continue;
                    const prev = dp[i - offer.size];
                    if (!prev) continue;
                    const candTotal = prev.total + offer.price;
                    const candShipping = prev.shipping + (offer.shipping||0);
                    const candSum = candTotal + candShipping;
                    if (!best || candSum < (best.total + best.shipping)){
                        const combo = Object.assign({}, prev.combo);
                        combo[offer.size] = (combo[offer.size]||0) + 1;
                        best = { total: candTotal, shipping: candShipping, combo };
                    }
                }
                dp[i] = best;
            }
            return dp[count] || { total:0, shipping:0, combo: {} };
        }

        function byId(id){return document.getElementById(id);}    

        // computeCartTotals: reutilizable para carrito y checkout
    function computeCartTotals(){
            const shirtItems = CART.filter(isShirtItem);
            const nonShirtItems = CART.filter(ci => !isShirtItem(ci));
            const nonShirtSubtotal = nonShirtItems.reduce((s,it)=> s + (it.total || 0), 0);
            const shirtCount = shirtItems.length;
            const shirtExtrasSum = shirtItems.reduce((s,it)=> s + (it.extra||0), 0);
            const shirtBaseSum = shirtItems.reduce((s,it)=> s + (it.price||0), 0);
            // Determinar precio base por unidad usado por las ofertas (pack de 1 si existe)
            const baseOffer = (OFFERS && OFFERS.find(o=>o.size===1) && OFFERS.find(o=>o.size===1).price) ? OFFERS.find(o=>o.size===1).price : 19.90;
            // Sumar recargo por camisetas que tengan precio mayor al precio base (p. ej. 24.90 vs 19.90)
            const shirtPriceSurplus = shirtItems.reduce((s,it) => s + Math.max(0, (it.price || 0) - baseOffer), 0);
            const originalSubtotal = nonShirtSubtotal + shirtBaseSum + shirtExtrasSum;
            const originalShipping = (CART.length>0? SHIPPING : 0);
            const originalTotal = originalSubtotal + originalShipping;
            if (shirtCount === 0) return { subtotal: originalSubtotal, shipping: originalShipping, total: originalTotal, appliedOffer: null, savings:0 };
            const best = computeBestOfferForCount(shirtCount);
            // El coste calculado por packs (best.total) asume precios base; añadimos extras y cualquier diferencia de precio por unidad
            const shirtsOfferCost = best.total + shirtExtrasSum + shirtPriceSurplus;
            // Si hay más de 1 camiseta aplicamos envío gratis a todo el pedido
            const shirtsOfferShipping = (shirtCount > 1) ? 0 : best.shipping;
            const newSubtotal = nonShirtSubtotal + shirtsOfferCost;
            // Si hay más de 1 camiseta, envío gratis global; si no, sumar shipping para nonShirtItems si existen
            const newShipping = (shirtCount > 1) ? 0 : (shirtsOfferShipping + (nonShirtItems.length>0 ? SHIPPING : 0));

            // Aplicar descuentos seleccionados manualmente (no automáticamente)
            let adjustedSubtotal = newSubtotal;
            let loyaltyApplied = null;
            
            // Verificar si hay un descuento aplicado manualmente (CURRENT_DISCOUNT)
            try {
              if (CURRENT_DISCOUNT) {
                console.log('Aplicando descuento seleccionado manualmente:', CURRENT_DISCOUNT);
                
                // Guardar el descuento aplicado para marcarlo al confirmar la compra
                window.__APPLIED_REWARD = CURRENT_DISCOUNT;
                
                // Aplicar el descuento según su tipo
                if (CURRENT_DISCOUNT.type === 'free_item' && shirtCount > 0) {
                  // Descuento de camiseta gratis
                  const baseOffer = (OFFERS && OFFERS.find(o=>o.size===1) && OFFERS.find(o=>o.size===1).price) ? OFFERS.find(o=>o.size===1).price : 19.90;
                  const value = baseOffer;
                  adjustedSubtotal = Math.max(0, adjustedSubtotal - value);
                  loyaltyApplied = { 
                    type: 'reward', 
                    rewardId: CURRENT_DISCOUNT.redemptionId || CURRENT_DISCOUNT.id, 
                    rewardKind: CURRENT_DISCOUNT.kind || CURRENT_DISCOUNT.type, 
                    label: CURRENT_DISCOUNT.title || CURRENT_DISCOUNT.name || 'Camiseta gratis', 
                    value 
                  };
                } else if (CURRENT_DISCOUNT.type === 'percentage') {
                  // Descuento porcentual
                  const percent = CURRENT_DISCOUNT.value / 100;
                  const value = adjustedSubtotal * percent;
                  adjustedSubtotal = Math.max(0, adjustedSubtotal - value);
                  loyaltyApplied = { 
                    type: 'reward', 
                    rewardId: CURRENT_DISCOUNT.redemptionId || CURRENT_DISCOUNT.id, 
                    rewardKind: CURRENT_DISCOUNT.kind || CURRENT_DISCOUNT.type, 
                    label: CURRENT_DISCOUNT.title || CURRENT_DISCOUNT.name || `${CURRENT_DISCOUNT.value}% de descuento`, 
                    value, 
                    percent 
                  };
                } else if (CURRENT_DISCOUNT.type === 'fixed') {
                  // Descuento de cantidad fija
                  const value = Math.min(adjustedSubtotal, CURRENT_DISCOUNT.value);
                  adjustedSubtotal = Math.max(0, adjustedSubtotal - value);
                  loyaltyApplied = { 
                    type: 'reward', 
                    rewardId: CURRENT_DISCOUNT.redemptionId || CURRENT_DISCOUNT.id, 
                    rewardKind: CURRENT_DISCOUNT.kind || CURRENT_DISCOUNT.type, 
                    label: CURRENT_DISCOUNT.title || CURRENT_DISCOUNT.name || `${CURRENT_DISCOUNT.value}€ de descuento`, 
                    value 
                  };
                } else if (CURRENT_DISCOUNT.type === 'free_shipping') {
                  // Descuento de envío gratis
                  loyaltyApplied = { 
                    type: 'reward', 
                    rewardId: CURRENT_DISCOUNT.redemptionId || CURRENT_DISCOUNT.id, 
                    rewardKind: CURRENT_DISCOUNT.kind || CURRENT_DISCOUNT.type, 
                    label: CURRENT_DISCOUNT.title || CURRENT_DISCOUNT.name || 'Envío gratis', 
                    value: newShipping 
                  };
                  // El envío gratis se aplica más adelante
                }
              } else {
                // No hay descuento aplicado manualmente
                window.__APPLIED_REWARD = null;
              }
            } catch(e) { 
              console.error('Error al aplicar descuento:', e);
              window.__APPLIED_REWARD = null; 
            }

            const newTotal = adjustedSubtotal + newShipping;

            // Map user-defined estimated savings per number of camisetas (base table)
            const SAVINGS_TABLE = { 1: 2.00, 2: 5.00, 3: 13.00, 4: 15.00, 5: 25.00 };

            // Decompose count into multiples of 5 + remainder and sum the table values
            function computeSavingsByDecomposition(n){
                if (!n || n <= 0) return 0;
                let remaining = n;
                let totalSavings = 0;
                // use as many 5-packs as possible
                const pack5 = Math.floor(remaining / 5);
                if (pack5 > 0 && SAVINGS_TABLE[5]) {
                    totalSavings += pack5 * SAVINGS_TABLE[5];
                    remaining = remaining - pack5 * 5;
                }
                // handle remainder using table if available, otherwise fallback to original diff for remainder
                if (remaining > 0) {
                    if (SAVINGS_TABLE[remaining] !== undefined) {
                        totalSavings += SAVINGS_TABLE[remaining];
                    } else {
                        // fallback: estimate proportional part of fallback savings
                        const fallback = Math.max(0, originalTotal - newTotal);
                        // distribute fallback proportionally by remaining/count
                        totalSavings += Math.round((fallback * (remaining / n)) * 100) / 100;
                    }
                }
                return totalSavings;
            }

            const fallbackSavings = Math.max(0, originalTotal - newTotal);
            const savings = (shirtCount > 0) ? computeSavingsByDecomposition(shirtCount) : 0;

            return { subtotal: adjustedSubtotal, shipping: newShipping, total: newTotal, appliedOffer: { count: shirtCount, detail: best, priceSurplus: shirtPriceSurplus }, savings, loyaltyApplied };
        }

        // simple debounce helper
        function debounce(fn, wait){ let t = null; return function(){ clearTimeout(t); t = setTimeout(()=> fn.apply(this, arguments), wait); }; }

        // Banner promocional: helpers de creación, posicionamiento y visibilidad
        const __PROMO = { el: null, type: null, visible: false };
        function ensurePromoEl(){
            if (__PROMO.el && document.body.contains(__PROMO.el)) return __PROMO.el;
            const el = document.createElement('div');
            el.id = 'cartPromoBanner';
            el.className = 'cart-promo-banner fast';
            // Contenido mínimo: el óvalo (.promo-badge) recibirá el texto dinámicamente
            el.innerHTML = '<div class="promo-inner"><span class="promo-badge"></span></div>';
            document.body.appendChild(el);
            __PROMO.el = el; return el;
        }
        function positionPromoBanner(){
            const el = ensurePromoEl();
            if (!__PROMO.visible) return; // solo si visible
            const cart = document.getElementById('cartPanel');
            const secCarrito = document.getElementById('carrito');
            const secPedidos = document.getElementById('pedidos');
            const sectionActive = (secCarrito && secCarrito.classList.contains('activa')) || (secPedidos && secPedidos.classList.contains('activa'));
            if (!cart || !sectionActive) { el.style.opacity = '0'; return; }
            const r = cart.getBoundingClientRect();
            const left = Math.round(r.left);
            const width = Math.round(r.width);
            // Colocar el banner por encima del borde superior del carrito
            const gap = 8;
            const bannerH = el.offsetHeight || 0;
            const topPos = Math.round(r.top) - bannerH - gap;
            el.style.left = left + 'px';
            el.style.top = topPos + 'px';
            el.style.width = width + 'px';
        }
        function hidePromoBanner(){
            const el = ensurePromoEl();
            __PROMO.visible = false;
            el.classList.remove('visible');
        }
        function showPromoBanner(type){
            const el = ensurePromoEl();
            const newType = (type === 5 ? 5 : 3);
            if (__PROMO.visible && __PROMO.type === newType) { positionPromoBanner(); return; }
            __PROMO.type = newType;
            el.classList.remove('theme-3','theme-5','fast','subtle');
            const badge = el.querySelector('.promo-badge');
            if (newType === 3){
                el.classList.add('theme-3','fast');
                if (badge) badge.textContent = 'PACK POPULAR';
            } else {
                el.classList.add('theme-5','subtle');
                if (badge) badge.textContent = 'MEJOR OFERTA';
            }
            __PROMO.visible = true;
            positionPromoBanner();
            void el.offsetWidth; // reflow para animación
            el.classList.add('visible');
        }
        function updateCartPromoBanner(){
            try {
                const secCarrito = document.getElementById('carrito');
                const secPedidos = document.getElementById('pedidos');
                const sectionActive = (secCarrito && secCarrito.classList.contains('activa')) || (secPedidos && secPedidos.classList.contains('activa'));
                if (!sectionActive) { hidePromoBanner(); return; }
                const shirtCount = (Array.isArray(CART)? CART : []).filter(isShirtItem).length;
                if (shirtCount === 5) showPromoBanner(5);
                else if (shirtCount === 3) showPromoBanner(3);
                else hidePromoBanner();
                setTimeout(positionPromoBanner, 30);
                setTimeout(positionPromoBanner, 160);
            } catch(e) {}
        }
        window.addEventListener('resize', debounce(positionPromoBanner, 60));
        window.addEventListener('scroll', debounce(positionPromoBanner, 60));
        document.addEventListener('DOMContentLoaded', ()=> setTimeout(positionPromoBanner, 140));
        // Ajustar tras cambiar sección
        document.querySelectorAll('.boton-seccion').forEach(b => b.addEventListener('click', ()=> setTimeout(()=> { updateCartPromoBanner(); positionPromoBanner(); }, 240)));

        // Variable global para almacenar el estado de ordenamiento y filtrado
        let currentSortOrder = 'default'; // 'default', 'price-asc', 'price-desc'
        let currentLeagueFilter = 'all'; // 'all', 'La Liga', 'Premier League', etc.
        let currentTeamFilter = 'all'; // 'all' o nombre de equipo específico
        
        // Helpers de normalización y extracción de liga/equipo
        function normalizeNoAccentsGlobal(s){
            return (s || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
        }
        function canonicalizeTeamName(name){
            const raw = (name || '').toString().trim();
            if (!raw) return '';
            // Eliminar paréntesis vacíos como "()" y espacios extra
            let s = raw.replace(/\(\s*\)/g, '').replace(/\s{2,}/g,' ').trim();
            const key = normalizeNoAccentsGlobal(s);
            const map = new Map([
                ['atletico', 'Atlético de Madrid'],
                ['atlético', 'Atlético de Madrid'],
                ['atleti', 'Atlético de Madrid'],
                ['atletico madrid', 'Atlético de Madrid'],
                ['atletico de madrid', 'Atlético de Madrid'],
                ['real madrid', 'Real Madrid'],
                ['fc barcelona', 'Barcelona'],
                ['barcelona', 'Barcelona'],
                ['athletic', 'Athletic Club'],
                ['athletic club', 'Athletic Club'],
                ['athletic bilbao', 'Athletic Club'],
                ['athletic de bilbao', 'Athletic Club']
            ]);
            if (map.has(key)) return map.get(key);
            return s;
        }
        function getLeagueFromProduct(p){
            try{
                const imgPath = p && (p.img || (p.images && p.images[0]) || '');
                const m = (imgPath||'').match(/assets\/productos\/([^/]+)\//i);
                return m ? m[1] : 'Otros';
            }catch(e){ return 'Otros'; }
        }
        function extractTeamFromName(name){
            let s = (name || '').replace(/\bCamiseta\b/gi,'').replace(/\bNBA\b/gi,'');
            s = s.replace(/\b(Local|Visitante|Tercera|Retro|Kids|niños)\b/gi,'');
            s = s.replace(/\(\s*(Kids|niños)\s*\)/gi,'');
            s = s.replace(/\(\s*Modelo\s*\d+\s*\)/gi,'');
            s = s.replace(/\b\d{2}\/\d{2}\b/g,'');
            s = s.replace(/\b\d{2}\d{2}\b/g,'');
            s = s.replace(/\b\d{4}\b/g,'');
            s = s.replace(/\s{2,}/g,' ').trim();
            return s;
        }
        function getTeamFromProduct(p){
            try{
                const nameTeam = extractTeamFromName(p && p.name);
                if (nameTeam && nameTeam.length >= 2) return nameTeam;
                const imgPath = p && (p.img || (p.images && p.images[0]) || '');
                const m = (imgPath||'').match(/assets\/productos\/[^/]+\/([^/]+)\//i);
                let folder = m ? m[1] : '';
                // limpiar sufijos de temporada y tipo de camiseta
                folder = folder.replace(/(Kids|LR|FR|TR)$/i,'');
                folder = folder.replace(/\d{2,4}/g,'');
                // normalizar claves conocidas
                const normas = [
                    ['RealMadrid','Real Madrid'], ['Barcelona','Barcelona'], ['Athletic','Athletic Club'], ['Atletico','Atlético'],
                    ['Betis','Betis'], ['Celta','Celta'], ['Elche','Elche'], ['Espanyol','Espanyol'], ['Getafe','Getafe'],
                    ['Girona','Girona'], ['Granada','Granada'], ['LasPalmas','Las Palmas'], ['Leganes','Leganés'], ['Levante','Levante'],
                    ['Malaga','Málaga'], ['Mallorca','Mallorca'], ['Osasuna','Osasuna'], ['Oviedo','Oviedo'], ['Rayo','Rayo Vallecano'],
                    ['RealSociedad','Real Sociedad'], ['Sevilla','Sevilla'], ['Valencia','Valencia'], ['Valladolid','Valladolid'],
                    ['Alaves','Alavés'], ['Villarreal','Villarreal'], ['Munich','Bayern Munich'], ['Paris','PSG'],
                    ['CrystalPalace','Crystal Palace'], ['Milan','Milan'], ['Lazio','Lazio'], ['Roma','Roma'], ['Schalke','Schalke'],
                    ['Flamengo','Flamengo'], ['Al-Nassr','Al-Nassr'], ['Boca','Boca Juniors'], ['Monaco','Monaco'],
                    ['Espana','España'], ['Francia','Francia'], ['Holanda','Holanda'], ['Lakers','Lakers'],
                    ['Oklahoma','Oklahoma City Thunder'], ['Phila','Philadelphia 76ers']
                ];
                for (const [k,v] of normas){
                    const rk = new RegExp('^'+k+'$', 'i');
                    if (rk.test(folder)) return v;
                }
                // fallback: separar camelCase
                const inferred = (folder||'').replace(/([a-z])([A-Z])/g,'$1 $2').replace(/[\-_]/g,' ').trim();
                return inferred || 'Otros';
            }catch(e){ return 'Otros'; }
        }
        
        // Extraer el año (inicio de temporada) de un producto, p.ej. "2023/24", "23/24", "2024"
        function getSeasonYearFromProduct(p){
            try{
                // Forzar NBA como temporada 25/26 (año base 2025) para que aparezcan como recientes
                try {
                    const league = getLeagueFromProduct(p);
                    if ((league || '').toLowerCase() === 'nba') return 2025;
                } catch (e) {}
                const candidates = [];
                const consider = [];
                if (p && p.name) consider.push(p.name);
                const imgPath = p && (p.img || (Array.isArray(p.images) && p.images[0]) || '');
                if (imgPath) consider.push(imgPath);
                for (const sRaw of consider){
                    const s = String(sRaw);
                    // Patrones tipo 2023/24 o 2023/2024 -> usar el primer año como año de temporada
                    let m = s.match(/\b(20\d{2})\s*\/\s*(\d{2,4})\b/);
                    if (m){ const y = parseInt(m[1],10); if (!Number.isNaN(y)) candidates.push(y); }
                    // Patrones tipo 23/24 -> asumir 2000+23 = 2023
                    m = s.match(/\b(\d{2})\s*\/\s*(\d{2})\b/);
                    if (m){ const y = 2000 + parseInt(m[1],10); if (!Number.isNaN(y)) candidates.push(y); }
                    // Año suelto 20xx
                    m = s.match(/\b(20\d{2})\b/);
                    if (m){ const y = parseInt(m[1],10); if (!Number.isNaN(y)) candidates.push(y); }
                }
                if (candidates.length) return Math.max(...candidates);
                return 0;
            }catch(e){ return 0; }
        }
        
        // Función para crear los controles de filtrado y ordenamiento
        function createGalleryControls(container) {
            // Obtener todas las ligas disponibles
            const leagues = [];
            PRODUCTS.forEach(p => {
                const imgPath = p.img || (p.images && p.images.length > 0 ? p.images[0] : '');
                const match = imgPath.match(/assets\/productos\/([^/]+)\//i);
                const league = match ? match[1] : 'Otros';
                if (!leagues.includes(league)) {
                    leagues.push(league);
                }
                // Reposition cart after layout settles to avoid visual jumps (delays are small)
                try {
                    if (typeof positionCartBelowHeader === 'function') {
                        setTimeout(positionCartBelowHeader, 120);
                        setTimeout(positionCartBelowHeader, 420);
                    }
                } catch(e){}
            });
            
            // Crear el contenedor de controles
            const controlsContainer = document.createElement('div');
            controlsContainer.id = 'galleryControls';
            controlsContainer.className = 'gallery-controls';
            
            // Crear el selector de ligas (dropdown personalizado con submenús)
            const leagueFilter = document.createElement('div');
            leagueFilter.className = 'league-filter';
            leagueFilter.innerHTML = `
                <label>Filtrar por liga:</label>
                <div class="league-dropdown" id="leagueDropdown">
                    <button type="button" class="dropdown-toggle" id="leagueDropdownToggle">Todas las ligas</button>
                    <div class="dropdown-menu" id="leagueDropdownMenu"></div>
                </div>
            `;

            // Construir menú de ligas con submenús de equipos (hover)
            (function(){
                // Inyectar estilos específicos si no existen
                const styleId = 'leagueSubmenuStyles';
                if (!document.getElementById(styleId)){
                    const st = document.createElement('style');
                    st.id = styleId;
                    st.textContent = `
                    /* Dropdown de ligas con submenú por equipos */
                    .gallery-controls .league-dropdown { position: relative; display: inline-block; }
                    .gallery-controls .league-dropdown .dropdown-toggle { padding: 8px 12px; padding-right: 32px; position: relative; border-radius: 6px; background: #071735; color: #fff; border: 1px solid #2e7bed; cursor: pointer; min-width: 220px; text-align:left; }
                    .gallery-controls .league-dropdown .dropdown-toggle::after { content: '▾'; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #9fe0ff; pointer-events: none; font-size: 14px; }
                    .gallery-controls .league-dropdown.open .dropdown-toggle { box-shadow: 0 0 8px rgba(46,123,237,0.4); border-color: var(--azul-acento); }
                    .gallery-controls .league-dropdown.open .dropdown-toggle::after { transform: translateY(-50%) rotate(180deg); }
                    .gallery-controls .league-dropdown .dropdown-menu { position: absolute; top: 100%; left: 0; min-width: 240px; background: #071735; border: 1px solid #2e7bed; border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.35); padding: 6px 0; display: none; z-index: 1200; max-height: none; overflow: visible; }
                    .gallery-controls .league-dropdown.open .dropdown-menu { display: block; }
                    .gallery-controls .dropdown-item { padding: 8px 12px; color: #fff; cursor: pointer; white-space: nowrap; line-height: 1.2; }
                    .gallery-controls .dropdown-item:hover { background: rgba(46,123,237,0.12); }
                    .gallery-controls .dropdown-item.has-sub { position: relative; padding-right: 28px; }
                    .gallery-controls .dropdown-item.has-sub::after { content: '›'; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #9fe0ff; }
                    .gallery-controls .submenu { position: absolute; top: 0; left: 100%; min-width: 240px; background: #071735; border: 1px solid #2e7bed; border-radius: 8px; box-shadow: 0 8px 30px rgba(0,0,0,0.35); padding: 6px 0; display: none; z-index: 1201; max-height: none; overflow: visible; }
                    .gallery-controls .dropdown-item.has-sub:hover > .submenu { display: block; }
                    .gallery-controls .dropdown-menu.fixed-open, .gallery-controls .submenu.fixed-open { position: fixed !important; max-height: none !important; overflow: visible !important; transform-origin: top left; }
                    .gallery-controls .dropdown-menu.columns, .gallery-controls .submenu.columns { column-gap: 8px; }
                    @media (max-width: 768px){
                        .gallery-controls .league-dropdown .dropdown-menu, .gallery-controls .submenu { position: static; box-shadow:none; border-radius:8px; border-width:1px; }
                        .gallery-controls .dropdown-item.has-sub::after { display:none; }
                        .gallery-controls .dropdown-item.has-sub { position: relative; cursor: pointer; }
                        .gallery-controls .dropdown-item.has-sub .submenu-toggle { 
                            display: block !important; 
                            position: absolute; 
                            right: 8px; 
                            top: 50%; 
                            transform: translateY(-50%); 
                            background: transparent; 
                            border: 1px solid rgba(159, 224, 255, 0.3); 
                            color: #9fe0ff; 
                            border-radius: 50%; 
                            width: 28px; 
                            height: 28px; 
                            cursor: pointer; 
                            font-size: 14px; 
                            transition: transform 0.2s ease, background 0.2s ease; 
                            line-height: 1; 
                        }
                        .gallery-controls .dropdown-item.has-sub .submenu-toggle:hover {
                            background: rgba(159, 224, 255, 0.1);
                        }
                        .gallery-controls .dropdown-item.has-sub .submenu-toggle.open {
                            transform: translateY(-50%) rotate(90deg);
                            background: rgba(159, 224, 255, 0.2);
                        }
                        .gallery-controls .submenu { 
                            display: none !important; 
                            position: relative !important; 
                            left: 0 !important; 
                            top: 0 !important; 
                            width: 100% !important; 
                            margin-left: 16px !important; 
                            border: none !important; 
                            box-shadow: none !important; 
                            background: rgba(46, 123, 237, 0.05) !important; 
                            border-left: 2px solid #2e7bed !important; 
                            border-radius: 0 8px 8px 0 !important; 
                        }
                        .gallery-controls .submenu.show { 
                            display: block !important; 
                        }
                        .gallery-controls .submenu .dropdown-item {
                            padding: 8px 12px !important; 
                            font-size: 0.9rem !important; 
                            border-bottom: 1px solid rgba(46, 123, 237, 0.1) !important; 
                        }
                        .gallery-controls .submenu .dropdown-item:last-child {
                            border-bottom: none !important; 
                        }
                    }
                    `;
                    document.head.appendChild(st);
                }

                const dd = leagueFilter.querySelector('#leagueDropdown');
                const toggle = leagueFilter.querySelector('#leagueDropdownToggle');
                const menu = leagueFilter.querySelector('#leagueDropdownMenu');
                if (!dd || !toggle || !menu) return;

                // Construir mapa Liga -> equipos (deduplicado por nombre normalizado)
                const leagueMap = new Map();
                (Array.isArray(PRODUCTS) ? PRODUCTS : []).forEach(p => {
                    const league = getLeagueFromProduct(p);
                    const team = getTeamFromProduct(p);
                    if (!leagueMap.has(league)) leagueMap.set(league, new Map());
                    const canonical = canonicalizeTeamName(team);
                    const key = normalizeNoAccentsGlobal(canonical);
                    if (key){
                        const m = leagueMap.get(league);
                        if (!m.has(key)) m.set(key, canonical);
                    }
                });
                const leaguesSorted = Array.from(leagueMap.keys()).sort((a,b)=> a.localeCompare(b));

                // Opción: Todas las ligas
                const itemAll = document.createElement('div');
                itemAll.className = 'dropdown-item';
                itemAll.textContent = 'Todas las ligas';
                itemAll.addEventListener('click', () => {
                    currentLeagueFilter = 'all';
                    currentTeamFilter = 'all';
                    toggle.textContent = 'Todas las ligas';
                    renderGallery(document.getElementById('productSearch')?.value || '');
                    closeDropdown();
                });
                menu.appendChild(itemAll);

                // Ligas con submenú de equipos
                leaguesSorted.forEach(league => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'dropdown-item has-sub';
                    wrapper.textContent = league;
                    // Al hacer clic en la competición, filtrar por toda la liga
                    wrapper.addEventListener('click', (e) => {º
                        e.stopPropagation();
                        currentLeagueFilter = league;
                        currentTeamFilter = 'all';
                        toggle.textContent = `Liga: ${league}`;
                        renderGallery(document.getElementById('productSearch')?.value || '');
                        closeDropdown();
                    });

                    const submenu = document.createElement('div');
                    submenu.className = 'submenu';

                    // Entrada de "Todos los equipos" para esa liga
                    const subAll = document.createElement('div');
                    subAll.className = 'dropdown-item';
                    subAll.textContent = 'Todos los equipos';
                    subAll.addEventListener('click', (e) => {
                        e.stopPropagation();
                        currentLeagueFilter = league;
                        currentTeamFilter = 'all';
                        toggle.textContent = `Liga: ${league}`;
                        renderGallery(document.getElementById('productSearch')?.value || '');
                        closeDropdown();
                    });
                    submenu.appendChild(subAll);

                    const teamsMap = leagueMap.get(league) || new Map();
                    const teams = Array.from(teamsMap.values())
                        .map(v => canonicalizeTeamName(v))
                        .filter((v,i,arr)=> arr.findIndex(x => normalizeNoAccentsGlobal(x) === normalizeNoAccentsGlobal(v)) === i)
                        .sort((a,b)=> a.localeCompare(b));
                    teams.forEach(team => {
                        const tItem = document.createElement('div');
                        tItem.className = 'dropdown-item';
                        tItem.textContent = team;
                        tItem.addEventListener('click', (e) => {
                            e.stopPropagation();
                            currentLeagueFilter = league;
                        currentTeamFilter = canonicalizeTeamName(team);
                        toggle.textContent = `Equipo: ${canonicalizeTeamName(team)}`;
                        renderGallery(document.getElementById('productSearch')?.value || '');
                            closeDropdown();
                        });
                        submenu.appendChild(tItem);
                    });

                    wrapper.appendChild(submenu);
                    menu.appendChild(wrapper);
                });

                // Helpers para posicionar y evitar scroll
                function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
                function layoutColumns(container, maxWidth){
                    const items = Array.from(container.children);
                    const firstItem = items.find(el => el.classList && el.classList.contains('dropdown-item')) || items[0];
                    const tempDisplay = container.style.display;
                    const tempVis = container.style.visibility;
                    container.style.display = 'block';
                    container.style.visibility = 'hidden';
                    const itemHeight = firstItem ? (firstItem.getBoundingClientRect().height || 32) : 32;
                    const totalItems = items.length || 1;
                    const margin = 8;
                    const maxColumnsByWidth = Math.max(1, Math.floor((maxWidth - 2*margin) / 260));
                    const columnsByHeight = Math.ceil((totalItems * itemHeight) / (window.innerHeight - 2*margin));
                    const columns = clamp(columnsByHeight, 1, maxColumnsByWidth);
                    container.classList.add('columns');
                    container.style.columnCount = String(columns);
                    container.style.columnWidth = '240px';
                    const width = Math.min(columns * 260, maxWidth - 2*margin);
                    container.style.width = width + 'px';
                    container.style.display = tempDisplay;
                    container.style.visibility = tempVis;
                    return width;
                }
                function positionFixed(container, anchorRect, preferBelow = true){
                    const margin = 8;
                    container.classList.add('fixed-open');
                    container.style.position = 'fixed';
                    container.style.display = 'block';
                    container.style.visibility = 'hidden';
                    // Ajustar columnas antes de medir tamaño total
                    layoutColumns(container, window.innerWidth);
                    const rect = container.getBoundingClientRect();
                    // Calcular escala para que quepa en pantalla sin scroll
                    const scale = Math.min(1,
                        (window.innerWidth - 2*margin) / rect.width,
                        (window.innerHeight - 2*margin) / rect.height
                    );
                    container.style.transform = (scale < 1 ? `scale(${scale})` : 'none');
                    const effWidth = rect.width * scale;
                    const effHeight = rect.height * scale;
                    let left = clamp(anchorRect.left, margin, window.innerWidth - effWidth - margin);
                    let topCandidate = preferBelow ? (anchorRect.bottom + margin) : (anchorRect.top - effHeight - margin);
                    if (preferBelow && (topCandidate + effHeight + margin > window.innerHeight)){
                        // No cabe abajo, intentar arriba
                        topCandidate = Math.max(margin, anchorRect.top - effHeight - margin);
                    }
                    if (!preferBelow && (topCandidate < margin)){
                        // No cabe arriba, intentar abajo
                        topCandidate = clamp(anchorRect.bottom + margin, margin, window.innerHeight - effHeight - margin);
                    }
                    const top = clamp(topCandidate, margin, window.innerHeight - effHeight - margin);
                    container.style.left = left + 'px';
                    container.style.top = top + 'px';
                    container.style.visibility = 'visible';
                }
                function clearFixed(container){
                    container.classList.remove('fixed-open','columns');
                    container.style.removeProperty('position');
                    container.style.removeProperty('left');
                    container.style.removeProperty('top');
                    container.style.removeProperty('width');
                    container.style.removeProperty('column-count');
                    container.style.removeProperty('column-width');
                    container.style.removeProperty('display');
                    container.style.removeProperty('visibility');
                }

                // Toggle abrir/cerrar menú de ligas con posicionamiento fijo y sin scroll
                let resizeHandler;
                function openDropdown(){
                    dd.classList.add('open');
                    const anchor = toggle.getBoundingClientRect();
                    positionFixed(menu, anchor, true);
                    // Recalcular en resize
                    resizeHandler = () => positionFixed(menu, toggle.getBoundingClientRect(), true);
                    window.addEventListener('resize', resizeHandler);
                    window.addEventListener('scroll', resizeHandler, { passive: true });
                }
                function closeDropdown(){
                    dd.classList.remove('open');
                    clearFixed(menu);
                    // Limpiar cualquier submenú abierto
                    menu.querySelectorAll('.submenu').forEach(sm => { clearFixed(sm); sm.style.display=''; });
                    if (resizeHandler){
                        window.removeEventListener('resize', resizeHandler);
                        window.removeEventListener('scroll', resizeHandler);
                        resizeHandler = null;
                    }
                }
                // Cierre por proximidad: cierra si el cursor se aleja más de 20px del área del toggle + menú + submenús visibles
                let __lastMouseX = 0, __lastMouseY = 0;
                (function(){
                    const PADDING = 20;
                    let proximityTimer = null;
                    function within(rect, x, y){
                        return x >= rect.left - PADDING && x <= rect.right + PADDING && y >= rect.top - PADDING && y <= rect.bottom + PADDING;
                    }
                    function withinAny(rects, x, y){
                        for (const r of rects){
                            if (within(r, x, y)) return true;
                        }
                        return false;
                    }
                    function collectRects(){
                        const rects = [ toggle.getBoundingClientRect(), menu.getBoundingClientRect() ];
                        menu.querySelectorAll('.submenu.fixed-open').forEach(sm => {
                            rects.push(sm.getBoundingClientRect());
                        });
                        return rects;
                    }
                    function onMove(e){
                        if (!dd.classList.contains('open')) return;
                        const rects = collectRects();
                        const x = e.clientX, y = e.clientY;
                        if (!withinAny(rects, x, y)){
                            if (proximityTimer) clearTimeout(proximityTimer);
                            proximityTimer = setTimeout(() => {
                                const rects2 = collectRects();
                                const x2 = e.clientX, y2 = e.clientY;
                                if (!withinAny(rects2, x2, y2)) closeDropdown();
                            }, 30);
                        } else if (proximityTimer){
                            clearTimeout(proximityTimer);
                            proximityTimer = null;
                        }
                    }
                    document.addEventListener('mousemove', onMove, { passive: true });
                    document.addEventListener('mousemove', (e)=>{ __lastMouseX = e.clientX; __lastMouseY = e.clientY; }, { passive: true });
                })();
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (dd.classList.contains('open')) closeDropdown(); else openDropdown();
                });
                document.addEventListener('click', () => closeDropdown());

                // Posicionamiento de submenús en escritorio (hover) y alternativa móvil con botón táctil
                const wrappers = menu.querySelectorAll('.dropdown-item.has-sub');
                const isSmallScreen = window.innerWidth <= 768;
                const supportsHover = window.matchMedia && window.matchMedia('(hover: hover) and (pointer: fine)').matches && !isSmallScreen;
                wrappers.forEach(wrapper => {
                    const submenu = wrapper.querySelector('.submenu');
                    if (!submenu) return;

                    if (supportsHover){
                        let hoverWrapper = false;
                        let hoverSubmenu = false;
                        let hideTimeout = null;

                        function positionSubmenu(){
                            submenu.style.display = 'block';
                            const wRect = wrapper.getBoundingClientRect();
                            submenu.classList.add('fixed-open');
                            layoutColumns(submenu, window.innerWidth);
                            const sRect = submenu.getBoundingClientRect();
                            const margin = 8;
                            let left = wRect.right + margin;
                            if (left + sRect.width + margin > window.innerWidth){
                                left = Math.max(margin, wRect.left - margin - sRect.width);
                            }
                            let top = clamp(wRect.top, margin, window.innerHeight - sRect.height - margin);
                            submenu.style.position = 'fixed';
                            submenu.style.left = left + 'px';
                            submenu.style.top = top + 'px';
                        }
                        function scheduleHide(){
                            if (hideTimeout) clearTimeout(hideTimeout);
                            hideTimeout = setTimeout(() => {
                                if (!hoverWrapper && !hoverSubmenu){
                                    const rects = [ wrapper.getBoundingClientRect(), submenu.getBoundingClientRect() ];
                                    const inside = rects.some(r => __lastMouseX >= r.left - 20 && __lastMouseX <= r.right + 20 && __lastMouseY >= r.top - 20 && __lastMouseY <= r.bottom + 20);
                                    if (!inside){
                                        clearFixed(submenu);
                                        submenu.style.display = '';
                                    }
                                }
                            }, 30);
                        }

                        wrapper.addEventListener('mouseenter', () => {
                            hoverWrapper = true;
                            menu.querySelectorAll('.submenu').forEach(sm => { if (sm !== submenu) { clearFixed(sm); sm.style.display=''; } });
                            positionSubmenu();
                        });
                        wrapper.addEventListener('mouseleave', () => {
                            hoverWrapper = false;
                            scheduleHide();
                        });
                        submenu.addEventListener('mouseenter', () => {
                            hoverSubmenu = true;
                            positionSubmenu();
                        });
                        submenu.addEventListener('mouseleave', () => {
                            hoverSubmenu = false;
                            scheduleHide();
                        });
                    } else if (isSmallScreen) {
                        // Móvil / táctil: botón flecha para abrir el submenú
                        submenu.style.display = 'none';
                        let btn = wrapper.querySelector('.submenu-toggle');
                        if (!btn){
                            btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'submenu-toggle';
                            btn.setAttribute('aria-label', 'Mostrar equipos');
                            btn.setAttribute('aria-expanded', 'false');
                            btn.textContent = '›';
                            wrapper.appendChild(btn);
                        }
                        btn.addEventListener('click', (e)=>{
                            e.stopPropagation();
                            const willOpen = !wrapper.classList.contains('open');
                            // Cerrar otros submenús abiertos
                            menu.querySelectorAll('.dropdown-item.has-sub.open').forEach(w => {
                                if (w !== wrapper){
                                    w.classList.remove('open');
                                    const sm = w.querySelector('.submenu');
                                    if (sm) sm.style.display = 'none';
                                    const b = w.querySelector('.submenu-toggle');
                                    if (b) b.setAttribute('aria-expanded','false');
                                }
                            });
                            wrapper.classList.toggle('open');
                            submenu.style.display = willOpen ? 'block' : 'none';
                            btn.setAttribute('aria-expanded', String(willOpen));
                        });
                    }
                });
                // Estilos móviles para el botón flecha
                if (!document.getElementById('leagueTouchStyles')){
                    const st2 = document.createElement('style');
                    st2.id = 'leagueTouchStyles';
                    st2.textContent = `
                    @media (max-width: 768px) and (hover: none) and (pointer: coarse){
                        .gallery-controls .dropdown-item.has-sub { position: relative; padding-right: 40px; }
                        .gallery-controls .dropdown-item.has-sub .submenu { display: none !important; margin-top: 4px; background: rgba(10,31,61,0.95); border-radius: 8px; padding: 4px 0; }
                        .gallery-controls .dropdown-item.has-sub.open > .submenu { display: block !important; }
                        .gallery-controls .dropdown-item.has-sub .submenu-toggle{ position:absolute; right:8px; top:50%; transform:translateY(-50%); background: rgba(42,91,168,0.3); border:1px solid rgba(255,255,255,0.2); color:#9fe0ff; border-radius:6px; padding:6px 10px; cursor:pointer; font-size:14px; transition:all 0.2s ease; min-width: 28px; text-align: center; }
                        .gallery-controls .dropdown-item.has-sub .submenu-toggle:active { background: rgba(42,91,168,0.5); }
                        .gallery-controls .dropdown-item.has-sub.open > .submenu-toggle { transform:translateY(-50%) rotate(90deg); background: rgba(42,91,168,0.6); }
                    }
                    @media (max-width: 768px) and (hover: hover){
                        .gallery-controls .dropdown-item.has-sub .submenu-toggle { display: none !important; }
                    }
                    `;
                    document.head.appendChild(st2);
                }
            })();
            
            // Crear el selector de ordenamiento
            const sortOrder = document.createElement('div');
            sortOrder.className = 'sort-order';
            sortOrder.innerHTML = `
                <label for="sortSelect">Ordenar por:</label>
                <select id="sortSelect">
                    <option value="default">Por defecto</option>
                    <option value="price-asc">Precio: menor a mayor</option>
                    <option value="price-desc">Precio: mayor a menor</option>
                    <option value="name-asc">Nombre: A-Z</option>
                    <option value="name-desc">Nombre: Z-A</option>
                    <option value="team-asc">Equipo: A-Z</option>
                    <option value="team-desc">Equipo: Z-A</option>
                    <option value="season-desc">Temporada: más reciente</option>
                    <option value="season-asc">Temporada: más antigua</option>
                </select>
            `;
            
            // Agregar los controles al contenedor
            controlsContainer.appendChild(leagueFilter);
            controlsContainer.appendChild(sortOrder);

            // Contador de productos
            const countEl = document.createElement('div');
            countEl.id = 'productCount';
            countEl.className = 'product-count';
            countEl.setAttribute('aria-live', 'polite');
            // Inicialmente muestra todos
            countEl.textContent = `Mostrando ${Array.isArray(PRODUCTS) ? PRODUCTS.length : 0} de ${Array.isArray(PRODUCTS) ? PRODUCTS.length : 0} productos`;
            controlsContainer.appendChild(countEl);
            
            // Buscar el contenedor del buscador para insertar los controles debajo
            const searchWrap = document.querySelector('.product-search-wrap');
            if (searchWrap) {
                // Insertar después del buscador
                searchWrap.parentNode.insertBefore(controlsContainer, searchWrap.nextSibling);
            } else {
                // Si no hay buscador, insertar al principio del contenedor
                container.insertBefore(controlsContainer, container.firstChild);
            }
            
            // Agregar event listeners (solo sort, el filtro por liga se maneja en el dropdown personalizado)
            
            document.getElementById('sortSelect').addEventListener('change', function(e) {
                currentSortOrder = e.target.value;
                renderGallery(document.getElementById('productSearch')?.value || '');
            });
        }
        
        function renderGallery(filterText){
            const container = byId('productGallery');
            container.innerHTML = '';
            
            // Crear controles de filtrado y ordenamiento si no existen
            if (!document.getElementById('galleryControls')) {
                createGalleryControls(container);
            } else {
                // Asegurarse de que los controles estén debajo del buscador
                const controls = document.getElementById('galleryControls');
                const searchWrap = document.querySelector('.product-search-wrap');
                
                if (controls && searchWrap) {
                    // Mover los controles debajo del buscador
                    searchWrap.parentNode.insertBefore(controls, searchWrap.nextSibling);
                }
            }
            
            // Normalizar y eliminar tildes tanto en la consulta como en los nombres de productos
            const normalizeNoAccents = (s)=> (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const q = normalizeNoAccents(filterText || '');
            // Base aleatoria por carga: se calcula una vez y se reutiliza en renderizados posteriores
            const base = (function(){
                if (Array.isArray(window._PRODUCTS_SHUFFLED)) return window._PRODUCTS_SHUFFLED;
                const copy = Array.isArray(PRODUCTS) ? PRODUCTS.slice() : [];
                for (let i = copy.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    const tmp = copy[i]; copy[i] = copy[j]; copy[j] = tmp;
                }
                window._PRODUCTS_SHUFFLED = copy;
                return copy;
            })();
            let list = base.filter(p => { 
                if (!q) return true; 
                const nameNoAccents = normalizeNoAccents(p.name || '');
                return nameNoAccents.indexOf(q) !== -1; 
            });
            
            // Aplicar filtro por liga
            if (currentLeagueFilter !== 'all') {
                list = list.filter(p => {
                    const league = getLeagueFromProduct(p);
                    return league === currentLeagueFilter;
                });
            }
            
            // Filtrar por equipo específico si está seleccionado
            if (currentTeamFilter !== 'all') {
                const target = canonicalizeTeamName(currentTeamFilter);
                list = list.filter(p => normalizeNoAccentsGlobal(canonicalizeTeamName(getTeamFromProduct(p))) === normalizeNoAccentsGlobal(target));
            }
            
            // Aplicar ordenamiento
            if (currentSortOrder === 'price-asc') {
                list.sort((a, b) => a.price - b.price);
            } else if (currentSortOrder === 'price-desc') {
                list.sort((a, b) => b.price - a.price);
            } else if (currentSortOrder === 'name-asc' || currentSortOrder === 'name-desc') {
                list.sort((a, b) => {
                    const an = normalizeNoAccentsGlobal(a.name || '');
                    const bn = normalizeNoAccentsGlobal(b.name || '');
                    return currentSortOrder === 'name-asc' ? an.localeCompare(bn) : bn.localeCompare(an);
                });
            } else if (currentSortOrder === 'team-asc' || currentSortOrder === 'team-desc') {
                list.sort((a, b) => {
                    const ta = normalizeNoAccentsGlobal(canonicalizeTeamName(getTeamFromProduct(a)) || '');
                    const tb = normalizeNoAccentsGlobal(canonicalizeTeamName(getTeamFromProduct(b)) || '');
                    return currentSortOrder === 'team-asc' ? ta.localeCompare(tb) : tb.localeCompare(ta);
                });
            } else if (currentSortOrder === 'season-desc' || currentSortOrder === 'season-asc') {
                list.sort((a, b) => {
                    const ya = getSeasonYearFromProduct(a) || 0;
                    const yb = getSeasonYearFromProduct(b) || 0;
                    return currentSortOrder === 'season-desc' ? (yb - ya) : (ya - yb);
                });
            }
            
            // Actualizar contador de productos
            const totalCount = Array.isArray(PRODUCTS) ? PRODUCTS.length : 0;
            const currentCount = list.length;
            const countBox = document.getElementById('productCount');
            if (countBox) {
                countBox.textContent = `Mostrando ${currentCount} de ${totalCount} productos`;
            }
            
            // Mostrar todos los productos juntos
            list.forEach(p => {
                    const el = document.createElement('article');
                    el.className = 'product-item';
                    // Make the entire card clickable: attach data attributes to the article
                    el.setAttribute('data-id', p.id);
                    el.setAttribute('data-action', 'add');
                    // If the product has an images array render a mini carousel; otherwise render the simple card
                    if (p.images && p.images.length) {
                        const imgsJson = JSON.stringify(p.images);
                        el.innerHTML = `
                            <div class="pedido-mini-card" data-images='${imgsJson}'>
                                <div style="display:flex;justify-content:center;">
                                    <div style="max-width:800px;width:100%;aspect-ratio:1/1;overflow:hidden;border-radius:8px;">
                                        <img class="pedido-carrusel-img" src="${p.images[0]}" alt="${p.name}" loading="lazy" width="1512" height="1512" style="width:100%;height:100%;object-fit:cover;display:block;">
                                    </div>
                                </div>
                                <h4 style="margin-top:6px">${p.name}</h4>
                                <div class="price">€${p.price.toFixed(2)}</div>
                                <div class="excerpt">${p.excerpt}</div>
                                <!-- boton eliminado: la tarjeta completa es clicable -->
                            </div>
                        `;
                    } else {
                        el.innerHTML = `
                                <div style="width:100%;aspect-ratio:1/1;overflow:hidden;border-radius:8px;">
                                    <img src="${p.img}" alt="${p.name}" loading="lazy" width="1512" height="1512" style="width:100%;height:100%;object-fit:cover;display:block;">
                                </div>
                                <h4>${p.name}</h4>
                                <div class="price">€${p.price.toFixed(2)}</div>
                                <div class="excerpt">${p.excerpt}</div>
                                <!-- boton eliminado: la tarjeta completa es clicable -->
                            `;
                    }
                    container.appendChild(el);
                });
        }

        function openProductModal(product){
            // panel simple: generate options inline
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.left = '0'; modal.style.top = '0'; modal.style.width = '100vw'; modal.style.height = '100vh';
            modal.style.display = 'flex';
            modal.style.alignItems = 'flex-start';
            modal.style.justifyContent = 'center';
            modal.style.background = 'rgba(2,6,23,0.7)';
            modal.style.zIndex = 1200;
            modal.style.padding = '0';
            modal.style.margin = '0';
            modal.style.maxWidth = '100vw';
            modal.style.overflow = 'hidden';
            modal.innerHTML = `
                <div class="product-modal-container" style="width:100%;max-width:280px;background:#071735;padding:8px;border-radius:8px;color:#dbeeff;overflow:visible;box-sizing:border-box;display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:start;">
                <style>
                @media (min-width: 992px) {
                    .product-modal-container {
                        max-width: calc(100vw - 300px) !important;
                        max-height: calc(100vh - 300px) !important;
                        width: calc(100vw - 300px) !important;
                        padding: 40px !important;
                        margin: 150px !important;
                        border-radius: 20px !important;
                    }
                }
                @media (max-width: 768px) {
                    #modal-tienda-carrusel > div > div {
                        max-width: 240px !important;
                        width: 85vw !important;
                        border-radius: 6px !important;
                        margin: 0 auto !important;
                        padding: 6px !important;
                    }
                }
                @media (max-width: 480px) {
                    #modal-tienda-carrusel > div > div {
                        max-width: 220px !important;
                        width: 80vw !important;
                        padding: 5px !important;
                    }
                }
                @media (max-width: 320px) {
                    #modal-tienda-carrusel > div > div {
                        max-width: 200px !important;
                        width: 90vw !important;
                        padding: 4px !important;
                    }
                }
                
                /* Estilos para desktop - aumentar tamaño de título y precio */
                @media (min-width: 769px) {
                    .product-title-desktop {
                        font-size: 2.5rem !important;
                    }
                    .product-excerpt-desktop {
                        font-size: 1.6rem !important;
                    }
                    .product-price-desktop {
                        font-size: 2.2rem !important;
                    }
                }
                </style>
                    <div style="display:flex;flex-direction:column;gap:6px;align-items:center;">
                        <img src="${product.img}" alt="${product.name}" loading="lazy" width="1512" height="1512" style="width:100%;max-width:400px;aspect-ratio:1/1;object-fit:cover;border-radius:16px;margin:0 auto;">
                        <div style="width:100%;">
                            <h3 style="margin:0;color:var(--azul-acento);font-size:2rem;text-align:center;" class="product-title-desktop">${product.name}</h3>
                            <p style="color:#d6e9ff;font-size:1.3rem;margin:8px 0;text-align:center;" class="product-excerpt-desktop">${product.excerpt}</p>
                            <p style="font-weight:800;font-size:1.8rem;color:#9fe0ff;margin:8px 0;text-align:center;" class="product-price-desktop">€${product.price.toFixed(2)}</p>
                            <form id="_personalizeForm" style="margin-top:16px;display:grid;grid-template-columns:1fr;gap:16px;align-items:start;font-size:1.2rem;">
                                <label style="font-weight:600;color:#dbeeff;font-size:1.6rem;">Nombre y número (+2€)
                                     <input id="_opt_dorsal" placeholder="Ej: MESSI 10" style="width:100%;padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;margin-top:12px;font-size:1.3rem;" />
                                 </label>

                                <label style="font-weight:600;color:#dbeeff;font-size:1.6rem;">Parche (+1€)
                                    <select id="_opt_parche_select" class="custom-select" style="margin-top:8px;width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-size:1.1rem;">
                                        <option value="none">Ninguno</option>
                                        <option value="LaLiga">LaLiga</option>
                                        <option value="Premier League">Premier League</option>
                                        <option value="Ligue 1">Ligue 1</option>
                                        <option value="Serie A">Serie A</option>
                                        <option value="Bundesliga">Bundesliga</option>
                                        <option value="Champions League">Champions League</option>
                                        <option value="Europa League">Europa League</option>
                                        <option value="Eurocopa">Eurocopa</option>
                                        <option value="Otros">Otros</option>
                                    </select>
                                </label>
                                <label id="_opt_parche_otros_wrap" style="display:none;font-size:1.6rem;">
                                    <input id="_opt_parche_otros" placeholder="Indica el parche" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-size:1.1rem;" />
                                </label>

                                <label style="font-weight:600;color:#dbeeff;font-size:1.6rem;"> Talla:
                                    <select id="_opt_talla" class="custom-select input-talla" style="margin-top:8px;width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-size:1.1rem;">
                                        <option value="S">S</option>
                                        <option value="M">M</option>
                                        <option value="L">L</option>
                                        <option value="XL">XL</option>
                                        <option value="2XL">2XL (+1€)</option>
                                        <option value="3XL">3XL (+2€)</option>
                                        <option value="4XL">4XL (+2€)</option>
                                    </select>
                                </label>

                                <label style="font-weight:600;color:#dbeeff;font-size:1.6rem;"> Versión (elige una):
                                    <select id="_opt_version" class="custom-select" style="margin-top:8px;width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-size:1.1rem;">
<option value="fan" selected>FAN</option>
                                        <option value="fan">FAN</option>
                                        <option value="jugador">JUGADOR (+5€)</option>
                                    </select>
                                </label>
                                <div style="margin-top:12px;text-align:center;">
                                    <button id="_sizeGuideBasic" type="button" style="background:transparent;color:var(--azul-acento);border:none;padding:0;cursor:pointer;font-family:inherit;font-size:1.5rem;font-weight:600;transition:all 0.2s ease;position:relative;padding-bottom:4px;display:inline-block;border-bottom:2px solid var(--azul-acento);">Guía de tallas</button>
                                </div>
                            </form>
                            <div style="margin-top:20px;display:flex;flex-direction:column;gap:16px;">
                                <button id="_addCart" class="btn-primary" style="padding:18px;font-size:1.4rem;">Personalizar y Comprar</button>
                                <button id="_closeModal" class="btn-secondary" style="padding:16px;font-size:1.3rem;">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            if (!document.getElementById('modalTiendaResponsiveStyles')){
                const st = document.createElement('style'); st.id = 'modalTiendaResponsiveStyles';
                st.textContent = `
                 @media (max-width: 768px){
                     #modal-tienda-carrusel{ padding:0 !important; margin:0 !important; align-items:flex-start !important; overflow-x:hidden !important; width:100vw !important; max-width:100vw !important; left:0 !important; right:0 !important; }
                     #modal-tienda-carrusel .tienda-panel{ grid-template-columns:1fr !important; max-width:100vw !important; width:100vw !important; min-width:100vw !important; overflow:hidden !important; box-sizing:border-box !important; margin:0 !important; border-radius:0 !important; }
                     #modal-tienda-carrusel .tienda-panel > div{ max-width:100vw !important; width:100vw !important; box-sizing:border-box !important; }
                     #modal-tienda-carrusel .tienda-panel img{ max-width:100% !important; height:auto !important; }
                     #modalTiendaThumbs{ flex-wrap: wrap; }
                 }
                 @media (max-width: 480px){
                     #modal-tienda-carrusel{ padding:0 !important; }
                     #modal-tienda-carrusel .tienda-panel{ max-width:100vw !important; width:100vw !important; height:100dvh !important; max-height:100dvh !important; border-radius:0 !important; display:flex !important; flex-direction:column !important; gap:8px !important; overflow:hidden !important; }
                     #modal-tienda-carrusel .tienda-panel > div{ border-radius:0 !important; }
                     #modal-tienda-carrusel .tienda-panel > div:last-child{ flex:1 1 auto !important; overflow:auto !important; display:flex !important; flex-direction:column !important; }
                     #modal-tienda-carrusel .tienda-panel > div:first-child{ flex:0 0 auto !important; }
                     #modalTiendaCarousel{ width:100% !important; max-height:45vh !important; aspect-ratio:auto !important; }
                     #modalTiendaCarousel .carousel-track > div{ aspect-ratio:auto !important; height:auto !important; }
                     #modalTiendaCarousel img{ width:100% !important; height:auto !important; object-fit:cover !important; }
                     #modalTiendaThumbs{ overflow-x:auto !important; -webkit-overflow-scrolling:touch !important; justify-content:flex-start !important; gap:8px !important; padding:6px 8px !important; }
                     #modal-tienda-carrusel #modalTiendaPersonalizar{ position:sticky !important; bottom:0 !important; margin-top:auto !important; padding:12px !important; }
                     #modal-tienda-carrusel .tienda-panel > div:last-child form{ padding:12px !important; }
                     #modal-tienda-carrusel .tienda-panel > div:last-child h3{ font-size:1.1rem !important; margin-bottom:8px !important; }
                     #modal-tienda-carrusel .tienda-panel > div:last-child .btn-primary,
                     #modal-tienda-carrusel .tienda-panel > div:last-child .btn-secondary{ width:100% !important; margin:4px 0 !important; padding:12px !important; font-size:0.9rem !important; }
                 }
                 @media (max-width: 390px){
                     #modal-tienda-carrusel .tienda-panel > div:last-child{ padding:8px !important; }
                     #modal-tienda-carrusel .tienda-panel > div:last-child form{ padding:8px !important; }
                     #modal-tienda-carrusel .tienda-panel > div:last-child h3{ font-size:1rem !important; }
                     #modalTiendaCarousel{ max-height:40vh !important; }
                 }
                 `;
                document.head.appendChild(st);
            }

            // Ajuste automático para hacer el modal extremadamente estrecho
            const panel = modal.firstElementChild;
            function __fitPanel(){
                if (!panel) return;
                if (window.innerWidth <= 768) {
                    // En móvil, hacer el modal extremadamente estrecho
                    panel.style.transform = 'none';
                    panel.style.maxWidth = '240px';
                    panel.style.width = '85vw';
                    panel.style.margin = '0 auto';
                    panel.style.borderRadius = '6px';
                    panel.style.padding = '6px';
                    
                    // Ajustar para pantallas más pequeñas
                    if (window.innerWidth <= 480) {
                        panel.style.maxWidth = '220px';
                        panel.style.width = '80vw';
                        panel.style.padding = '5px';
                    }
                    
                    // Ajustar para pantallas muy pequeñas
                    if (window.innerWidth <= 320) {
                        panel.style.maxWidth = '200px';
                        panel.style.width = '90vw';
                        panel.style.padding = '4px';
                    }
                    
                    // Ajustar imagen y contenido
                    const img = panel.querySelector('img');
                    if (img) {
                        img.style.width = '80px';
                        img.style.height = '80px';
                        
                        if (window.innerWidth <= 320) {
                            img.style.width = '70px';
                            img.style.height = '70px';
                        }
                    }
                } else {
                    // En desktop, ocupar casi toda la pantalla con 150px de margen
                    panel.style.transformOrigin = 'center center';
                    panel.style.maxWidth = 'calc(100vw - 300px)';
                    panel.style.maxHeight = 'calc(100vh - 300px)';
                    panel.style.width = 'calc(100vw - 300px)';
                    panel.style.padding = '40px';
                    panel.style.margin = '150px';
                    panel.style.borderRadius = '20px';
                    panel.style.overflow = 'auto';
                    const availH = Math.max(0, window.innerHeight - 300);
                    const availW = Math.max(0, window.innerWidth - 300);
                    const rectH = panel.scrollHeight;
                    const rectW = panel.scrollWidth;
                    const scale = Math.min(1, (availH > 0 ? availH / rectH : 1), (availW > 0 ? availW / rectW : 1));
                    panel.style.transform = `scale(${scale})`;
                }
            }
            __fitPanel();
            window.addEventListener('resize', __fitPanel);

            // Cerrar al hacer click fuera del panel y restaurar scroll del body
            function __closeProductModal(){
                window.removeEventListener('resize', __fitPanel);
                modal.remove();
                document.body.style.overflow = '';
            }
            modal.addEventListener('click', (e)=>{ if (e.target === modal) { __closeProductModal(); } });

                // Visor ampliado: click en la imagen principal para abrir a pantalla completa
                try {
                    const imgsForViewer = (Array.isArray(product.images) && product.images.length) ? product.images : [product.img];
                    const mainImgEl = modal.querySelector('img');
                    if (mainImgEl) {
                        mainImgEl.style.cursor = 'zoom-in';
                        mainImgEl.addEventListener('click', (e)=>{ e.stopPropagation(); openImageViewer(imgsForViewer, 0); });
                    }
                } catch(e) {}

                // Cerrar modal al pulsar el botón o al hacer click fuera del panel
                modal.querySelector('#_closeModal').addEventListener('click', ()=> modal.remove());
                modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });

                // Guía de tallas overlay
                const _sizeGuideBtn = modal.querySelector('#_sizeGuideBasic');
                if (_sizeGuideBtn) {
                    _sizeGuideBtn.addEventListener('click', ()=>{
                        const overlay = document.createElement('div');
                        overlay.style.position='fixed'; overlay.style.left=0; overlay.style.top=0; overlay.style.right=0; overlay.style.bottom=0;
                        overlay.style.background='rgba(0,0,0,0.85)'; overlay.style.zIndex=5000; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
                        const isNBA = /^nba/i.test(product.id) || /\bNBA\b/i.test(product.name);
                        const isKids = /kids/i.test(product.id) || /\((kids|niños)\)/i.test(product.name);
                        const guideSrc = isKids ? 'assets/images/guia tallas niños.png' : (isNBA ? 'assets/images/guias tallas nba.png' : 'assets/images/guia tallas camisetas futbol.png');
                        const guideAlt = isKids ? 'Guía de tallas Niños' : (isNBA ? 'Guía de tallas NBA' : 'Guía de tallas Fútbol');
                        overlay.innerHTML = `
                            <div style="position:relative;width:auto;max-width:98vw;max-height:98vh;background:transparent;border-radius:12px;padding:0;box-shadow:0 12px 40px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;overflow:auto;">
                                <button aria-label="Cerrar" style="position:absolute;top:8px;right:8px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:500;transition:all 0.2s ease;font-size:0.9rem;">✕ Cerrar</button>
                                <img src="${guideSrc}" alt="${guideAlt}" loading="lazy" style="${isKids ? 'height:65vh;max-height:65vh;max-width:88vw;width:auto;object-fit:contain;border-radius:6px;display:block;' : 'height:80vh;max-height:80vh;max-width:98vw;width:auto;object-fit:contain;border-radius:6px;display:block;'}">
                            </div>
                        `;
                        document.body.appendChild(overlay);
                        const panel = overlay.firstElementChild;
                        const closeBtn = panel.querySelector('button');
                        const close = ()=> overlay.remove();
                        closeBtn.addEventListener('click', (e)=>{ e.stopPropagation(); close(); });
                        overlay.addEventListener('click', (e)=>{ if (e.target === overlay) close(); });
                    });
                }
                try {
                    const __isKids = /kids/i.test(product.id) || /\((kids|niños)\)/i.test(product.name);
                    if (__isKids) {
                        const tallaSel = modal.querySelector('#_opt_talla');
                        if (tallaSel) {
                            tallaSel.innerHTML = `
                                <option value="16">16</option>
                                <option value="18">18</option>
                                <option value="20">20</option>
                                <option value="22">22</option>
                                <option value="24">24</option>
                                <option value="26">26</option>
                                <option value="28">28</option>
                            `;
                        }
                        const verSel = modal.querySelector('#_opt_version');
                        const verLabel = verSel ? verSel.parentElement : null;
                        if (verSel) verSel.value = 'none';
                        if (verLabel) verLabel.style.display = 'none';
                    }
                    const __isNBA = /^nba/i.test(product.id) || /\bNBA\b/i.test(product.name);
                    if (__isNBA) {
                        const verSel = modal.querySelector('#_opt_version');
                        const verLabel = verSel ? verSel.parentElement : null;
                        if (verLabel) verLabel.style.display = 'none';
                        const parcheSel = modal.querySelector('#_opt_parche_select');
                        const parcheLabel = parcheSel ? parcheSel.parentElement : null;
                        if (parcheLabel) parcheLabel.style.display = 'none';
                        const otrosWrap = modal.querySelector('#_opt_parche_otros_wrap');
                        if (otrosWrap) otrosWrap.style.display = 'none';
                        }
                } catch(e) {}
            // Si el producto define versiones y sólo hay una opción, preseleccionarla y ocultar el selector
            try {
                if (product && Array.isArray(product.versions)) {
                    const verSelect = modal.querySelector('#_opt_version');
                    const verLabel = verSelect ? verSelect.parentElement : null;
                    if (verSelect) {
                        if (product.versions.length === 1) {
                            verSelect.value = product.versions[0];
                            if (verLabel) { verLabel.style.display = 'none'; }
                        } else {
                            // Múltiples versiones: seleccionar 'fan' por defecto si existe
                            const optFan = Array.from(verSelect.options).find(o => o.value.toLowerCase() === 'fan');
                            if (optFan) verSelect.value = 'fan';
                        }
                    }
                }
            } catch(e) { /* ignore if modal not present */ }
            // show/hide 'otros' field for parche
            const parcheSelect = modal.querySelector('#_opt_parche_select');
            const parcheOtrosWrap = modal.querySelector('#_opt_parche_otros_wrap');
            const parcheOtrosInput = modal.querySelector('#_opt_parche_otros');
            if (parcheSelect) {
                parcheSelect.addEventListener('change', function(){
                    if (this.value === 'Otros') { parcheOtrosWrap.style.display = ''; parcheOtrosInput.focus(); }
                    else { parcheOtrosWrap.style.display = 'none'; parcheOtrosInput.value = ''; }
                });
            }
            // Aviso con enlace clickable cuando el usuario selecciona versión JUGADOR (modal básico)
             const versionSelectBasic = modal.querySelector('#_opt_version');
             if (versionSelectBasic) {
                 versionSelectBasic.addEventListener('change', function(){
                     if (this.value === 'jugador') {
                         const overlay = document.createElement('div');
                         overlay.style.position='fixed'; overlay.style.left=0; overlay.style.top=0; overlay.style.right=0; overlay.style.bottom=0;
                         overlay.style.background='rgba(0,0,0,0.55)'; overlay.style.zIndex=6000; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
                         overlay.innerHTML = `
                             <div style="max-width:520px;background:#071735;color:#dbeeff;padding:16px 18px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.4);font-size:0.95rem;line-height:1.45;">
                                 <div style="margin-bottom:12px;">
                                     Has seleccionado la versión JUGADOR. Debes encontrar la camiseta en el siguiente enlace:<br>
                                     <a href="https://hxltds.x.yupoo.com/" target="_blank" rel="noopener noreferrer" style="color:#60a5fa;text-decoration:underline;word-break:break-all;">https://hxltds.x.yupoo.com/</a>.<br>
                                     Si no la encuentras, contáctanos primero por Instagram.
                                 </div>
                                 <div style="display:flex;justify-content:flex-end;gap:8px;">
                                     <button id="jugadorNoticeClose" type="button" style="background:#1f2a44;border:none;color:#dbeeff;padding:8px 12px;border-radius:8px;cursor:pointer;">Cerrar</button>
                                     <a href="https://hxltds.x.yupoo.com/" target="_blank" rel="noopener noreferrer" style="background:#2563eb;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;">Abrir enlace</a>
                                 </div>
                             </div>`;
                         document.body.appendChild(overlay);
                         overlay.addEventListener('click', (e)=>{ if (e.target === overlay) overlay.remove(); });
                         const closeBtn = overlay.querySelector('#jugadorNoticeClose');
                         if (closeBtn) closeBtn.addEventListener('click', ()=> overlay.remove());
                     }
                 });
             }

            modal.querySelector('#_addCart').addEventListener('click', ()=>{
                const talla = modal.querySelector('#_opt_talla').value;
                const dorsal = modal.querySelector('#_opt_dorsal').value.trim();
                const __isNBA = /^nba/i.test(product.id) || /\bNBA\b/i.test(product.name);
                // En NBA: dorsal obligatorio y sin parches ni versión
                let parcheFinal = '';
                let version = 'none';
                if (!__isNBA) {
                    const parcheSel = modal.querySelector('#_opt_parche_select').value;
                    if (parcheSel === 'Otros') {
                        const otros = modal.querySelector('#_opt_parche_otros').value.trim();
                        if (!otros) { alert('Indica el parche en el campo "Otros".'); modal.querySelector('#_opt_parche_otros').focus(); return; }
                        parcheFinal = otros;
                    } else {
                        parcheFinal = (parcheSel === 'none' ? '' : parcheSel);
                    }
                    version = modal.querySelector('#_opt_version').value;
                    if (!version) { alert('Selecciona una versión antes de añadir al carrito.'); return; }
                }
                if (__isNBA && !dorsal) { alert('Debes introducir un dorsal para camisetas NBA.'); return; }
                addToCart({ productId: product.id, name: product.name, price: product.price, img: product.img, talla, dorsal, parche: parcheFinal, version });
                modal.remove();
                document.body.style.overflow = '';
            });
        }

        // Nuevo: abrir modal que reutiliza el carrusel/programación visual de la tienda
        function openTiendaCarouselModal(product) {
            if (document.getElementById('modal-tienda-carrusel')) return;
            const modal = document.createElement('div');
            modal.id = 'modal-tienda-carrusel';
            modal.style.position = 'fixed';
            modal.style.left = 0; modal.style.top = 0; modal.style.right = 0; modal.style.bottom = 0;
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.background = 'rgba(2,6,23,0.78)'; modal.style.zIndex = 1400;
            modal.style.padding = '24px';
            modal.style.overflow = 'auto';

            // Build carousel HTML dynamically from product.images (fallback to [product.img])
            const imgs = Array.isArray(product.images) && product.images.length ? product.images : [product.img];
            const slidesHtml = imgs.map((src, i) => `<div style="flex:0 0 100%;width:100%;aspect-ratio:1/1;overflow:hidden;border-radius:4px;min-width:100%;"><img src="${src}" alt="Imagen ${i+1} de ${imgs.length}" loading="lazy" width="1512" height="1512" style="width:100%;height:100%;object-fit:cover;display:block;"></div>`).join('');
            const thumbsHtml = imgs.map((src, i) => `<img data-index="${i}" src="${src}" alt="Miniatura ${i+1} de ${imgs.length}" loading="lazy" class="${i === 0 ? 'active-thumb' : ''}" style="width:56px;height:56px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid rgba(255,255,255,0.06);">`).join('');

            modal.innerHTML = `
                <div class="tienda-panel" style="width:100%;max-width:720px;background:#071735;padding:8px;border-radius:8px;color:#dbeeff;display:grid;grid-template-columns:1fr 240px;gap:8px;overflow:visible;">
                    <div style="background:rgba(10,31,61,0.6);padding:6px;border-radius:6px;">
                        <div id="modalTiendaCarousel" style="position:relative;overflow:hidden;border-radius:8px;">
                            <button id="modalTiendaPrev" aria-label="Anterior" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);z-index:5;background:rgba(0,0,0,0.4);border:none;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;">‹</button>
                            <div class="carousel-track" style="display:flex;transition:transform .35s ease;">
                                ${slidesHtml}
                            </div>
                            <button id="modalTiendaNext" aria-label="Siguiente" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);z-index:5;background:rgba(0,0,0,0.4);border:none;color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer;">›</button>
                        </div>
                        <div id="modalTiendaThumbs" style="display:flex;gap:4px;margin-top:6px;justify-content:center;padding:3px;">
                            ${thumbsHtml}
                        </div>
                    </div>
                    <div style="background:rgba(10,31,61,0.9);padding:10px;border-radius:6px;border:1px solid rgba(42,91,168,0.12);overflow:visible;">
                        <h3 style="color:var(--azul-acento);margin-top:0;font-size:1rem;">${product.name}</h3>
                        <p style="color:#d6e9ff;font-size:0.8rem;margin:4px 0;">${product.excerpt}</p>
                        <div style="font-weight:800;color:#9fe0ff;font-size:1.1rem;margin:6px 0;">€${product.price.toFixed(2)}</div>
                        <div style="display:flex;gap:4px;flex-direction:column;">
                            <button id="modalTiendaPersonalizar" class="btn-primary" style="padding:6px 12px;font-size:0.8rem;">Personalizar y Comprar</button>
                        </div>
                    </div>
                </div>
                <button id="modalTiendaClose" aria-label="Cerrar" style="position:fixed;top:18px;right:18px;background:transparent;border:2px solid rgba(255,255,255,0.12);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;z-index:1500;">Cerrar</button>
            `;

            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';

            // Ajuste automático de escala para que el panel del carrusel quepa sin scroll
            const panel = modal.firstElementChild;
            function __fitTiendaPanel(){
                if (!panel) return;
                panel.style.transformOrigin = 'center center';
                if (window.innerWidth <= 768){ panel.style.transform = 'none'; return; }
                const availH = Math.max(0, window.innerHeight - 48);
                const availW = Math.max(0, window.innerWidth - 48);
                const rectH = panel.scrollHeight;
                const rectW = panel.scrollWidth;
                const scale = Math.min(1, (availH > 0 ? availH / rectH : 1), (availW > 0 ? availW / rectW : 1));
                panel.style.transform = scale < 1 ? `scale(${scale})` : 'none';
            }
            __fitTiendaPanel();
            window.addEventListener('resize', __fitTiendaPanel);

            function __closeTienda(){
                window.removeEventListener('resize', __fitTiendaPanel);
                modal.remove();
                document.body.style.overflow = '';
            }
            document.getElementById('modalTiendaClose').addEventListener('click', ()=> { __closeTienda(); });
            // Cerrar modal al hacer click fuera del panel principal
            modal.addEventListener('click', (e) => { if (e.target === modal) { __closeTienda(); } });

            // Carousel logic (scoped to modal)
            const track = modal.querySelector('.carousel-track');
            const slides = Array.from(track.querySelectorAll('div[style*="flex:0 0 100%"]'));
            let idx = 0;
            const prev = modal.querySelector('#modalTiendaPrev');
            const next = modal.querySelector('#modalTiendaNext');
            const thumbs = modal.querySelector('#modalTiendaThumbs');
            // Visor ampliado: click en el carrusel para abrir a pantalla completa en el índice actual
            try { track.style.cursor = 'zoom-in'; track.addEventListener('click', (e)=>{ e.stopPropagation(); openImageViewer(imgs, idx); }); } catch(e) {}
            function update(){ 
                track.style.transform = `translateX(-${idx * 100}%)`; 
                Array.from(thumbs.children).forEach((t,i)=> {
                    // Eliminar outline antiguo y usar clase active-thumb en su lugar
                    t.style.outline = 'none';
                    t.classList.toggle('active-thumb', i === idx);
                }); 
            }
            prev && prev.addEventListener('click', (e)=>{ e.stopPropagation(); idx = (idx-1+slides.length)%slides.length; update(); });
            next && next.addEventListener('click', (e)=>{ e.stopPropagation(); idx = (idx+1)%slides.length; update(); });
            if (thumbs) thumbs.addEventListener('click', (e)=>{ const t = e.target.closest('img[data-index]'); if (!t) return; idx = parseInt(t.dataset.index,10); update(); });
            update();

            // Autoplay every 5s with robust start/stop (avoid duplicated intervals)
            let autoplayTimer = null;
            function startAutoplay(){ if (autoplayTimer) clearInterval(autoplayTimer); autoplayTimer = setInterval(()=>{ idx = (idx+1)%slides.length; update(); }, 5000); }
            function stopAutoplay(){ if (autoplayTimer) { clearInterval(autoplayTimer); autoplayTimer = null; } }
            startAutoplay();
            const carouselWrap = modal.querySelector('#modalTiendaCarousel');
            [carouselWrap, prev, next, thumbs, modal].forEach(el => { if (!el) return; el.addEventListener('mouseenter', ()=> stopAutoplay()); el.addEventListener('mouseleave', ()=> startAutoplay()); });

            // Reemplazamos el botón de personalizar por un formulario embebido en la columna derecha
            const rightCol = modal.querySelector('div[style*="background:rgba(10,31,61,0.9)"]');
            if (rightCol) {
                rightCol.innerHTML = `
                    <h3 style="color:var(--azul-acento);margin-top:0;font-size:1.4rem;" class="product-title-desktop">${product.name}</h3>
                    <p style="color:#d6e9ff;font-size:1.2rem;margin:4px 0;" class="product-excerpt-desktop">${product.excerpt}</p>
                    <div style="font-weight:800;color:#9fe0ff;font-size:1.4rem;margin:6px 0;" class="product-price-desktop">€${product.price.toFixed(2)}</div>
                    <form id="modalTiendaForm" style="display:grid;gap:4px;overflow:visible;font-size:0.8rem;">
                        <label style="font-weight:700;color:#dbeeff;font-size:1.3rem;">Nombre y número (+2€)
                             <input id="_opt_dorsal_modal" placeholder="Ej: JAMES 6" style="width:100%;padding:8px;border-radius:4px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;margin-top:8px;font-size:1.0rem;" />
                         </label>
                        <label style="font-size:1.3rem;">Talla:
                            <select id="_opt_talla_modal" class="custom-select input-talla" style="margin-top:3px;padding:4px;border-radius:4px;font-size:1.0rem;">
                                <option value="S">S</option>
                                <option value="M">M</option>
                                <option value="L">L</option>
                                <option value="XL">XL</option>
                                <option value="2XL">2XL (+1€)</option>
                                <option value="3XL">3XL (+2€)</option>
                                <option value="4XL">4XL (+2€)</option>
                            </select>
                        </label>
                        <div style="margin:2px 0 0 0;">
                            <button id="_sizeGuideCarousel" type="button" style="background:transparent;color:var(--azul-acento);border:none;padding:0;cursor:pointer;font-family:inherit;font-size:1.2rem;font-weight:600;transition:all 0.2s ease;position:relative;padding-bottom:1px;display:inline-block;transform:translateX(2px);border-bottom:1px solid var(--azul-acento);">Guía de tallas</button>
                        </div>
                        <div style="display:flex;gap:4px;justify-content:flex-end;margin-top:4px;">
                            <button id="modalTiendaAdd" type="button" class="btn-primary" style="padding:4px 8px;font-size:1.0rem;">Añadir al carrito</button>
                            <button id="modalTiendaCloseInline" type="button" class="btn-secondary" style="padding:4px 8px;font-size:1.0rem;">Cerrar</button>
                        </div>
                    </form>
                `;

                // Inserción dinámica de campos según tipo de producto (NBA/Kids)
                try {
                    const isNBA = /^nba/i.test(product.id) || /\bNBA\b/i.test(product.name);
                    const isKids = /kids/i.test(product.id) || /\((kids|niños)\)/i.test(product.name);
                    const form = rightCol.querySelector('#modalTiendaForm');
                    if (form && !isNBA) {
                        // Insertar Parche (no NBA)
                        if (!rightCol.querySelector('#_opt_parche_select_modal')) {
                            const parcheHTML = `
                        <label style="font-weight:700;color:#dbeeff;font-size:1.3rem;">Parche (+1€)
                            <select id="_opt_parche_select_modal" class="custom-select" style="margin-top:3px;padding:4px;border-radius:4px;font-size:1.0rem;">
                                <option value="none">Ninguno</option>
                                <option value="LaLiga">LaLiga</option>
                                <option value="Premier League">Premier League</option>
                                <option value="Ligue 1">Ligue 1</option>
                                <option value="Serie A">Serie A</option>
                                <option value="Bundesliga">Bundesliga</option>
                                <option value="Champions League">Champions League</option>
                                <option value="Europa League">Europa League</option>
                                <option value="Eurocopa">Eurocopa</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </label>
                        <label id="_opt_parche_otros_wrap_modal" style="display:none;font-size:1.3rem;"><input id="_opt_parche_otros_modal" placeholder="Indica el parche" style="width:100%;padding:4px;border-radius:4px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-size:1.0rem;" /></label>`;
                            const tallaLabel = rightCol.querySelector('#_opt_talla_modal')?.parentElement;
                            if (tallaLabel) tallaLabel.insertAdjacentHTML('beforebegin', parcheHTML);
                            else form.insertAdjacentHTML('beforeend', parcheHTML);
                        }
                        // Insertar Versión si NO es Kids
                        if (!isKids && !rightCol.querySelector('#_opt_version_modal')) {
                            const versionHTML = `
                        <label style="font-size:1.3rem;">Versión:
                            <select id="_opt_version_modal" class="custom-select" style="margin-top:3px;padding:4px;border-radius:4px;font-size:1.0rem;">
                                <option value="fan" selected>FAN</option>
                                <option value="jugador">JUGADOR (+5€)</option>
                            </select>
                        </label>`;
                            // Insertar la versión por encima del botón "Guía de tallas" para mejorar la jerarquía visual
                            const sizeGuideRow = form.querySelector('#_sizeGuideCarousel')?.closest('div');
                            if (sizeGuideRow) {
                                sizeGuideRow.insertAdjacentHTML('beforebegin', versionHTML);
                            } else {
                                const buttonsRow = form.querySelector('div[style*="justify-content:flex-end"]');
                                if (buttonsRow) buttonsRow.insertAdjacentHTML('beforebegin', versionHTML);
                                else form.insertAdjacentHTML('beforeend', versionHTML);
                            }
                            // Asegurar que 'fan' queda seleccionado si el producto define múltiples versiones
                            const verSelModalInit = rightCol.querySelector('#_opt_version_modal');
                            if (verSelModalInit) {
                                const optFan2 = Array.from(verSelModalInit.options).find(o => o.value.toLowerCase() === 'fan');
                                if (optFan2) verSelModalInit.value = 'fan';
                            }
                        }
                        // Reemplazar tallas por numéricas si es Kids (16-28)
                        if (isKids) {
                            const tSel = rightCol.querySelector('#_opt_talla_modal');
                            if (tSel) {
                                tSel.innerHTML = ['16','18','20','22','24','26','28'].map(s=>`<option value="${s}">${s}</option>`).join('');
                            }
                        }
                    } else if (form && isNBA) {
                        // Si es NBA pero es Kids, aún así tallas pueden ser numéricas si el nombre lo indica
                        const isKidsNBA = isKids;
                        const tSel = rightCol.querySelector('#_opt_talla_modal');
                        if (isKidsNBA) {
                            if (tSel) tSel.innerHTML = ['16','18','20','22','24','26','28'].map(s=>`<option value="${s}">${s}</option>`).join('');
                        } else {
                            // Quitar tallas 3XL, 4XL y duplicado XXL en NBA (adulto). Mantener 2XL
                            if (tSel) {
                                ['3XL','4XL'].forEach(val => {
                                    const opt = tSel.querySelector(`option[value="${val}"]`);
                                    if (opt) opt.remove();
                                });
                                if (['3XL','4XL'].includes(tSel.value)) tSel.value = '2XL';
                            }
                        }
                    }
                } catch(e) {}

                // parche otros toggle
                const parcheSelectModal = rightCol.querySelector('#_opt_parche_select_modal');
                const parcheOtrosWrapModal = rightCol.querySelector('#_opt_parche_otros_wrap_modal');
                if (parcheSelectModal) parcheSelectModal.addEventListener('change', function(){ if (this.value === 'Otros') { parcheOtrosWrapModal.style.display = ''; } else { parcheOtrosWrapModal.style.display = 'none'; const inp = rightCol.querySelector('#_opt_parche_otros_modal'); if (inp) inp.value=''; } });
                // Aviso con enlace clickable cuando el usuario selecciona versión JUGADOR (modal carrusel)
                const versionSelectModal = rightCol.querySelector('#_opt_version_modal');
                if (versionSelectModal) {
                    versionSelectModal.addEventListener('change', function(){
                        if (this.value === 'jugador') {
                            const overlay = document.createElement('div');
                            overlay.style.position='fixed'; overlay.style.left=0; overlay.style.top=0; overlay.style.right=0; overlay.style.bottom=0;
                            overlay.style.background='rgba(0,0,0,0.55)'; overlay.style.zIndex=6000; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
                            overlay.innerHTML = `
                                <div style="max-width:520px;background:#071735;color:#dbeeff;padding:16px 18px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.4);font-size:0.95rem;line-height:1.45;">
                                    <div style="margin-bottom:12px;">
                                        Has seleccionado la versión JUGADOR. Debes encontrar la camiseta en el siguiente enlace:<br>
                                        <a href="https://hxltds.x.yupoo.com/" target="_blank" rel="noopener noreferrer" style="color:#60a5fa;text-decoration:underline;word-break:break-all;">https://hxltds.x.yupoo.com/</a>.<br>
                                        Si no la encuentras, contáctanos primero por Instagram.
                                    </div>
                                    <div style="display:flex;justify-content:flex-end;gap:8px;">
                                        <button id="jugadorNoticeClose2" type="button" style="background:#1f2a44;border:none;color:#dbeeff;padding:8px 12px;border-radius:8px;cursor:pointer;">Cerrar</button>
                                        <a href="https://hxltds.x.yupoo.com/" target="_blank" rel="noopener noreferrer" style="background:#2563eb;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;">Abrir enlace</a>
                                    </div>
                                </div>`;
                            document.body.appendChild(overlay);
                            overlay.addEventListener('click', (e)=>{ if (e.target === overlay) overlay.remove(); });
                            const closeBtn = overlay.querySelector('#jugadorNoticeClose2');
                            if (closeBtn) closeBtn.addEventListener('click', ()=> overlay.remove());
                        }
                    });
                }

                // Si el producto define versiones y sólo hay una opción, preseleccionarla y ocultar el selector modal
                try {
                    if (product && Array.isArray(product.versions) && product.versions.length === 1) {
                        const verSelModal = rightCol.querySelector('#_opt_version_modal');
                        const verLabelModal = verSelModal ? verSelModal.parentElement : null;
                        if (verSelModal) verSelModal.value = product.versions[0];
                        if (verLabelModal) verLabelModal.style.display = 'none';
                    }
                } catch(e) {}

                // add to cart from modal right column
                rightCol.querySelector('#modalTiendaAdd').addEventListener('click', ()=>{
                    const talla = rightCol.querySelector('#_opt_talla_modal').value;
                    const dorsal = rightCol.querySelector('#_opt_dorsal_modal').value.trim();
                    const isNBA = /^nba/i.test(product.id) || /\bNBA\b/i.test(product.name);

                    let parcheFinal = '';
                    let version = 'none';
                    if (isNBA) {
                        // En NBA el dorsal es obligatorio y no hay parches ni versión
                        if (!dorsal) { alert('Debes introducir un dorsal para camisetas NBA.'); return; }
                    } else {
                        // No NBA: permitir parches y versión
                        const parcheSelectEl = rightCol.querySelector('#_opt_parche_select_modal');
                        if (parcheSelectEl) {
                            const parcheSel = parcheSelectEl.value;
                            if (parcheSel === 'Otros') {
                                const otros = rightCol.querySelector('#_opt_parche_otros_modal').value.trim();
                                if (!otros) { alert('Indica el parche en el campo "Otros".'); rightCol.querySelector('#_opt_parche_otros_modal').focus(); return; }
                                parcheFinal = otros;
                            } else {
                                parcheFinal = (parcheSel === 'none' ? '' : parcheSel);
                            }
                        }
                        const versionEl = rightCol.querySelector('#_opt_version_modal');
                        version = versionEl ? versionEl.value : 'fan';
                        if (versionEl && !version) { alert('Selecciona una versión antes de añadir al carrito.'); return; }
                    }
                    addToCart({ productId: product.id, name: product.name, price: product.price, img: product.img, talla, dorsal, parche: parcheFinal, version });
                    // opción: cerrar modal tras añadir
                    stopAutoplay(); modal.remove(); document.body.style.overflow = '';
                });
                rightCol.querySelector('#modalTiendaCloseInline').addEventListener('click', ()=> { stopAutoplay(); modal.remove(); document.body.style.overflow = ''; });

                const sizeGuideBtn2 = rightCol.querySelector('#_sizeGuideCarousel');
                if (sizeGuideBtn2){
                    sizeGuideBtn2.addEventListener('click', ()=>{
                        const overlay = document.createElement('div');
                        overlay.style.position='fixed'; overlay.style.left=0; overlay.style.top=0; overlay.style.right=0; overlay.style.bottom=0;
                        overlay.style.background='rgba(0,0,0,0.85)'; overlay.style.zIndex=5000; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
                        const isNBA2 = /^nba/i.test(product.id) || /\bNBA\b/i.test(product.name);
const isKids2 = /kids/i.test(product.id) || /\((kids|niños)\)/i.test(product.name);
const guideSrc2 = isKids2 ? 'assets/images/guia tallas niños.png' : (isNBA2 ? 'assets/images/guias tallas nba.png' : 'assets/images/guia tallas camisetas futbol.png');
const guideAlt2 = isKids2 ? 'Guía de tallas Niños' : (isNBA2 ? 'Guía de tallas NBA' : 'Guía de tallas Fútbol');
                        overlay.innerHTML = `
                            <div style="position:relative;width:auto;max-width:98vw;max-height:98vh;background:transparent;border-radius:12px;padding:0;box-shadow:0 12px 40px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;overflow:auto;">
                                <button aria-label=\"Cerrar\" style=\"position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;\">Cerrar</button>
                                <img src=\"${guideSrc2}\" alt=\"${guideAlt2}\" loading=\"lazy\" style=\"${isKids2 ? 'height:65vh;max-height:65vh;max-width:88vw;width:auto;object-fit:contain;border-radius:6px;display:block;' : 'height:80vh;max-height:80vh;max-width:98vw;width:auto;object-fit:contain;border-radius:6px;display:block;'}\">
                            </div>
                        `;
                        document.body.appendChild(overlay);
                        const panel = overlay.firstElementChild;
                        const closeBtn = panel.querySelector('button');
                        const close = ()=> overlay.remove();
                        closeBtn.addEventListener('click', (e)=>{ e.stopPropagation(); close(); });
                        overlay.addEventListener('click', (e)=>{ if (e.target === overlay) close(); });
                    });
                }
            }
        }

        function openImageViewer(images, startIndex) {
            if (!Array.isArray(images) || images.length === 0) return;
            let idx = Math.max(0, Math.min(startIndex || 0, images.length - 1));

            const overlay = document.createElement('div');
            overlay.id = 'image-viewer-overlay';
            overlay.style.position = 'fixed';
            overlay.style.left = 0; overlay.style.top = 0; overlay.style.right = 0; overlay.style.bottom = 0;
            overlay.style.background = 'rgba(0,0,0,0.88)';
            overlay.style.zIndex = 6000;
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';

            overlay.innerHTML = `
                <div id="iv-panel" style="position:relative;width:92vw;max-width:1200px;height:86vh;max-height:900px;display:flex;align-items:center;justify-content:center;overflow:hidden;border-radius:12px;background:rgba(0,0,0,0.1);border:1px solid rgba(255,255,255,0.12);">
                    <img id="iv-img" src="${images[idx]}" alt="Imagen ${idx+1}" loading="lazy" width="1512" height="1512" style="max-width:100%;max-height:100%;object-fit:contain;will-change:transform;touch-action:none;user-select:none;cursor:zoom-in;" />
                    <button id="iv-prev" aria-label="Anterior" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);z-index:2;background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-size:20px;">‹</button>
                    <button id="iv-next" aria-label="Siguiente" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);z-index:2;background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-size:20px;">›</button>
                    <div id="iv-controls" style="position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:8px;background:rgba(0,0,0,0.45);padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.15);align-items:center;">
                        <button id="iv-toggle" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;">Alternar zoom</button>
                        <button id="iv-reset" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;">Restablecer</button>
                        <span id="iv-index" style="color:#fff;opacity:.8;font-size:.9rem;">${idx+1}/${images.length}</span>
                    </div>
                    <button id="iv-close" aria-label="Cerrar" style="position:absolute;top:12px;right:12px;background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer;">✕ Cerrar</button>
                </div>
            `;

            document.body.appendChild(overlay);

            // Bloquear scroll de fondo mientras el visor está abierto
            const __prevScrollY = window.scrollY;
            const __prevOverflow = document.body.style.overflow;
            const __prevPosition = document.body.style.position;
            const __prevTop = document.body.style.top;
            const __prevWidth = document.body.style.width;
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.top = `-${__prevScrollY}px`;
            document.body.style.width = '100%';

            const panel = overlay.querySelector('#iv-panel');
            const img = overlay.querySelector('#iv-img');
            const btnPrev = overlay.querySelector('#iv-prev');
            const btnNext = overlay.querySelector('#iv-next');
            const btnClose = overlay.querySelector('#iv-close');
            const btnToggle = overlay.querySelector('#iv-toggle');
            const btnReset = overlay.querySelector('#iv-reset');
            const idxLabel = overlay.querySelector('#iv-index');

            let scale = 1, tx = 0, ty = 0;
            const minScale = 1, maxScale = 5;
            let isPanning = false, startX = 0, startY = 0, lastX = 0, lastY = 0;
            let lastTapTime = 0;
            let pinchStartDist = 0, pinchStartScale = 1;
            let panMovedMouse = false, movedDuringPanTouch = false;

            function applyTransform(){ img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`; }
            function resetTransform(){
                scale = 1; tx = 0; ty = 0;
                isPanning = false;
                panMovedMouse = false;
                movedDuringPanTouch = false;
                lastPanEnd = 0;
                lastTapTime = 0;
                img.style.cursor = 'zoom-in';
                applyTransform();
            }
            function updateIndex(){ if (idxLabel) idxLabel.textContent = `${idx+1}/${images.length}`; }
            function showImage(newIdx){ idx = (newIdx + images.length) % images.length; img.src = images[idx]; resetTransform(); updateIndex(); }

            // Navegación
            btnPrev.addEventListener('click', (e)=>{ e.stopPropagation(); showImage(idx - 1); });
            btnNext.addEventListener('click', (e)=>{ e.stopPropagation(); showImage(idx + 1); });

            // Cerrar
            function close(){
                document.removeEventListener('keydown', onKey);
                overlay.remove();
                // Restaurar scroll de fondo
                document.body.style.overflow = __prevOverflow;
                document.body.style.position = __prevPosition;
                document.body.style.top = __prevTop;
                document.body.style.width = __prevWidth;
                window.scrollTo(0, __prevScrollY);
            }
            btnClose.addEventListener('click', (e)=>{ e.stopPropagation(); close(); });
            // Evitar cierre accidental al hacer pan: sólo cerrar si no hubo pan reciente
            let lastPanEnd = 0;
            overlay.addEventListener('click', (e)=>{ if (e.target === overlay && Date.now() - lastPanEnd > 200) close(); });
            function onKey(e){ if (e.key === 'Escape') close(); else if (e.key === 'ArrowLeft') showImage(idx-1); else if (e.key === 'ArrowRight') showImage(idx+1); }
            document.addEventListener('keydown', onKey);

            // Alternar zoom con botón
            btnToggle.addEventListener('click', (e)=>{ e.stopPropagation(); if (scale === 1) { scale = 2; img.style.cursor = 'grab'; } else { resetTransform(); } applyTransform(); });
            btnReset.addEventListener('click', (e)=>{ e.stopPropagation(); resetTransform(); });

            // Rueda para zoom (desktop)
            panel.addEventListener('wheel', (e)=>{
                e.preventDefault();
                const delta = -e.deltaY; // up -> zoom in
                const factor = Math.exp(delta * 0.0015);
                const newScale = Math.min(maxScale, Math.max(minScale, scale * factor));
                if (newScale !== scale) {
                    scale = newScale;
                    img.style.cursor = scale > 1 ? 'grab' : 'zoom-in';
                    applyTransform();
                }
            }, { passive: false });

            // Pan con mouse
            img.addEventListener('mousedown', (e)=>{
                if (scale <= 1) return;
                isPanning = true;
                img.style.cursor = 'grabbing';
                startX = e.clientX; startY = e.clientY; lastX = tx; lastY = ty;
                panMovedMouse = false;
                e.preventDefault();
            });
            window.addEventListener('mousemove', (e)=>{
                if (!isPanning) return;
                tx = lastX + (e.clientX - startX);
                ty = lastY + (e.clientY - startY);
                if (!panMovedMouse) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    if (Math.hypot(dx, dy) > 3) panMovedMouse = true;
                }
                applyTransform();
            });
            window.addEventListener('mouseup', ()=>{ if (isPanning) { isPanning = false; img.style.cursor = 'grab'; lastPanEnd = Date.now(); } });

            // Click simple para alternar zoom
            img.addEventListener('click', (e)=>{
                if (Date.now() - lastPanEnd < 250 || panMovedMouse) { e.stopPropagation(); e.preventDefault(); return; }
                e.preventDefault();
                if (scale === 1) { scale = 2; img.style.cursor = 'grab'; } else { resetTransform(); }
                applyTransform();
            });

            // Doble click para alternar zoom (se mantiene)
            img.addEventListener('dblclick', (e)=>{
                if (Date.now() - lastPanEnd < 250 || panMovedMouse) { e.stopPropagation(); e.preventDefault(); return; }
                e.preventDefault();
                if (scale === 1) { scale = 2; img.style.cursor = 'grab'; } else { resetTransform(); }
                applyTransform();
            });

            // Toque: doble tap y pan, pinch to zoom y swipe para cambiar imagen
            let swipeStartX = 0, swipeStartY = 0, swipeActive = false;
            panel.addEventListener('touchstart', (e)=>{
                if (e.touches.length === 2) {
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    pinchStartDist = Math.hypot(dx, dy);
                    pinchStartScale = scale;
                    swipeActive = false;
                } else if (e.touches.length === 1) {
                    swipeStartX = e.touches[0].clientX; swipeStartY = e.touches[0].clientY;
                    if (scale > 1) {
                        isPanning = true;
                        startX = swipeStartX; startY = swipeStartY; lastX = tx; lastY = ty;
                        movedDuringPanTouch = false;
                        swipeActive = false;
                    } else {
                        // sin zoom: activar swipe
                        swipeActive = true;
                    }
                }
            }, { passive: false });
            panel.addEventListener('touchmove', (e)=>{
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const dist = Math.hypot(dx, dy);
                    const newScale = Math.min(maxScale, Math.max(minScale, (dist / pinchStartDist) * pinchStartScale));
                    if (newScale !== scale) { scale = newScale; img.style.cursor = scale > 1 ? 'grab' : 'zoom-in'; applyTransform(); }
                } else if (e.touches.length === 1) {
                    if (isPanning) {
                        e.preventDefault();
                        const curX = e.touches[0].clientX;
                        const curY = e.touches[0].clientY;
                        tx = lastX + (curX - startX);
                        ty = lastY + (curY - startY);
                        if (!movedDuringPanTouch) {
                            const dx = curX - startX; const dy = curY - startY;
                            if (Math.hypot(dx, dy) > 3) movedDuringPanTouch = true;
                        }
                        applyTransform();
                    } else if (swipeActive) {
                        const dxSwipe = e.touches[0].clientX - swipeStartX;
                        const dySwipe = e.touches[0].clientY - swipeStartY;
                        // iniciar navegación si gesto horizontal predominante
                        if (Math.abs(dxSwipe) > 24 && Math.abs(dxSwipe) > Math.abs(dySwipe)) {
                            e.preventDefault();
                            swipeActive = false;
                            if (dxSwipe < 0) showImage(idx + 1); else showImage(idx - 1);
                        }
                    }
                }
            }, { passive: false });
            panel.addEventListener('touchend', (e)=>{
                if (e.touches.length === 0) {
                    const wasPanning = isPanning;
                    if (isPanning) { isPanning = false; lastPanEnd = Date.now(); }
                    // Si hubo desplazamiento durante el pan, no tratar como tap
                    if (movedDuringPanTouch) { movedDuringPanTouch = false; return; }
                    const now = Date.now();
                    if (!wasPanning && (now - lastTapTime < 300)) { // doble tap
                        if (scale === 1) { scale = 2; img.style.cursor = 'grab'; } else { resetTransform(); }
                        applyTransform();
                        lastTapTime = 0;
                    } else {
                        lastTapTime = now;
                    }
                }
            });
        }

        function addToCart(item){
            // compute extra costs
            let extra = 0;
            if (item.parche) extra += EXTRAS.parche;
            if (item.dorsal) extra += EXTRAS.dorsal;
            // apply version surcharge only when version === 'jugador'
            if (item.version === 'jugador') extra += EXTRAS.versionJugador;
            else if (item.talla === '3XL') extra += 2;
            else if (item.talla === '4XL') extra += 2;
            const total = (item.price + extra);
            const cartItem = { id: Date.now().toString(36), productId: item.productId, name: item.name, img: item.img, price: item.price, extra, talla: item.talla, dorsal: item.dorsal, parche: item.parche, version: item.version, total };
            CART.push(cartItem);
            renderCart();
            try {
                const totalTxt = byId('cartTotal') ? byId('cartTotal').textContent : '';
                const totalNum = parseFloat(totalTxt);
                if (!isNaN(totalNum) && typeof window.showCartTotalToast === 'function') {
                    window.showCartTotalToast(totalNum);
                }
                // Notificación interna de pestaña carrito deshabilitada
            } catch (e) {}
        }

        function renderCart(){
            const list = byId('cartItems');
                list.innerHTML = '';
            let subtotal = 0;
            // Agrupar items iguales (por productId + talla + version + dorsal + parche) para manejar cantidades sin perder personalizaciones
            const grouped = {};
            CART.forEach(ci => {
                subtotal += ci.total;
                const key = `${ci.productId}::${ci.talla}::${ci.version || 'none'}::${ci.dorsal || 'none'}::${ci.parche || 'none'}`;
                if (!grouped[key]) grouped[key] = { ...ci, cantidad: 0 };
                grouped[key].cantidad += 1;
                // recalcular subtotal por agrupado si queremos mostrar precio por unidad
            });
            Object.keys(grouped).forEach(key => {
                const ci = grouped[key];
                const row = document.createElement('div'); row.className = 'cart-item';
                const parcheLabel = ci.parche ? `<small>Parche: ${ci.parche}</small>` : '';
                row.innerHTML = `
                    <img src="${ci.img}" alt="${ci.name}">
                    <div class="meta"><b>${ci.name}</b><small>${ci.talla} ${ci.dorsal? '· ' + ci.dorsal : ''} ${ci.version !== 'none' ? '· ' + ci.version : ''}</small>${parcheLabel}<small>Extras: €${ci.extra.toFixed(2)}</small></div>
                    <div style="text-align:right">
                        <div style="font-weight:700">€${(ci.total * ci.cantidad).toFixed(2)}</div>
                        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;justify-content:flex-end;">
                            <button class="decrease" data-key="${key}" aria-label="Disminuir" style="width:32px;height:32px;border-radius:8px;background:linear-gradient(180deg, var(--azul-acento) 0%, #1a3b6d 100%);color:#fff;border:1px solid rgba(255,255,255,0.12);box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:18px;font-weight:bold;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease;">−</button>
                            <input class="cart-qty-input" data-key="${key}" value="${ci.cantidad}" style="width:48px;height:32px;text-align:center;border-radius:8px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.08);color:#fff;font-weight:600;" />
                            <button class="increase" data-key="${key}" aria-label="Aumentar" style="width:32px;height:32px;border-radius:8px;background:linear-gradient(180deg, var(--azul-acento) 0%, #1a3b6d 100%);color:#fff;border:1px solid rgba(255,255,255,0.12);box-shadow:0 2px 8px rgba(0,0,0,0.15);font-size:18px;font-weight:bold;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease;">+</button>
                            <button class="remove" data-key="${key}" style="margin-left:8px;height:32px;padding:0 12px;border-radius:8px;background:rgba(255,50,50,0.2);color:#ff5050;border:1px solid rgba(255,80,80,0.3);font-weight:600;transition:all 0.2s ease;">Eliminar</button>
                        </div>
                    </div>
                `;
                list.appendChild(row);
            });
            // actualizar contador visual
            const countEl = byId('cartCount');
            if (countEl) countEl.textContent = CART.length.toString();
            // actualizar badge permanente del botón Carrito (cantidad total)
            (function(){
                const cartBtn = document.querySelector('.boton-seccion[data-seccion="carrito"]');
                if (!cartBtn) return;
                let badge = cartBtn.querySelector('.cart-tab-badge');
                if (!badge) {
                    badge = document.createElement('span');
                    badge.className = 'cart-tab-badge';
                    cartBtn.appendChild(badge);
                }
                const totalQty = Array.isArray(CART) ? CART.length : 0;
                if (totalQty > 0) {
                    badge.textContent = String(totalQty);
                    badge.classList.remove('hidden');
                } else {
                    badge.textContent = '0';
                    badge.classList.add('hidden');
                }
            })();
            // si no hay items mostrar mensaje de vacío
            if (CART.length === 0) {
                list.innerHTML = '<div class="cart-empty">Tu carrito está vacío<br><small>Agrega productos para empezar</small></div>';
            }
            // Detectar camisetas en el carrito para aplicar ofertas por cantidad
            function isShirt(ci){
                if (!ci || !ci.name) return false;
                const n = ci.name.toLowerCase();
                return ci.productId === 'barca1' || n.indexOf('camiseta') !== -1 || n.indexOf('camisetas') !== -1;
            }

            const shirtItems = CART.filter(isShirt);
            const nonShirtItems = CART.filter(ci => !isShirt(ci));

            // Sumas base y extras de camisetas
            const shirtCount = shirtItems.length;
            const shirtExtrasSum = shirtItems.reduce((s, it) => s + (it.extra || 0), 0);
            const shirtBaseSum = shirtItems.reduce((s, it) => s + (it.price || 0), 0);

            // precio base usado en las ofertas (pack 1) - por defecto 19.90
            const baseOffer = (OFFERS && OFFERS.find(o=>o.size===1) && OFFERS.find(o=>o.size===1).price) ? OFFERS.find(o=>o.size===1).price : 19.90;
            const shirtPriceSurplus = shirtItems.reduce((s,it) => s + Math.max(0, (it.price || 0) - baseOffer), 0);

            // use global computeBestOfferForCount

            // calcular totals no afectados por oferta
            const nonShirtTotal = nonShirtItems.reduce((s,it)=> s + (it.total || 0), 0);

            // original totals (antes de ofertas) - comportamiento previo usaba SHIPPING global si carrito no vacío
            const originalTotal = (subtotal + (CART.length>0? SHIPPING : 0));

            let appliedOffer = null;
            let newSubtotal = subtotal;
            let newShipping = (CART.length>0? SHIPPING : 0);

            if (shirtCount > 0){
                const best = computeBestOfferForCount(shirtCount);
                // best.total es precio de bases de packs; añadimos extras de camisetas
                const shirtsOfferCost = best.total + shirtExtrasSum + shirtPriceSurplus;
                // Si hay más de 1 camiseta aplicamos envío gratis global
                const shirtsOfferShipping = (shirtCount > 1) ? 0 : best.shipping;
                // nuevo subtotal = nonShirtTotal + shirtsOfferCost
                newSubtotal = nonShirtTotal + shirtsOfferCost;
                // Si hay más de 1 camiseta, envío gratis global; si no, sumar shipping para nonShirtItems si existen
                newShipping = (shirtCount > 1) ? 0 : (shirtsOfferShipping + (nonShirtItems.length>0 ? SHIPPING : 0));
                appliedOffer = { count: shirtCount, detail: best, shirtsOfferCost, shirtsOfferShipping };
            }

            // Calcular descuento aplicado
            let discountAmount = 0;
            let discountDescription = '';
            
            if (CURRENT_DISCOUNT) {
                const isValid = validateDiscount(CURRENT_DISCOUNT);
                if (isValid) {
                    switch (CURRENT_DISCOUNT.type) {
                        case 'percentage':
                            const percentageAmount = (newSubtotal * CURRENT_DISCOUNT.value) / 100;
                            discountAmount = Math.min(percentageAmount, CURRENT_DISCOUNT.maxDiscount || percentageAmount);
                            discountDescription = `${CURRENT_DISCOUNT.value}% descuento`;
                            break;
                        case 'fixed':
                            if (newSubtotal >= CURRENT_DISCOUNT.minPurchase) {
                                discountAmount = CURRENT_DISCOUNT.value;
                                discountDescription = `${CURRENT_DISCOUNT.value}€ descuento`;
                            }
                            break;
                        case 'free_shipping':
                            if (newSubtotal >= CURRENT_DISCOUNT.value) {
                                newShipping = 0;
                                discountDescription = 'Envío gratis';
                            }
                            break;
                        case 'free_item':
                            // Para artículos gratis, se aplicará al final del proceso de pago
                            discountDescription = `${CURRENT_DISCOUNT.value} artículo(s) gratis`;
                            break;
                    }
                }
            }

            const discountedSubtotal = Math.max(0, newSubtotal - discountAmount);
            const total = (CART.length>0) ? (discountedSubtotal + newShipping) : 0;

            // Actualizar UI con descuento
            byId('cartSubtotal').textContent = newSubtotal.toFixed(2) + '€';
            byId('cartShipping').textContent = newShipping.toFixed(2) + '€';
            byId('cartTotal').textContent = total.toFixed(2) + '€';
            
            // Mostrar descuento aplicado
            const discountRow = document.getElementById('cartDiscount');
            if (discountRow) {
                if (discountAmount > 0) {
                    discountRow.innerHTML = `<span>${discountDescription}</span><span>-€${discountAmount.toFixed(2)}</span>`;
                    discountRow.style.display = 'flex';
                } else if (CURRENT_DISCOUNT && CURRENT_DISCOUNT.type === 'free_shipping' && newShipping === 0) {
                    discountRow.innerHTML = `<span>${discountDescription}</span><span>-€${SHIPPING.toFixed(2)}</span>`;
                    discountRow.style.display = 'flex';
                } else {
                    discountRow.style.display = 'none';
                }
            }
            
            // Actualizar descuento aplicado
            updateAppliedDiscount();

            // Si hay una oferta aplicada, mostrar summary del ahorro justo encima de totales
            const totalsContainer = document.querySelector('.cart-totals');
            if (totalsContainer){
                // remove previous offer note if any
                const prev = totalsContainer.querySelector('.offer-summary'); if (prev) prev.remove();
                    if (appliedOffer){
                        // Prefer centralized computed savings when available
                        let savings = 0;
                        try { const computed = computeCartTotals(); if (computed && computed.savings !== undefined) savings = Number(computed.savings); else savings = (originalTotal - total); } catch(e){ savings = (originalTotal - total); }
                        // UI rule: display the computed 'savings' value directly
                        const displayedSavings = Number(savings);
                    const box = document.createElement('div');
                    box.className = 'offer-summary';
                    box.style.margin = '10px 0';
                    box.style.padding = '8px';
                    box.style.borderRadius = '8px';
                    box.style.background = 'linear-gradient(90deg, rgba(255,250,230,0.04), rgba(180,220,255,0.02))';
                    box.innerHTML = `
                        <div style="font-weight:800;color:#ffd966">Oferta aplicada: ${appliedOffer.count} camisetas</div>
                        <div style="color:#cfe7ff;font-size:0.95rem">Ahorro estimado: <strong>€${displayedSavings.toFixed(2)}</strong></div>
                        <div style="color:#bcd9ff;font-size:0.9rem">Detalle: ${Object.keys(appliedOffer.detail.combo).map(sz => `${appliedOffer.detail.combo[sz]}×${sz}`).join(' + ')}</div>
                    `;
                    totalsContainer.insertBefore(box, totalsContainer.firstChild);
                }
            }

            // attach remove (remove whole grouped item regardless of quantity)
            list.querySelectorAll('.remove').forEach(btn => btn.addEventListener('click', ()=>{
                const key = btn.dataset.key;
                if (!key) return;
                const [productId, talla, version, dorsal, parche] = key.split('::');
                CART = CART.filter(i => !(i.productId === productId && i.talla === talla && (i.version || 'none') === version && (i.dorsal || 'none') === dorsal && (i.parche || 'none') === parche));
                renderCart();
            }));
            list.querySelectorAll('.increase').forEach(btn => btn.addEventListener('click', ()=>{
                const key = btn.dataset.key;
                // añadir una unidad igual a la agrupación (clonar primer ítem de esa agrupación)
                const [productId, talla, version, dorsal, parche] = key.split('::');
                const item = CART.find(i=> i.productId === productId && i.talla === talla && (i.version || 'none') === version && (i.dorsal || 'none') === dorsal && (i.parche || 'none') === parche);
                if (item) CART.push(Object.assign({}, item, { id: Date.now().toString(36) }));
                renderCart();
            }));
            list.querySelectorAll('.decrease').forEach(btn => btn.addEventListener('click', ()=>{
                const key = btn.dataset.key;
                const [productId, talla, version, dorsal, parche] = key.split('::');
                // encontrar una instancia y eliminarla (la última)
                for (let i = CART.length-1; i>=0; i--) {
                    const it = CART[i];
                    if (it.productId === productId && it.talla === talla && (it.version || 'none') === version && (it.dorsal || 'none') === dorsal && (it.parche || 'none') === parche) { CART.splice(i,1); break; }
                }
                renderCart();
            }));
            list.querySelectorAll('.cart-qty-input').forEach(inp => inp.addEventListener('change', ()=>{
                const key = inp.dataset.key;
                const v = Math.max(1, parseInt(inp.value) || 1);
                const [productId, talla, version, dorsal, parche] = key.split('::');
                // contar actuales
                const current = CART.filter(i=> i.productId === productId && i.talla === talla && (i.version || 'none') === version && (i.dorsal || 'none') === dorsal && (i.parche || 'none') === parche).length;
                if (v > current) {
                    const item = CART.find(i=> i.productId === productId && i.talla === talla && (i.version || 'none') === version && (i.dorsal || 'none') === dorsal && (i.parche || 'none') === parche);
                    for (let k=0;k < v-current; k++) { if (item) CART.push(Object.assign({}, item, { id: Date.now().toString(36) })); }
                } else if (v < current) {
                    let toRemove = current - v;
                    for (let i = CART.length-1; i>=0 && toRemove>0; i--) {
                        const it = CART[i];
                        if (it.productId === productId && it.talla === talla && (it.version || 'none') === version && (it.dorsal || 'none') === dorsal && (it.parche || 'none') === parche) { CART.splice(i,1); toRemove--; }
                    }
                }
                renderCart();
            }));
            // actualizar banner promocional tras renderizar carrito
            try { updateCartPromoBanner(); } catch(e) {}
            // actualizar recomendaciones junto al carrito
            try { if (typeof updateRecommendations === 'function') updateRecommendations(); } catch(e) {}
            // actualizar desplegable de descuentos
            try { updateDiscountDropdown(); } catch(e) {}
        }

        function clearCart(){ CART = []; renderCart(); }

        // Sistema de descuentos
        let CURRENT_DISCOUNT = null;
        let USER_DISCOUNTS = [];

        // Simular descuentos del usuario (en producción vendrían de Firebase)
        async function loadUserDiscounts() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    USER_DISCOUNTS = [];
                    updateDiscountDropdown();
                    return;
                }

                // Cargar descuentos comprados desde Firebase
                const redemptionsRef = ref(db, `loyaltyByUser/${user.uid}/redemptions`);
                const snapshot = await get(redemptionsRef);
                
                if (!snapshot.exists()) {
                    USER_DISCOUNTS = [];
                    updateDiscountDropdown();
                    return;
                }

                const redemptions = snapshot.val();
                const availableDiscounts = [];

                // Convertir redenciones a formato de descuento
                Object.entries(redemptions).forEach(([id, redemption]) => {
                    if (!redemption.used && redemption.kind) {
                        let discount = {
                            id: id,
                            code: redemption.kind,
                            title: redemption.label || 'Descuento comprado',
                            description: 'Descuento adquirido en la tienda de puntos',
                            type: 'percentage',
                            value: 0,
                            minPurchase: 0,
                            maxDiscount: 0,
                            expires: '2099-12-31',
                            used: false,
                            redemptionId: id
                        };

                        // Configurar valores según el tipo de descuento comprado
                        switch (redemption.kind) {
                            case 'discount10':
                                discount.type = 'percentage';
                                discount.value = 10;
                                discount.title = '10% de descuento';
                                discount.maxDiscount = 50;
                                break;
                            case 'discount15':
                                discount.type = 'percentage';
                                discount.value = 15;
                                discount.title = '15% de descuento';
                                discount.maxDiscount = 75;
                                break;
                            case 'discount20':
                                discount.type = 'percentage';
                                discount.value = 20;
                                discount.title = '20% de descuento';
                                discount.maxDiscount = 100;
                                break;
                            case 'freeShirt':
                                discount.type = 'free_item';
                                discount.value = 1;
                                discount.title = 'Camiseta gratis';
                                discount.description = 'Una camiseta gratis en tu pedido';
                                discount.minPurchase = 0;
                                discount.maxDiscount = 25;
                                discount.itemType = 'shirt';
                                break;
                        }

                        availableDiscounts.push(discount);
                    }
                });

                USER_DISCOUNTS = availableDiscounts;
                updateDiscountDropdown();
                
            } catch (error) {
                console.error('Error cargando descuentos del usuario:', error);
                USER_DISCOUNTS = [];
                updateDiscountDropdown();
            }
        }

        function updateDiscountDropdown() {
            const discountList = document.getElementById('discountList');
            const discountBtn = document.getElementById('discountDropdownBtn');
            const discountBtnText = document.getElementById('discountBtnText');
            
            if (!discountList) {
                console.warn('No se encontró el elemento discountList');
                return;
            }
            
            // Limpiar la lista de descuentos
            discountList.innerHTML = '';
            
            // Filtrar descuentos disponibles (no usados)
            let availableDiscounts = Array.isArray(USER_DISCOUNTS) ? USER_DISCOUNTS.filter(d => !d.used) : [];
            console.log('Descuentos disponibles (USER_DISCOUNTS):', availableDiscounts);

            // Respaldo: si no hay descuentos en USER_DISCOUNTS, intentar con USER_ACTIVE_REWARDS
            if ((!availableDiscounts || availableDiscounts.length === 0) && Array.isArray(window.USER_ACTIVE_REWARDS) && window.USER_ACTIVE_REWARDS.length > 0) {
                try {
                    availableDiscounts = window.USER_ACTIVE_REWARDS
                        .filter(r => !r.used)
                        .map(r => {
                            const type = r.type === 'shipping' ? 'free_shipping' : (r.type || (r.kind === 'freeShirt' ? 'free_item' : 'percentage'));
                            const value = typeof r.value === 'number' ? r.value : (r.kind === 'discount10' ? 10 : (r.kind === 'discount15' ? 15 : (r.kind === 'discount20' ? 20 : 0)));
                            return {
                                id: r.id || r.redemptionId,
                                redemptionId: r.redemptionId || r.id,
                                title: r.title || r.name || getDiscountTitle(type, value),
                                description: r.description || getDiscountDescription(type, value),
                                type,
                                value,
                                used: !!r.used
                            };
                        });
                    console.log('Descuentos disponibles (USER_ACTIVE_REWARDS fallback):', availableDiscounts);
                } catch (e) {
                    console.warn('Error al transformar USER_ACTIVE_REWARDS:', e);
                }
            }
            
            // Actualizar el texto del botón según la cantidad de descuentos disponibles
            if (discountBtnText) {
                if (availableDiscounts.length > 0) {
                    discountBtnText.textContent = `Descuentos (${availableDiscounts.length})`;
                    // Añadir una clase para destacar que hay descuentos disponibles
                    if (discountBtn) {
                        discountBtn.classList.add('has-discounts');
                    }
                } else {
                    discountBtnText.textContent = 'Aplicar descuento';
                    // Quitar la clase si no hay descuentos
                    if (discountBtn) {
                        discountBtn.classList.remove('has-discounts');
                    }
                }
            }
            
            // Si no hay descuentos disponibles, mostrar mensaje
            if (availableDiscounts.length === 0) {
                discountList.innerHTML = '<div class="discount-empty">No tienes descuentos disponibles</div>';
                return;
            }
            
            // Crear elementos para cada descuento disponible
            availableDiscounts.forEach(discount => {
                const item = document.createElement('div');
                item.className = 'discount-item';
                item.style.cursor = 'pointer';
                item.style.transition = 'all 0.2s ease';
                item.style.padding = '12px';
                item.style.borderRadius = '8px';
                item.style.marginBottom = '8px';
                item.style.border = '1px solid rgba(102, 126, 234, 0.2)';
                
                // Crear HTML según el tipo de descuento
                let discountHTML = '';
                let discountIcon = '';
                
                // Determinar el icono según el tipo de descuento
                switch (discount.type) {
                    case 'percentage':
                        discountIcon = '💯';
                        break;
                    case 'free_item':
                        discountIcon = '🎁';
                        break;
                    case 'free_shipping':
                        discountIcon = '🚚';
                        break;
                    case 'fixed':
                        discountIcon = '💰';
                        break;
                    default:
                        discountIcon = '🏷️';
                }
                
                // Crear el HTML del descuento
                switch (discount.type) {
                    case 'percentage':
                        discountHTML = `
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div style="font-size:24px;">${discountIcon}</div>
                                <div style="flex:1;">
                                    <div class="discount-item-title" style="font-weight:600;margin-bottom:4px;">${discount.title || `${discount.value}% de descuento`}</div>
                                    <div class="discount-item-description" style="font-size:12px;color:#718096;">Descuento del ${discount.value}% en tu pedido</div>
                                    <div class="discount-item-code" style="font-size:11px;color:#4299e1;margin-top:4px;">Descuento canjeado • Clic para aplicar</div>
                                </div>
                            </div>
                        `;
                        break;
                    case 'free_item':
                        discountHTML = `
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div style="font-size:24px;">${discountIcon}</div>
                                <div style="flex:1;">
                                    <div class="discount-item-title" style="font-weight:600;margin-bottom:4px;">${discount.title || 'Camiseta gratis'}</div>
                                    <div class="discount-item-description" style="font-size:12px;color:#718096;">Una camiseta gratis en tu pedido</div>
                                    <div class="discount-item-code" style="font-size:11px;color:#4299e1;margin-top:4px;">Descuento canjeado • Clic para aplicar</div>
                                </div>
                            </div>
                        `;
                        break;
                    case 'free_shipping':
                        discountHTML = `
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div style="font-size:24px;">${discountIcon}</div>
                                <div style="flex:1;">
                                    <div class="discount-item-title" style="font-weight:600;margin-bottom:4px;">${discount.title || 'Envío gratis'}</div>
                                    <div class="discount-item-description" style="font-size:12px;color:#718096;">Envío gratis en tu pedido</div>
                                    <div class="discount-item-code" style="font-size:11px;color:#4299e1;margin-top:4px;">Descuento canjeado • Clic para aplicar</div>
                                </div>
                            </div>
                        `;
                        break;
                    case 'fixed':
                        discountHTML = `
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div style="font-size:24px;">${discountIcon}</div>
                                <div style="flex:1;">
                                    <div class="discount-item-title" style="font-weight:600;margin-bottom:4px;">${discount.title || `${discount.value}€ de descuento`}</div>
                                    <div class="discount-item-description" style="font-size:12px;color:#718096;">${discount.value}€ de descuento en tu pedido</div>
                                    <div class="discount-item-code" style="font-size:11px;color:#4299e1;margin-top:4px;">Descuento canjeado • Clic para aplicar</div>
                                </div>
                            </div>
                        `;
                        break;
                    default:
                        discountHTML = `
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div style="font-size:24px;">${discountIcon}</div>
                                <div style="flex:1;">
                                    <div class="discount-item-title" style="font-weight:600;margin-bottom:4px;">${discount.title || 'Descuento'}</div>
                                    <div class="discount-item-description" style="font-size:12px;color:#718096;">${discount.description || 'Descuento para tu próxima compra'}</div>
                                    <div class="discount-item-code" style="font-size:11px;color:#4299e1;margin-top:4px;">Descuento canjeado • Clic para aplicar</div>
                                </div>
                            </div>
                        `;
                }
                
                item.innerHTML = discountHTML;
                
                // Agregar efecto hover
                item.addEventListener('mouseenter', () => {
                    item.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
                    item.style.transform = 'translateY(-2px)';
                    item.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.15)';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.backgroundColor = '';
                    item.style.transform = '';
                    item.style.boxShadow = '';
                });
                
                // Agregar evento para aplicar el descuento al hacer clic
                item.addEventListener('click', () => {
                    console.log('Aplicando descuento:', discount);
                    applyDiscount(discount);
                });
                
                // Agregar el elemento a la lista
                discountList.appendChild(item);
            });
        }

        // Cargar descuentos disponibles del usuario
        async function loadUserDiscounts() {
            try {
                // Verificar si auth está definido
                if (typeof auth === 'undefined' || !auth) {
                    console.warn('Auth no está definido al cargar descuentos');
                    USER_DISCOUNTS = [];
                    updateDiscountDropdown();
                    return;
                }
                
                const user = auth.currentUser;
                if (!user) {
                    USER_DISCOUNTS = [];
                    updateDiscountDropdown();
                    return;
                }
                
                // Obtener descuentos del usuario desde Firebase
                // Usamos la misma ruta que la función redeemPoints del sistema de puntos
                const redemptionsRef = ref(db, `users/${user.uid}/redemptions`);
                const snapshot = await get(redemptionsRef);
                
                if (!snapshot.exists()) {
                    USER_DISCOUNTS = [];
                    updateDiscountDropdown();
                    return;
                }
                
                const redemptions = [];
                snapshot.forEach((childSnapshot) => {
                    const redemption = childSnapshot.val();
                    if (!redemption.used) {
                        redemptions.push({
                            id: childSnapshot.key,
                            redemptionId: childSnapshot.key,
                            title: redemption.name || getDiscountTitle(redemption.type, redemption.value),
                            description: redemption.description || getDiscountDescription(redemption.type, redemption.value),
                            type: redemption.type,
                            value: redemption.value,
                            used: false,
                            createdAt: redemption.createdAt
                        });
                    }
                });
                
                USER_DISCOUNTS = redemptions;
                updateDiscountDropdown();
                
                // Actualizar también la lista de descuentos en el perfil
                renderOwnedDiscounts(redemptions);
                
            } catch (error) {
                console.error('Error cargando descuentos del usuario:', error);
                USER_DISCOUNTS = [];
                updateDiscountDropdown();
            }
        }
        
        // Obtener título del descuento según su tipo y valor
        function getDiscountTitle(type, value) {
            switch (type) {
                case 'percentage':
                    return `${value}% de descuento`;
                case 'fixed':
                    return `${value}€ de descuento`;
                case 'free_shipping':
                    return 'Envío gratis';
                case 'free_item':
                    return 'Camiseta gratis';
                default:
                    return 'Descuento';
            }
        }
        
        // Obtener descripción del descuento según su tipo y valor
        function getDiscountDescription(type, value) {
            switch (type) {
                case 'percentage':
                    return `Descuento del ${value}% en tu pedido`;
                case 'fixed':
                    return `${value}€ de descuento en tu pedido`;
                case 'free_shipping':
                    return 'Envío gratis en tu pedido';
                case 'free_item':
                    return 'Una camiseta gratis en tu pedido';
                default:
                    return 'Descuento para tu próxima compra';
            }
        }

        async function applyDiscount(discount) {
            if (discount.used) return;
            
            const isValid = validateDiscount(discount);
            if (!isValid) {
                alert('Este descuento no es válido para tu compra actual.');
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) {
                    alert('Debes iniciar sesión para usar descuentos.');
                    return;
                }

                // No marcamos el descuento como usado en Firebase todavía
                // Solo lo marcamos como seleccionado en la aplicación
                // Se marcará como usado cuando se complete la compra
                
                console.log(`Descuento ${discount.redemptionId || discount.id} seleccionado para aplicar`);
                
                // Guardar una copia del descuento seleccionado
                const discountCopy = { ...discount };
                
                // Quitar descuento anterior si existe
                if (CURRENT_DISCOUNT && CURRENT_DISCOUNT.redemptionId) {
                    // Restaurar el descuento anterior como no usado en Firebase
                    // Usamos la misma ruta que la función loadUserDiscounts
                    const prevRedemptionRef = ref(db, `users/${user.uid}/redemptions/${CURRENT_DISCOUNT.redemptionId}`);
                    try {
                        await set(prevRedemptionRef, { 
                            ...CURRENT_DISCOUNT, 
                            used: false 
                        });
                        console.log(`Descuento anterior ${CURRENT_DISCOUNT.redemptionId} restaurado como no usado`);
                    } catch (error) {
                        console.error(`Error al restaurar descuento anterior ${CURRENT_DISCOUNT.redemptionId}:`, error);
                        // No lanzamos el error para que el nuevo descuento se aplique de todos modos
                    }
                }
                
                CURRENT_DISCOUNT = discount;
                CURRENT_DISCOUNT.used = true;
                
                // Actualizar UI
                updateAppliedDiscount();
                updateDiscountDropdown();
                renderCart();
                
                // Cerrar dropdown
                const dropdown = document.getElementById('discountDropdown');
                const button = document.getElementById('discountDropdownBtn');
                if (dropdown) dropdown.classList.add('hidden');
                if (button) button.classList.remove('active');
                
            } catch (error) {
                console.error('Error al aplicar descuento:', error);
                alert('Error al aplicar el descuento. Inténtalo de nuevo.');
            }
        }

        async function removeDiscount() {
            try {
                const user = auth.currentUser;
                if (CURRENT_DISCOUNT && CURRENT_DISCOUNT.redemptionId && user) {
                    // Marcar el descuento como no usado en Firebase
                    // Usamos la misma ruta que la función loadUserDiscounts
                    const redemptionRef = ref(db, `users/${user.uid}/redemptions/${CURRENT_DISCOUNT.redemptionId}`);
                    try {
                        await set(redemptionRef, { 
                            ...CURRENT_DISCOUNT, 
                            used: false 
                        });
                        console.log(`Descuento ${CURRENT_DISCOUNT.redemptionId} restaurado como no usado`);
                    } catch (error) {
                        console.error(`Error al restaurar descuento ${CURRENT_DISCOUNT.redemptionId}:`, error);
                        throw error;
                    }
                }
                
                if (CURRENT_DISCOUNT) {
                    CURRENT_DISCOUNT.used = false;
                    CURRENT_DISCOUNT = null;
                }
                
                updateAppliedDiscount();
                updateDiscountDropdown();
                renderCart();
                
            } catch (error) {
                console.error('Error al quitar descuento:', error);
                alert('Error al quitar el descuento. Inténtalo de nuevo.');
            }
        }

        function updateAppliedDiscount() {
            const appliedContainer = document.getElementById('appliedDiscount');
            if (!appliedContainer) return;
            
            if (CURRENT_DISCOUNT) {
                // Determinar el texto a mostrar según el tipo de descuento
                let discountTitle = CURRENT_DISCOUNT.title || 'Descuento aplicado';
                let discountCode = CURRENT_DISCOUNT.code || '';
                
                // Si es un descuento obtenido a través del sistema de puntos, mostrar información adicional
                if (CURRENT_DISCOUNT.redemptionId) {
                    // Mostrar información según el tipo de descuento
                    switch (CURRENT_DISCOUNT.type) {
                        case 'percentage':
                            discountTitle = `${CURRENT_DISCOUNT.value}% de descuento`;
                            discountCode = 'Canjeado con puntos';
                            break;
                        case 'fixed':
                            discountTitle = `${CURRENT_DISCOUNT.value}€ de descuento`;
                            discountCode = 'Canjeado con puntos';
                            break;
                        case 'free_shipping':
                            discountTitle = 'Envío gratis';
                            discountCode = 'Canjeado con puntos';
                            break;
                        case 'free_item':
                            discountTitle = 'Camiseta gratis';
                            discountCode = 'Canjeado con puntos';
                            break;
                        default:
                            discountTitle = CURRENT_DISCOUNT.title || 'Descuento aplicado';
                            discountCode = 'Canjeado con puntos';
                    }
                }
                
                appliedContainer.innerHTML = `
                    <div class="applied-discount-info">
                        <div>
                            <div class="applied-discount-title">${discountTitle}</div>
                            <div class="applied-discount-code">${discountCode}</div>
                        </div>
                        <button class="remove-discount-btn" onclick="removeDiscount()">×</button>
                    </div>
                `;
                appliedContainer.style.display = 'block';
            } else {
                appliedContainer.style.display = 'none';
            }
        }

        function validateDiscount(discount) {
            if (!discount) return false;
            
            // Si es un descuento obtenido a través del sistema de puntos, siempre es válido
            if (discount.redemptionId) return true;
            
            // Para descuentos tradicionales, verificar si ya está usado
            if (discount.used) return false;
            
            // Verificar fecha de expiración
            if (discount.expires) {
                const today = new Date();
                const expires = new Date(discount.expires);
                if (today > expires) return false;
            }
            
            // Calcular subtotal actual
            let currentSubtotal = 0;
            CART.forEach(item => {
                currentSubtotal += item.total;
            });
            
            // Verificar compra mínima
            if (discount.minPurchase > 0 && currentSubtotal < discount.minPurchase) {
                return false;
            }
            
            // Verificar requisitos específicos por tipo
            switch (discount.type) {
                case 'free_item':
                    if (discount.itemType === 'shirt') {
                        return hasShirtInCart();
                    }
                    break;
                case 'free_shipping':
                    return currentSubtotal >= (discount.value || 0);
                case 'percentage':
                    // Los descuentos porcentuales son válidos para cualquier compra
                    return true;
                case 'fixed':
                    // Los descuentos fijos son válidos si el subtotal es mayor que el descuento
                    return currentSubtotal >= (discount.value || 0);
            }
            
            return true;
        }

        function hasShirtInCart() {
            return CART.some(item => {
                if (!item || !item.name) return false;
                const name = item.name.toLowerCase();
                return item.productId === 'barca1' || name.includes('camiseta') || name.includes('camisetas');
            });
        }

        async function toggleDiscountDropdown() {
            const dropdown = document.getElementById('discountDropdown');
            const button = document.getElementById('discountDropdownBtn');
            if (dropdown && button) {
                const willOpen = dropdown.classList.contains('hidden');
                if (willOpen) {
                    try {
                        await loadUserDiscounts();
                    } catch (e) {
                        console.warn('No se pudo recargar descuentos antes de abrir el desplegable:', e);
                    }
                }
                dropdown.classList.toggle('hidden');
                button.classList.toggle('active');
                
                // Si se abre el desplegable, agregar listener para cerrar al hacer clic fuera
                if (!dropdown.classList.contains('hidden')) {
                    setTimeout(() => {
                        document.addEventListener('click', closeDiscountDropdownOutside);
                    }, 100);
                }
            }
        }
        
        function closeDiscountDropdownOutside(event) {
            const dropdown = document.getElementById('discountDropdown');
            const button = document.getElementById('discountDropdownBtn');
            
            if (dropdown && button && !dropdown.classList.contains('hidden')) {
                if (!dropdown.contains(event.target) && !button.contains(event.target)) {
                    dropdown.classList.add('hidden');
                    button.classList.remove('active');
                    document.removeEventListener('click', closeDiscountDropdownOutside);
                }
            }
        }

        // Inicializar descuentos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadUserDiscounts();
        });

        function calculateDiscountAmount(subtotal, shipping) {
            if (!CURRENT_DISCOUNT) return { discount: 0, newShipping: shipping };

            let discount = 0;
            let newShipping = shipping;

            switch (CURRENT_DISCOUNT.type) {
                case 'percentage':
                    discount = subtotal * (CURRENT_DISCOUNT.value / 100);
                    if (CURRENT_DISCOUNT.maxDiscount > 0) {
                        discount = Math.min(discount, CURRENT_DISCOUNT.maxDiscount);
                    }
                    break;
                    
                case 'fixed':
                    discount = CURRENT_DISCOUNT.value;
                    break;
                    
                case 'free_shipping':
                    newShipping = 0;
                    break;
                    
                case 'free_item':
                    // Para items gratis, calculamos el valor de la camiseta más barata
                    const shirtItems = CART.filter(item => {
                        const name = (item.name || '').toLowerCase();
                        return item.productId === 'barca1' || name.includes('camiseta') || name.includes('camisetas');
                    });
                    
                    if (shirtItems.length > 0) {
                        // Aplicar descuento igual al precio de la camiseta más barata
                        const cheapestShirt = Math.min(...shirtItems.map(item => item.price || 0));
                        discount = cheapestShirt * CURRENT_DISCOUNT.value;
                        if (CURRENT_DISCOUNT.maxDiscount > 0) {
                            discount = Math.min(discount, CURRENT_DISCOUNT.maxDiscount);
                        }
                    }
                    break;
            }

            return { discount, newShipping };
        }

        // Improve UX: after clearing the cart, reposition the fixed cart to avoid visual jump
        const _origClearCart = clearCart;
        function clearCart(){ 
            CART = []; 
            renderCart();
            // small debounce reposition
            try { setTimeout(() => { const evt = new Event('resize'); window.dispatchEvent(evt); }, 80); } catch(e){}
        }

        // Nuevo flujo: abrir modal de checkout para recopilar correo PayPal, @Instagram y dirección
        function openCheckout(){
            const total = parseFloat(byId('cartTotal').textContent);
            if (!total || total <= 0) { alert('Tu carrito está vacío. Añade algún producto antes de proceder al checkout.'); return; }
            // Evitar duplicados
            if (document.getElementById('checkoutModal')) return;
            const modal = document.createElement('div');
            modal.id = 'checkoutModal';
            modal.style.position = 'fixed'; modal.style.left = 0; modal.style.top = 0; modal.style.right = 0; modal.style.bottom = 0; modal.style.display = 'flex'; modal.style.alignItems = 'center'; modal.style.justifyContent = 'center'; modal.style.background = 'rgba(2,6,23,0.78)'; modal.style.zIndex = 3001;
            modal.innerHTML = `
                <div style="width:92%;max-width:760px;background:#071735;padding:16px;border-radius:10px;color:#dbeeff;">
                    <h3 style="margin-top:0;color:var(--azul-acento);">Resumen de pedido y datos de envío</h3>
                    <div style="margin-bottom:10px;color:#cfe7ff">Total a pagar: <strong>€${total.toFixed(2)}</strong></div>
                    <div id="checkoutSummary" style="background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;margin-bottom:12px;max-height:200px;overflow:auto;"></div>
                    
                    <!-- Opción de usar dirección predefinida -->
                    <div style="margin-bottom:16px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                            <input type="checkbox" id="use-saved-address" style="transform:scale(1.2);" />
                            <label for="use-saved-address" style="color:#cfe7ff;font-size:14px;cursor:pointer;">Usar dirección predefinida</label>
                        </div>
                        <div id="saved-addresses-container" class="hidden" style="margin-bottom:12px;">
                            <select id="saved-addresses" class="checkout-input" style="width:100%;margin-bottom:8px;">
                                <option value="">Selecciona una dirección guardada</option>
                            </select>
                            <button id="load-saved-address" class="btn-secondary" style="width:100%;padding:8px;font-size:14px;">Cargar Dirección</button>
                        </div>
                    </div>
                    
                    <div id="checkoutGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px;">
                        <input id="checkoutContactName" class="checkout-input" placeholder="Contact Name:" />
                        <input id="checkoutAddressLine" class="checkout-input" placeholder="Address Line:" />
                        <input id="checkoutCity" class="checkout-input" placeholder="City:" />
                        <input id="checkoutState" class="checkout-input" placeholder="State:" />
                        <input id="checkoutCountry" class="checkout-input" placeholder="Country:" />
                        <input id="checkoutPostal" class="checkout-input" placeholder="Postal Code:" />
                        <input id="checkoutPhone" class="checkout-input" placeholder="Phone Number:" />
                        <input id="checkoutPaypalEmail" class="checkout-input" placeholder="PayPal Email:" />
                        <input id="checkoutInstagram" class="checkout-input" placeholder="@Instagram" />
                    </div>
                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px;">
                                <button id="checkoutCancel" class="btn-secondary">Cancelar</button>
                                <button id="checkoutConfirm" class="btn-primary">Pagar con PayPal</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Ajustes de layout para mantener visible el CTA en móviles
            try {
                const content = modal.firstElementChild;
                if (content) {
                    content.style.maxHeight = '100dvh';
                    content.style.display = 'flex';
                    content.style.flexDirection = 'column';
                    // Hacer scrollable el grid de inputs y mantener el CTA al fondo
                    const grid = content.querySelector('#checkoutGrid');
                    if (grid) {
                        grid.style.flex = '1 1 auto';
                        grid.style.minHeight = '0';
                        grid.style.overflow = 'auto';
                    }
                    const actions = content.querySelector('#checkoutConfirm')?.parentElement;
                    if (actions) {
                        actions.style.position = 'sticky';
                        actions.style.bottom = '8px';
                        actions.style.background = 'rgba(7,23,53,0.95)';
                        actions.style.paddingTop = '8px';
                        actions.style.marginTop = '6px';
                    }
                }
            } catch(e) { /* no-op */ }

            // Estilos responsive para el modal de checkout en móviles
            if (!document.getElementById('checkoutResponsiveStyles')){
                const stc = document.createElement('style'); stc.id = 'checkoutResponsiveStyles';
                stc.textContent = `
                @media (max-width: 768px){
                    #checkoutModal{ align-items:flex-start !important; padding:12px !important; }
                    #checkoutModal > div{ padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px)) !important; }
                    #checkoutModal > div{ width:100% !important; max-width:100% !important; }
                    #checkoutGrid{ grid-template-columns:1fr !important; }
                    #checkoutSummary{ max-height:40vh !important; }
                }
                `;
                document.head.appendChild(stc);
            }

            // render summary (itemized)
            const summary = modal.querySelector('#checkoutSummary');
            function renderSummary(){
                console.log('renderSummary: CART length =', CART.length);
                summary.innerHTML = '';
                let subtotal = 0;
                CART.forEach(ci => {
                    subtotal += ci.total;
                    const item = document.createElement('div');
                    item.style.padding = '8px 0';
                    const parche = ci.parche ? `<div style="color:#bcd9ff;font-size:0.95rem">Parche: ${ci.parche} (+€${(ci.parche? EXTRAS.parche:0).toFixed(2)})</div>` : '';
                    const dorsal = ci.dorsal ? `<div style="color:#bcd9ff;font-size:0.95rem">Dorsal: ${ci.dorsal} (+€${(ci.dorsal? EXTRAS.dorsal:0).toFixed(2)})</div>` : '';
                    const version = (ci.version && ci.version !== 'none') ? (ci.version === 'jugador' ? `<div style="color:#bcd9ff;font-size:0.95rem">Versión: ${ci.version} (+€${EXTRAS.versionJugador.toFixed(2)})</div>` : `<div style=\"color:#bcd9ff;font-size:0.95rem\">Versión: ${ci.version}</div>`) : '';
                    item.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
                            <div style="flex:1">
                                <strong>${ci.name}</strong>
                                <div style="color:#d6e9ff;font-size:0.95rem">Talla: ${ci.talla} ${ci.version && ci.version !== 'none' ? '· ' + ci.version : ''}</div>
                                ${parche}${dorsal}${version}
                                <div style="color:#bcd9ff;font-size:0.9rem">Extras: €${ci.extra.toFixed(2)}</div>
                            </div>
                            <div style="text-align:right"><div style="font-weight:800">€${ci.total.toFixed(2)}</div></div>
                        </div>
                    `;
                    summary.appendChild(item);
                });

                // Totals block usando la lógica de ofertas por cantidad
                const totals = document.createElement('div');
                totals.style.marginTop = '10px';
                const computed = computeCartTotals();
                // Display the computed.savings in the UI
                const displayedSavingsModal = computed.savings ? Number(computed.savings) : 0;
                totals.innerHTML = `
                        <div style="display:flex;justify-content:space-between;color:#cfe7ff"><div>Subtotal</div><div>€${computed.subtotal.toFixed(2)}</div></div>
                        <div style="display:flex;justify-content:space-between;color:#cfe7ff"><div>Gastos envío</div><div>€${computed.shipping.toFixed(2)}</div></div>
                        ${displayedSavingsModal>0? `<div style="display:flex;justify-content:space-between;color:#ffd966;font-weight:800"><div>Ahorro total</div><div>€${displayedSavingsModal.toFixed(2)}</div></div>`: ''}
                        <div style="display:flex;justify-content:space-between;font-weight:800;margin-top:6px"><div>Total</div><div>€${computed.total.toFixed(2)}</div></div>
                        <div style="margin-top:8px;color:#9aaed9;font-size:0.9rem">ENVIO EXPRESS 5-15 DIAS</div>
                    `;
                summary.appendChild(totals);
            }
            renderSummary();

            // Funcionalidad de direcciones predefinidas en checkout
            const useSavedAddressCheckbox = modal.querySelector('#use-saved-address');
            const savedAddressesContainer = modal.querySelector('#saved-addresses-container');
            const savedAddressesSelect = modal.querySelector('#saved-addresses');
            const loadSavedAddressBtn = modal.querySelector('#load-saved-address');
            
            // Función para cargar direcciones guardadas en el select
            function loadSavedAddresses() {
                const addresses = JSON.parse(localStorage.getItem('savedAddresses') || '[]');
                savedAddressesSelect.innerHTML = '<option value="">Selecciona una dirección guardada</option>';
                
                addresses.forEach((address, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${address.name} - ${address.contactName}, ${address.city}`;
                    savedAddressesSelect.appendChild(option);
                });
            }
            
            // Función para cargar los datos de la dirección seleccionada
            function loadSelectedAddress() {
                const selectedIndex = savedAddressesSelect.value;
                if (selectedIndex === '') return;
                
                const addresses = JSON.parse(localStorage.getItem('savedAddresses') || '[]');
                const selectedAddress = addresses[parseInt(selectedIndex)];
                
                if (selectedAddress) {
                    modal.querySelector('#checkoutContactName').value = selectedAddress.contactName || '';
                    modal.querySelector('#checkoutAddressLine').value = selectedAddress.addressLine || '';
                    modal.querySelector('#checkoutCity').value = selectedAddress.city || '';
                    modal.querySelector('#checkoutState').value = selectedAddress.state || '';
                    modal.querySelector('#checkoutCountry').value = selectedAddress.country || '';
                    modal.querySelector('#checkoutPostal').value = selectedAddress.postal || '';
                    modal.querySelector('#checkoutPhone').value = selectedAddress.phone || '';
                }
            }
            
            // Event listener para el checkbox de usar dirección predefinida
            useSavedAddressCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    savedAddressesContainer.classList.remove('hidden');
                    loadSavedAddresses();
                } else {
                    savedAddressesContainer.classList.add('hidden');
                    // Limpiar campos si se desmarca
                    modal.querySelector('#checkoutContactName').value = '';
                    modal.querySelector('#checkoutAddressLine').value = '';
                    modal.querySelector('#checkoutCity').value = '';
                    modal.querySelector('#checkoutState').value = '';
                    modal.querySelector('#checkoutCountry').value = '';
                    modal.querySelector('#checkoutPostal').value = '';
                    modal.querySelector('#checkoutPhone').value = '';
                }
            });
            
            // Event listener para el botón de cargar dirección
            loadSavedAddressBtn.addEventListener('click', loadSelectedAddress);
            
            // Event listener para cambio en el select
            savedAddressesSelect.addEventListener('change', loadSelectedAddress);

            modal.querySelector('#checkoutCancel').addEventListener('click', ()=> { modal.remove(); document.body.style.overflow = ''; });

            modal.querySelector('#checkoutConfirm').addEventListener('click', ()=>{
                const name = modal.querySelector('#checkoutContactName').value.trim();
                const address = modal.querySelector('#checkoutAddressLine').value.trim();
                const city = modal.querySelector('#checkoutCity').value.trim();
                const state = modal.querySelector('#checkoutState').value.trim();
                const country = modal.querySelector('#checkoutCountry').value.trim();
                const postal = modal.querySelector('#checkoutPostal').value.trim();
                const phone = modal.querySelector('#checkoutPhone').value.trim();
                const paypalEmail = modal.querySelector('#checkoutPaypalEmail').value.trim();
                const instagram = modal.querySelector('#checkoutInstagram').value.trim();

                // Validación mejorada de campos de dirección
                const addressFields = [
                    { value: name, name: 'Nombre de contacto' },
                    { value: address, name: 'Dirección' },
                    { value: city, name: 'Ciudad' },
                    { value: country, name: 'País' },
                    { value: postal, name: 'Código postal' },
                    { value: phone, name: 'Teléfono' }
                ];

                const missingFields = addressFields.filter(field => !field.value);
                if (missingFields.length > 0) {
                    const fieldNames = missingFields.map(field => field.name).join(', ');
                    alert(`Por favor, completa los siguientes campos: ${fieldNames}`);
                    return;
                }

                if (!paypalEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(paypalEmail)) { 
                    alert('Introduce un correo PayPal válido.'); 
                    return; 
                }
                if (!instagram || !/^@/.test(instagram)) { 
                    alert('Introduce tu usuario de Instagram, debe empezar por @'); 
                    return; 
                }

                const checkoutData = { name, address, city, state, country, postal, phone, paypalEmail, instagram };

                // Recompute totals using centralized logic (incluye ofertas y recargos)
                const computed = computeCartTotals();
                const total = Number(computed.total || 0);

                console.log('Checkout data:', checkoutData, 'total:', total);

                if (typeof window.abrirPayPal === 'function') {
                    // pasar el total formateado con 2 decimales para el enlace PayPal
                    // Nota: la detección de cierre y la limpieza del carrito están centralizadas en `abrirPayPal`
                    window.abrirPayPal(total.toFixed(2));
                } else {
                    alert('Función de pago no disponible.');
                }
            });
        }

        // eventos globales
            document.addEventListener('click', (e)=>{
            // Accept clicks on either a button[data-action] or any element with [data-action]
            const targetWithAction = e.target.closest('[data-action]');
            if (!targetWithAction) return;
            // If the click originated from an interactive control inside the card (like a form input), ignore it
            if (e.target.matches('input,textarea,select,button') && !e.target.closest('.product-item')) {
                return;
            }
            const id = targetWithAction.dataset.id;
            const action = targetWithAction.dataset.action;
            const product = PRODUCTS.find(p=>p.id===id);
            if (!product) return;
            if (action === 'details') {
                // open carousel modal for products with images, otherwise product modal
                if (product.images && product.images.length) openTiendaCarouselModal(product);
                else openProductModal(product);
            }
            if (action === 'add') {
                if (product.images && product.images.length) openTiendaCarouselModal(product);
                else openProductModal(product);
            }
        });

    // solo adjuntar listeners si los botones existen (por seguridad)
    if (byId('gotoCheckoutBtn')) byId('gotoCheckoutBtn').addEventListener('click', openCheckout);
            if (byId('clearCartGallery')) byId('clearCartGallery').addEventListener('click', clearCart);
            if (byId('discountDropdownBtn')) byId('discountDropdownBtn').addEventListener('click', toggleDiscountDropdown);

        // Renderizar UI solo si existe el contenedor (sección pedidos)
        if (byId('productGallery') && byId('cartItems')) {
            // render with a prominent search control inside the gallery header
            const galleryWrap = document.getElementById('productGallery');
            const galleryHeaderEl = document.querySelector('.gallery-header') || galleryWrap.parentElement;
            if (!document.getElementById('productSearch')) {
                const wrap = document.createElement('div');
                wrap.className = 'product-search-wrap';
                wrap.style.display = 'flex';
                wrap.style.justifyContent = 'space-between';
                wrap.style.alignItems = 'center';
                wrap.style.margin = '0 0 12px 0';
                wrap.style.width = '100%';
                wrap.style.boxSizing = 'border-box';
                wrap.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;width:100%;">
                            <div style="background:linear-gradient(90deg, rgba(5,25,55,0.6), rgba(10,31,61,0.6));padding:8px 12px;border-radius:12px;display:flex;align-items:center;gap:10px;width:100%;box-shadow:0 8px 30px rgba(10,31,61,0.25);border:1px solid rgba(255,255,255,0.04);">
                            <i class="fas fa-search" style="color:#9fe0ff;font-size:1.05rem;"></i>
                            <input id="productSearch" placeholder="Buscar camiseta por nombre..." style="flex:1;padding:12px 8px;border-radius:8px;border:none;background:transparent;color:#fff;font-size:1.05rem;outline:none;" />
                            <button id="productSearchClear" title="Limpiar" style="background:transparent;border:none;color:#bcd9ff;cursor:pointer;font-weight:700;padding:6px 8px;border-radius:8px;">Limpiar</button>
                        </div>
                    </div>
                `;
                galleryHeaderEl.appendChild(wrap);

                const input = document.getElementById('productSearch');
                const clearBtn = document.getElementById('productSearchClear');
                if (input) input.addEventListener('input', debounce(function(e){ renderGallery(e.target.value.trim()); }, 180));
                if (clearBtn) clearBtn.addEventListener('click', function(){ if (input) { input.value = ''; renderGallery(''); input.focus(); } });
            }
            renderGallery(); renderCart();
            if (window.updateCartTabBadge) window.updateCartTabBadge();
            try { updateRecommendations(); } catch(e) {}
        }
    </script>
  </div>
</section>
<section id="reco-helpers" style="display:none">
    <script>
        // recomendaciones simples a partir de PRODUCTS
        function updateRecommendations(){
            const scroller = document.getElementById('recoScroller');
            if (!scroller) return;
            scroller.innerHTML = '';
            const inCartIds = new Set(CART.map(ci => ci.productId));
            const recos = (Array.isArray(PRODUCTS) ? PRODUCTS : []).filter(p => !inCartIds.has(p.id)).slice(0, 12);
            if (!recos.length) {
                const hint = document.createElement('div');
                hint.className = 'reco-empty';
                hint.style.color = '#bcd9ff';
                hint.style.padding = '8px 0';
                hint.textContent = 'Añade productos al carrito para ver recomendaciones personalizadas';
                scroller.appendChild(hint);
                return;
            }
            recos.forEach(p => {
                const card = document.createElement('div');
                card.className = 'reco-card';
                // Hacer la tarjeta completa clickeable como en Tienda
                card.setAttribute('data-id', p.id);
                card.setAttribute('data-action', 'add');
                const imgSrc = Array.isArray(p.images) && p.images.length ? p.images[0] : p.img || '';
                const price = (typeof p.price === 'number') ? `€${p.price.toFixed(2)}` : '';
                card.innerHTML = `
                    <div style="width:100%;aspect-ratio:1/1;overflow:hidden;border-radius:8px;">
                        <img src="${imgSrc}" alt="${p.name}" loading="lazy" width="1512" height="1512" style="width:100%;height:100%;object-fit:cover;display:block;">
                    </div>
                    <div class="reco-meta">
                        <div class="reco-name">${p.name}</div>
                        <div class="reco-price">${price}</div>
                    </div>
                    <!-- botones eliminados: la tarjeta completa es clickeable -->
                `;
                scroller.appendChild(card);
            });
            // Usamos el delegado global de clics ([data-action]) igual que en Tienda
            scroller.onclick = null;
        }
    </script>
</section>
<!-- Sección Identificarse -->
<section id="identificarse" class="seccion">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
    
    #identificarse.seccion.activa {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 0;
      padding: 0.5rem 1rem;
      background: transparent;
    }
    
    .ident-ui {
      max-width: 480px;
      width: 100%;
      margin: 0 auto;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 10px 30px rgba(0, 0, 0, 0.2);
      padding: 2.5rem;
      border: 1px solid rgba(99, 102, 241, 0.2);
      animation: fadeIn 0.6s ease-out, floatUp 0.8s ease-out;
      font-family: 'Poppins', sans-serif;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes floatUp {
      from { transform: translateY(30px); }
      to { transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
      100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    
    .ident-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .ident-header img {
      width: 70px;
      height: 70px;
      border-radius: 16px;
      object-fit: cover;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      margin-bottom: 1rem;
      border: 2px solid rgba(99, 102, 241, 0.5);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .ident-header img:hover {
      transform: scale(1.05);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
    }
    
    .ident-title {
      color: #fff;
      font-size: 2.2rem;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin: 0;
      background: linear-gradient(to right, #6366f1, #8b5cf6);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(99, 102, 241, 0.3);
    }
    
    .ident-card {
      background: rgba(30, 41, 59, 0.7);
      border: 1px solid rgba(99, 102, 241, 0.15);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(5px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .ident-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    }
    
    .ident-tabs { margin-bottom: 12px; }
    #profile-section .ident-card { margin-top: 0; }
    #profile-section #profile-orders, #profile-section #profile-points, #profile-section #profile-account { margin-top: 0; }
    #profile-section .order-meta { margin-top: 2px; }
    #profile-section .order-points { margin-top: 4px !important; }

    
    .ident-tab {
      flex: 1;
      text-align: center;
      padding: 12px 16px;
      border-radius: 12px;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      color: #94a3b8;
      transition: all 0.3s ease;
      font-size: 0.95rem;
    }
    
    .ident-tab:hover:not([aria-selected="true"]) {
      background: rgba(99, 102, 241, 0.1);
      color: #cbd5e1;
    }
    
    .ident-tab[aria-selected="true"] {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: #fff;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      animation: pulse 2s infinite;
    }
    
    .ident-form {
      display: grid;
      gap: 1.25rem;
    }
    
    .ident-form label {
      font-weight: 500;
      font-size: 0.95rem;
      color: #e2e8f0;
      margin-bottom: 6px;
      display: block;
      letter-spacing: 0.3px;
    }
    
    .ident-input-wrapper {
      position: relative;
    }
    
    .ident-form input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid rgba(99, 102, 241, 0.2);
      background: rgba(15, 23, 42, 0.8);
      color: #fff;
      outline: none;
      font-size: 1rem;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }
    
    .ident-form input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
    }
    
    .password-toggle {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      padding: 0;
      transition: color 0.2s ease;
    }
    
    .password-toggle:hover {
      color: #6366f1;
    }
    
    .password-toggle svg {
      width: 20px;
      height: 20px;
      transition: transform 0.2s ease;
    }
    
    .password-toggle:hover svg {
      transform: scale(1.1);
    }
    
    .ident-row {
      display: grid;
      gap: 1.25rem;
      grid-template-columns: 1fr;
    }
    
    .ident-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 0.5rem;
    }
    
    .btn-ident {
      width: 100%;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: #fff;
      border: none;
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.3px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
    }
    
    .btn-ident:hover {
      background: linear-gradient(135deg, #4338ca, #4f46e5);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(99, 102, 241, 0.3);
    }
    
    .btn-ident:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(99, 102, 241, 0.2);
    }
    
    .btn-ident[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn-ident.secondary {
      background: transparent;
      border: 1px solid rgba(99, 102, 241, 0.3);
      color: #94a3b8;
    }
    
    .btn-ident.secondary:hover {
      background: rgba(99, 102, 241, 0.1);
      border-color: rgba(99, 102, 241, 0.4);
      color: #e2e8f0;
    }
    
    .btn-register {
      background: linear-gradient(135deg, #10b981, #34d399);
    }
    
    .btn-register:hover {
      background: linear-gradient(135deg, #059669, #10b981);
    }
    
    .ident-help {
      color: #94a3b8;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      text-align: center;
      display: block;
      margin-top: 0.5rem;
      text-decoration: none;
    }
    
    .ident-help:hover {
      color: #6366f1;
      text-decoration: underline;
    }
    
    .ident-small {
      font-size: 0.85rem;
      color: #94a3b8;
    }
    
    .msg-err {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      padding: 12px;
      border-radius: 12px;
      font-size: 0.9rem;
      animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
    }
    
    @keyframes shake {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-3px); }
      40%, 60% { transform: translateX(3px); }
    }
    
    .msg-ok {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      color: #86efac;
      padding: 12px;
      border-radius: 12px;
      font-size: 0.9rem;
      animation: fadeIn 0.5s ease;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Responsive adjustments */
    @media (max-width: 520px) {
      .ident-ui {
        padding: 1.5rem;
      }
      
      .ident-title {
        font-size: 1.8rem;
      }
      
      .ident-form input {
        padding: 12px 14px;
      }
      
      .btn-ident {
        padding: 12px 16px;
      }
    }
    
    /* Order styles */
    .orders-list {
      margin-top: 16px;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }
    
    .order-card {
      display: flex;
      gap: 16px;
      align-items: center;
      background: rgba(30, 41, 59, 0.7);
      border: 1px solid rgba(99, 102, 241, 0.15);
      border-radius: 14px;
      padding: 16px;
      transition: all 0.3s ease;
    }
    
    .order-card:hover {
      background: rgba(30, 41, 59, 0.9);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    .order-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .order-id {
      font-weight: 700;
      color: #fff;
    }
    
    .order-date {
      color: #94a3b8;
      font-size: 0.9rem;
    }
    
    .order-total {
      margin-left: auto;
      font-weight: 700;
      color: #6366f1;
      font-size: 1.1rem;
    }
    
    .order-status {
      font-size: 0.85rem;
      color: #94a3b8;
    }

    /* Nueva tarjeta vertical compacta para Identificarse */
    .auth-card {
      max-width: 420px;
      width: 100%;
      margin: 0 auto;
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(6px);
      border-radius: 16px;
      border: 1px solid rgba(99, 102, 241, 0.15);
      padding: 24px 22px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    }
    .auth-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      text-align: center;
      margin-bottom: 16px;
    }
    .auth-header img { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; }
    .auth-header .ident-title { margin: 0; }

    @media (max-width: 520px) {
      .auth-card { padding: 18px 16px; }
    }
  </style>
  <style>
    #auth-section {
      display: grid;
      place-items: center;
      padding: 20px 16px;
      min-height: 500px;
      width: 100%;
      box-sizing: border-box;
    }
    
    /* Asegurar que el contenedor principal del perfil no se superponga */
    #profile-section {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      box-sizing: border-box;
    }
    
    /* Evitar desbordamiento horizontal */
    * {
      max-width: 100%;
    }
    
    /* Mejoras visuales finales */
    .seccion.activa {
      animation: fadeIn 0.4s ease-in-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Asegurar scroll suave */
    html {
      scroll-behavior: smooth;
    }
    
    /* Mejorar legibilidad en móvil */
    @media (max-width: 768px) {
      #auth-section {
        padding: 12px 8px;
      }
      
      #profile-section {
        padding: 12px 8px;
      }
    }
  </style>
  <div id="auth-section">
    <div class="auth-card">
      <div class="auth-header">
        <img src="assets/logos/logo.jpg" alt="Camisetazo" loading="lazy" width="70" height="70"/>
        <h2 class="ident-title">Identificarse</h2>
      </div>

      <div class="ident-card">
        <div class="ident-tabs" role="tablist" aria-label="Autenticación">
          <button id="tab-login" class="ident-tab" role="tab" aria-selected="true" aria-controls="panel-login">Iniciar sesión</button>
          <button id="tab-register" class="ident-tab" role="tab" aria-selected="false" aria-controls="panel-register">Crear cuenta</button>
        </div>

        <div id="panel-login" role="tabpanel" aria-labelledby="tab-login">
          <form id="form-login" class="ident-form" novalidate>
            <div>
              <label for="login-email">Email</label>
              <input id="login-email" name="email" type="email" autocomplete="email" required placeholder="tu@email.com" />
              <div id="login-email-error" class="ident-small hidden"></div>
            </div>
            <div>
              <label for="login-password">Contraseña</label>
              <div class="ident-input-wrapper">
                <input id="login-password" name="password" type="password" autocomplete="current-password" required minlength="6" placeholder="••••••" />
                <button type="button" class="password-toggle" aria-label="Mostrar contraseña" data-target="login-password">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="eye-icon">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>
              <div id="login-password-error" class="ident-small hidden"></div>
            </div>
            <div class="ident-actions">
              <button id="btn-login" class="btn-ident" type="submit">Iniciar sesión</button>
              <a id="btn-forgot" class="ident-help" href="javascript:void(0)">¿Olvidaste tu contraseña?</a>
            </div>
            <div id="login-msg" class="hidden"></div>
          </form>
        </div>

        <div id="panel-register" class="hidden" role="tabpanel" aria-labelledby="tab-register">
          <form id="form-register" class="ident-form" novalidate>
            <div>
              <label for="reg-email">Email</label>
              <input id="reg-email" name="email" type="email" autocomplete="email" required placeholder="tu@email.com" />
              <div id="reg-email-error" class="ident-small hidden"></div>
            </div>
            <div>
              <label for="reg-password">Contraseña</label>
              <div class="ident-input-wrapper">
                <input id="reg-password" name="password" type="password" autocomplete="new-password" required minlength="6" placeholder="••••••" />
                <button type="button" class="password-toggle" aria-label="Mostrar contraseña" data-target="reg-password">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="eye-icon">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>
              <div id="reg-password-error" class="ident-small hidden"></div>
            </div>
            <div>
              <label for="reg-password2">Confirmar contraseña</label>
              <div class="ident-input-wrapper">
                <input id="reg-password2" name="password2" type="password" autocomplete="new-password" required minlength="6" placeholder="••••••" />
                <button type="button" class="password-toggle" aria-label="Mostrar contraseña" data-target="reg-password2">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="eye-icon">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>
              <div id="reg-password2-error" class="ident-small hidden"></div>
            </div>
            <div class="ident-actions">
              <button id="btn-register" class="btn-ident btn-register" type="submit">Crear cuenta</button>
              <button id="btn-clear-reg" class="btn-ident secondary" type="button">Limpiar</button>
            </div>
            <div id="reg-msg" class="hidden"></div>
          </form>
        </div>
      </div>
    </div>
  </div>

    <div id="verify-cta" class="hidden" role="region" aria-live="polite" style="margin-top:12px">
      <div class="ident-small" id="verify-msg" style="margin-bottom:10px">
        Te hemos enviado un correo de verificación. Revisa tu bandeja de entrada y sigue el enlace para activar tu cuenta.
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="btn-resend-verif" class="btn-ident" type="button">Reenviar verificación</button>
        <button id="btn-verified-refresh" class="btn-ident secondary" type="button">Ya verifiqué</button>
      </div>
    </div>
  </div>

  <style>
    /* Perfil: layout y espaciados coherentes con Identificarse */
    #profile-section .profile-header-container {
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(99, 102, 241, 0.15);
      margin-bottom: 20px;
    }
    
    #profile-section .ident-header {
      flex-direction: row;
      align-items: center;
      text-align: left;
      gap: 16px;
      margin-bottom: 20px;
    }
    
    #profile-section .ident-header img {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      object-fit: cover;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      border: 2px solid rgba(99, 102, 241, 0.3);
    }
    
    #profile-section .ident-header > div:nth-child(2) .ident-title { 
      margin: 0;
      font-size: 28px;
    }
    
    #profile-section .ident-header .ident-small {
      font-size: 14px;
      color: #94a3b8;
      margin-top: 4px;
    }

    /* Contenedor de acciones (botones de pestañas) */
    #profile-section .profile-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      width: 100%;
    }
    /* Botones del perfil: icono + etiqueta, espaciado y estados */
    #profile-section .profile-actions .btn-ident {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 16px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.5);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 500;
      width: 100%;
    }
    #profile-section .profile-actions .btn-ident.secondary {
      background: rgba(30, 41, 59, 0.55);
    }
    #profile-section .profile-actions .btn-ident:hover {
      background: rgba(51, 65, 85, 0.65);
      border-color: rgba(148, 163, 184, 0.35);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
      transform: translateY(-1px);
    }
    #profile-section .profile-actions .btn-ident:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }
    #profile-section .profile-actions .btn-ident:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
      border-color: rgba(99, 102, 241, 0.6);
    }
    #profile-section .profile-actions .btn-icon {
      width: 18px;
      height: 18px;
      flex: 0 0 auto;
    }
    #profile-section .profile-actions .btn-label {
      line-height: 1;
    }

    /* Estado activo para botones de pestañas del perfil */
    #profile-section .profile-actions .btn-ident.active {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: #fff;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
      border-color: rgba(99, 102, 241, 0.35);
    }
    #profile-section .profile-actions .btn-ident.secondary.active {
      filter: saturate(1.2);
    }

    /* Tarjetas internas del perfil */
    #profile-section .ident-card {
      padding: 20px 18px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      background: linear-gradient(180deg, rgba(15,23,42,0.65), rgba(15,23,42,0.55));
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.18);
    }

    /* Listado de pedidos dentro del perfil */
    #profile-section .orders-list { gap: 12px; margin-top: 6px; }
    #profile-section .order-card {
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding: 12px;
    }

    /* Contenedor de tarjeta del perfil para consistencia visual */
    #profile-section .profile-card {
      max-width: 960px; /* cubrir más ancho en desktop */
      width: 100%;
      margin: 16px auto 0; /* separación sutil debajo de los botones */
      display: grid;
      gap: 20px;
    }

    /* En pantallas grandes, ordenar el layout en dos columnas cuando sea útil (por ahora una columna para simplicidad) */
    @media (min-width: 992px) {
      #profile-section .profile-card {
        max-width: 1040px; /* ligeramente más ancho en pantallas grandes */
      }
    }

    /* Panel de puntos: separación de líneas */
    #profile-section #points-summary { gap: 10px; }
    /* Ocultar niveles y progreso (eliminamos niveles Bronce/Plata/etc.) */
    #profile-section .points-progress-section,
    #profile-section .points-tiers,
    #profile-section #points-tier-line { display: none !important; }

    /* Responsive: apilar cabecera y centrar acciones en móvil */
    @media (max-width: 520px) {
      #profile-section .ident-header { flex-direction: column; text-align: center; gap: 12px; }
      #profile-section .profile-actions { width: 100%; justify-content: center; margin-left: 0; margin-bottom: 0; }
      #profile-section .profile-actions .btn-ident { width: 100%; justify-content: center; }
    }

    /* Estilos para la gestión de direcciones */
    #profile-section #addresses-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #profile-section .address-card {
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 20px;
      position: relative;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    #profile-section .address-card:hover {
      background: rgba(255,255,255,0.12);
      border-color: rgba(255,255,255,0.2);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    #profile-section .address-card h5 {
      color: #fff;
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
    }

    #profile-section .address-card .address-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    #profile-section .address-card .edit-address,
    #profile-section .address-card .delete-address {
      background: rgba(255,255,255,0.12);
      color: #fff;
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      min-width: 80px;
    }

    #profile-section .address-card .edit-address:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.4), rgba(139, 92, 246, 0.4));
      border-color: rgba(99, 102, 241, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    #profile-section .address-card .delete-address {
      background: rgba(255, 0, 0, 0.15);
      color: #ff6b6b;
      border-color: rgba(255, 0, 0, 0.3);
    }

    #profile-section .address-card .delete-address:hover {
      background: linear-gradient(135deg, rgba(255, 0, 0, 0.3), rgba(220, 38, 38, 0.3));
      border-color: rgba(255, 0, 0, 0.5);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 0, 0, 0.2);
    }

    #profile-section #address-form {
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(15px);
      border-radius: 16px;
      padding: 24px;
      margin-top: 20px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    #profile-section #address-form h4 {
      color: #fff;
      margin: 0 0 20px 0;
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #profile-section #address-form h4::before {
      content: "📍";
      font-size: 18px;
    }

    #profile-section #address-form .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    #profile-section #address-form input {
      width: 100%;
      padding: 14px 18px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 14px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    #profile-section #address-form input:focus {
      outline: none;
      border-color: rgba(99, 102, 241, 0.7);
      background: rgba(255,255,255,0.15);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
      transform: translateY(-2px);
    }

    #profile-section #address-form input::placeholder {
      color: rgba(255,255,255,0.7);
      font-weight: 400;
    }

    #profile-section #address-form input:hover {
      border-color: rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.12);
    }

    #profile-section #address-form .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 8px;
    }

    #profile-section #address-form .form-actions button {
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      min-width: 120px;
    }

    #profile-section #address-form .btn-cancel {
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 2px solid rgba(255,255,255,0.2);
    }

    #profile-section #address-form .btn-cancel:hover {
      background: rgba(255,255,255,0.15);
      border-color: rgba(255,255,255,0.3);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    #profile-section #address-form .btn-save {
      background: linear-gradient(135deg,#667eea,#764ba2);
      color: #fff;
      border: 2px solid rgba(99, 102, 241, 0.3);
    }

    #profile-section #address-form .btn-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg,#5a67d8,#6b46c1);
    }

    /* Estilos para el modal de checkout con direcciones */
    #checkoutModal #saved-addresses-container {
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }

    #checkoutModal #saved-addresses {
      background: rgba(255,255,255,0.12);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 10px;
      color: #fff;
      padding: 12px 16px;
      font-size: 14px;
      width: 100%;
      margin-bottom: 12px;
      transition: all 0.3s ease;
    }

    #checkoutModal #saved-addresses:focus {
      outline: none;
      border-color: rgba(99, 102, 241, 0.6);
      background: rgba(255,255,255,0.15);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    #checkoutModal #saved-addresses option {
      background: #071735;
      color: #fff;
      padding: 8px;
    }

    #checkoutModal #load-saved-address {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.3));
      color: #fff;
      border: 2px solid rgba(99, 102, 241, 0.4);
      border-radius: 10px;
      padding: 12px 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
    }

    #checkoutModal #load-saved-address:hover {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.5), rgba(139, 92, 246, 0.5));
      border-color: rgba(99, 102, 241, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    #checkoutModal #use-saved-address {
      transform: scale(1.3);
      margin-right: 8px;
    }

    #checkoutModal label[for="use-saved-address"] {
      color: #cfe7ff;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
    }

    /* Estilos para el botón Nueva Dirección */
    #profile-section #btn-add-address:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg,#5a67d8,#6b46c1);
    }

    #profile-section #btn-add-address:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    /* Responsive para direcciones */
    @media (max-width: 768px) {
      #profile-section #address-form .form-grid {
        grid-template-columns: 1fr;
      }
      
      #profile-section .address-card .address-actions {
        flex-direction: column;
      }
      
      #profile-section .address-card .edit-address,
      #profile-section .address-card .delete-address {
        width: 100%;
        text-align: center;
      }
    }
  </style>

  <div id="profile-section" class="ident-ui hidden" aria-live="polite">
    <div class="profile-header-container">
      <div class="profile-header ident-header" role="banner">
        <img src="assets/logos/logo.jpg" alt="Camisetazo" loading="lazy" width="48" height="48"/>
        <div>
          <h2 class="ident-title">Perfil</h2>
          <div class="ident-small" id="profile-email"></div>
        </div>
      </div>
      <div class="profile-actions">
        <button id="btn-ver-pedidos" class="btn-ident secondary active" type="button"><span class="btn-icon" aria-hidden="true">🛒</span><span class="btn-label">Pedidos</span></button>
        <button id="btn-ver-puntos" class="btn-ident secondary" type="button"><span class="btn-icon" aria-hidden="true">🏅</span><span class="btn-label">Puntos</span></button>
        <button id="btn-ver-cuenta" class="btn-ident secondary" type="button"><span class="btn-icon" aria-hidden="true">👤</span><span class="btn-label">Cuenta</span></button>
        <button id="btn-logout" class="btn-ident" type="button"><span class="btn-icon" aria-hidden="true">🚪</span><span class="btn-label">Cerrar sesión</span></button>
      </div>
    </div>
    <div class="profile-card">
      <section id="profile-orders" class="ident-card" style="padding:0;background:transparent;border:none;">
        <div id="orders-empty" class="hidden" style="padding:20px;">Todavía no tienes pedidos.</div>
        <div id="orders-list" class="orders-list" style="display:flex;flex-direction:column;gap:16px;"></div>
      </section>
      
      <section id="profile-points" class="ident-card hidden" style="padding:0;background:transparent;border:none;">
        <div class="points-container" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:16px; padding:24px; box-shadow: 0 10px 40px rgba(102,126,234,0.3);">
          <div class="points-header" style="margin-bottom:24px;">
            <h3 style="color:#fff;font-size:24px;margin:0 0 8px 0;font-weight:700;">Programa de Fidelidad</h3>
            <p style="color:rgba(255,255,255,0.85);font-size:14px;margin:0;">Acumula puntos con cada compra y obtén descuentos exclusivos</p>
          </div>
          
          <!-- Saldo de Puntos -->
          <div class="points-balance" style="background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);border-radius:12px;padding:20px;margin-bottom:24px;text-align:center;">
            <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:8px;">
              <span style="font-size:32px;">🏆</span>
              <div>
                <div id="user-points-balance" style="color:#fff;font-size:28px;font-weight:700;margin:0;">0</div>
                <div style="color:rgba(255,255,255,0.8);font-size:14px;margin:0;">Puntos disponibles</div>
              </div>
            </div>
            <div style="color:rgba(255,255,255,0.7);font-size:12px;">
              Gana 10 puntos por cada camiseta comprada
            </div>
          </div>
          
          <!-- Tienda de Canje -->
          
          <div class="points-stats" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:16px;margin-bottom:24px;">
            <div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:12px;padding:16px;">
              <div style="color:rgba(255,255,255,0.7);font-size:12px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Puntos Disponibles</div>
              <div style="color:#fff;font-size:32px;font-weight:700;display:flex;align-items:center;gap:8px;">
                <span id="points-total">0</span>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="#ffd700" style="opacity:0.9;">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                </svg>
              </div>
            </div>
            <div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:12px;padding:16px;">
              <div style="color:rgba(255,255,255,0.7);font-size:12px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Puntos Pendientes</div>
              <div style="color:#fff;font-size:28px;font-weight:700;display:flex;align-items:center;gap:8px;">
                <span id="points-pending">0</span>
              </div>
            </div>
            <div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:12px;padding:16px;">
              <div style="color:rgba(255,255,255,0.7);font-size:12px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Puntos Canjeados</div>
              <div style="color:#fff;font-size:28px;font-weight:700;display:flex;align-items:center;gap:8px;">
                <span id="points-spent">0</span>
              </div>
            </div>
            
          </div>
          
          
          
          
          
          <div class="points-shop" style="margin-top:24px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:16px;">
            <h4 style="color:#fff;margin:0 0 12px 0;font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px;">🛍️ Tienda de Canje</h4>
            <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:12px;">
              <div style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px;">
                <div style="color:#fff;font-weight:600;margin-bottom:6px;">10% de descuento</div>
                <div style="color:#ffd700;font-size:12px;margin-bottom:10px;">20 pts</div>
                <button id="redeem-discount10" style="width:100%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;padding:10px;cursor:pointer;">Canjear</button>
              </div>
              <div style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px;">
                <div style="color:#fff;font-weight:600;margin-bottom:6px;">15% de descuento</div>
                <div style="color:#ffd700;font-size:12px;margin-bottom:10px;">40 pts</div>
                <button id="redeem-discount15" style="width:100%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;padding:10px;cursor:pointer;">Canjear</button>
              </div>
              <div style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px;">
                <div style="color:#fff;font-weight:600;margin-bottom:6px;">20% de descuento</div>
                <div style="color:#ffd700;font-size:12px;margin-bottom:10px;">60 pts</div>
                <button id="redeem-discount20" style="width:100%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;padding:10px;cursor:pointer;">Canjear</button>
              </div>
              <div style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px;">
                <div style="color:#fff;font-weight:600;margin-bottom:6px;">Camiseta gratis 🔥</div>
                <div style="color:#ffd700;font-size:12px;margin-bottom:10px;">100 pts</div>
                <button id="redeem-freeShirt" style="width:100%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;padding:10px;cursor:pointer;">Canjear</button>
              </div>
            </div>
            <div id="redeem-msg" style="margin-top:12px;color:#fff;font-size:13px;"></div>
            <div class="owned-discounts" style="margin-top:16px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:12px;">
              <button id="toggle-owned-discounts" style="width:100%;background:transparent;border:none;color:#fff;text-align:left;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
                <span>🧾 Descuentos para cuando haga la proxima compra</span>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5H7z"/></svg>
              </button>
              <div id="owned-discounts-list" style="display:none;padding:12px 14px;color:#e2e8f0;font-size:14px;">
                <div style="color:#94a3b8;">No tienes descuentos comprados aún.</div>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <section id="profile-account" class="ident-card hidden" style="padding:0;background:transparent;border:none;">
        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;padding:32px;box-shadow:0 10px 40px rgba(102,126,234,0.3);">
          <div style="text-align:center;margin-bottom:24px;">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" style="margin:0 auto 16px;opacity:0.9;">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" fill="white"/>
            </svg>
            <h3 style="color:#fff;font-size:24px;margin:0 0 8px 0;font-weight:700;">Mi Cuenta</h3>
            <p style="color:rgba(255,255,255,0.85);font-size:14px;margin:0;">Gestión completa de tu perfil y preferencias</p>
          </div>
          
          <!-- Panel Administrativo (solo para administradores) -->
          <div id="admin-panel" class="hidden" style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:12px;padding:20px;margin-bottom:20px;">
            <h4 style="color:#fff;font-size:18px;margin:0 0 16px 0;font-weight:600;">🔧 Panel Administrativo - Gestión de Puntos</h4>
            
            <!-- Buscar usuario -->
            <div style="margin-bottom:20px;">
              <label style="color:rgba(255,255,255,0.9);font-size:14px;margin-bottom:8px;display:block;">Buscar usuario por email:</label>
              <div style="display:flex;gap:8px;">
                <input type="email" id="admin-search-email" placeholder="email@ejemplo.com" style="
                  flex:1;padding:10px;border:none;border-radius:6px;background:rgba(255,255,255,0.2);
                  color:#fff;font-size:14px;outline:none;
                ">
                <button id="admin-search-btn" style="
                  background:rgba(255,255,255,0.2);border:none;color:#fff;padding:10px 16px;
                  border-radius:6px;cursor:pointer;font-size:14px;
                ">Buscar</button>
              </div>
            </div>
            
            <!-- Información del usuario -->
            <div id="admin-user-info" class="hidden" style="background:rgba(255,255,255,0.1);border-radius:8px;padding:16px;margin-bottom:16px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div>
                  <div style="color:#fff;font-weight:600;" id="admin-user-email"></div>
                  <div style="color:rgba(255,255,255,0.7);font-size:12px;" id="admin-user-uid"></div>
                </div>
                <div style="color:#ffd700;font-size:20px;font-weight:700;" id="admin-user-points">0</div>
              </div>
              
              <!-- Ajustar puntos -->
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="number" id="admin-new-points" placeholder="Nuevos puntos" style="
                  flex:1;padding:8px;border:none;border-radius:4px;background:rgba(255,255,255,0.2);
                  color:#fff;font-size:14px;outline:none;
                ">
                <input type="text" id="admin-reason" placeholder="Motivo" style="
                  flex:1;padding:8px;border:none;border-radius:4px;background:rgba(255,255,255,0.2);
                  color:#fff;font-size:14px;outline:none;
                ">
                <button id="admin-update-points" style="
                  background:rgba(76,175,80,0.8);border:none;color:#fff;padding:8px 12px;
                  border-radius:4px;cursor:pointer;font-size:12px;
                ">Actualizar</button>
              </div>
            </div>
            
            <!-- Lista de usuarios recientes -->
            <div>
              <h5 style="color:rgba(255,255,255,0.9);font-size:14px;margin:0 0 12px 0;">Usuarios recientes:</h5>
              <div id="admin-users-list" style="max-height:200px;overflow-y:auto;">
                <!-- Se cargará dinámicamente -->
              </div>
            </div>
          </div>
          
          <!-- Gestión de Direcciones -->
          <div style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:12px;padding:20px;margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
              <h4 style="color:#fff;margin:0;font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px;">
                <span>📍</span> Mis Direcciones
              </h4>
              <button id="btn-add-address" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:2px solid rgba(99, 102, 241, 0.3);border-radius:10px;padding:10px 20px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(102, 126, 234, 0.3);">
                <span style="margin-right:6px;">➕</span> Nueva Dirección
              </button>
            </div>
            
            <div id="addresses-list" style="display:flex;flex-direction:column;gap:12px;">
              <!-- Las direcciones se cargarán aquí dinámicamente -->
            </div>
            
            <div id="no-addresses" class="hidden" style="text-align:center;padding:20px;color:rgba(255,255,255,0.7);">
              <p style="margin:0 0 8px 0;">No tienes direcciones guardadas</p>
              <p style="margin:0;font-size:12px;">Guarda direcciones para agilizar tus compras</p>
            </div>
          </div>
          
          <!-- Formulario de Nueva Dirección (oculto por defecto) -->
          <div id="address-form" class="hidden" style="background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:12px;padding:20px;">
            <h4 style="color:#fff;margin:0 0 16px 0;font-size:18px;font-weight:700;">Nueva Dirección</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
              <input id="address-name" class="checkout-input" placeholder="Nombre de la dirección (ej: Casa, Trabajo)" />
              <input id="address-contact-name" class="checkout-input" placeholder="Nombre completo" />
              <input id="address-line" class="checkout-input" placeholder="Dirección" style="grid-column:1/-1;" />
              <input id="address-city" class="checkout-input" placeholder="Ciudad" />
              <input id="address-state" class="checkout-input" placeholder="Provincia/Estado" />
              <input id="address-country" class="checkout-input" placeholder="País" />
              <input id="address-postal" class="checkout-input" placeholder="Código postal" />
              <input id="address-phone" class="checkout-input" placeholder="Teléfono" />
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;">
              <button id="btn-cancel-address" style="background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:8px 16px;cursor:pointer;">Cancelar</button>
              <button id="btn-save-address" style="background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;">Guardar Dirección</button>
            </div>
          </div>
        </div>
      </section>
    </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
    import { getAuth, setPersistence, browserLocalPersistence, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, sendPasswordResetEmail, signOut, sendEmailVerification, reload } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // Configuración Firebase (proyecto camisetazo-puntos)
    const firebaseConfig = {
      apiKey: "AIzaSyBYPvmvzzNxtTFOVpPXKRvUhoHBjBTCVBE",
      authDomain: "camisetazo-puntos.firebaseapp.com",
      databaseURL: "https://camisetazo-puntos-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "camisetazo-puntos",
      storageBucket: "camisetazo-puntos.firebasestorage.app",
      messagingSenderId: "652477026185",
      appId: "1:652477026185:web:4a05e015da74d4541d1b58",
      measurementId: "G-GS53GWE2Z0"
    };

    // Inicializar Firebase (evitar doble init)
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(_){}
    const auth = getAuth(app);
    const db = getDatabase(app, firebaseConfig.databaseURL);
    await setPersistence(auth, browserLocalPersistence);
    
    // Hacer auth global para que otras partes del código puedan acceder
    window.auth = auth;

    // Utils DOM (scoped al contenedor para evitar colisiones)
    const root = document.getElementById('auth-section');
    const $ = (sel) => root.querySelector(sel);
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');

    function emailValido(email){
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i; return re.test(String(email||'').trim());
    }
    function mapAuthError(code){
      switch(code){
        case 'auth/email-already-in-use': return 'Este email ya está registrado.';
        case 'auth/invalid-email': return 'El email no es válido.';
        case 'auth/operation-not-allowed': return 'Operación no permitida. Contacta soporte.';
        case 'auth/weak-password': return 'La contraseña es demasiado débil (mínimo 6 caracteres).';
        case 'auth/user-disabled': return 'Esta cuenta fue deshabilitada.';
        case 'auth/user-not-found': return 'No existe una cuenta con ese email.';
        case 'auth/wrong-password': return 'Contraseña incorrecta.';
        case 'auth/too-many-requests': return 'Demasiados intentos. Inténtalo más tarde.';
        case 'auth/network-request-failed': return 'Fallo de red. Revisa tu conexión e inténtalo de nuevo.';
        case 'auth/internal-error': return 'Error interno del servidor. Intenta de nuevo más tarde.';
        case 'auth/invalid-credential': return 'Credenciales inválidas o sesión caducada. Vuelve a intentarlo.';
        case 'auth/invalid-continue-uri':
        case 'auth/unauthorized-continue-uri':
        case 'auth/missing-continue-uri': return 'Dominio de retorno no autorizado o falta la URL de retorno. Añádelo en Firebase > Authentication > Settings > Authorized domains.';
        default: return `Ocurrió un error inesperado. Código: ${code || 'desconocido'}.`;
      }
    }

    // Tabs accesibles
    const tabLogin = $('#tab-login');
    const tabRegister = $('#tab-register');
    const panelLogin = $('#panel-login');
    const panelRegister = $('#panel-register');
    function selectTab(which){
      const loginSelected = which === 'login';
      tabLogin.setAttribute('aria-selected', String(loginSelected));
      tabRegister.setAttribute('aria-selected', String(!loginSelected));
      if (loginSelected){ hide(panelRegister); show(panelLogin); }
      else { hide(panelLogin); show(panelRegister); }
    }
    tabLogin.addEventListener('click', ()=> selectTab('login'));
    tabRegister.addEventListener('click', ()=> selectTab('register'));

    // Login
    const loginForm = $('#form-login');
    const loginEmail = $('#login-email');
    const loginPass = $('#login-password');
    const loginMsg = $('#login-msg');
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      loginMsg.className='hidden'; loginMsg.textContent='';
      $('#login-email-error').className='ident-small hidden'; $('#login-password-error').className='ident-small hidden';
      const email = loginEmail.value.trim();
      const pass = loginPass.value;
      let ok = true;
      if (!emailValido(email)){ ok=false; const el=$('#login-email-error'); el.textContent='Introduce un email válido.'; el.className='ident-small'; }
      if (!pass || pass.length < 6){ ok=false; const el=$('#login-password-error'); el.textContent='La contraseña debe tener al menos 6 caracteres.'; el.className='ident-small'; }
      if (!ok) return;
      const btn = $('#btn-login'); const prev = btn.textContent; btn.disabled = true; btn.textContent='Accediendo...';
      try { await signInWithEmailAndPassword(auth, email, pass); loginMsg.className='msg-ok'; loginMsg.textContent='Sesión iniciada correctamente.'; }
      catch(err){ loginMsg.className='msg-err'; loginMsg.textContent = mapAuthError(err?.code); }
      finally { btn.disabled=false; btn.textContent=prev; }
    });

    // Recuperar contraseña
    $('#btn-forgot').addEventListener('click', async ()=>{
      const email = (loginEmail.value||'').trim();
      loginMsg.className='hidden'; loginMsg.textContent='';
      if (!emailValido(email)){ const el=$('#login-email-error'); el.textContent='Introduce un email válido para recuperar tu contraseña.'; el.className='ident-small'; return; }
      const btn = $('#btn-login'); const prev = btn.textContent; btn.disabled = true; btn.textContent='Enviando email...';
      try { await sendPasswordResetEmail(auth, email); loginMsg.className='msg-ok'; loginMsg.textContent='Hemos enviado un correo para restablecer tu contraseña.'; }
      catch(err){ loginMsg.className='msg-err'; loginMsg.textContent=mapAuthError(err?.code); }
      finally { btn.disabled=false; btn.textContent=prev; }
    });

    // Registro
    const regForm = $('#form-register');
    const regEmail = $('#reg-email');
    const regPass = $('#reg-password');
    const regPass2 = $('#reg-password2');
    const regMsg = $('#reg-msg');
    $('#btn-clear-reg').addEventListener('click', ()=>{ regForm.reset(); regMsg.className='hidden'; regMsg.textContent=''; ['#reg-email-error','#reg-password-error','#reg-password2-error'].forEach(s=>{ const el=$(s); el.textContent=''; el.className='ident-small hidden'; }); });
    regForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      regMsg.className='hidden'; regMsg.textContent='';
      ['#reg-email-error','#reg-password-error','#reg-password2-error'].forEach(s=>{ const el=$(s); el.textContent=''; el.className='ident-small hidden'; });
      const email = regEmail.value.trim();
      const p1 = regPass.value; const p2 = regPass2.value;
      let ok = true;
      if (!emailValido(email)){ ok=false; const el=$('#reg-email-error'); el.textContent='Introduce un email válido.'; el.className='ident-small'; }
      if (!p1 || p1.length < 6){ ok=false; const el=$('#reg-password-error'); el.textContent='La contraseña debe tener al menos 6 caracteres.'; el.className='ident-small'; }
      if (p1 !== p2){ ok=false; const el=$('#reg-password2-error'); el.textContent='Las contraseñas no coinciden.'; el.className='ident-small'; }
      if (!ok) return;
      const btn = $('#btn-register'); const prev = btn.textContent; btn.disabled = true; btn.textContent='Creando cuenta...';
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, p1);
        const uid = cred.user.uid;
        let profileSaved = true;
        try {
          await set(ref(db, `users/${uid}`), { email, createdAt: new Date().toISOString() });
        } catch (e) {
          profileSaved = false;
          console.error('Error guardando perfil en RTDB:', e);
        }
        let verifOk = true;
        try{
          await sendEmailVerification(cred.user, { url: window.location.origin + '/' });
        }catch(err){
          verifOk = false;
          const code = err?.code || '';
          let msg = 'No se pudo enviar el correo de verificación.';
          if (code === 'auth/too-many-requests') msg = 'Demasiados intentos de verificación. Espera unos minutos y vuelve a intentarlo.';
          if (code === 'auth/invalid-continue-uri' || code === 'auth/unauthorized-continue-uri' || code === 'auth/missing-continue-uri'){
            msg = 'El dominio de retorno no está autorizado o falta la URL de retorno. Añádelo en Firebase > Authentication > Settings > Authorized domains.';
            // Intento de fallback sin continue URL
            try{ await sendEmailVerification(cred.user); verifOk = true; }catch(_){ }
          }
          regMsg.className='msg-err'; regMsg.textContent=msg;
        }
        if (verifOk){
          regMsg.className='msg-ok';
          regMsg.textContent = profileSaved ? 'Cuenta creada. Te enviamos un email para verificar tu cuenta.' : 'Cuenta creada. Te enviamos un email para verificar tu cuenta. Nota: no pudimos guardar tu perfil aún (permiso denegado). Se guardará después de verificar.';
        }
        const cta = document.getElementById('verify-cta'); if (cta) cta.classList.remove('hidden');
        selectTab('login');
      } catch(err){ regMsg.className='msg-err'; regMsg.textContent=mapAuthError(err?.code); }
      finally { btn.disabled=false; btn.textContent=prev; }
    });

    // Sistema de Puntos - Funciones principales
    window.PointsSystem = {
      // Obtener puntos del usuario desde puntosCliente con migración automática
      async getUserPoints(uid) {
        try {
          const userRef = ref(db, `users/${uid}/puntosCliente`);
          const snapshot = await get(userRef);
          
          // Si el campo puntosCliente no existe, migrar desde el sistema anterior
          if (!snapshot.exists()) {
            console.log('Campo puntosCliente no existe, iniciando migración automática...');
            const migratedPoints = await this.migrateUserPoints(uid);
            return migratedPoints;
          }
          
          return snapshot.val() || 0;
        } catch (error) {
          console.error('Error obteniendo puntos:', error);
          return 0;
        }
      },

      // Migrar puntos del sistema anterior al nuevo campo puntosCliente
      async migrateUserPoints(uid) {
        try {
          console.log(`Iniciando migración de puntos para usuario: ${uid}`);
          
          // Obtener pedidos del usuario
          const ordersSnap = await get(ref(db, `ordersByUser/${uid}`));
          let calculatedPoints = 0;
          let pendingPoints = 0;
          
          if (ordersSnap.exists()) {
            const orders = ordersSnap.val() || {};
            const ordersList = Object.entries(orders).map(([id, data]) => ({ id, ...(data || {}) }));
            
            // Calcular puntos basados en pedidos entregados y pendientes
            const numVal = (v) => { const n = Number(v); return Number.isFinite(n) ? n : 0; };
            
            ordersList.forEach(o => {
              const st = String(o.status || '').toLowerCase();
              let pointsForOrder = 0;
              
              // Calcular puntos para este pedido
              const pe = numVal(o.pointsEarned);
              if (pe > 0) {
                pointsForOrder = pe;
              } else {
                const sc = numVal(o.shirtsCount);
                if (sc > 0) {
                  pointsForOrder = sc * 10;
                } else if (o.itemsText) {
                  pointsForOrder = o.itemsText.split('\n').reduce((s, line) => {
                    const m = line.match(/(\d+)x\s/i);
                    return s + (m ? parseInt(m[1], 10) * 10 : 0);
                  }, 0);
                }
              }
              
              // Asignar a confirmados/entregados o pendientes
              if (st === 'confirmado' || st === 'entregado') {
                calculatedPoints += pointsForOrder;
              } else {
                // Puntos pendientes (pedidos no entregados)
                pendingPoints += pointsForOrder;
              }
            });
          }
          
          // Obtener puntos gastados en canjes anteriores
          let spentPoints = 0;
          try {
            const redemptionsSnap = await get(ref(db, `users/${uid}/redemptions`));
            if (redemptionsSnap.exists()) {
              const redemptions = redemptionsSnap.val() || {};
              spentPoints = Object.values(redemptions).reduce((sum, redemption) => {
                return sum + (redemption.points || 0);
              }, 0);
            }
          } catch (e) {
            console.warn('Error calculando puntos gastados durante migración:', e);
          }
          
          // Calcular puntos disponibles (ganados + pendientes - gastados)
          // Incluimos los pendientes como solicitado
          const totalPoints = calculatedPoints + pendingPoints;
          const availablePoints = Math.max(0, totalPoints - spentPoints);
          
          console.log(`Migración: Puntos calculados: ${calculatedPoints}, Pendientes: ${pendingPoints}, Gastados: ${spentPoints}, Disponibles: ${availablePoints}`);
          
          // Guardar en el nuevo campo puntosCliente
          const userRef = ref(db, `users/${uid}/puntosCliente`);
          await set(userRef, availablePoints);
          
          // Registrar la migración en el historial
          const migrationHistoryRef = ref(db, `users/${uid}/pointsHistory/${Date.now()}`);
          await set(migrationHistoryRef, {
            previousPoints: 0,
            newPoints: availablePoints,
            difference: availablePoints,
            reason: 'Migración automática del sistema anterior (incluye puntos pendientes)',
            timestamp: new Date().toISOString(),
            migration: true,
            calculatedFromOrders: calculatedPoints,
            pendingPoints: pendingPoints,
            spentPoints: spentPoints
          });
          
          console.log(`Migración completada para usuario ${uid}: ${availablePoints} puntos (incluye ${pendingPoints} pendientes)`);
          return availablePoints;
          
        } catch (error) {
          console.error('Error durante la migración de puntos:', error);
          return 0;
        }
      },

      // Actualizar puntos del usuario directamente en puntosCliente
      async updateUserPoints(uid, newPoints, reason = 'Ajuste manual') {
        try {
          const userRef = ref(db, `users/${uid}/puntosCliente`);
          const pointsHistoryRef = ref(db, `users/${uid}/pointsHistory/${Date.now()}`);
          
          // Obtener puntos actuales
          const currentPoints = await this.getUserPoints(uid);
          
          // Guardar nuevo saldo en puntosCliente
          await set(userRef, newPoints);
          
          // Registrar en historial
          await set(pointsHistoryRef, {
            previousPoints: currentPoints,
            newPoints: newPoints,
            difference: newPoints - currentPoints,
            reason: reason,
            timestamp: new Date().toISOString(),
            adminAction: true
          });
          
          return true;
        } catch (error) {
          console.error('Error actualizando puntos:', error);
          return false;
        }
      },

      // Añadir puntos al usuario (para cuando se confirmen pedidos)
      async addPoints(uid, pointsToAdd, reason = 'Puntos por pedido') {
        try {
          const currentPoints = await this.getUserPoints(uid);
          const newPoints = currentPoints + pointsToAdd;
          return await this.updateUserPoints(uid, newPoints, reason);
        } catch (error) {
          console.error('Error añadiendo puntos:', error);
          return false;
        }
      },

      // Restar puntos al usuario (para canjes)
      async subtractPoints(uid, pointsToSubtract, reason = 'Canje de recompensa') {
        try {
          const currentPoints = await this.getUserPoints(uid);
          if (currentPoints < pointsToSubtract) {
            throw new Error('Puntos insuficientes');
          }
          const newPoints = currentPoints - pointsToSubtract;
          return await this.updateUserPoints(uid, newPoints, reason);
        } catch (error) {
          console.error('Error restando puntos:', error);
          return false;
        }
      },
      
      // Verificar si el usuario tiene suficientes puntos para canjear
      // Incluye sistema de respaldo para usar window.USER_POINTS_AVAILABLE si falla la base de datos
      async verifyUserHasEnoughPoints(uid, pointsNeeded) {
        try {
          // Intentar obtener puntos de la base de datos primero
          const dbPoints = await this.getUserPoints(uid);
          
          if (dbPoints >= pointsNeeded) {
            console.log(`Verificación de puntos exitosa desde DB: ${dbPoints} >= ${pointsNeeded}`);
            return true;
          }
          
          // Si no hay suficientes puntos en la base de datos, verificar el respaldo
          console.log(`Puntos insuficientes en DB (${dbPoints}), verificando respaldo...`);
          
          // Usar window.USER_POINTS_AVAILABLE como respaldo
          const backupPoints = window.USER_POINTS_AVAILABLE || 0;
          
          if (backupPoints >= pointsNeeded) {
            console.log(`Verificación de puntos exitosa desde respaldo: ${backupPoints} >= ${pointsNeeded}`);
            
            // Intentar sincronizar los puntos del respaldo con la base de datos
            try {
              console.log(`Sincronizando puntos de respaldo (${backupPoints}) con la base de datos`);
              await this.updateUserPoints(uid, backupPoints, 'Sincronización desde respaldo');
            } catch (syncError) {
              console.warn('No se pudieron sincronizar los puntos con la base de datos:', syncError);
              // Continuamos aunque falle la sincronización
            }
            
            return true;
          }
          
          // No hay suficientes puntos en ninguna fuente
          console.log(`Puntos insuficientes en ambas fuentes. DB: ${dbPoints}, Respaldo: ${backupPoints}, Necesarios: ${pointsNeeded}`);
          return false;
          
        } catch (error) {
          console.error('Error al verificar puntos del usuario:', error);
          
          // En caso de error, intentar usar el respaldo
          const backupPoints = window.USER_POINTS_AVAILABLE || 0;
          const hasEnough = backupPoints >= pointsNeeded;
          
          console.log(`Usando puntos de respaldo debido a error: ${backupPoints} ${hasEnough ? '>=' : '<'} ${pointsNeeded}`);
          return hasEnough;
        }
      },
      
      // Actualizar estado de pedido y asignar puntos si es necesario
      async updateOrderStatus(orderId, uid, newStatus, adminUid = null) {
        try {
          if (!orderId || !uid || !newStatus) {
            throw new Error('Datos insuficientes para actualizar estado del pedido');
          }
          
          // Obtener datos actuales del pedido
          const orderRef = ref(db, `ordersByUser/${uid}/${orderId}`);
          const snapshot = await get(orderRef);
          
          if (!snapshot.exists()) {
            throw new Error(`Pedido ${orderId} no encontrado`);
          }
          
          const orderData = snapshot.val();
          const oldStatus = orderData.status || 'pendiente-de-confirmacion';
          
          // Si el estado no ha cambiado, no hacer nada
          if (oldStatus === newStatus) {
            return { success: true, message: 'El estado ya era ' + newStatus, pointsAdded: 0 };
          }
          
          // Actualizar estado del pedido
          await set(ref(db, `ordersByUser/${uid}/${orderId}/status`), newStatus);
          await set(ref(db, `ordersByUser/${uid}/${orderId}/statusUpdatedAt`), new Date().toISOString());
          
          if (adminUid) {
            await set(ref(db, `ordersByUser/${uid}/${orderId}/statusUpdatedBy`), adminUid);
          }
          
          // Si el nuevo estado es 'entregado', asignar puntos al usuario
          let pointsAdded = 0;
          if (newStatus === 'entregado') {
            try {
              // Calcular puntos (10 por cada camiseta)
              const shirtsCount = orderData.shirtsCount || 0;
              pointsAdded = shirtsCount * 10;
              
              if (pointsAdded > 0) {
                // Verificar si ya se asignaron puntos por este pedido
                const pointsByOrderRef = ref(db, `users/${uid}/pointsByOrder/${orderId}`);
                const pointsSnapshot = await get(pointsByOrderRef);
                
                if (!pointsSnapshot.exists()) {
                  // Asignar puntos al usuario usando la nueva función
                  const success = await this.addPoints(uid, pointsAdded, `Pedido entregado #${orderId}`);
                  if (success) {
                    console.log(`Puntos asignados automáticamente: ${pointsAdded} para usuario ${uid} por pedido ${orderId}`);
                  } else {
                    console.error(`Error al asignar puntos para el pedido ${orderId}`);
                    throw new Error(`Error al asignar puntos para el pedido ${orderId}`);
                  }
                } else {
                  console.log(`Ya se asignaron puntos para el pedido ${orderId}`);
                  pointsAdded = 0; // No se agregaron nuevos puntos
                }
              }
            } catch (pointsError) {
              console.error('Error al asignar puntos:', pointsError);
              // No lanzamos el error para que el cambio de estado se complete de todos modos
              // pero registramos el error para depuración
            }
          }
          
          return { 
            success: true, 
            message: `Estado actualizado de ${oldStatus} a ${newStatus}`, 
            pointsAdded: pointsAdded 
          };
        } catch (error) {
          console.error('Error actualizando estado del pedido:', error);
          return { 
            success: false, 
            message: error.message || 'Error desconocido', 
            pointsAdded: 0 
          };
        }
      },

      // Agregar puntos (por compra) - FUNCIÓN LEGACY - Usar PointsSystem.addPoints en su lugar
      async addPoints(uid, points, reason = 'Compra realizada', orderId = null) {
        try {
          // Usar la nueva función del PointsSystem
          const success = await window.PointsSystem.addPoints(uid, points, reason);
          
          // Marcar como procesado si hay orderId
          if (success && orderId) {
            try {
              await set(ref(db, `users/${uid}/pointsByOrder/${orderId}`), {
                points: points,
                timestamp: new Date().toISOString()
              });
              console.log(`Orden ${orderId} marcada como procesada para el usuario ${uid}`);
            } catch (orderError) {
              console.error(`Error al marcar orden ${orderId} como procesada para el usuario ${uid}:`, orderError);
            }
          }
          
          return success;
        } catch (error) {
          console.error('Error en addPoints legacy:', error);
          return false;
        }
      },

      // Canjear puntos por descuento
      async redeemPoints(uid, pointsToRedeem, rewardType, rewardValue) {
        try {
          // Validaciones de seguridad
          if (!uid || !pointsToRedeem || pointsToRedeem <= 0) {
            throw new Error('Datos inválidos para canjear puntos');
          }
          
          if (!rewardType || rewardValue === undefined) {
            throw new Error('Tipo de recompensa inválido');
          }
          
          const currentPoints = await this.getUserPoints(uid);
          
          if (currentPoints < pointsToRedeem) {
            throw new Error('Puntos insuficientes');
          }
          
          // Verificar que no se canjee más de lo permitido
          if (pointsToRedeem > 1000) {
            throw new Error('No se pueden canjear más de 1000 puntos a la vez');
          }
          
          const newPoints = currentPoints - pointsToRedeem;
          const pointsRef = ref(db, `users/${uid}/points`);
          const pointsHistoryRef = ref(db, `users/${uid}/pointsHistory/${Date.now()}`);
          const redemptionRef = ref(db, `users/${uid}/redemptions/${Date.now()}`);
          
          // Guardar nuevo saldo
          await set(pointsRef, newPoints);
          
          // Registrar en historial
          await set(pointsHistoryRef, {
            previousPoints: currentPoints,
            newPoints: newPoints,
            difference: -pointsToRedeem,
            reason: `Canje: ${rewardType} - ${rewardValue}`,
            timestamp: new Date().toISOString(),
            adminAction: false
          });
          
          // Registrar canje
          await set(redemptionRef, {
            pointsUsed: pointsToRedeem,
            rewardType: rewardType,
            rewardValue: rewardValue,
            timestamp: new Date().toISOString(),
            used: false
          });
          
          return true;
        } catch (error) {
          console.error('Error canjeando puntos:', error);
          throw error;
        }
      },

      // Obtener historial de puntos
      async getPointsHistory(uid) {
        try {
          const historyRef = ref(db, `users/${uid}/pointsHistory`);
          const snapshot = await get(historyRef);
          if (!snapshot.exists()) return [];
          
          const history = [];
          snapshot.forEach((childSnapshot) => {
            history.push({
              id: childSnapshot.key,
              ...childSnapshot.val()
            });
          });
          
          return history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        } catch (error) {
          console.error('Error obteniendo historial:', error);
          return [];
        }
      },

      // Obtener canjes del usuario
      async getUserRedemptions(uid) {
        try {
          const redemptionsRef = ref(db, `users/${uid}/redemptions`);
          const snapshot = await get(redemptionsRef);
          if (!snapshot.exists()) return [];
          
          const redemptions = [];
          snapshot.forEach((childSnapshot) => {
            redemptions.push({
              id: childSnapshot.key,
              ...childSnapshot.val()
            });
          });
          
          return redemptions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        } catch (error) {
          console.error('Error obteniendo canjes:', error);
          return [];
        }
      }
    };

    // Estado de autenticación y UI de perfil
    function updateIdentityLabels(user){
      try{
        const topBtn = document.querySelector('.boton-seccion[data-seccion="identificarse"]');
        if (topBtn) topBtn.textContent = user ? 'Perfil' : 'Identificarse';
        const bottomBtn = document.querySelector('.bottom-nav__btn[data-seccion="identificarse"]');
        if (bottomBtn){
          const lab = bottomBtn.querySelector('.label');
          if (lab) lab.textContent = user ? 'Perfil' : 'Acceso';
          bottomBtn.setAttribute('aria-label', user ? 'Ir a Perfil' : 'Ir a Identificarse');
        }
      }catch(e){}
    }

    const profileUI = document.getElementById('profile-section');
    const profileEmailEl = document.getElementById('profile-email');
    const profileAvatarEl = document.getElementById('profile-avatar');
    const ordersListEl = document.getElementById('orders-list');
    const ordersEmptyEl = document.getElementById('orders-empty');
    const profileOrdersPanel = document.getElementById('profile-orders');
    const profileAccountPanel = document.getElementById('profile-account');
    const profilePointsPanel = document.getElementById('profile-points');

    // Configuración de recompensas disponibles
    const AVAILABLE_REWARDS = [
      { id: 'discount_5', name: '5% Descuento', points: 50, type: 'percentage', value: 5, description: '5% de descuento en tu próxima compra' },
      { id: 'discount_10', name: '10% Descuento', points: 100, type: 'percentage', value: 10, description: '10% de descuento en tu próxima compra' },
      { id: 'discount_15', name: '15% Descuento', points: 150, type: 'percentage', value: 15, description: '15% de descuento en tu próxima compra' },
      { id: 'discount_20', name: '20% Descuento', points: 200, type: 'percentage', value: 20, description: '20% de descuento en tu próxima compra' },
      { id: 'free_shipping', name: 'Envío Gratis', points: 80, type: 'shipping', value: 0, description: 'Envío gratuito en tu próxima compra' },
      { id: 'euro_5', name: '5€ Descuento', points: 100, type: 'fixed', value: 5, description: '5€ de descuento fijo en tu próxima compra' },
      { id: 'euro_10', name: '10€ Descuento', points: 200, type: 'fixed', value: 10, description: '10€ de descuento fijo en tu próxima compra' }
    ];

    // Cargar puntos del usuario
    async function loadUserPoints(uid) {
      try {
        // Obtener puntos disponibles del usuario
        const points = await window.PointsSystem.getUserPoints(uid);
        
        // Actualizar la variable global para asegurar consistencia
        window.USER_POINTS_AVAILABLE = points;
        console.log('loadUserPoints: Puntos disponibles actualizados:', points);
        
        const pointsBalanceEl = document.getElementById('user-points-balance');
        const pointsTotalEl = document.getElementById('points-total');
        
        if (pointsBalanceEl) pointsBalanceEl.textContent = points;
        if (pointsTotalEl) pointsTotalEl.textContent = points;
        
        // Cargar recompensas disponibles
        await loadAvailableRewards(uid, points);
        
        // Cargar historial de puntos
        await loadPointsHistory(uid);
        
      } catch (error) {
        console.error('Error cargando puntos:', error);
      }
    }

    // Cargar recompensas disponibles
    async function loadAvailableRewards(uid, userPoints) {
      const rewardsGrid = document.getElementById('points-rewards-grid');
      if (!rewardsGrid) return;
      
      rewardsGrid.innerHTML = '';
      
      // Usar window.USER_POINTS_AVAILABLE directamente para asegurar consistencia
      const availablePoints = Number(window.USER_POINTS_AVAILABLE || userPoints || 0);
      console.log('Puntos disponibles para mostrar recompensas:', availablePoints);
      
      AVAILABLE_REWARDS.forEach(reward => {
        const canAfford = availablePoints >= reward.points;
        const rewardCard = document.createElement('div');
        rewardCard.className = 'reward-card';
        rewardCard.style.cssText = `
          background: ${canAfford ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.1)'};
          border: 1px solid ${canAfford ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)'};
          border-radius: 8px;
          padding: 16px;
          text-align: center;
          cursor: ${canAfford ? 'pointer' : 'not-allowed'};
          opacity: ${canAfford ? '1' : '0.6'};
          transition: all 0.3s ease;
        `;
        
        rewardCard.innerHTML = `
          <div style="font-size:24px;margin-bottom:8px;">${getRewardIcon(reward.type)}</div>
          <div style="color:#fff;font-weight:600;margin-bottom:4px;">${reward.name}</div>
          <div style="color:rgba(255,255,255,0.8);font-size:12px;margin-bottom:8px;">${reward.description}</div>
          <div style="display:flex;align-items:center;justify-content:center;gap:4px;margin-bottom:12px;">
            <span style="color:#ffd700;font-weight:700;">${reward.points}</span>
            <span style="color:rgba(255,255,255,0.7);font-size:12px;">puntos</span>
          </div>
          <button class="redeem-btn" ${!canAfford ? 'disabled' : ''} style="
            background: ${canAfford ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.1)'};
            border: 1px solid ${canAfford ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.1)'};
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: ${canAfford ? 'pointer' : 'not-allowed'};
            width: 100%;
            transition: all 0.3s ease;
          ">
            ${canAfford ? 'Canjear' : 'Puntos insuficientes'}
          </button>
        `;
        
        if (canAfford) {
          rewardCard.addEventListener('click', () => redeemReward(uid, reward));
          rewardCard.addEventListener('mouseenter', () => {
            rewardCard.style.background = 'rgba(255,255,255,0.3)';
            rewardCard.style.transform = 'translateY(-2px)';
          });
          rewardCard.addEventListener('mouseleave', () => {
            rewardCard.style.background = 'rgba(255,255,255,0.2)';
            rewardCard.style.transform = 'translateY(0)';
          });
        }
        
        rewardsGrid.appendChild(rewardCard);
      });
    }

    // Obtener icono para tipo de recompensa
    function getRewardIcon(type) {
      const icons = {
        percentage: '📊',
        fixed: '💰',
        shipping: '🚚'
      };
      return icons[type] || '🎁';
    }

    // Canjear recompensa
    async function redeemReward(uid, reward) {
      try {
        const confirmed = confirm(`¿Estás seguro de que quieres canjear ${reward.points} puntos por ${reward.name}?`);
        if (!confirmed) return;
        
        // Verificar puntos disponibles con sistema de respaldo
        // Implementamos la nueva función que verifica tanto en BD como en USER_POINTS_AVAILABLE
        const hasEnoughPoints = await window.PointsSystem.verifyUserHasEnoughPoints(uid, reward.points);
        console.log(`Verificación de puntos para canje: ${hasEnoughPoints ? 'Suficientes' : 'Insuficientes'}`);
        
        if (!hasEnoughPoints) {
          const displayPoints = window.USER_POINTS_AVAILABLE || await window.PointsSystem.getUserPoints(uid) || 0;
          showMessage(`No tienes suficientes puntos. Necesitas ${reward.points} puntos pero solo tienes ${displayPoints}.`, 'error');
          return;
        }
        
        // Restar puntos usando la función del PointsSystem
        const success = await window.PointsSystem.subtractPoints(uid, reward.points, `Canje: ${reward.name}`);
        if (!success) {
          showMessage('Error al procesar el canje. Inténtalo de nuevo.', 'error');
          return;
        }
        
        // Generar ID único para la recompensa
        const rewardId = Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
        
        // Crear objeto de recompensa para guardar en la base de datos
        const rewardData = {
          id: rewardId,
          type: reward.type,
          value: reward.value,
          name: reward.name,
          description: reward.description || `${reward.name} - ${reward.value}${reward.type === 'percentage' ? '%' : '€'} de descuento`,
          points: reward.points,
          createdAt: new Date().toISOString(),
          used: false
        };
        
        // Guardar recompensa en el inventario del usuario
        const rewardRef = ref(db, `users/${uid}/redemptions/${rewardId}`);
        await set(rewardRef, rewardData);
        
        console.log(`Puntos canjeados correctamente: ${reward.points} puntos por ${reward.name}`);
        
        // Mostrar mensaje de éxito
        showMessage(`¡Recompensa canjeada! ${reward.name} está disponible en tu próxima compra.`, 'success');
        
        // Recargar puntos y recompensas
        await loadUserPoints(uid);
        
        // Recargar descuentos disponibles en el carrito
        await loadUserDiscounts();
        
      } catch (error) {
        console.error('Error canjeando recompensa:', error);
        showMessage(`Error: ${error.message}`, 'error');
      }
    }

    // Cargar historial de puntos
    async function loadPointsHistory(uid) {
      try {
        const history = await window.PointsSystem.getPointsHistory(uid);
        const historyList = document.getElementById('points-history-list');
        if (!historyList) return;
        
        if (history.length === 0) {
          historyList.innerHTML = '<div style="color:rgba(255,255,255,0.7);text-align:center;padding:20px;">No hay historial de puntos</div>';
          return;
        }
        
        historyList.innerHTML = history.slice(0, 10).map(entry => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);">
            <div>
              <div style="color:#fff;font-size:14px;">${entry.reason}</div>
              <div style="color:rgba(255,255,255,0.6);font-size:12px;">${new Date(entry.timestamp).toLocaleDateString()}</div>
            </div>
            <div style="color:${entry.difference > 0 ? '#4CAF50' : '#f44336'};font-weight:600;">
              ${entry.difference > 0 ? '+' : ''}${entry.difference}
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error cargando historial:', error);
      }
    }

    // Función para mostrar mensajes
    function showMessage(message, type = 'info') {
      const messageEl = document.createElement('div');
      messageEl.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-width: 300px;
      `;
      messageEl.textContent = message;
      document.body.appendChild(messageEl);
      
      setTimeout(() => {
        messageEl.remove();
      }, 5000);
    }

    // Panel Administrativo - Funciones
    const ADMIN_EMAILS = ['admin@camisetazo.com', 'igort@camisetazo.com']; // Lista de emails de administradores

    // Verificar si el usuario es administrador
    function isAdmin(user) {
      return user && ADMIN_EMAILS.includes(user.email);
    }

    // Mostrar/ocultar panel administrativo
    function toggleAdminPanel(user) {
      const adminPanel = document.getElementById('admin-panel');
      if (adminPanel) {
        if (isAdmin(user)) {
          adminPanel.classList.remove('hidden');
          loadAdminUsersList();
        } else {
          adminPanel.classList.add('hidden');
        }
      }
    }

    // Cargar lista de usuarios para administradores
    async function loadAdminUsersList() {
      try {
        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        const usersList = document.getElementById('admin-users-list');
        
        if (!snapshot.exists() || !usersList) return;
        
        const users = [];
        snapshot.forEach((childSnapshot) => {
          const userData = childSnapshot.val();
          users.push({
            uid: childSnapshot.key,
            email: userData.email,
            createdAt: userData.createdAt
          });
        });
        
        // Ordenar por fecha de creación (más recientes primero)
        users.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
        usersList.innerHTML = users.slice(0, 10).map(user => `
          <div style="
            display:flex;justify-content:space-between;align-items:center;
            padding:8px 12px;margin-bottom:4px;background:rgba(255,255,255,0.1);
            border-radius:6px;cursor:pointer;transition:background 0.2s;
          " onclick="selectUserForAdmin('${user.uid}', '${user.email}')">
            <div>
              <div style="color:#fff;font-size:14px;">${user.email}</div>
              <div style="color:rgba(255,255,255,0.6);font-size:12px;">${new Date(user.createdAt).toLocaleDateString()}</div>
            </div>
            <div style="color:rgba(255,255,255,0.5);font-size:12px;">👆</div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error cargando lista de usuarios:', error);
      }
    }

    // Seleccionar usuario para administración
    window.selectUserForAdmin = async function(uid, email) {
      try {
        const points = await window.PointsSystem.getUserPoints(uid);
        
        document.getElementById('admin-user-email').textContent = email;
        document.getElementById('admin-user-uid').textContent = uid;
        document.getElementById('admin-user-points').textContent = points;
        document.getElementById('admin-new-points').value = points;
        
        const userInfo = document.getElementById('admin-user-info');
        userInfo.classList.remove('hidden');
        
      } catch (error) {
        console.error('Error seleccionando usuario:', error);
        showMessage('Error al cargar información del usuario', 'error');
      }
    };

    // Buscar usuario por email
    async function searchUserByEmail(email) {
      try {
        const usersRef = ref(db, 'users');
        const snapshot = await get(usersRef);
        
        if (!snapshot.exists()) {
          showMessage('No se encontraron usuarios', 'error');
          return;
        }
        
        let foundUser = null;
        snapshot.forEach((childSnapshot) => {
          const userData = childSnapshot.val();
          if (userData.email && userData.email.toLowerCase() === email.toLowerCase()) {
            foundUser = {
              uid: childSnapshot.key,
              email: userData.email
            };
          }
        });
        
        if (foundUser) {
          await selectUserForAdmin(foundUser.uid, foundUser.email);
          showMessage('Usuario encontrado', 'success');
        } else {
          showMessage('Usuario no encontrado', 'error');
        }
        
      } catch (error) {
        console.error('Error buscando usuario:', error);
        showMessage('Error al buscar usuario', 'error');
      }
    }

    // Actualizar puntos de usuario
    async function updateUserPoints() {
      try {
        const uid = document.getElementById('admin-user-uid').textContent;
        const newPoints = parseInt(document.getElementById('admin-new-points').value);
        const reason = document.getElementById('admin-reason').value || 'Ajuste administrativo';
        
        // Validaciones de seguridad
        if (!uid || isNaN(newPoints)) {
          showMessage('Datos inválidos', 'error');
          return;
        }
        
        if (newPoints < 0) {
          showMessage('Los puntos no pueden ser negativos', 'error');
          return;
        }
        
        if (newPoints > 10000) {
          showMessage('No se pueden asignar más de 10,000 puntos', 'error');
          return;
        }
        
        if (reason.length < 3) {
          showMessage('El motivo debe tener al menos 3 caracteres', 'error');
          return;
        }
        
        // Confirmar acción
        const confirmed = confirm(`¿Estás seguro de actualizar los puntos a ${newPoints}?`);
        if (!confirmed) return;
        
        const success = await window.PointsSystem.updateUserPoints(uid, newPoints, reason);
        
        if (success) {
          showMessage('Puntos actualizados correctamente', 'success');
          document.getElementById('admin-user-points').textContent = newPoints;
          document.getElementById('admin-reason').value = '';
        } else {
          showMessage('Error al actualizar puntos', 'error');
        }
        
      } catch (error) {
        console.error('Error actualizando puntos:', error);
        showMessage('Error al actualizar puntos', 'error');
      }
    }

    function renderOrdersList(orders){
      console.log('renderOrdersList: Renderizando lista de pedidos, cantidad:', orders ? orders.length : 0);
      console.log('renderOrdersList: Datos de pedidos:', orders);
      ordersListEl.innerHTML = '';
      if (!orders || orders.length === 0){
        ordersEmptyEl.classList.remove('hidden');
        ordersEmptyEl.innerHTML = `
          <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);border-radius:16px;padding:48px 24px;text-align:center;">
            <div style="width:80px;height:80px;margin:0 auto 20px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(102,126,234,0.3);">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" fill="white" opacity="0.7"/>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2v16a2 2 0 002 2h8a2 2 0 002-2V5a1 1 0 100-2 2 2 0 012 2v16a4 4 0 01-4 4H6a4 4 0 01-4-4V5z" fill="white"/>
              </svg>
            </div>
            <h3 style="color:#2d3748;font-size:20px;font-weight:700;margin:0 0 8px 0;font-family:'Segoe UI', system-ui, sans-serif;">No tienes pedidos aún</h3>
            <p style="color:#718096;font-size:14px;margin:0;font-family:'Segoe UI', system-ui, sans-serif;">Cuando realices tu primera compra, aparecerá aquí</p>
            <div style="margin-top:24px;padding-top:24px;border-top:1px solid rgba(0,0,0,0.1);">
              <p style="color:#a0aec0;font-size:12px;margin:0;">💡 Recuerda iniciar sesión antes de comprar para acumular puntos</p>
            </div>
          </div>
        `;
        return;
      }
      ordersEmptyEl.classList.add('hidden');
      
      // Añadir estilos específicos para las tarjetas de pedidos con tipografía profesional
      if (!document.getElementById('order-cards-styles')) {
        const style = document.createElement('style');
        style.id = 'order-cards-styles';
        style.textContent = `
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
          .order-card {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 0;
            margin-bottom: 20px;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3), 0 0 20px rgba(96, 165, 250, 0.15);
          }
          .order-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4), 0 0 30px rgba(96, 165, 250, 0.3);
            border-color: #667eea;
          }
          .order-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
          }
          .order-card-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
          .order-card-body {
            padding: 20px 24px;
            background: rgba(15, 23, 42, 0.6);
          }
          .order-status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          }
          .order-status-pendiente-de-confirmacion { background: rgba(156, 163, 175, 0.2); color: #9ca3af; border: 1px solid rgba(156, 163, 175, 0.3); }
          .order-status-confirmado { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3); }
          .order-status-entregado { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
          .order-status-recibido { background: rgba(118, 75, 162, 0.2); color: #c084fc; border: 1px solid rgba(192, 132, 252, 0.3); }
          .order-status-processing { background: rgba(243, 156, 18, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); }
          .order-status-shipped { background: rgba(52, 152, 219, 0.2); color: #60a5fa; border: 1px solid rgba(96, 165, 250, 0.3); }
          .order-status-delivered { background: rgba(39, 174, 96, 0.2); color: #34d399; border: 1px solid rgba(52, 211, 153, 0.3); }
          .order-status-cancelled { background: rgba(231, 76, 60, 0.2); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.3); }
          .order-expand-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            padding: 12px 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 14px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 16px;
          }
          .order-expand-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(102,126,234,0.3);
          }
          .order-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(15, 23, 42, 0.8);
            border-top: 1px solid rgba(99, 102, 241, 0.1);
            box-shadow: inset 0 2px 8px rgba(96, 165, 250, 0.1);
          }
          .order-details.expanded {
            max-height: 800px;
          }
          .order-details-inner {
            padding: 20px 24px;
          }
          .order-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
            font-size: 14px;
            font-family: 'Inter', sans-serif;
          }
          .order-detail-row:last-child {
            border-bottom: none;
          }
          .order-detail-label {
            color: #94a3b8;
            font-weight: 500;
          }
          .order-detail-value {
            color: #e2e8f0;
            text-align: right;
            font-weight: 600;
            max-width: 60%;
            word-wrap: break-word;
          }
          .order-products-box {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #cbd5e1;
            white-space: pre-wrap;
            word-break: break-word;
            box-shadow: 0 2px 8px rgba(96, 165, 250, 0.1);
          }
        `;
        document.head.appendChild(style);
      }
      
      orders.forEach((o, index) => {
        const card = document.createElement('div');
        card.className = 'order-card';
        
        // Formatear fecha
        const dateStr = o.date ? new Date(o.date).toLocaleDateString('es-ES', {
          day: '2-digit',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : (o.createdAt ? new Date(o.createdAt).toLocaleDateString('es-ES', {
          day: '2-digit',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : 'Fecha desconocida');
        
        const totalStr = typeof o.total === 'number' ? `€${o.total.toFixed(2)}` : (o.total || '€0.00');
        const status = o.status || 'recibido';
        const statusClass = `order-status-${status.toLowerCase().replace(/\s+/g, '-')}`;
        const statusText = {
          'pendiente-de-confirmacion': 'Pendiente de Confirmación',
          'confirmado': 'Confirmado',
          'entregado': 'Entregado',
          'recibido': 'Recibido',
          'processing': 'Procesando',
          'shipped': 'Enviado',
          'delivered': 'Entregado',
          'cancelled': 'Cancelado'
        }[status.toLowerCase()] || status;
        
        // Calcular puntos
        const points = (typeof o.pointsEarned === 'number') ? o.pointsEarned : 
          (o.shirtsCount ? o.shirtsCount * 10 : 0);
        
        // Crear número de pedido más corto y legible
        const shortId = o.id ? o.id.substring(0, 8).toUpperCase() : `ORD${(index + 1).toString().padStart(4, '0')}`;
        
        // Crear icono según el estado
        const statusIcon = {
          'pendiente-de-confirmacion': '⏳',
          'confirmado': '✅',
          'entregado': '🎉',
          'recibido': '📦',
          'processing': '⏳',
          'shipped': '🚚',
          'delivered': '✅',
          'cancelled': '❌'
        }[status.toLowerCase()] || '📦';
        
        card.innerHTML = `
          <div class="order-card-header">
            <div>
              <div style="display:flex;align-items:center;gap:12px;">
                <div style="width:40px;height:40px;background:rgba(255,255,255,0.15);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;">
                  ${statusIcon}
                </div>
                <div>
                  <div style="font-weight:700;color:#ffffff;font-size:18px;margin-bottom:2px;font-family:'Inter', sans-serif;">
                    Pedido #${shortId}
                  </div>
                  <div style="color:rgba(255,255,255,0.85);font-size:13px;font-family:'Inter', sans-serif;">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" style="display:inline;margin-right:4px;vertical-align:middle;">
                      <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" fill="currentColor" opacity="0.6"/>
                    </svg>
                    ${dateStr}
                  </div>
                </div>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
              <span class="order-status-badge ${statusClass}">
                <span style="display:inline-block;width:6px;height:6px;background:currentColor;border-radius:50%;margin-right:6px;vertical-align:middle;"></span>
                ${statusText}
              </span>
              ${isAdmin(auth.currentUser) ? `
                <div class="admin-order-controls" style="display:flex;gap:6px;">
                  <select class="status-selector" data-order-id="${o.id}" data-user-id="${o.uid || ''}" style="
                    background: rgba(255,255,255,0.1);
                    border: 1px solid rgba(255,255,255,0.2);
                    color: #fff;
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-size: 12px;
                    cursor: pointer;
                  ">
                    <option value="" disabled selected>Cambiar estado</option>
                    <option value="pendiente-de-confirmacion" ${status === 'pendiente-de-confirmacion' ? 'disabled' : ''}>Pendiente</option>
                    <option value="confirmado" ${status === 'confirmado' ? 'disabled' : ''}>Confirmado</option>
                    <option value="entregado" ${status === 'entregado' ? 'disabled' : ''}>Entregado</option>
                    <option value="recibido" ${status === 'recibido' ? 'disabled' : ''}>Recibido</option>
                  </select>
                </div>
              ` : ''}
            </div>
          </div>
          
          <div class="order-card-body">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(99,102,241,0.2);">
              <div>
                <div style="color:#94a3b8;font-size:12px;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px;font-weight:500;">Total del pedido</div>
                <div style="font-size:32px;font-weight:700;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-family:'Inter', sans-serif;">${totalStr}</div>
              </div>
              ${points > 0 ? `
                <div style="text-align:center;">
                  <div style="background:linear-gradient(135deg, #f6d365 0%, #fda085 100%);border-radius:12px;padding:12px 20px;box-shadow:0 4px 12px rgba(253,160,133,0.3);">
                    <div style="color:#fff;font-size:11px;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px;font-weight:600;">Puntos ganados</div>
                    <div style="color:#fff;font-size:24px;font-weight:700;">+${points}</div>
                  </div>
                </div>
              ` : ''}
            </div>
            
            ${o.shirtsCount && o.shirtsCount > 0 ? `
              <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:12px;margin-bottom:16px;">
                <div style="background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);border-radius:8px;padding:12px;text-align:center;">
                  <div style="font-size:20px;margin-bottom:4px;">👕</div>
                  <div style="color:#94a3b8;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Camisetas</div>
                  <div style="color:#e2e8f0;font-size:20px;font-weight:700;">${o.shirtsCount}</div>
                </div>
                ${o.total > 0 ? `
                  <div style="background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);border-radius:8px;padding:12px;text-align:center;">
                    <div style="font-size:20px;margin-bottom:4px;">💰</div>
                    <div style="color:#94a3b8;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Por unidad</div>
                    <div style="color:#e2e8f0;font-size:20px;font-weight:700;">€${(o.total/o.shirtsCount).toFixed(2)}</div>
                  </div>
                ` : ''}
              </div>
            ` : ''}
            
            ${status.toLowerCase() === 'confirmado' ? `
              <div style="background:linear-gradient(135deg, #10b981 0%, #059669 100%);border-radius:12px;padding:20px;margin-bottom:16px;text-align:center;box-shadow:0 4px 12px rgba(16,185,129,0.3);">
                <div style="font-size:24px;margin-bottom:8px;">🎉</div>
                <h3 style="color:#fff;font-size:18px;font-weight:700;margin:0 0 12px 0;">¡Gana Puntos con cada Compra!</h3>
                <p style="color:rgba(255,255,255,0.9);font-size:14px;margin:0 0 16px 0;">Compra en Camisetazo y envía una foto de tu pedido cuando lo recibas.<br/>¡Te damos <strong>10 puntos por cada camiseta</strong> comprada! 💥</p>
                <div style="background:rgba(255,255,255,0.1);border-radius:8px;padding:12px;margin-bottom:16px;">
                  <p style="color:#fff;font-size:14px;margin:0;">📸 <strong>Ejemplo:</strong> Si compras ${o.shirtsCount || 5} camisetas, obtienes <strong>${(o.shirtsCount || 5) * 10} puntos</strong>.</p>
                </div>
                <div style="text-align:left;">
                  <h4 style="color:#fff;font-size:16px;font-weight:600;margin:0 0 12px 0;">🎁 Premios por Puntos</h4>
                  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:8px;">
                    <div style="background:rgba(255,255,255,0.1);border-radius:6px;padding:8px;text-align:center;">
                      <div style="color:#fbbf24;font-weight:700;">20 pts</div>
                      <div style="color:#fff;font-size:12px;">10% dto</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.1);border-radius:6px;padding:8px;text-align:center;">
                      <div style="color:#fbbf24;font-weight:700;">40 pts</div>
                      <div style="color:#fff;font-size:12px;">15% dto</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.1);border-radius:6px;padding:8px;text-align:center;">
                      <div style="color:#fbbf24;font-weight:700;">60 pts</div>
                      <div style="color:#fff;font-size:12px;">20% dto</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.1);border-radius:6px;padding:8px;text-align:center;">
                      <div style="color:#ffd700;font-weight:700;">100 pts</div>
                      <div style="color:#fff;font-size:12px;">🔥 Gratis</div>
                    </div>
                  </div>
                </div>
              </div>
            ` : ''}
            
            <button class="order-expand-btn" onclick="toggleOrderDetails('${o.id || shortId}')">
              <span style="display:flex;align-items:center;gap:8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm-7 4c0-3.86 3.14-7 7-7s7 3.14 7 7-3.14 7-7 7-7-3.14-7-7z" fill="currentColor" opacity="0.9"/>
                  <path d="M12 10v4M10 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Ver detalles completos
              </span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" id="arrow-${o.id || shortId}" style="transition:transform 0.3s;">
                <path d="M7 10l5 5 5-5H7z"/>
              </svg>
            </button>
          </div>
          
          <div class="order-details" id="details-${o.id || shortId}">
            <div class="order-details-inner">
              ${o.itemsText ? `
                <div style="margin-bottom:20px;padding:16px;background:rgba(96,165,250,0.05);border-radius:12px;border:1px solid rgba(96,165,250,0.1);">
                  <h4 style="color:#e2e8f0;font-size:16px;font-weight:600;margin:0 0 12px 0;font-family:'Inter', sans-serif;display:flex;align-items:center;gap:8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                      <path d="M7 4V2c0-.55.45-1 1-1h8c.55 0 1 .45 1 1v2h4c.55 0 1 .45 1 1s-.45 1-1 1H3c-.55 0-1-.45-1-1s.45-1 1-1h4zm10 0V2H7v2h10zm-1 15c0 .55-.45 1-1 1H9c-.55 0-1-.45-1-1V8h8v11z" fill="#60a5fa"/>
                    </svg>
                    Productos del pedido
                  </h4>
                  <div class="order-products-box">${o.itemsText}</div>
                </div>
              ` : ''}
              
              ${o.contactName || o.emailPaypal || o.shippingAddress ? `
                <div style="margin-bottom:20px;padding:16px;background:rgba(96,165,250,0.05);border-radius:12px;border:1px solid rgba(96,165,250,0.1);">
                  <h4 style="color:#e2e8f0;font-size:16px;font-weight:600;margin:0 0 12px 0;font-family:'Inter', sans-serif;display:flex;align-items:center;gap:8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" fill="#60a5fa"/>
                    </svg>
                    Información del cliente
                  </h4>
                  <div style="background:rgba(30,41,59,0.5);border:1px solid rgba(99,102,241,0.15);border-radius:8px;padding:16px;box-shadow:0 2px 8px rgba(96,165,250,0.1);">
                    ${o.contactName ? `
                      <div class="order-detail-row">
                        <span class="order-detail-label">👤 Nombre</span>
                        <span class="order-detail-value">${o.contactName}</span>
                      </div>
                    ` : ''}
                    ${o.emailPaypal ? `
                      <div class="order-detail-row">
                        <span class="order-detail-label">📧 Email</span>
                        <span class="order-detail-value" style="word-break:break-all;">${o.emailPaypal}</span>
                      </div>
                    ` : ''}
                    ${o.phone ? `
                      <div class="order-detail-row">
                        <span class="order-detail-label">📞 Teléfono</span>
                        <span class="order-detail-value">${o.phone}</span>
                      </div>
                    ` : ''}
                    ${o.instagram ? `
                      <div class="order-detail-row">
                        <span class="order-detail-label">📸 Instagram</span>
                        <span class="order-detail-value">${o.instagram}</span>
                      </div>
                    ` : ''}
                  </div>
                </div>
              ` : ''}
              
              ${o.shippingAddress || o.city || o.country || o.postal ? `
                <div style="padding:16px;background:rgba(96,165,250,0.05);border-radius:12px;border:1px solid rgba(96,165,250,0.1);">
                  <h4 style="color:#e2e8f0;font-size:16px;font-weight:600;margin:0 0 12px 0;font-family:'Inter', sans-serif;display:flex;align-items:center;gap:8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" fill="#60a5fa"/>
                    </svg>
                    Dirección de envío
                  </h4>
                  <div style="background:rgba(30,41,59,0.5);border:1px solid rgba(99,102,241,0.15);border-radius:8px;padding:16px;box-shadow:0 2px 8px rgba(96,165,250,0.1);">
                    ${o.shippingAddress ? `
                      <div class="order-detail-row">
                        <span class="order-detail-label">🏠 Dirección</span>
                        <span class="order-detail-value">${o.shippingAddress}</span>
                      </div>
                    ` : ''}
                    ${o.city || o.state || o.country ? `
                      <div class="order-detail-row">
                        <span class="order-detail-label">🗺️ Ubicación</span>
                        <span class="order-detail-value">${[o.city, o.state, o.country].filter(Boolean).join(', ')}</span>
                      </div>
                    ` : ''}
                    ${o.postal ? `
                      <div class="order-detail-row">
                        <span class="order-detail-label">📬 C.P.</span>
                        <span class="order-detail-value">${o.postal}</span>
                      </div>
                    ` : ''}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        `;
        ordersListEl.appendChild(card);
      });
      
      // Añadir función global para expandir/colapsar detalles con animación suave
      if (!window.toggleOrderDetails) {
        window.toggleOrderDetails = function(orderId) {
          const details = document.getElementById(`details-${orderId}`);
          const arrow = document.getElementById(`arrow-${orderId}`);
          if (details) {
            const isExpanded = details.classList.contains('expanded');
            
            // Cerrar todos los demás detalles abiertos
            document.querySelectorAll('.order-details.expanded').forEach(d => {
              if (d.id !== `details-${orderId}`) {
                d.classList.remove('expanded');
                const otherId = d.id.replace('details-', '');
                const otherArrow = document.getElementById(`arrow-${otherId}`);
                if (otherArrow) otherArrow.style.transform = '';
              }
            });
            
            // Toggle el actual
            if (!isExpanded) {
              details.classList.add('expanded');
              if (arrow) arrow.style.transform = 'rotate(180deg)';
              
              // Scroll suave al elemento expandido
              setTimeout(() => {
                const card = details.closest('.order-card');
                if (card) {
                  const rect = card.getBoundingClientRect();
                  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                  const targetTop = rect.top + scrollTop - 100;
                  
                  window.scrollTo({
                    top: targetTop,
                    behavior: 'smooth'
                  });
                }
              }, 100);
            } else {
              details.classList.remove('expanded');
              if (arrow) arrow.style.transform = '';
            }
          }
        };
      }
      
      // Añadir event listeners para los selectores de estado de pedido
      setTimeout(() => {
        document.querySelectorAll('.status-selector').forEach(selector => {
          selector.addEventListener('change', async function() {
            const orderId = this.getAttribute('data-order-id');
            const userId = this.getAttribute('data-user-id');
            const newStatus = this.value;
            
            if (!orderId || !userId || !newStatus) {
              showMessage('Datos insuficientes para actualizar el estado', 'error');
              return;
            }
            
            try {
              // Mostrar indicador de carga
              this.disabled = true;
              const originalText = this.options[0].textContent;
              this.options[0].textContent = 'Actualizando...';
              
              // Actualizar estado del pedido
              const result = await window.PointsSystem.updateOrderStatus(
                orderId, 
                userId, 
                newStatus, 
                auth.currentUser ? auth.currentUser.uid : null
              );
              
              if (result.success) {
                // Actualizar UI
                const card = this.closest('.order-card');
                if (card) {
                  // Actualizar badge de estado
                  const statusBadge = card.querySelector('.order-status-badge');
                  if (statusBadge) {
                    statusBadge.className = 'order-status-badge order-status-' + newStatus.toLowerCase().replace(/\s+/g, '-');
                    const statusText = {
                      'pendiente-de-confirmacion': 'Pendiente de Confirmación',
                      'confirmado': 'Confirmado',
                      'entregado': 'Entregado',
                      'recibido': 'Recibido'
                    }[newStatus.toLowerCase()] || newStatus;
                    
                    statusBadge.innerHTML = `
                      <span style="display:inline-block;width:6px;height:6px;background:currentColor;border-radius:50%;margin-right:6px;vertical-align:middle;"></span>
                      ${statusText}
                    `;
                  }
                  
                  // Actualizar icono de estado
                  const statusIconContainer = card.querySelector('.order-card-header > div > div > div:first-child');
                  if (statusIconContainer) {
                    const statusIcon = {
                      'pendiente-de-confirmacion': '⏳',
                      'confirmado': '✅',
                      'entregado': '🎉',
                      'recibido': '📦'
                    }[newStatus.toLowerCase()] || '📦';
                    
                    statusIconContainer.innerHTML = statusIcon;
                  }
                  
                  // Si se asignaron puntos, mostrar mensaje y actualizar panel de puntos
                  if (result.pointsAdded > 0) {
                    // Mostrar mensaje de puntos asignados
                    showMessage(`¡Se han asignado ${result.pointsAdded} puntos al usuario por el pedido entregado!`, 'success');
                    
                    // Actualizar panel de puntos si es el usuario actual
                    if (auth.currentUser && auth.currentUser.uid === userId) {
                      await loadUserPoints(userId);
                      await loadUserOrders(userId);
                    }
                    
                    // Añadir o actualizar el indicador de puntos en la tarjeta
                    const pointsContainer = card.querySelector('.order-card-body > div:first-child > div:last-child');
                    if (pointsContainer) {
                      pointsContainer.innerHTML = `
                        <div style="background:linear-gradient(135deg, #f6d365 0%, #fda085 100%);border-radius:12px;padding:12px 20px;box-shadow:0 4px 12px rgba(253,160,133,0.3);">
                          <div style="color:#fff;font-size:11px;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:4px;font-weight:600;">Puntos ganados</div>
                          <div style="color:#fff;font-size:24px;font-weight:700;">+${result.pointsAdded}</div>
                        </div>
                      `;
                    }
                  } else {
                    showMessage(`Estado actualizado a ${newStatus}`, 'success');
                  }
                }
              } else {
                showMessage(`Error: ${result.message}`, 'error');
              }
            } catch (error) {
              console.error('Error actualizando estado:', error);
              showMessage('Error al actualizar el estado del pedido', 'error');
            } finally {
              // Restaurar selector
              this.disabled = false;
              this.options[0].textContent = originalText;
              this.value = '';
            }
          });
        });
      }, 500);
    }

    function computeLoyaltyTier(points){
      const p = Number(points||0);
      if (p >= 100) return { key:'free', label:'Camiseta gratis', percent:0, nextAt:null, toNext:0 };
      if (p >= 60) return { key:'20', label:'20% de descuento', percent:0.20, nextAt:100, toNext:100 - p };
      if (p >= 40) return { key:'15', label:'15% de descuento', percent:0.15, nextAt:60, toNext:60 - p };
      if (p >= 20) return { key:'10', label:'10% de descuento', percent:0.10, nextAt:40, toNext:40 - p };
      return { key:'none', label:'Sin descuento', percent:0, nextAt:20, toNext:Math.max(0, 20 - p) };
    }

    function updatePointsPanel(points){
      try{
        const totalEl = document.getElementById('points-total');
        const lifeEl = document.getElementById('points-lifetime');
        const pendingEl = document.getElementById('points-pending');
        const spentEl = document.getElementById('points-spent');
        const tierLine = document.getElementById('points-tier-line');
        const nextMsg = document.getElementById('points-next-msg');
        const progress = document.getElementById('points-progress');
        // Continuar incluso si totalEl no existe; actualizaremos pendientes/gastados y solo animaremos disponibles si totalEl está presente.
        
        const isObj = points && typeof points === 'object';
        const available = isObj ? Number(points.available || 0) : Number(points || 0);
        const lifetime = isObj ? Number(points.lifetime || 0) : Number(window.USER_POINTS || available || 0);
        const pending = isObj ? Number(points.pending || 0) : 0;
        const spent = isObj ? Number(points.spent || Math.max(0, lifetime - available)) : Math.max(0, lifetime - available);

        if (lifeEl) lifeEl.textContent = String(lifetime);
        if (pendingEl) pendingEl.textContent = String(pending);
        if (spentEl) spentEl.textContent = String(spent);

        // Actualizar puntos disponibles en ambas vistas si existen
        const balanceEl = document.getElementById('user-points-balance');
        if (balanceEl) balanceEl.textContent = String(available);

        // Animación del contador de puntos (disponibles) solo si existe el elemento
        if (totalEl) {
          const currentPoints = parseInt(totalEl.textContent) || 0;
          const targetPoints = available;
          const increment = (targetPoints - currentPoints) / 20;
          let step = 0;
          
          if (currentPoints !== targetPoints) {
            const counter = setInterval(() => {
              step++;
              const newValue = Math.round(currentPoints + increment * step);
              totalEl.textContent = String(newValue);
              if (step >= 20) {
                clearInterval(counter);
                totalEl.textContent = String(targetPoints);
              }
            }, 30);
          } else {
            totalEl.textContent = String(targetPoints);
          }
        }
        
        // Opcional: Tier y progreso (solo si existen elementos en el DOM)
        if (tierLine && nextMsg && progress) {
          const tier = computeLoyaltyTier(lifetime);
          const tierEmoji = {
            'none': '⭐',
            '10': '🌟',
            '15': '✨',
            '20': '🏆',
            'free': '💎'
          }[tier.key] || '⭐';
          tierLine.innerHTML = `${tierEmoji} ${tier.label}`;
          if (tier.key === 'free') { 
            progress.style.width = '100%'; 
            nextMsg.innerHTML = '<span style="color:#ffd700;">🎉 ¡Máximo nivel alcanzado!</span>';
          } else {
            let base = 0, target = 20;
            const p = lifetime;
            if (p < 20) { base = 0; target = 20; }
            else if (p < 40) { base = 20; target = 40; }
            else if (p < 60) { base = 40; target = 60; }
            else { base = 60; target = 100; }
            const pct = Math.max(0, Math.min(100, ((p - base) / (target - base)) * 100));
            progress.style.width = pct.toFixed(1) + '%';
            const pointsNeeded = Math.max(0, target - p);
            nextMsg.innerHTML = `<strong>${pointsNeeded}</strong> pts`;
          }
        }
      }catch(e){ console.error('updatePointsPanel error', e); }
    }

    async function loadUserOrders(uid){
      try{
        console.log('loadUserOrders: Cargando pedidos para usuario:', uid);
        if (!uid) { 
          console.log('loadUserOrders: UID no proporcionado');
          renderOrdersList([]); 
          window.USER_POINTS = 0; window.USER_POINTS_LIFETIME = 0; window.USER_POINTS_SPENT = 0; window.USER_POINTS_AVAILABLE = 0;
          updatePointsPanel({ available:0, lifetime:0, spent:0 }); 
          return; 
        }
        const snap = await get(ref(db, `ordersByUser/${uid}`));
        console.log('loadUserOrders: Snapshot de pedidos:', snap.exists() ? 'existe' : 'no existe', snap.val());
        if (!snap.exists()){ 
          console.log('loadUserOrders: No hay pedidos para este usuario');
          renderOrdersList([]); 
          window.USER_POINTS = 0; window.USER_POINTS_LIFETIME = 0; window.USER_POINTS_SPENT = 0; window.USER_POINTS_AVAILABLE = 0;
          updatePointsPanel({ available:0, lifetime:0, spent:0 }); 
          return; 
        }
        const obj = snap.val() || {};
        const arr = Object.entries(obj).map(([id, data])=>({ id, ...(data||{}) }));
        arr.sort((a,b)=> new Date(b.date||b.createdAt||0) - new Date(a.date||a.createdAt||0));
        
        // Leer puntos del usuario directamente
        let availablePoints = 0;
        try {
          availablePoints = await window.PointsSystem.getUserPoints(uid);
          console.log(`Puntos disponibles para el usuario ${uid}: ${availablePoints}`);
        } catch(e) { 
          console.error('Error obteniendo puntos del usuario:', e);
          availablePoints = 0;
        }

        // Calcular puntos gastados
        let spentPoints = 0;
        try {
          // Obtener historial de puntos para calcular los puntos gastados
          const history = await window.PointsSystem.getPointsHistory(uid);
          // Sumar todos los valores negativos (canjes)
          spentPoints = history.reduce((sum, entry) => {
            if (entry.difference < 0) {
              return sum + Math.abs(entry.difference);
            }
            return sum;
          }, 0);
          console.log(`Puntos gastados por el usuario ${uid}: ${spentPoints}`);
        } catch(e) { 
          console.error('Error calculando puntos gastados:', e);
          spentPoints = 0;
        }

        // Calcular puntos totales (disponibles + gastados)
        let lifetimePoints = availablePoints + spentPoints;
        
        // Verificar si hay puntos en los pedidos confirmados (método anterior)
        // y usar el valor más alto entre los dos métodos
        const numVal = (v)=>{ const n = Number(v); return Number.isFinite(n) ? n : 0; };
        const pointsFromOrders = arr.reduce((sum, o)=>{
          const st = String(o.status || '').toLowerCase();
          if (st === 'confirmado' || st === 'entregado') {
            const pe = numVal(o.pointsEarned);
            if (pe > 0) return sum + pe;
            const sc = numVal(o.shirtsCount);
            if (sc > 0) return sum + (sc * 10);
            if (o.itemsText){
              const add = o.itemsText.split('\n').reduce((s,line)=>{ const m=line.match(/(\d+)x\s/i); return s + (m? parseInt(m[1],10)*10 : 0); }, 0);
              return sum + add;
            }
          }
          return sum;
        }, 0);
        
        // Usar el valor más alto entre los dos métodos
        if (pointsFromOrders > lifetimePoints) {
          console.log(`Usando puntos calculados desde pedidos: ${pointsFromOrders} > ${lifetimePoints}`);
          lifetimePoints = pointsFromOrders;
          // Recalcular puntos disponibles
          availablePoints = Math.max(0, lifetimePoints - spentPoints);
        }

        // Leer redenciones del usuario y construir rewards activos (no usados)
        let activeRewards = [];
        try {
          // Usar la misma ruta que la función redeemPoints
          const redSnap = await get(ref(db, `users/${uid}/redemptions`));
          if (redSnap.exists()){
            const objR = redSnap.val() || {};
            const all = Object.entries(objR).map(([id, r])=>({ id, ...(r||{}) }));
            activeRewards = all.filter(r => !r.used);
            // Renderizar lista en el panel
            renderOwnedDiscounts(activeRewards);
          } else {
            renderOwnedDiscounts([]);
          }
        }catch(e){ console.warn('No se pudieron leer las redenciones', e); renderOwnedDiscounts([]); }
        
        // Globals
        window.USER_POINTS = lifetimePoints; // usado por descuentos automáticos
        window.USER_POINTS_LIFETIME = lifetimePoints;
        window.USER_POINTS_SPENT = spentPoints;
        window.USER_POINTS_AVAILABLE = availablePoints;
        window.USER_ACTIVE_REWARDS = activeRewards;

        // Guardar pedidos en global para cálculos de puntos pendientes
        window.USER_ORDERS = arr;
        // Calcular puntos pendientes (pedidos no entregados)
        const pendingPoints = arr.reduce((sum, o) => {
          const st = String(o.status || '').toLowerCase();
          if (st !== 'entregado') {
            const pe = numVal(o.pointsEarned);
            if (pe > 0) return sum + pe;
            const sc = numVal(o.shirtsCount);
            if (sc > 0) return sum + (sc * 10);
            if (o.itemsText) {
              const add = o.itemsText.split('\n').reduce((s, line) => { const m = line.match(/(\d+)x\s/i); return s + (m ? parseInt(m[1], 10) * 10 : 0); }, 0);
              return sum + add;
            }
          }
          return sum;
        }, 0);
        updatePointsPanel({ available: availablePoints, pending: pendingPoints, lifetime: lifetimePoints, spent: spentPoints });
        renderOrdersList(arr);
      }catch(err){ 
        console.error('Error cargando pedidos:', err); 
        renderOrdersList([]); 
        window.USER_POINTS = 0; window.USER_POINTS_LIFETIME = 0; window.USER_POINTS_SPENT = 0; window.USER_POINTS_AVAILABLE = 0;
        window.USER_ACTIVE_REWARDS = [];
        updatePointsPanel({ available:0, lifetime:0, spent:0 }); 
      }
    }

    // Helpers globales: guardar pedido y refrescar listado en Perfil
    window.saveOrderToRTDB = async (orderData)=>{
      try{
        console.log('saveOrderToRTDB: Iniciando guardado de pedido...');
        console.log('saveOrderToRTDB: orderData recibido:', orderData);
        
        const u = auth.currentUser; 
        console.log('saveOrderToRTDB: Usuario actual:', u ? u.uid : 'null');
        
        if (!u) {
          console.log('saveOrderToRTDB: No hay usuario autenticado');
          return null;
        }
        if (!u.emailVerified){ 
          console.warn('saveOrderToRTDB: Email no verificado, guardando de todos modos');
          // Cambiado para permitir guardar pedidos aunque el email no esté verificado
        }
        
        const uid = u.uid;
        const id = orderData && orderData.id ? String(orderData.id) : (Date.now().toString(36) + Math.random().toString(36).slice(2,8));
        
        // Calcular puntos basándose en el número de camisetas si no están especificados
        let pointsEarned = orderData.pointsEarned;
        if (typeof pointsEarned !== 'number' || pointsEarned === 0) {
          // Intentar calcular desde shirtsCount o desde itemsText
          if (orderData.shirtsCount && orderData.shirtsCount > 0) {
            pointsEarned = orderData.shirtsCount * 10;
          } else if (orderData.itemsText) {
            // Contar camisetas desde el texto de items
            const lines = orderData.itemsText.split('\n');
            let totalShirts = 0;
            lines.forEach(line => {
              const match = line.match(/(\d+)x\s/);
              if (match) {
                totalShirts += parseInt(match[1], 10);
              }
            });
            pointsEarned = totalShirts * 10;
          } else {
            pointsEarned = 0;
          }
        }
        
        const payload = Object.assign(
          { 
            uid, 
            id, 
            createdAt: new Date().toISOString(), 
            date: new Date().toISOString(),
            status: 'pendiente-de-confirmacion', // Nuevo estado por defecto
            pointsEarned: pointsEarned,
            appliedReward: (orderData && orderData.appliedReward) ? orderData.appliedReward : (window.__APPLIED_REWARD ? {
              id: window.__APPLIED_REWARD.id,
              kind: window.__APPLIED_REWARD.kind,
              label: window.__APPLIED_REWARD.label || '',
            } : null)
          }, 
          orderData || {}
        );
        
        console.log('saveOrderToRTDB: Guardando pedido con payload:', payload);
        await set(ref(db, `ordersByUser/${uid}/${id}`), payload);
        console.log('saveOrderToRTDB: Pedido guardado exitosamente con ID:', id);
        
        // Nota: ya no se agregan puntos al crear el pedido.
        // Los puntos se acreditan automáticamente cuando el pedido pasa a estado 'entregado' (ver PointsSystem.updateOrderStatus).
        // Si hay un descuento aplicado, marcarlo como usado
        try{
          const ar = window.__APPLIED_REWARD;
          if (ar && ar.id) {
            // Usamos la misma ruta que la función loadUserDiscounts
            await set(ref(db, `users/${uid}/redemptions/${ar.id}/used`), true);
            await set(ref(db, `users/${uid}/redemptions/${ar.id}/usedAt`), new Date().toISOString());
            console.log(`Descuento ${ar.id} marcado como usado en la compra ${id}`);
            window.__APPLIED_REWARD = null;
          }
        }catch(eMark){ console.warn('No se pudo marcar el descuento como usado:', eMark); }
        return id;
      }catch(e){ 
        console.error('saveOrderToRTDB error:', e); 
        return null; 
      }
    };
    window.refreshProfileOrders = async ()=>{ try{ const u = auth.currentUser; if (u) await loadUserOrders(u.uid); }catch(e){ console.error('refreshProfileOrders error:', e); } };
    window.redeemReward = async (kind, cost, label)=>{
      try{
        const u = auth.currentUser; 
        const msgEl = document.getElementById('redeem-msg');
        if (!u){ if (msgEl){ msgEl.textContent = 'Inicia sesión para canjear.'; msgEl.style.color = '#fecaca'; } return; }
        
        // Usar window.USER_POINTS_AVAILABLE directamente en lugar de obtener los puntos de nuevo
        // Esto asegura que usamos el mismo valor que se muestra en la UI
        const available = Number(window.USER_POINTS_AVAILABLE || 0);
        console.log('Puntos disponibles para canje:', available, 'Costo:', Number(cost||0));
        if (available < Number(cost||0)) { if (msgEl){ msgEl.textContent = 'No tienes puntos suficientes.'; msgEl.style.color = '#fecaca'; } return; }

        // Usar la función redeemReward del sistema de puntos
        try {
          // Crear objeto de recompensa
          const reward = {
            type: 'percentage', // Por defecto, asumimos que es un descuento porcentual
            value: 0,
            points: Number(cost||0),
            name: String(label||''),
            description: `${label} - Canjeado por ${cost} puntos`
          };
          
          // Determinar el tipo y valor según el kind
          if (kind === 'discount10') {
            reward.type = 'percentage';
            reward.value = 10;
          } else if (kind === 'discount15') {
            reward.type = 'percentage';
            reward.value = 15;
          } else if (kind === 'discount20') {
            reward.type = 'percentage';
            reward.value = 20;
          } else if (kind === 'freeShirt') {
            reward.type = 'free_item';
            reward.value = 1;
          }
          
          // Usar la función redeemReward que ya hemos corregido
          await redeemReward(u.uid, reward);
          
          // Actualizar variables globales
          const lifetime = Number(window.USER_POINTS_LIFETIME || 0);
          const newSpent = Number(window.USER_POINTS_SPENT || 0) + Number(cost||0);
          const availableNew = Math.max(0, lifetime - newSpent);
          window.USER_POINTS_SPENT = newSpent;
          window.USER_POINTS_AVAILABLE = availableNew;
          
          // Actualizar panel de puntos
          updatePointsPanel({ available: availableNew, lifetime, spent: newSpent });
          
          // Mostrar mensaje de éxito
          if (msgEl){ msgEl.textContent = `Canjeado: ${label} (-${cost} pts)`; msgEl.style.color = '#bbf7d0'; }
          
          // Actualizar el desplegable del carrito con el nuevo descuento
          loadUserDiscounts();
          
          return;
        } catch (redeemError) {
          console.error('Error usando redeemReward:', redeemError);
          // Continuar con el método antiguo como fallback
        }
        
        // Método antiguo (fallback)
        try {
          // Leer puntos canjeados actuales
          const spentRef = ref(db, `users/${u.uid}/spentPoints`);
          let currentSpent = 0;
          try{ const s = await get(spentRef); if (s.exists()) currentSpent = Number(s.val()) || 0; }catch(_){ currentSpent = 0; }
  
          const newSpent = currentSpent + Number(cost||0);
          const rid = Date.now().toString(36) + Math.random().toString(36).slice(2,8);
          // Usamos la misma ruta que la función loadUserDiscounts
          const redemptionRef = ref(db, `users/${u.uid}/redemptions/${rid}`);
  
          await Promise.all([
            set(spentRef, newSpent),
            set(redemptionRef, { 
              id: rid, 
              kind: String(kind||''), 
              label: String(label||''), 
              points: Number(cost||0), 
              createdAt: new Date().toISOString(), 
              uid: u.uid, 
              used: false,
              // Añadir campos compatibles con la nueva estructura
              type: kind === 'freeShirt' ? 'free_item' : 'percentage',
              value: kind === 'discount10' ? 10 : (kind === 'discount15' ? 15 : (kind === 'discount20' ? 20 : 0)),
              name: String(label||''),
              description: `${label} - Canjeado por ${cost} puntos`
            })
          ]);
  
          const lifetime = Number(window.USER_POINTS_LIFETIME || 0);
          const availableNew = Math.max(0, lifetime - newSpent);
          window.USER_POINTS_SPENT = newSpent;
          window.USER_POINTS_AVAILABLE = availableNew;
  
          // Refrescar lista de redenciones
          try {
            // Usamos la misma ruta que la función loadUserDiscounts
            const redSnap = await get(ref(db, `users/${u.uid}/redemptions`));
            let activeRewards = [];
            if (redSnap.exists()){
              const objR = redSnap.val() || {};
              const all = Object.entries(objR).map(([id, r])=>({ id, ...(r||{}) }));
              activeRewards = all.filter(r => !r.used);
            }
            window.USER_ACTIVE_REWARDS = activeRewards;
            renderOwnedDiscounts(activeRewards);
          } catch(e){ console.warn('refresh redemptions after redeem error', e); }
        } catch (fallbackError) {
          console.error('Error en método fallback:', fallbackError);
          throw fallbackError;
        }

        // No necesitamos actualizar el panel de puntos aquí, ya se hace en el método principal
      }catch(e){
        console.error('redeemReward error', e);
        const msgEl = document.getElementById('redeem-msg'); if (msgEl){ msgEl.textContent = 'Error al canjear. Inténtalo de nuevo.'; msgEl.style.color = '#fecaca'; }
      }
    };

    // Renderizar lista de descuentos comprados (no usados)
    function renderOwnedDiscounts(rewards){
      try{
        const list = document.getElementById('owned-discounts-list');
        if (!list) return;
        const items = Array.isArray(rewards) ? rewards.filter(r=>!r.used) : [];
        if (items.length === 0){
          list.innerHTML = '<div style="color:#94a3b8;">No tienes descuentos comprados aún.</div>';
          return;
        }
        
        // Función para obtener el emoji y título según el tipo de descuento
        function getDiscountInfo(reward) {
          const type = reward.type || '';
          const value = reward.value || 0;
          
          switch (type) {
            case 'percentage':
              return { emoji: '💯', title: `${value}% de descuento` };
            case 'fixed':
              return { emoji: '💰', title: `${value}€ de descuento` };
            case 'free_shipping':
              return { emoji: '🚚', title: 'Envío gratis' };
            case 'free_item':
              return { emoji: '🔥', title: 'Camiseta gratis' };
            default:
              if (reward.kind === 'freeShirt') return { emoji: '🔥', title: 'Camiseta gratis' };
              if (reward.kind === 'discount20') return { emoji: '💯', title: '20% de descuento' };
              if (reward.kind === 'discount15') return { emoji: '💯', title: '15% de descuento' };
              if (reward.kind === 'discount10') return { emoji: '💯', title: '10% de descuento' };
              return { emoji: '🎟️', title: reward.label || 'Descuento' };
          }
        }
        
        list.innerHTML = items.map(r=>{
          const info = getDiscountInfo(r);
          return `
            <div class="owned-discount-item" style="display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px;margin-bottom:8px;">
              <div style="display:flex;align-items:center;gap:10px;">
                <span>${info.emoji}</span>
                <div>
                  <div style="color:#fff;font-weight:600;">${info.title}</div>
                  <div style="color:#94a3b8;font-size:12px;">${r.points||0} pts • Disponible</div>
                </div>
              </div>
              <span style="color:#22c55e;font-size:12px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);padding:4px 8px;border-radius:999px;">Se aplicará automáticamente</span>
            </div>
          `;
        }).join('');
        
        // Mostrar el contenedor de descuentos si hay descuentos disponibles
        const toggleBtn = document.getElementById('toggle-owned-discounts');
        if (toggleBtn) {
          const span = toggleBtn.querySelector('span');
          if (span) {
            span.textContent = `🧾 Descuentos disponibles (${items.length})`;
          }
          
          // Mostrar automáticamente la lista si hay descuentos
          const listEl = document.getElementById('owned-discounts-list');
          if (listEl) {
            listEl.style.display = 'block';
            const arrow = toggleBtn.querySelector('svg');
            if (arrow) arrow.style.transform = 'rotate(180deg)';
          }
        }
        
        // Sincronizar con el desplegable del carrito
        loadUserDiscounts();
      }catch(e){ console.error('renderOwnedDiscounts error', e); }
    }

    // Navegación dentro de Perfil
    (function(){
      const btnVerPedidos = document.getElementById('btn-ver-pedidos');
      const btnVerCuenta = document.getElementById('btn-ver-cuenta');
      const btnVerPuntos = document.getElementById('btn-ver-puntos');
      if (btnVerPedidos && btnVerCuenta && btnVerPuntos){
        btnVerPedidos.addEventListener('click', ()=>{ profileAccountPanel.classList.add('hidden'); profilePointsPanel.classList.add('hidden'); profileOrdersPanel.classList.remove('hidden'); btnVerPedidos.classList.add('active'); btnVerPuntos.classList.remove('active'); btnVerCuenta.classList.remove('active'); });
        btnVerPuntos.addEventListener('click', async ()=>{ 
          profileOrdersPanel.classList.add('hidden'); 
          profileAccountPanel.classList.add('hidden'); 
          profilePointsPanel.classList.remove('hidden'); 
          btnVerPuntos.classList.add('active'); 
          btnVerPedidos.classList.remove('active'); 
          btnVerCuenta.classList.remove('active');
          
          // Cargar puntos si hay usuario autenticado
          if (auth.currentUser) {
            await loadUserPoints(auth.currentUser.uid);
            await loadUserOrders(auth.currentUser.uid);
          }
        });
        btnVerCuenta.addEventListener('click', ()=>{ profileOrdersPanel.classList.add('hidden'); profilePointsPanel.classList.add('hidden'); profileAccountPanel.classList.remove('hidden'); btnVerCuenta.classList.add('active'); btnVerPedidos.classList.remove('active'); btnVerPuntos.classList.remove('active'); });
      }
      
      // Event listeners para los botones de canje de puntos
      const redeemDiscount10Btn = document.getElementById('redeem-discount10');
      const redeemDiscount15Btn = document.getElementById('redeem-discount15');
      const redeemDiscount20Btn = document.getElementById('redeem-discount20');
      const redeemFreeShirtBtn = document.getElementById('redeem-freeShirt');
      
      if (redeemDiscount10Btn) {
        redeemDiscount10Btn.addEventListener('click', async () => {
          // Verificar si auth está definido
          if (typeof auth === 'undefined' || !auth) {
            showMessage('Error al acceder al sistema de autenticación', 'error');
            return;
          }
          
          if (!auth.currentUser) {
            showMessage('Debes iniciar sesión para canjear puntos', 'error');
            return;
          }
          
          const reward = {
            type: 'percentage',
            value: 10,
            points: 20,
            name: '10% de descuento',
            description: 'Descuento del 10% en tu próxima compra'
          };
          
          await redeemReward(auth.currentUser.uid, reward);
        });
      }
      
      if (redeemDiscount15Btn) {
        redeemDiscount15Btn.addEventListener('click', async () => {
          // Verificar si auth está definido
          if (typeof auth === 'undefined' || !auth) {
            showMessage('Error al acceder al sistema de autenticación', 'error');
            return;
          }
          
          if (!auth.currentUser) {
            showMessage('Debes iniciar sesión para canjear puntos', 'error');
            return;
          }
          
          const reward = {
            type: 'percentage',
            value: 15,
            points: 40,
            name: '15% de descuento',
            description: 'Descuento del 15% en tu próxima compra'
          };
          
          await redeemReward(auth.currentUser.uid, reward);
        });
      }
      
      if (redeemDiscount20Btn) {
        redeemDiscount20Btn.addEventListener('click', async () => {
          // Verificar si auth está definido
          if (typeof auth === 'undefined' || !auth) {
            showMessage('Error al acceder al sistema de autenticación', 'error');
            return;
          }
          
          if (!auth.currentUser) {
            showMessage('Debes iniciar sesión para canjear puntos', 'error');
            return;
          }
          
          const reward = {
            type: 'percentage',
            value: 20,
            points: 60,
            name: '20% de descuento',
            description: 'Descuento del 20% en tu próxima compra'
          };
          
          await redeemReward(auth.currentUser.uid, reward);
        });
      }
      
      if (redeemFreeShirtBtn) {
        redeemFreeShirtBtn.addEventListener('click', async () => {
          // Verificar si auth está definido
          if (typeof auth === 'undefined' || !auth) {
            showMessage('Error al acceder al sistema de autenticación', 'error');
            return;
          }
          
          if (!auth.currentUser) {
            showMessage('Debes iniciar sesión para canjear puntos', 'error');
            return;
          }
          
          const reward = {
            type: 'free_item',
            value: 1,
            points: 100,
            name: 'Camiseta gratis',
            description: 'Una camiseta gratis en tu próxima compra'
          };
          
          await redeemReward(auth.currentUser.uid, reward);
        });
      }
      const btnLogout = document.getElementById('btn-logout');
      if (btnLogout){ btnLogout.addEventListener('click', async ()=>{ try{ await signOut(auth); }catch(e){ console.error(e); } }); }
      
      // Toggle historial de puntos
      const toggleHistory = document.getElementById('toggle-history');
      if (toggleHistory) {
        toggleHistory.addEventListener('click', () => {
          const historyList = document.getElementById('points-history-list');
          if (historyList.classList.contains('hidden')) {
            historyList.classList.remove('hidden');
            toggleHistory.textContent = 'Ocultar historial';
          } else {
            historyList.classList.add('hidden');
            toggleHistory.textContent = 'Ver historial';
          }
        });
      }
      
      // Event listeners del panel administrativo
      const adminSearchBtn = document.getElementById('admin-search-btn');
      const adminSearchEmail = document.getElementById('admin-search-email');
      const adminUpdatePoints = document.getElementById('admin-update-points');
      
      if (adminSearchBtn) {
        adminSearchBtn.addEventListener('click', () => {
          const email = adminSearchEmail.value.trim();
          if (email) {
            searchUserByEmail(email);
          }
        });
      }
      
      if (adminSearchEmail) {
        adminSearchEmail.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const email = adminSearchEmail.value.trim();
            if (email) {
              searchUserByEmail(email);
            }
          }
        });
      }
      
      if (adminUpdatePoints) {
        adminUpdatePoints.addEventListener('click', updateUserPoints);
      }
      
      // Toggle lista de descuentos comprados
      try{
        const toggleBtn = document.getElementById('toggle-owned-discounts');
        const listEl = document.getElementById('owned-discounts-list');
        const arrow = toggleBtn ? toggleBtn.querySelector('svg') : null;
        if (toggleBtn && listEl){
          let open = false;
          listEl.style.display = 'none';
          toggleBtn.addEventListener('click', ()=>{
            open = !open;
            listEl.style.display = open ? 'block' : 'none';
            if (arrow) arrow.style.transform = open ? 'rotate(180deg)' : 'rotate(0deg)';
            if (arrow) arrow.style.transition = 'transform 0.25s ease';
          });
        }
      }catch(e){ console.warn('toggle owned discounts init error', e); }

      // Funcionalidad de mostrar/ocultar contraseña
      document.querySelectorAll('.password-toggle').forEach(button => {
        button.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          const passwordInput = document.getElementById(targetId);
          
          // Cambiar tipo de input entre password y text
          if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            this.setAttribute('aria-label', 'Ocultar contraseña');
            // Cambiar icono a ojo tachado
            this.querySelector('svg').innerHTML = `
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
              <line x1="3" y1="3" x2="21" y2="21"></line>
            `;
          } else {
            passwordInput.type = 'password';
            this.setAttribute('aria-label', 'Mostrar contraseña');
            // Restaurar icono de ojo normal
            this.querySelector('svg').innerHTML = `
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            `;
          }
        });
      });
    })();

    onAuthStateChanged(auth, async (user)=>{
      updateIdentityLabels(user);
      const authUIEl = document.getElementById('auth-section');
      const verifyCta = document.getElementById('verify-cta');
      if (user){
        if (!user.emailVerified){
          // Usuario autenticado pero NO verificado: mostrar CTA verificación y bloquear Perfil
          if (verifyCta) verifyCta.classList.remove('hidden');
          if (profileUI) profileUI.classList.add('hidden');
          if (authUIEl) authUIEl.classList.remove('hidden');
          if (profileEmailEl) profileEmailEl.textContent = user.email || '';
        } else {
          // Usuario verificado: UI de Perfil normal
          if (verifyCta) verifyCta.classList.add('hidden');
          if (profileEmailEl) profileEmailEl.textContent = user.email || '';
          if (profileAvatarEl) profileAvatarEl.src = user.photoURL || 'assets/logos/logo.jpg';
          if (authUIEl) authUIEl.classList.add('hidden');
          if (profileUI) profileUI.classList.remove('hidden');

          // Desplazar suavemente la tarjeta de perfil a la vista cuando la sesión está iniciada
          try {
            const identSection = document.getElementById('identificarse');
            if (identSection) {
              setTimeout(() => {
                try {
                  const card = identSection.querySelector('#profile-section .profile-card') || identSection.querySelector('#profile-section') || identSection;
                  if (card && typeof card.scrollIntoView === 'function') {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
                  } else {
                    const rect = identSection.getBoundingClientRect();
                    const y = (rect.top + window.scrollY) - 16;
                    window.scrollTo({ top: y, behavior: 'smooth' });
                  }
                } catch(e){}
              }, 120);
            }
          } catch(e){}

          await loadUserOrders(user.uid);
          
          // Cargar puntos del usuario
          await loadUserPoints(user.uid);
          await loadUserDiscounts(); // Cargar descuentos comprados disponibles
          
          // Mostrar panel administrativo si es administrador
          toggleAdminPanel(user);
        }
      } else {
        if (verifyCta) verifyCta.classList.add('hidden');
        if (profileUI) profileUI.classList.add('hidden');
        if (authUIEl) authUIEl.classList.remove('hidden');
        renderOrdersList([]);
        profileAccountPanel.classList.add('hidden');
        profileOrdersPanel.classList.remove('hidden');
      }
    });

    // Handlers de verificación: reenviar y refrescar estado
    (function(){
      const btnResend = document.getElementById('btn-resend-verif');
      const btnRefresh = document.getElementById('btn-verified-refresh');
      const verifyMsg = document.getElementById('verify-msg');
      if (btnResend){
        btnResend.addEventListener('click', async ()=>{
          const u = auth.currentUser; if (!u) return;
          try{
            await sendEmailVerification(u, { url: window.location.origin + '/' });
            if (verifyMsg){ verifyMsg.className='ok'; verifyMsg.textContent = 'Hemos reenviado el correo de verificación.'; }
          }catch(e){
            console.error('Resend verification error:', e);
            if (e?.code === 'auth/invalid-continue-uri' || e?.code === 'auth/unauthorized-continue-uri'){
              try{
                await sendEmailVerification(u);
                if (verifyMsg){ verifyMsg.className='ok'; verifyMsg.textContent = 'Hemos reenviado el correo de verificación.'; }
                return;
              }catch(e2){ console.error('Resend verification fallback error:', e2); }
            }
            if (verifyMsg){ verifyMsg.className='err'; verifyMsg.textContent = mapAuthError(e?.code); }
          }
        });
      }
      if (btnRefresh){
        btnRefresh.addEventListener('click', async ()=>{
          const u = auth.currentUser; if (!u) return;
          try{ await reload(u); }catch(_){ }
        });
      }
    })();

    // Funcionalidad de gestión de direcciones
    (function(){
      let addresses = JSON.parse(localStorage.getItem('savedAddresses') || '[]');
      
      // Elementos del DOM
      const addressesList = document.getElementById('addresses-list');
      const noAddresses = document.getElementById('no-addresses');
      const addressForm = document.getElementById('address-form');
      const btnAddAddress = document.getElementById('btn-add-address');
      const btnCancelAddress = document.getElementById('btn-cancel-address');
      const btnSaveAddress = document.getElementById('btn-save-address');
      
      // Campos del formulario - inicialización diferida
      let addressFields = {};
      
      function initializeAddressFields() {
        addressFields = {
          name: document.getElementById('address-name'),
          contactName: document.getElementById('address-contact-name'),
          addressLine: document.getElementById('address-line'),
          city: document.getElementById('address-city'),
          state: document.getElementById('address-state'),
          country: document.getElementById('address-country'),
          postal: document.getElementById('address-postal'),
          phone: document.getElementById('address-phone')
        };
      }
      
      // Inicializar campos al cargar
      initializeAddressFields();
      
      // Configurar listeners de validación para campos
      setupFieldValidationListeners();
      
      // Renderizar lista inicial de direcciones
      renderAddressesList();
      
      // Función para renderizar la lista de direcciones
      function renderAddressesList() {
        if (addresses.length === 0) {
          addressesList.innerHTML = '';
          noAddresses.classList.remove('hidden');
          return;
        }
        
        noAddresses.classList.add('hidden');
        addressesList.innerHTML = '';
        
        addresses.forEach((address, index) => {
          const addressCard = document.createElement('div');
          addressCard.style.cssText = `
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 16px;
            position: relative;
          `;
          
          addressCard.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
              <h5 style="color:#fff;margin:0;font-size:16px;font-weight:600;">${address.name}</h5>
              <div style="display:flex;gap:8px;">
                <button class="edit-address" data-index="${index}" style="background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2);border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px;">Editar</button>
                <button class="delete-address" data-index="${index}" style="background:rgba(255,0,0,0.2);color:#ff6b6b;border:1px solid rgba(255,0,0,0.3);border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px;">Eliminar</button>
              </div>
            </div>
            <div style="color:rgba(255,255,255,0.8);font-size:14px;line-height:1.4;">
              <div><strong>${address.contactName}</strong></div>
              <div>${address.addressLine}</div>
              <div>${address.city}, ${address.state} ${address.postal}</div>
              <div>${address.country}</div>
              <div style="margin-top:4px;color:rgba(255,255,255,0.6);">📞 ${address.phone}</div>
            </div>
          `;
          
          addressesList.appendChild(addressCard);
        });
        
        // Event listeners para botones de editar y eliminar
        addressesList.querySelectorAll('.edit-address').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            editAddress(index);
          });
        });
        
        addressesList.querySelectorAll('.delete-address').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            deleteAddress(index);
          });
        });
      }
      
      // Función para mostrar/ocultar formulario
      function toggleAddressForm(show = true) {
        if (show) {
          addressForm.classList.remove('hidden');
          btnAddAddress.style.display = 'none';
        } else {
          addressForm.classList.add('hidden');
          btnAddAddress.style.display = 'block';
          clearAddressForm();
        }
      }
      
      // Función para limpiar el formulario
      function clearAddressForm() {
        initializeAddressFields();
        Object.values(addressFields).forEach(field => {
          if (field) field.value = '';
        });
      }
      
      // Función para mostrar mensajes de error específicos del campo
      function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        if (!field) return;
        
        field.style.borderColor = '#ff4444';
        field.style.boxShadow = '0 0 0 2px rgba(255, 68, 68, 0.2)';
        
        // Crear o actualizar mensaje de error
        let errorDiv = field.parentNode.querySelector('.field-error-message');
        if (!errorDiv) {
          errorDiv = document.createElement('div');
          errorDiv.className = 'field-error-message';
          errorDiv.style.color = '#ff4444';
          errorDiv.style.fontSize = '0.8rem';
          errorDiv.style.marginTop = '4px';
          field.parentNode.appendChild(errorDiv);
        }
        errorDiv.textContent = message;
      }
      
      // Función para limpiar errores cuando el usuario empieza a escribir
      function setupFieldValidationListeners() {
        const addressFields = addressForm.querySelectorAll('input');
        addressFields.forEach(field => {
          field.addEventListener('input', function() {
            // Limpiar el error de este campo específico
            this.style.borderColor = '';
            this.style.boxShadow = '';
            const errorDiv = this.parentNode.querySelector('.field-error-message');
            if (errorDiv) {
              errorDiv.remove();
            }
          });
          
          field.addEventListener('blur', function() {
            // Validar este campo específico cuando pierde el foco
            if (this.value.trim()) {
              this.style.borderColor = '#28a745';
              this.style.boxShadow = '0 0 0 2px rgba(40, 167, 69, 0.2)';
            }
          });
        });
      }
      
      // Función para limpiar mensajes de error
      function clearFieldErrors() {
        const fields = addressForm.querySelectorAll('input');
        fields.forEach(field => {
          field.style.borderColor = '';
          field.style.boxShadow = '';
          const errorDiv = field.parentNode.querySelector('.field-error-message');
          if (errorDiv) {
            errorDiv.remove();
          }
        });
      }
      
      // Función para validar el formulario con mensajes de error específicos
      function validateAddressForm() {
        clearFieldErrors();
        
        const requiredFields = [
          { id: 'address-name', message: 'El nombre de la dirección es requerido' },
          { id: 'address-contact-name', message: 'El nombre del contacto es requerido' },
          { id: 'address-line', message: 'La dirección es requerida' },
          { id: 'address-city', message: 'La ciudad es requerida' },
          { id: 'address-country', message: 'El país es requerido' },
          { id: 'address-postal', message: 'El código postal es requerido' }
        ];
        
        let isValid = true;
        let firstInvalidField = null;
        
        requiredFields.forEach(fieldInfo => {
          const field = document.getElementById(fieldInfo.id);
          if (!field || !field.value.trim()) {
            isValid = false;
            showFieldError(fieldInfo.id, fieldInfo.message);
            if (!firstInvalidField) firstInvalidField = field;
          }
        });
        
        // Validación específica para el teléfono
        const phoneField = document.getElementById('address-phone');
        if (phoneField && phoneField.value.trim()) {
          const phoneRegex = /^[+]?[0-9\s\-\(\)]{7,15}$/;
          if (!phoneRegex.test(phoneField.value.trim())) {
            isValid = false;
            showFieldError('address-phone', 'El teléfono debe tener entre 7 y 15 dígitos');
            if (!firstInvalidField) firstInvalidField = phoneField;
          }
        }
        
        // Validación de longitud mínima para dirección
        const addressLineField = document.getElementById('address-line');
        if (addressLineField && addressLineField.value.trim() && addressLineField.value.trim().length < 5) {
          isValid = false;
          showFieldError('address-line', 'La dirección debe tener al menos 5 caracteres');
          if (!firstInvalidField) firstInvalidField = addressLineField;
        }
        
        // Hacer focus en el primer campo inválido
        if (firstInvalidField) {
          firstInvalidField.focus();
        }
        
        return isValid;
      }
      
      
      // Función para mostrar éxito usando el sistema de notificaciones
      function mostrarExitoLocal(mensaje) {
        const notificacion = document.getElementById('formStatus');
        if (!notificacion) return;
        notificacion.className = 'success';
        notificacion.style.position = 'fixed';
        notificacion.style.top = '20px';
        notificacion.style.left = '50%';
        notificacion.style.transform = 'translateX(-50%)';
        notificacion.style.zIndex = '200000';
        notificacion.style.background = '#1e7e34';
        notificacion.style.color = '#fff';
        notificacion.style.padding = '12px 16px';
        notificacion.style.borderRadius = '8px';
        notificacion.style.display = 'block';
        notificacion.style.width = 'auto';
        notificacion.style.maxWidth = '94%';
        notificacion.style.boxShadow = '0 8px 30px rgba(30,126,52,0.22)';
        notificacion.innerHTML = `<strong style="margin-right:8px;">✔</strong> ${mensaje} <button id="closeFormStatus" style="margin-left:12px;background:transparent;border:1px solid rgba(255,255,255,0.12);color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;">Cerrar</button>`;
        const closeBtn = document.getElementById('closeFormStatus');
        if (closeBtn) closeBtn.addEventListener('click', ()=> { notificacion.style.display = 'none'; });
      }
      
      // Función para verificar si una dirección ya existe con mensajes claros
      function isDuplicateAddress(newAddress, excludeIndex = -1) {
        // Verificar si es una dirección completamente vacía
        const isEmptyAddress = !newAddress.name.trim() || 
                              !newAddress.contactName.trim() || 
                              !newAddress.addressLine.trim() || 
                              !newAddress.city.trim() || 
                              !newAddress.country.trim() || 
                              !newAddress.postal.trim();
        
        if (isEmptyAddress) {
          return { isDuplicate: true, message: 'La dirección no puede estar vacía. Por favor completa todos los campos requeridos.' };
        }
        
        // Verificar duplicados basados en campos clave
        const duplicate = addresses.find((addr, index) => {
          if (index === excludeIndex) return false;
          
          return addr.name.toLowerCase().trim() === newAddress.name.toLowerCase().trim() ||
                 (addr.contactName.toLowerCase().trim() === newAddress.contactName.toLowerCase().trim() &&
                  addr.addressLine.toLowerCase().trim() === newAddress.addressLine.toLowerCase().trim() &&
                  addr.city.toLowerCase().trim() === newAddress.city.toLowerCase().trim());
        });
        
        if (duplicate) {
          return { 
            isDuplicate: true, 
            message: `Ya existe una dirección con este nombre o en esta ubicación. Por favor usa un nombre diferente o verifica la dirección.` 
          };
        }
        
        return { isDuplicate: false, message: '' };
      }
      
      // Función para guardar dirección con validaciones y prevención de duplicados
      function saveAddress() {
        // Prevenir doble envío
        if (isSubmitting) return;
        isSubmitting = true;
        
        // Validar el formulario primero
        if (!validateAddressForm()) {
          mostrarExitoLocal('Por favor, completa todos los campos requeridos');
          isSubmitting = false;
          return;
        }
        
        // Obtener valores del DOM
        const getValue = (elementId) => {
          const element = document.getElementById(elementId);
          return element ? element.value.trim() : '';
        };
        
        const addressData = {
          name: getValue('address-name'),
          contactName: getValue('address-contact-name'),
          addressLine: getValue('address-line'),
          city: getValue('address-city'),
          state: getValue('address-state'),
          country: getValue('address-country'),
          postal: getValue('address-postal'),
          phone: getValue('address-phone')
        };
        
        // Verificar si ya existe una dirección idéntica
        const duplicateCheck = isDuplicateAddress(addressData);
        if (duplicateCheck.isDuplicate) {
          mostrarExitoLocal(duplicateCheck.message);
          isSubmitting = false;
          return;
        }
        
        addresses.push(addressData);
        localStorage.setItem('savedAddresses', JSON.stringify(addresses));
        renderAddressesList();
        toggleAddressForm(false);
        
        // Mostrar mensaje de éxito
        mostrarExitoLocal('Dirección agregada correctamente');
        
        // Restablecer el estado de envío
        isSubmitting = false;
      }
      
      // Función para editar dirección
      function editAddress(index) {
        const address = addresses[index];
        // Re-inicializar campos antes de editarlos
        initializeAddressFields();
        
        Object.keys(addressFields).forEach(key => {
          if (addressFields[key]) {
            addressFields[key].value = address[key] || '';
          }
        });
        toggleAddressForm(true);
        
        // Cambiar el botón de guardar para actualizar
        btnSaveAddress.textContent = 'Actualizar Dirección';
        btnSaveAddress.onclick = () => updateAddress(index);
      }
      
      // Función para actualizar dirección con validaciones y prevención de duplicados
      function updateAddress(index) {
        // Prevenir doble envío
        if (isSubmitting) return;
        isSubmitting = true;
        
        // Validar el formulario primero
        if (!validateAddressForm()) {
          mostrarExitoLocal('Por favor, completa todos los campos requeridos');
          isSubmitting = false;
          return;
        }
        
        // Obtener valores del DOM
        const getValue = (elementId) => {
          const element = document.getElementById(elementId);
          return element ? element.value.trim() : '';
        };
        
        const addressData = {
          name: getValue('address-name'),
          contactName: getValue('address-contact-name'),
          addressLine: getValue('address-line'),
          city: getValue('address-city'),
          state: getValue('address-state'),
          country: getValue('address-country'),
          postal: getValue('address-postal'),
          phone: getValue('address-phone')
        };
        
        // Verificar si ya existe una dirección idéntica (excluyendo la dirección actual)
        const duplicateCheck = isDuplicateAddress(addressData, index);
        if (duplicateCheck.isDuplicate) {
          mostrarExitoLocal(duplicateCheck.message);
          isSubmitting = false;
          return;
        }
        
        addresses[index] = addressData;
        localStorage.setItem('savedAddresses', JSON.stringify(addresses));
        renderAddressesList();
        toggleAddressForm(false);
        
        // Mostrar mensaje de éxito
        mostrarExitoLocal('Dirección actualizada correctamente');
        
        // Restaurar botón de guardar
        btnSaveAddress.textContent = 'Guardar Dirección';
        btnSaveAddress.onclick = null;
        btnSaveAddress.removeEventListener('click', () => {});
        btnSaveAddress.addEventListener('click', saveAddress);
        
        // Restablecer el estado de envío
        isSubmitting = false;
      }
      
      // Función para eliminar dirección
      function deleteAddress(index) {
        if (confirm('¿Estás seguro de que quieres eliminar esta dirección?')) {
          addresses.splice(index, 1);
          localStorage.setItem('savedAddresses', JSON.stringify(addresses));
          renderAddressesList();
          mostrarExitoLocal('Dirección eliminada correctamente');
        }
      }
      
      // Variable para prevenir doble envío
      let isSubmitting = false;
      
      // Event listeners - usar solo addEventListener para evitar conflictos
      if (btnAddAddress) {
        btnAddAddress.addEventListener('click', () => {
          clearAddressForm();
          toggleAddressForm(true);
          btnSaveAddress.textContent = 'Guardar Dirección';
          // Remover listeners anteriores antes de agregar el nuevo
          btnSaveAddress.onclick = null;
          btnSaveAddress.removeEventListener('click', saveAddress);
          btnSaveAddress.removeEventListener('click', () => {}); // Remover cualquier listener anónimo
          btnSaveAddress.addEventListener('click', saveAddress);
        });
      }
      
      if (btnCancelAddress) {
        btnCancelAddress.addEventListener('click', () => {
          toggleAddressForm(false);
          btnSaveAddress.textContent = 'Guardar Dirección';
          btnSaveAddress.onclick = null;
          btnSaveAddress.removeEventListener('click', saveAddress);
          btnSaveAddress.removeEventListener('click', () => {});
        });
      }
      
      // El listener para btnSaveAddress se maneja dinámicamente en las funciones de toggle
      
      // Inicializar
      renderAddressesList();
      
      // Hacer las funciones disponibles globalmente para el checkout
      window.addresses = addresses;
      window.renderAddressesList = renderAddressesList;
    })();
  </script>
</section>

<footer>
    <div class="redes_sociales">
        <a href="https://www.instagram.com/camisetazo._/"><i class="fab fa-instagram"></i></a>
        <a href="https://www.tiktok.com/@camisetazo"><i class="fab fa-tiktok"></i></a>
    </div>
    <p style="margin-top: 2rem; opacity: 0.8; font-size: 0.9rem;">
        © 2025 Camisetazo. Todos los derechos reservados
    </p>
</footer>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {

        const PRECIOS_BASE = {
          1: 25.00,
          2: 24.00,
          3: 23.00,
          4: 22.00,
          5: 21.00,
          6: 20.00,
          7: 19.00,
          8: 18.00,
          9: 17.00,
          10: 16.00,
          11: 15.50,
          12: 15.00,
          13: 14.50,
          14: 14.00,
          15: 13.50,
          16: 13.00,
          17: 12.50,
          18: 12.00,
          19: 11.50,
          20: 11.00
        };
        const EXTRAS = {
          parche: 3.00,
          dorsal: 4.00,
          versionJugador: 5.00
        };
        const GASTOS_ENVIO = 5.00;
        // Simplified: all section buttons behave the same. No automatic scrolling or
        // special handling for the 'pedidos' tab — just toggle the active class and
        // refresh cart positioning.

        document.querySelectorAll('.boton-seccion').forEach(boton => {
            boton.addEventListener('click', function() {
                document.querySelectorAll('.boton-seccion').forEach(b => b.classList.remove('activo'));
                document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activa'));
                const seccionId = this.dataset.seccion;
                this.classList.add('activo');
                const target = document.getElementById(seccionId);
                if (target) target.classList.add('activa');

                // Si el usuario hace clic en "Identificarse", desplazamos suavemente la tarjeta al centro de la pantalla
                if (seccionId === 'identificarse' && target) {
                    setTimeout(() => {
                        try {
                            const card = target.querySelector('#auth-section .auth-card') || target;
                            if (card && typeof card.scrollIntoView === 'function') {
                                card.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
                            } else {
                                const rect = target.getBoundingClientRect();
                                const y = (rect.top + window.scrollY) - 16;
                                window.scrollTo({ top: y, behavior: 'smooth' });
                            }
                        } catch(e){}
                    }, 120);
                }

                // Si el usuario está autenticado y la vista activa es Identificarse (modo perfil), también hacemos scroll a la tarjeta de perfil
                try {
                    const isIdentSection = seccionId === 'identificarse';
                    const isProfileVisible = document.getElementById('profile-section')?.classList?.contains('hidden') === false;
                    if (isIdentSection && isProfileVisible) {
                        setTimeout(() => {
                            try {
                                const identSection = document.getElementById('identificarse');
                                const card = identSection?.querySelector('#profile-section .profile-card') || identSection?.querySelector('#profile-section') || identSection;
                                if (card && typeof card.scrollIntoView === 'function') {
                                    card.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
                                }
                            } catch(e){}
                        }, 140);
                    }
                } catch(e){}

        });
        });

    // Posicionar el carrito fijo debajo del nav (botones de sección). Fallback a header si no existe nav.
    (function(){
        const cart = document.getElementById('cartPanel');
        const nav = document.querySelector('.navegacion');
        const header = document.querySelector('header');
        if (!cart) return;

        // Compute the ideal top (viewport px) where the cart should sit so its top border
        // aligns with the top of the first product row. Return null if the gallery
        // isn't ready yet (so caller can retry shortly).
        function calculateTopForCart(){
            const pedidos = document.getElementById('pedidos');
            const gallery = document.getElementById('productGallery');
            const ref = nav || header;
            const refBottom = ref ? Math.round((ref.getBoundingClientRect().bottom || 0) + 8) : 8;
            // top of the pedidos section (we will not allow the cart to be placed above this)
            const pedidosTop = pedidos ? Math.round(pedidos.getBoundingClientRect().top || 8) : 8;
            const minTop = Math.max(refBottom, pedidosTop);

            if (pedidos && pedidos.classList.contains('activa') && gallery) {
                const firstProduct = gallery.querySelector('.product-item');
                if (!firstProduct) return null; // not rendered yet
                const pRect = firstProduct.getBoundingClientRect();
                let top = Math.round(pRect.top);
                if (isNaN(top)) top = Math.round(gallery.getBoundingClientRect().top);
                // ensure cart doesn't sit above the nav/header or above the pedidos top
                top = Math.max(top, minTop);
                return top;
            }

            if (ref) return Math.max(minTop, refBottom);
            return minTop || 8;
        }

        function positionCartBelowHeader(){
            // Avoid fixed positioning inside the dedicated Cart section to respect its grid layout
            try {
                const secCarrito = document.getElementById('carrito');
                if (secCarrito && secCarrito.classList.contains('activa')) {
                    cart.style.position = 'relative';
                    cart.style.top = '';
                    cart.style.right = '';
                    cart.style.zIndex = '';
                    cart.style.transition = '';
                    return;
                }
            } catch(e){}
            // Only use fixed cart on smaller viewports to avoid complex layout shifts on wide desktop
            // On wide desktop the grid already positions the cart in the right column.
            if (window.innerWidth > 1200) {
                cart.style.position = 'relative';
                cart.style.top = '';
                cart.style.right = '';
                cart.style.zIndex = '';
                try { positionPromoBanner(); } catch(e) {}
                return;
            }

            let top = calculateTopForCart();
            if (top === null) {
                // gallery or images not ready: retry shortly so alignment happens after layout
                clearTimeout(positionCartBelowHeader._retry);
                positionCartBelowHeader._retry = setTimeout(positionCartBelowHeader, 120);
                return;
            }
            if (isNaN(top) || top < 8) top = 8;
            // limit top so the cart always fits inside viewport
            const vh = Math.max(320, window.innerHeight || 768);
            const cartH = Math.min(cart.offsetHeight || 420, vh - 32);
            if (top + cartH > vh - 12) top = Math.max(8, vh - 12 - cartH);

            cart.style.position = 'fixed';
            cart.style.top = top + 'px';
            // prefer a comfortable right offset on narrow screens
            cart.style.right = '12px';
            cart.style.zIndex = 1200;
            // ensure smooth visibility: add small transition only when changing from relative
            cart.style.transition = 'top 0.12s ease, right 0.12s ease';
            try { positionPromoBanner(); } catch(e) {}
        }

        // Update on common events and after section switches
        window.addEventListener('resize', positionCartBelowHeader);
        window.addEventListener('scroll', positionCartBelowHeader);
        document.querySelectorAll('.boton-seccion').forEach(b => b.addEventListener('click', () => setTimeout(positionCartBelowHeader, 220)));

        // Retry positioning after images in the gallery load (helps avoid jumps when images change layout)
        const gallery = document.getElementById('productGallery');
        if (gallery) {
            const imgs = gallery.querySelectorAll('img');
            imgs.forEach(img => {
                if (!img.complete) {
                    img.addEventListener('load', () => setTimeout(positionCartBelowHeader, 120));
                    img.addEventListener('error', () => setTimeout(positionCartBelowHeader, 120));
                }
            });
        }

        // initial attempt shortly after load
        setTimeout(positionCartBelowHeader, 120);
    })();

    document.querySelectorAll('.boton-unidad').forEach(boton => {
        boton.addEventListener('click', function() {
            unidades = parseInt(this.dataset.unidades);
            document.querySelectorAll('.boton-unidad').forEach(b => b.classList.remove('activo'));
            this.classList.add('activo');
            const contenedor = document.getElementById('contenedorUnidades');
            contenedor.innerHTML = '';
            for(let i = 1; i <= unidades; i++) {
                const isFullWidth = (unidades % 2 === 1) && (i === unidades);
                contenedor.innerHTML += crearUnidad(i, isFullWidth);
            }
            actualizarPrecio();
            configurarEventosUnidades();
        });
    });

    

    function actualizarPrecio() {
    if (typeof unidades === 'undefined' || isNaN(unidades) || unidades < 1) { unidades = 1; }
    let precioBase = PRECIOS_BASE[unidades] || 0;
    let total = precioBase;
    let parches = 0;
    let dorsales = 0;
    let versionesJugador = 0;
    let versionesEspecial = 0;
    let camisetasNBA = 0;
    let recargoTallas = 0;
    let totalRecargoTallas = 0;

    document.querySelectorAll('.unidad').forEach(unidad => {
        const parche = unidad.querySelector('[name="parche[]"]').value.trim();
        const dorsal = unidad.querySelector('[name="dorsal[]"]').value.trim();
        const versionJugador = unidad.querySelector('[name="versionJugador[]"]').value === 'Sí';
        const versionEspecial = unidad.querySelector('[name="versionRetro[]"]').value === 'Sí';
        const esCamisetaNBA = unidad.querySelector('[name="camisetaNBA[]"]').value === 'Sí';
        const talla = unidad.querySelector('[name="talla[]"]').value;

        if (esCamisetaNBA && !dorsal) {
        }

        if (esCamisetaNBA) {
            if (parche) {
                unidad.querySelector('[name="parche[]"]').value = '';
            }
            camisetasNBA++;
            if (dorsal) dorsales++;
        } else {
            if (parche) parches++;
            if (dorsal) dorsales++;
        }
        if (versionJugador) versionesJugador++;
        if (versionEspecial) versionesEspecial++;
        if (talla === '3XL') {
            recargoTallas++;
            totalRecargoTallas += 2;
        } else if (talla === '4XL') {
            recargoTallas++;
            totalRecargoTallas += 2;
        }
    });

    const totalParches = parches * EXTRAS.parche;
    const totalDorsales = dorsales * EXTRAS.dorsal;
    const totalVersionesCombinadas = (versionesJugador + versionesEspecial + camisetasNBA);
    const totalVersionesJugador = totalVersionesCombinadas * EXTRAS.versionJugador;

    total += totalParches + totalDorsales + totalVersionesJugador + totalRecargoTallas;

    let gastosEnvio = 0;
    if (unidades === 1) {
        gastosEnvio = GASTOS_ENVIO;
        total += gastosEnvio;
    }

    if (gastosEnvio === 0) {
        const ge = document.getElementById('gastos-envio'); if (ge) { ge.innerHTML = '<i class="fas fa-gift" style="color:#28a745;margin-right:0.4em;"></i><strong style="color:#28a745;font-size:1.1em;letter-spacing:1px;">GRATIS</strong>'; }
    } else {
        const ge = document.getElementById('gastos-envio'); if (ge) { ge.innerHTML = gastosEnvio.toFixed(2) + '€'; }
    }

    const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };
    const setVal = (id, value) => { const el = document.getElementById(id); if (el) el.value = value; };

    setText('cantidad-unidades', unidades);
    setText('plural-unidades', unidades > 1 ? 'es' : '');
    setText('precio-base-detalle', (PRECIOS_BASE[unidades] || 0).toFixed(2));

    setText('cantidad-unidades-sin-desc', unidades);
    setText('plural-unidades-sin-desc', unidades > 1 ? 'es' : '');
    const precioSinDescuentoUnidad = 25.00;
    const totalSinDescuentoExtras = (parches * EXTRAS.parche) + (dorsales * EXTRAS.dorsal) + ((versionesJugador + versionesEspecial + camisetasNBA) * EXTRAS.versionJugador) + totalRecargoTallas;
    const totalSinDescuento = (precioSinDescuentoUnidad * unidades + totalSinDescuentoExtras).toFixed(2);
    setText('precio-sin-descuento', totalSinDescuento);
    setText('precioSinDescuentoTotal', totalSinDescuento);

    setText('cantidad-parches', parches);
    setText('total-parches', totalParches.toFixed(2));

    setText('cantidad-dorsales', dorsales);
    setText('total-dorsales', totalDorsales.toFixed(2));

    setText('cantidad-versiones', totalVersionesCombinadas);
    setText('total-versiones', totalVersionesJugador.toFixed(2));

    setText('cantidad-tallas-extra', recargoTallas);
    setText('total-tallas-extra', totalRecargoTallas.toFixed(2));

    setText('precioDisplay', total.toFixed(2));
    setVal('precioTotal', total.toFixed(2));

    const precioConDescuento = total.toFixed(2);
    const diferencia = (totalSinDescuento - precioConDescuento).toFixed(2);
    let ahorroHtml = '';
    if (unidades > 0) {
        ahorroHtml = `
        <div class="ahorro-visual animate__animated animate__fadeIn" style="display:flex;justify-content:flex-end;margin:0.5rem 0 0.2rem 0;">
            <span style="background:rgba(40,167,69,0.08);color:#28a745;font-weight:600;font-size:1rem;padding:0.25em 0.9em;border-radius:16px;box-shadow:0 1px 4px #2a5ba81a;display:inline-flex;align-items:center;gap:0.5em;">
                <i class="fas fa-arrow-down" style="color:#28a745;font-size:1em;"></i>
                Ahorro: <span style="font-weight:700;">-${diferencia}€</span>
            </span>
        </div>`;
    }
    const totalContainer = document.querySelector('.total-container');
    if (totalContainer) {
        let oldAhorro = totalContainer.parentElement.querySelector('.ahorro-visual');
        if (oldAhorro) oldAhorro.remove();
        totalContainer.insertAdjacentHTML('beforebegin', ahorroHtml);
    }

    return total;
}
    function prepararRedireccion(event) {
    const total = document.getElementById('precioDisplay').textContent;
    const direccion = document.getElementById('direccion').value;
    const params = new URLSearchParams({
        total: total,
        direccion: encodeURIComponent(direccion)
    });
    const baseUrl = window.location.href.replace('index.html', 'exito.html');
    document.getElementById('nextUrl').value = `${baseUrl}?${params.toString()}`;
    return true;
    }
    function configurarEventosUnidades() {
        document.querySelectorAll('.boton-version-jugador').forEach(boton => {
            boton.addEventListener('click', function() {
                const hiddenInput = this.parentElement.querySelector('[name="versionJugador[]"]');
                const unidad = this.closest('.unidad');
                const botonNBA = unidad.querySelector('.boton-camiseta-nba');
                const botonRetro = unidad.querySelector('.boton-version-especial:not(.boton-version-jugador):not(.boton-camiseta-nba)');

                if (!this.classList.contains('activo')) {
                    if (botonNBA.classList.contains('activo')) {
                        botonNBA.classList.remove('activo');
                        botonNBA.querySelector('span').textContent = 'DESACTIVADO';
                        botonNBA.parentElement.querySelector('[name="camisetaNBA[]"]').value = 'No';
                    }
                    if (botonRetro && botonRetro.classList.contains('activo')) {
                        botonRetro.classList.remove('activo');
                        botonRetro.querySelector('span').textContent = 'DESACTIVADO';
                        botonRetro.parentElement.querySelector('[name="versionRetro[]"]').value = 'No';
                    }
                }

                this.classList.toggle('activo');
                const activo = this.classList.contains('activo');
                this.querySelector('span').textContent = activo ? 'ACTIVADO' : 'DESACTIVADO';
                hiddenInput.value = activo ? 'Sí' : 'No';

                if (activo) {
                    // Aviso al activar versión JUGADOR (con enlace clickable)
                    (function(){
                        const overlay = document.createElement('div');
                        overlay.style.position='fixed'; overlay.style.left=0; overlay.style.top=0; overlay.style.right=0; overlay.style.bottom=0;
                        overlay.style.background='rgba(0,0,0,0.55)'; overlay.style.zIndex=6000; overlay.style.display='flex'; overlay.style.alignItems='center'; overlay.style.justifyContent='center';
                        overlay.innerHTML = `
                            <div style="max-width:520px;background:#071735;color:#dbeeff;padding:16px 18px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.4);font-size:0.95rem;line-height:1.45;">
                                <div style="margin-bottom:12px;">
                                    Has seleccionado la versión JUGADOR. Debes encontrar la camiseta en el siguiente enlace:<br>
                                    <a href=\"https://hxltds.x.yupoo.com/\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"color:#60a5fa;text-decoration:underline;word-break:break-all;\">https://hxltds.x.yupoo.com/</a>.<br>
                                    Si no la encuentras, contáctanos primero por Instagram.
                                </div>
                                <div style="display:flex;justify-content:flex-end;gap:8px;">
                                    <button id="jugadorNoticeClose3" type="button" style="background:#1f2a44;border:none;color:#dbeeff;padding:8px 12px;border-radius:8px;cursor:pointer;">Cerrar</button>
                                    <a href=\"https://hxltds.x.yupoo.com/\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"background:#2563eb;color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;\">Abrir enlace</a>
                                </div>
                            </div>`;
                        document.body.appendChild(overlay);
                        overlay.addEventListener('click', (e)=>{ if (e.target === overlay) overlay.remove(); });
                        const closeBtn = overlay.querySelector('#jugadorNoticeClose3');
                        if (closeBtn) closeBtn.addEventListener('click', ()=> overlay.remove());
                    })();

                    if (botonNBA.classList.contains('activo')) {
                        botonNBA.classList.remove('activo');
                        botonNBA.querySelector('span').textContent = 'DESACTIVADO';
                        botonNBA.parentElement.querySelector('[name="camisetaNBA[]"]').value = 'No';
                    }
                    if (botonRetro && botonRetro.classList.contains('activo')) {
                        botonRetro.classList.remove('activo');
                        botonRetro.querySelector('span').textContent = 'DESACTIVADO';
                        botonRetro.parentElement.querySelector('[name="versionRetro[]"]').value = 'No';
                    }
                }

                actualizarPrecio();
            });
        });

        document.querySelectorAll('.boton-version-especial').forEach(boton => {
            if (
                !boton.classList.contains('boton-version-jugador') &&
                !boton.classList.contains('boton-camiseta-nba')
            ) {
                boton.addEventListener('click', function() {
                    const hiddenInput = this.parentElement.querySelector('[name="versionRetro[]"]');
                    const unidad = this.closest('.unidad');
                    const botonNBA = unidad.querySelector('.boton-camiseta-nba');
                    const botonJugador = unidad.querySelector('.boton-version-jugador');

                    if (!this.classList.contains('activo')) {
                        if (botonNBA.classList.contains('activo')) {
                            botonNBA.classList.remove('activo');
                            botonNBA.querySelector('span').textContent = 'DESACTIVADO';
                            botonNBA.parentElement.querySelector('[name="camisetaNBA[]"]').value = 'No';
                        }
                        if (botonJugador.classList.contains('activo')) {
                            botonJugador.classList.remove('activo');
                            botonJugador.querySelector('span').textContent = 'DESACTIVADO';
                            botonJugador.parentElement.querySelector('[name="versionJugador[]"]').value = 'No';
                        }
                    }

                    this.classList.toggle('activo');
                    const activo = this.classList.contains('activo');
                    this.querySelector('span').textContent = activo ? 'ACTIVADO' : 'DESACTIVADO';
                    hiddenInput.value = activo ? 'Sí' : 'No';

                    if (activo) {
                        if (botonNBA.classList.contains('activo')) {
                            botonNBA.classList.remove('activo');
                            botonNBA.querySelector('span').textContent = 'DESACTIVADO';
                            botonNBA.parentElement.querySelector('[name="camisetaNBA[]"]').value = 'No';
                        }
                        if (botonJugador.classList.contains('activo')) {
                            botonJugador.classList.remove('activo');
                            botonJugador.querySelector('span').textContent = 'DESACTIVADO';
                            botonJugador.parentElement.querySelector('[name="versionJugador[]"]').value = 'No';
                        }
                    }

                    actualizarPrecio();
                });
            }
        });

        document.querySelectorAll('.boton-camiseta-nba').forEach(boton => {
            boton.addEventListener('click', function() {
                const hiddenInput = this.parentElement.querySelector('[name="camisetaNBA[]"]');
                const unidad = this.closest('.unidad');
                const botonJugador = unidad.querySelector('.boton-version-jugador');
                const botonRetro = unidad.querySelector('.boton-version-especial:not(.boton-version-jugador):not(.boton-camiseta-nba)');
                const inputParche = unidad.querySelector('[name="parche[]"]');
                const inputDorsal = unidad.querySelector('[name="dorsal[]"]');

                if (!this.classList.contains('activo')) {
                    if (!inputDorsal.value.trim()) {
                        alert('Debes introducir un dorsal para activar la camiseta NBA.');
                        inputDorsal.focus();
                        return;
                    }
                }

                if (!this.classList.contains('activo')) {
                    if (botonJugador.classList.contains('activo')) {
                        botonJugador.classList.remove('activo');
                        botonJugador.querySelector('span').textContent = 'DESACTIVADO';
                        botonJugador.parentElement.querySelector('[name="versionJugador[]"]').value = 'No';
                    }
                    if (botonRetro && botonRetro.classList.contains('activo')) {
                        botonRetro.classList.remove('activo');
                        botonRetro.querySelector('span').textContent = 'DESACTIVADO';
                        botonRetro.parentElement.querySelector('[name="versionRetro[]"]').value = 'No';
                    }
                }

                this.classList.toggle('activo');
                const activo = this.classList.contains('activo');
                this.querySelector('span').textContent = activo ? 'ACTIVADO' : 'DESACTIVADO';
                hiddenInput.value = activo ? 'Sí' : 'No';

                if (activo) {
                    if (botonJugador.classList.contains('activo')) {
                        botonJugador.classList.remove('activo');
                        botonJugador.querySelector('span').textContent = 'DESACTIVADO';
                        botonJugador.parentElement.querySelector('[name="versionJugador[]"]').value = 'No';
                    }
                    if (botonRetro && botonRetro.classList.contains('activo')) {
                        botonRetro.classList.remove('activo');
                        botonRetro.querySelector('span').textContent = 'DESACTIVADO';
                        botonRetro.parentElement.querySelector('[name="versionRetro[]"]').value = 'No';
                    }
                }

                inputParche.disabled = activo;
                if (activo) inputParche.value = '';

                inputDorsal.disabled = false;

                actualizarPrecio();
            });
        });
    document.querySelectorAll('.input-parche, .input-dorsal').forEach(input => {
        input.addEventListener('input', actualizarPrecio);
    });

        document.querySelectorAll('.input-talla').forEach(input => {
            input.addEventListener('change', actualizarPrecio);
        });
}

    // Ensure the payment function is available globally so event handlers can find it
    // abrirPayPal(total, { skipHint: true }) -> open immediately
    // abrirPayPal(total) -> show prominent hint with close button; open PayPal after user closes hint
    window.abrirPayPal = function (total, opts) {
        opts = opts || {};
        // Normalize amount to two decimals
        let totalStr = String(total || '0');
        totalStr = totalStr.replace(/,/g, '.').replace(/[^0-9.]/g, '');
        const parts = totalStr.split('.');
        if (parts.length > 2) {
            const dec = parts.pop();
            totalStr = parts.join('') + '.' + dec;
        }
        const payAmount = (Number(totalStr) || 0).toFixed(2);

        const width = 600;
        const height = 800;
        const left = Math.round((window.innerWidth - width) / 2);
        const top = Math.round((window.innerHeight - height) / 2);
        const paypalUrl = `https://www.paypal.com/paypalme/camisetazo/${encodeURIComponent(payAmount)}EUR`;

        // If caller requested to skip the hint, open immediately
        if (opts && opts.skipHint) {
            // open popup immediately
            let popup = null;
            try {
                popup = window.open(paypalUrl, 'PagoPayPal', `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);
                if (popup && typeof popup.focus === 'function') popup.focus();
            } catch(e) {
                setTimeout(()=> { try { popup = window.open(paypalUrl, 'PagoPayPal', `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`); if (popup && typeof popup.focus === 'function') popup.focus(); } catch(e2){} }, 300);
            }
            if (!popup) {
                mostrarExito('Popup bloqueado. Abre manualmente: ' + paypalUrl);
                return null;
            }

            const intervalo = setInterval(() => {
                try {
                    if (popup.closed) {
                        clearInterval(intervalo);
                        mostrarExito('Pago detectado. Enviando pedido...');
                        try { if (typeof enviarFormulario === 'function') enviarFormulario(); } catch (err) { console.error(err); }
                        const cm = document.getElementById('checkoutModal'); if (cm) cm.remove();
                    }
                } catch (e) {}
            }, 500);
            return popup;
        }

        // Default behaviour: show prominent yellow hint in primer plano with Close button.
        // When user closes the hint we open PayPal.
        (function showHintThenOpen(){
            // remove any existing hint overlay we created before
            const existing = document.getElementById('paypalHintOverlay'); if (existing) existing.remove();
            const overlay = document.createElement('div');
            overlay.id = 'paypalHintOverlay';
            overlay.style.position = 'fixed';
            overlay.style.left = '0'; overlay.style.top = '0'; overlay.style.right = '0'; overlay.style.bottom = '0';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.background = 'rgba(0,0,0,0.45)';
            overlay.style.zIndex = 99999;

            const box = document.createElement('div');
            box.style.background = '#ffc107';
            box.style.color = '#000';
            box.style.padding = '18px';
            box.style.borderRadius = '10px';
            box.style.maxWidth = '820px';
            box.style.width = '92%';
            box.style.boxShadow = '0 10px 40px rgba(0,0,0,0.35)';
            box.innerHTML = `
                    <div style="display:flex;align-items:flex-start;gap:12px;">
                        <div style="flex:1">
                            <strong>Importante:</strong>
                            <div style="margin-top:6px;color:#111;line-height:1.3;">En la ventana de PayPal selecciona la opción "Enviar a amigos y familiares". Cuando cierres la ventana de PayPal se enviará el pedido automáticamente. Si quieres revisar o modificar tu pedido pulsa "Revisar pedido". Para proceder, pulsa "Abrir PayPal" IMPORTANTE: El pedido se enviará simepre y cuando se reciba el pago correctamente.</div>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
                            <button id="paypalHintRevisar" class="btn-secondary" style="background:transparent;color:#000;border:1px solid rgba(0,0,0,0.08);padding:8px 12px;border-radius:8px;">Revisar pedido</button>
                            <button id="paypalHintAbrir" class="btn-primary" style="background:#0b5ed7;color:#fff;border:none;padding:8px 12px;border-radius:8px;">Abrir PayPal</button>
                        </div>
                    </div>
            `;
            overlay.appendChild(box);

                // 'Revisar pedido' simply closes the overlay so the user can modify the cart
                const revisarBtn = box.querySelector('#paypalHintRevisar');
                const abrirBtn = box.querySelector('#paypalHintAbrir');
                if (revisarBtn) revisarBtn.addEventListener('click', () => { overlay.remove(); });

                // 'Abrir PayPal' removes overlay and opens PayPal immediately (skip hint)
                if (abrirBtn) abrirBtn.addEventListener('click', () => {
                    overlay.remove();
                    try { window.abrirPayPal(payAmount, { skipHint: true }); } catch (e) { console.error('abrirBtn error', e); }
                });
            document.body.appendChild(overlay);
        })();
        return null;
    }

    function mostrarExito(mensaje) {
    const notificacion = document.getElementById('formStatus');
    if (!notificacion) return;
    notificacion.className = 'success';
    // Make it a fixed, high z-index floating notification so it's always visible in primer plano
    notificacion.style.position = 'fixed';
    notificacion.style.top = '20px';
    notificacion.style.left = '50%';
    notificacion.style.transform = 'translateX(-50%)';
    notificacion.style.zIndex = '200000';
    notificacion.style.background = '#1e7e34';
    notificacion.style.color = '#fff';
    notificacion.style.padding = '12px 16px';
    notificacion.style.borderRadius = '8px';
    notificacion.style.display = 'block';
    notificacion.style.width = 'auto';
    notificacion.style.maxWidth = '94%';
    notificacion.style.boxShadow = '0 8px 30px rgba(30,126,52,0.22)';
    notificacion.innerHTML = `<strong style="margin-right:8px;">✔</strong> ${mensaje} <button id="closeFormStatus" style="margin-left:12px;background:transparent;border:1px solid rgba(255,255,255,0.12);color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer;">Cerrar</button>`;
    const closeBtn = document.getElementById('closeFormStatus');
    if (closeBtn) closeBtn.addEventListener('click', ()=> { notificacion.style.display = 'none'; });
    }
    function enviarFormulario() {
    console.log('enviarFormulario: start. CART length=', (window.CART||[]).length);
        const precioTotalEl = document.getElementById('precioTotal');
        const precioDisplayEl = document.getElementById('precioDisplay');
        const pedidoFormEl = document.getElementById('pedidoForm');
    if (!pedidoFormEl) { console.error('enviarFormulario: pedidoForm not found'); return; }

        // Evitar envíos dobles
        if (pedidoFormEl.dataset.submitted === '1') {
            mostrarExito('Pedido ya en proceso de envío...');
            return;
        }

        // Rellenar campos básicos: usar el total calculado centralmente si está disponible
        try {
            const computed = (typeof computeCartTotals === 'function') ? computeCartTotals() : null;
            if (computed && computed.total !== undefined) {
                precioTotalEl.value = Number(computed.total).toFixed(2);
            } else if (precioDisplayEl) {
                precioTotalEl.value = precioDisplayEl.textContent || precioTotalEl.value || '0.00';
            } else {
                const cartTotalEl = document.getElementById('cartTotal');
                precioTotalEl.value = cartTotalEl ? (cartTotalEl.textContent || '0.00') : '0.00';
            }
        } catch (e) {
            precioTotalEl.value = '0.00';
        }

        // Copiar campos del modal/legacy
        const copyIfExists = (srcSelector, destId) => {
            const el = document.querySelector(srcSelector);
            const dest = document.getElementById(destId);
            if (el && dest) dest.value = el.value ? el.value.trim() : '';
        };
        copyIfExists('#checkoutPaypalEmail', 'form_emailPaypal');
        copyIfExists('#checkoutContactName', 'form_contactName');
        copyIfExists('#checkoutAddressLine', 'form_direccion');
        copyIfExists('#checkoutCity', 'form_city');
        copyIfExists('#checkoutState', 'form_state');
        copyIfExists('#checkoutCountry', 'form_country');
        copyIfExists('#checkoutPostal', 'form_postal');
        copyIfExists('#checkoutPhone', 'form_phone');
        copyIfExists('#checkoutInstagram', 'form_instagram');
        // Establecer _replyto desde el email del cliente
        try {
            const replyEl = document.getElementById('form_replyto');
            const srcEmail = document.querySelector('#checkoutPaypalEmail') || document.querySelector('#emailPaypal');
            if (replyEl && srcEmail && srcEmail.value) replyEl.value = srcEmail.value.trim();
        } catch(e){}
    // fallbacks legacy
    copyIfExists('#emailPaypal', 'form_emailPaypal');
    // (usuario field removed) copyIfExists('#usuario', 'form_usuario');
    copyIfExists('#direccion', 'form_direccion');

                // Serialize cart items into a human-readable text field (no JSON): include talla, parche, dorsal y versión
        try {
            let itemsToProcess = (window.CART || []);
            if ((!itemsToProcess || itemsToProcess.length === 0) && document.querySelectorAll) {
                console.warn('enviarFormulario: CART vacío — intentando reconstruir items desde DOM');
                const domRows = document.querySelectorAll('#cartItems .cart-item');
                const reconstructed = [];
                domRows.forEach(row => {
                    try {
                        const name = row.querySelector('.meta b') ? row.querySelector('.meta b').textContent.trim() : 'Producto';
                        const metaSmall = row.querySelector('.meta small') ? row.querySelectorAll('.meta small')[0].textContent.trim() : '';
                        const qtyInput = row.querySelector('.cart-qty-input');
                        const quantity = qtyInput ? Math.max(1, parseInt(qtyInput.value) || 1) : 1;
                        let talla = '';
                        let dorsal = '';
                        let parche = '';
                        let version = '';
                        if (metaSmall) {
                            const parts = metaSmall.split('·').map(s=>s.trim()).filter(Boolean);
                            parts.forEach(p => {
                                if (!talla && /^(S|M|L|XL|2XL|3XL|4XL|[0-9]{1,2})$/i.test(p)) { talla = p; }
                                else if (!dorsal && /\d+|[A-Z\s]{2,}/.test(p)) { dorsal = p; }
                                else if (!version && (p.toLowerCase()==='fan' || p.toLowerCase()==='jugador' || p.toLowerCase()==='player')) { version = p; }
                            });
                        }
                        // Extraer "Parche: ..." desde otros <small> dentro de .meta
                        try {
                            const smEls = row.querySelectorAll('.meta small');
                            Array.from(smEls).forEach(sm => {
                                const txt = (sm.textContent||'').trim();
                                const m = txt.match(/^Parche:\s*(.+)$/i);
                                if (m && !parche) parche = m[1].trim();
                            });
                        } catch(e){}
                        let priceTextEl = row.querySelector('div[style*="font-weight:700"]');
                        let totalDisplayed = 0;
                        if (priceTextEl) {
                            const raw = priceTextEl.textContent || priceTextEl.innerText || '';
                            const m = raw.replace(/[^0-9.,]/g,'').replace(',', '.');
                            totalDisplayed = parseFloat(m) || 0;
                        }
                        // Reconstruir múltiples ítems si la cantidad es > 1
                        for (let k = 0; k < quantity; k++) {
                            reconstructed.push({ productId: '', name, talla, dorsal, parche, version, extra:0, unitPrice: totalDisplayed/quantity || 0, total: totalDisplayed/quantity, quantity: 1 });
                        }
                    } catch (e) { console.error('reconstruct row error', e); }
                });
                if (reconstructed.length) itemsToProcess = reconstructed;
            }

            // Agrupar ítems para mostrar la cantidad
            const groupedItems = {};
            itemsToProcess.forEach(item => {
                const key = `${item.productId || ''}-${item.name || ''}-${item.talla || ''}-${item.dorsal || ''}-${item.parche || ''}-${item.version || ''}`;
                if (!groupedItems[key]) {
                    groupedItems[key] = { ...item, quantity: 0, total: 0 };
                }
                groupedItems[key].quantity += 1;
                groupedItems[key].total += item.total; // Sumar el total de cada unidad
            });

            const finalItems = Object.values(groupedItems);

            // human-friendly version mapping
            const mapVersion = v => { if (!v) return ''; if (v.toLowerCase() === 'jugador') return 'player'; return v; };
            const textEl = document.getElementById('form_cart_items_text');
            if (textEl) { 
                const lines = finalItems.map((it, idx) => {
                    const parts = [];
                    if (it.talla) parts.push(it.talla);
                    if (it.parche) parts.push(it.parche);
                    if (it.dorsal) parts.push(it.dorsal);
                    const ver = mapVersion(it.version);
                    if (ver) parts.push(ver);
                    const extras = parts.length ? ' · ' + parts.join(' · ') : '';
                    const priceStr = `€${(it.total||0).toFixed(2)}`;
                    return `${idx+1}. ${it.quantity}x ${it.name}${extras} — ${priceStr}`;
                });
                textEl.value = lines.join('\n');
                console.log('enviarFormulario: cart_items_text =', textEl.value);
            }
        } catch (e) { console.error('serialize cart error', e); }
    // Debug: precio_total value
    try { console.log('enviarFormulario: precio_total =', precioTotalEl ? precioTotalEl.value : '(no input)'); } catch(e){}

        // Intentar primero envío AJAX a FormSubmit para diagnosticar errores y evitar navegación
        try {
            const ajaxUrl = pedidoFormEl.action.replace('formsubmit.co/', 'formsubmit.co/ajax/');
            const formData = new FormData(pedidoFormEl);
            pedidoFormEl.dataset.submitted = '1';
            console.log('enviarFormulario: intentando AJAX ->', ajaxUrl);
            fetch(ajaxUrl, { method: 'POST', body: formData, headers: { 'Accept': 'application/json' } })
                .then(res => { if (!res.ok) throw new Error('HTTP '+res.status); return res.json().catch(()=>({})); })
                .then(data => {
                    console.log('FormSubmit AJAX success:', data);
                    mostrarExito('Pedido enviado correctamente.');
                    try { if (typeof clearCart === 'function') clearCart(); } catch (e) {}
                    pedidoFormEl.dataset.submitted = '0';
                    
                    // Mostrar mensaje adicional si el usuario no está autenticado
                    if (!window.auth || !window.auth.currentUser) {
                      setTimeout(() => {
                        const nota = document.createElement('div');
                        nota.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#f39c12;color:#fff;padding:12px 20px;border-radius:8px;z-index:200001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);max-width:90%;text-align:center;';
                        nota.innerHTML = '💡 <strong>Consejo:</strong> Inicia sesión para guardar tus pedidos y acumular puntos para descuentos.';
                        document.body.appendChild(nota);
                        setTimeout(() => nota.remove(), 7000);
                      }, 1500);
                    }
                    
                    // Guardar pedido en RTDB si el usuario está autenticado y refrescar panel Perfil
                    try {
                      const getVal = (id)=>{ const el = document.getElementById(id); return el ? (el.value||'').trim() : ''; };
                      const totalNum = (precioTotalEl && precioTotalEl.value) ? parseFloat(String(precioTotalEl.value).replace(',', '.')) : 0;
                      const shirtCount = (function(){ try { const c = computeCartTotals(); return (c && c.appliedOffer && c.appliedOffer.count) ? c.appliedOffer.count : 0; } catch(_) { return 0; } })();
                      const orderPayload = {
                        total: Number.isFinite(totalNum) ? totalNum : 0,
                        itemsText: (document.getElementById('form_cart_items_text')||{}).value || '',
                        contactName: getVal('form_contactName'),
                        shippingAddress: getVal('form_direccion'),
                        city: getVal('form_city'),
                        state: getVal('form_state'),
                        country: getVal('form_country'),
                        postal: getVal('form_postal'),
                        phone: getVal('form_phone'),
                        instagram: getVal('form_instagram'),
                        emailPaypal: getVal('form_emailPaypal'),
                        shirtsCount: shirtCount,
                        pointsEarned: shirtCount * 10,
                        cartItems: window.CART ? JSON.stringify(window.CART) : '[]'
                      };
                      console.log('Checkout: orderPayload creado:', orderPayload);
                      console.log('Checkout: saveOrderToRTDB disponible:', typeof window.saveOrderToRTDB);
                      if (window.saveOrderToRTDB) {
                        window.saveOrderToRTDB(orderPayload).then(()=>{
                          console.log('Checkout: Pedido guardado exitosamente');
                          if (window.refreshProfileOrders) window.refreshProfileOrders();
                        }).catch(err=>console.error('saveOrderToRTDB promise error:', err));
                      } else {
                        console.warn('Checkout: saveOrderToRTDB no está disponible');
                      }
                    } catch(e) { console.warn('No se pudo guardar el pedido en RTDB:', e); }
                    // Redirigir si hay _next
                    const nextEl = pedidoFormEl.querySelector('input[name="_next"]');
                    if (nextEl && nextEl.value) {
                        window.location.href = nextEl.value;
                    }
                })
                .catch(err => {
                    console.warn('FormSubmit AJAX falló, usando fallback por iframe:', err);
                    // Fallback: enviar con iframe oculto para no salir de la página
                    try {
                        let iframe = document.querySelector('iframe[name="formsubmit_iframe"]');
                        if (!iframe) {
                            iframe = document.createElement('iframe');
                            iframe.name = 'formsubmit_iframe';
                            iframe.style.display = 'none';
                            document.body.appendChild(iframe);
                        }
                        pedidoFormEl.target = 'formsubmit_iframe';
                        const onLoadHandler = () => {
                            setTimeout(() => {
                                mostrarExito('Pedido enviado correctamente.');
                                try { if (typeof clearCart === 'function') clearCart(); } catch (e) {}
                                pedidoFormEl.dataset.submitted = '0';
                                
                                // Mostrar mensaje adicional si el usuario no está autenticado
                                if (!window.auth || !window.auth.currentUser) {
                                  setTimeout(() => {
                                    const nota = document.createElement('div');
                                    nota.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#f39c12;color:#fff;padding:12px 20px;border-radius:8px;z-index:200001;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.15);max-width:90%;text-align:center;';
                                    nota.innerHTML = '💡 <strong>Consejo:</strong> Inicia sesión para guardar tus pedidos y acumular puntos para descuentos.';
                                    document.body.appendChild(nota);
                                    setTimeout(() => nota.remove(), 7000);
                                  }, 1500);
                                }
                                
                                // Guardar pedido en RTDB si el usuario está autenticado y refrescar panel Perfil
                                try {
                                  console.log('Checkout fallback: Intentando guardar pedido en RTDB...');
                                  const getVal = (id)=>{ const el = document.getElementById(id); return el ? (el.value||'').trim() : ''; };
                                  const totalNum = (precioTotalEl && precioTotalEl.value) ? parseFloat(String(precioTotalEl.value).replace(',', '.')) : 0;
                                  const shirtCount = (function(){ try { const c = computeCartTotals(); return (c && c.appliedOffer && c.appliedOffer.count) ? c.appliedOffer.count : 0; } catch(_) { return 0; } })();
                                  const orderPayload = {
                                    total: Number.isFinite(totalNum) ? totalNum : 0,
                                    itemsText: (document.getElementById('form_cart_items_text')||{}).value || '',
                                    contactName: getVal('form_contactName'),
                                    shippingAddress: getVal('form_direccion'),
                                    city: getVal('form_city'),
                                    state: getVal('form_state'),
                                    country: getVal('form_country'),
                                    postal: getVal('form_postal'),
                                    phone: getVal('form_phone'),
                                    instagram: getVal('form_instagram'),
                                    emailPaypal: getVal('form_emailPaypal'),
                                    shirtsCount: shirtCount,
                                    pointsEarned: shirtCount * 10,
                                    cartItems: window.CART ? JSON.stringify(window.CART) : '[]'
                                  };
                                  console.log('Checkout fallback: orderPayload creado:', orderPayload);
                                  console.log('Checkout fallback: saveOrderToRTDB disponible:', typeof window.saveOrderToRTDB);
                                  if (window.saveOrderToRTDB) {
                                    window.saveOrderToRTDB(orderPayload).then(()=>{
                                      console.log('Checkout fallback: Pedido guardado exitosamente');
                                      if (window.refreshProfileOrders) window.refreshProfileOrders();
                                    }).catch(err=>console.error('saveOrderToRTDB promise error:', err));
                                  } else {
                                    console.warn('Checkout fallback: saveOrderToRTDB no está disponible');
                                  }
                                } catch(e) { console.warn('No se pudo guardar el pedido en RTDB:', e); }
                            }, 600);
                            iframe.removeEventListener('load', onLoadHandler);
                        };
                        iframe.addEventListener('load', onLoadHandler);
                        console.log('enviarFormulario: submitting (fallback) to', pedidoFormEl.action, 'target=', pedidoFormEl.target);
                        pedidoFormEl.submit();
                    } catch (err2) {
                        console.error('Error enviando formulario (fallback):', err2);
                        mostrarExito('Error al enviar el pedido. Intenta de nuevo o contacta por Instagram.');
                        pedidoFormEl.dataset.submitted = '0';
                    }
                });
        } catch (err) {
            console.error('Error preparando envío AJAX:', err);
            pedidoFormEl.dataset.submitted = '0';
        }
    }

    // (Confirmación visual eliminada) El envío ahora se realizará automáticamente tras cerrar la ventana de PayPal.

    // Legacy form handlers: only attach if the old pedido form exists on the page
    (function attachLegacyFormHandlers(){
        const pedidoFormEl = document.getElementById('pedidoForm');
        if (!pedidoFormEl) return;

        const paypalBtn = document.getElementById('paypalButton');
        if (!paypalBtn) return;

        paypalBtn.addEventListener('click', function(event) {
            event.preventDefault();

            const emailEl = document.getElementById('emailPaypal');
            const usuarioEl = document.getElementById('usuario');
            const cantidadEl = document.getElementById('cantidad-unidades');
            const precioDisplayEl = document.getElementById('precioDisplay');

            const emailPaypal = emailEl ? emailEl.value.trim() : '';
            if (!emailPaypal || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailPaypal)) {
                alert("Por favor, ingresa un correo válido de PayPal.");
                return;
            }

            const usuarioInstagram = usuarioEl ? usuarioEl.value.trim() : '';
            if (!usuarioInstagram || !/^@[A-Za-z0-9_.]{1,30}$/.test(usuarioInstagram)) {
                alert("Por favor, ingresa un nombre de usuario válido de Instagram (debe comenzar con @ y tener entre 1 y 30 caracteres).");
                return;
            }

            const cantidadUnidades = cantidadEl ? cantidadEl.textContent : '0';
            if (parseInt(cantidadUnidades) === 0) {
                alert("Debes seleccionar al menos una unidad.");
                return;
            }

            const total = precioDisplayEl ? parseFloat(precioDisplayEl.textContent) : NaN;
            if (isNaN(total) || total <= 0) {
                alert("El total a pagar no es válido.");
                return;
            }

            if (typeof window.abrirPayPal === 'function') window.abrirPayPal(total);
        });
    })();

document.querySelectorAll('.catalogo-card-clickable').forEach(card => {
    card.addEventListener('click', function(e) {
        if (
            e.target.closest('.futbol-dropdown-menu a') ||
            e.target.closest('.futbol-dropdown-btn')
        ) {
            return;
        }
        const link = card.getAttribute('data-link');
        if (link) {
            const win = window.open(link, '_blank', 'noopener,noreferrer'); if (win) { try { win.opener = null; } catch(_){} }
        }
    });
});

    actualizarPrecio();

});
</script>

<!-- Barra de pestañas inferior (solo móvil) -->
<nav class="bottom-nav" aria-label="Navegación inferior" role="navigation">
  <!-- Catálogo (sección: tienda) -->
  <button class="bottom-nav__btn" data-seccion="tienda" aria-label="Ir a Catálogo">
    <span class="icon" aria-hidden="true">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 7h18l-1.5 10.5a2 2 0 0 1-2 1.7H6.5a2 2 0 0 1-2-1.7L3 7Z" stroke="currentColor" stroke-width="1.5"/>
        <path d="M8 7V5a3 3 0 0 1 3-3h2a3 3 0 0 1 3 3v2" stroke="currentColor" stroke-width="1.5"/>
      </svg>
    </span>
    <span class="label">Catálogo</span>
  </button>
  <!-- Tienda (sección: pedidos) -->
  <button class="bottom-nav__btn" data-seccion="pedidos" aria-label="Ir a Tienda">
    <span class="icon" aria-hidden="true">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 7h16l-1 12a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2L4 7Z" stroke="currentColor" stroke-width="1.5"/>
        <path d="M6 7l2-3h8l2 3" stroke="currentColor" stroke-width="1.5"/>
      </svg>
    </span>
    <span class="label">Tienda</span>
  </button>
  <!-- Carrito -->
  <button class="bottom-nav__btn" data-seccion="carrito" aria-label="Ir a Carrito">
    <span class="icon" aria-hidden="true">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 5h2l1.6 9.5a2 2 0 0 0 2 1.7h7.8a2 2 0 0 0 2-1.7L20 9H7" stroke="currentColor" stroke-width="1.5"/>
        <circle cx="9" cy="20" r="1.6" stroke="currentColor" stroke-width="1.5"/>
        <circle cx="17" cy="20" r="1.6" stroke="currentColor" stroke-width="1.5"/>
      </svg>
    </span>
    <span class="label">Carrito</span>
    <span class="cart-tab-badge hidden" aria-hidden="true">0</span>
  </button>
  <!-- ¿Quiénes Somos? -->
  <button class="bottom-nav__btn" data-seccion="quienes-somos" aria-label="Ir a ¿Quiénes Somos?">
    <span class="icon" aria-hidden="true">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="12" cy="7" r="3" stroke="currentColor" stroke-width="1.5"/>
        <path d="M4 20a8 8 0 0 1 16 0" stroke="currentColor" stroke-width="1.5"/>
      </svg>
    </span>
    <span class="label">Nosotros</span>
  </button>
  <!-- Identificarse -->
  <button class="bottom-nav__btn" data-seccion="identificarse" aria-label="Ir a Identificarse">
    <span class="icon" aria-hidden="true">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 7a4 4 0 1 1 8 0 4 4 0 0 1-8 0Z" stroke="currentColor" stroke-width="1.5"/>
        <path d="M20 21v-2a5 5 0 0 0-5-5h-1" stroke="currentColor" stroke-width="1.5"/>
        <path d="M7 7l-4 4 4 4" stroke="currentColor" stroke-width="1.5"/>
        <path d="M3 11h9" stroke="currentColor" stroke-width="1.5"/>
      </svg>
    </span>
    <span class="label">Acceso</span>
  </button>
</nav>
<script>
(function(){
  const bottomNav = document.querySelector('.bottom-nav');
  if (!bottomNav) return;

  const bottomButtons = Array.from(bottomNav.querySelectorAll('.bottom-nav__btn'));
  function activateSection(id){
    const topBtn = document.querySelector('.boton-seccion[data-seccion="'+id+'"]');
    if (topBtn) topBtn.click();
  }
  bottomButtons.forEach(btn => btn.addEventListener('click', () => activateSection(btn.dataset.seccion)));
  document.querySelectorAll('.boton-seccion').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.seccion;
      bottomButtons.forEach(b => {
        const isActive = b.dataset.seccion === id;
        b.classList.toggle('activo', isActive);
        if (isActive) { b.setAttribute('aria-current', 'page'); } else { b.removeAttribute('aria-current'); }
      });
    });
  });
  const activeSection = document.querySelector('.seccion.activa');
  if (activeSection){
    const id = activeSection.id;
    bottomButtons.forEach(b => {
      const isActive = b.dataset.seccion === id;
      b.classList.toggle('activo', isActive);
      if (isActive) { b.setAttribute('aria-current', 'page'); } else { b.removeAttribute('aria-current'); }
    });
  }
  const orig = window.updateCartTabBadge;
  window.updateCartTabBadge = function(total){
    try {
      if (typeof orig === 'function') orig(total);
      const btn = bottomNav.querySelector('.bottom-nav__btn[data-seccion="carrito"]');
      if (!btn) return;
      let badge = btn.querySelector('.cart-tab-badge');
      if (!badge){ badge = document.createElement('span'); badge.className='cart-tab-badge'; btn.appendChild(badge); }
      const v = (typeof total === 'number' ? total : (Array.isArray(window.CART) ? window.CART.length : 0));
      if (v > 0){ badge.textContent=String(v); badge.classList.remove('hidden'); }
      else { badge.textContent='0'; badge.classList.add('hidden'); }
    } catch(e) {}
  };
  if (typeof window.updateCartTabBadge === 'function') {
    window.updateCartTabBadge(Array.isArray(window.CART) ? window.CART.length : 0);
  }
})();
</script>

<script defer src="scripts/cookie-consent.js"></script>
<script defer src="scripts/webp-optimization.js"></script>
<script defer src="scripts/register-sw.js"></script>
<script defer src="scripts/scripts.js"></script>
<script defer src="js/mobile-optimizations.js"></script>
<script defer src="https://analytics.vercel.com/script.js"></script>
</body>
</html>
